eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('6 5H=0;6 6P=1;6 36=2;6 4b=3;6 5f=0;6 67=1;6 6t=2;6 51=3;6 4H=4;6 4I=5;6 65=["3V 6O","3V 6M","64 6N","3V 6T","3V 6Y","64 6X",];v 6U(b,a){6 c={1r:b,4A:C,5v:v(f,e){u e},4C:C};L(6 d 2Q c){9[d]=(1m a=="1o"||1m a[d]=="1o")?c[d]:a[d]}}v E(b,a){6 c={1r:b,2D:J,3m:C,Z:C,2c:0,3n:10,2Z:10,2N:-2e,2b:2e,2w:-2e,2d:2e,6p:J,4F:J,6l:J,5d:J,6A:1,2g:36,2p:20,34:40,2U:20,4g:40,27:"15-6V",1C:["70","6H","6G","6I","6K","7A","7n","1c"],2K:0,3r:0,1n:v(g,f,e){},48:v(e){u e.5e=="7k"&&e.F.1G=="4p"&&9.4L(e,9.1r+"-A")},4c:v(e){u J},5G:v(e){u J},5B:v(i,h,g,e,f){i.F.1V=h+"3H";i.F.5J=e+"3H";i.F.1D=g+"3H";i.F.5a=f+"3H"},6d:v(e,j,h,f,i,g){},5E:v(e,f){},5O:v(e){},z:C,3U:K,D:C,1M:J,1I:1v 3h(),1w:1v 3h(),3z:0,49:0,22:0,1Z:0,3E:0,3N:0,1P:0,1O:0,11:0,12:0,18:0,19:0,I:C,15:C,2v:K,2S:C,S:C,1U:1,5m:0,2R:K,1l:C};L(6 d 2Q c){9[d]=(1m a=="1o"||1m a[d]=="1o")?c[d]:a[d]}}E.B.7m=v(a){u 65[a]};E.B.58=v(){u 9.1I};E.B.53=v(){9.1I=1v 3h()};E.B.71=v(b){8(!9.z){u}6 c=9;6 a=1v 7z({T:b||C,7x:v(j,h,g){6 i=j;2P(i){8(c.48(i)){1X}i=i.2r;a.7w=i}6 e=h-c.3t(c.z)+2a(c.z.1h);6 d=g-c.3x(c.z)+2a(c.z.1k);6 l=c.4t(e,d);6 f=l?l.r:-1;6 k=l?l.c:-1;u c.6d(a,i,e,d,f,k)}});a.4l(9.z)};E.B.4k=v(A,2C){R(9){6 V=1A(A);1l={2C:2C,A:2C?3P(A):A,V:V,2f:52(V)}}};E.B.7j=v(3c,A,3T,3Z,3d,3e,6m,6n,75,3R,3Y,3B,3D){3R=3R||"74";3Y=3Y||"79";3B=3B||"7a";3D=3D||"(7g 7e 7c)";R(9){8(A){8(6m){3c.3v(3R,v(A,14){14.4k(A,K);14.3l(A)},9)}8(6n){3c.3v(3Y,v(A,14){14.4k(A,J)},9)}}8(1l){6 2t=1l.2C?C:1l;8(3d>=0&&3e>=0&&1l.2f&&1M){6 4u=3d+1l.2f.h-1;6 4r=3e+1l.2f.w-1;6 4D=5z(3d,3e,4u,4r,2t);6 4s=v(I,14){14.5C(3d,3e,4u,4r)}}1b{6 O=3T+1l.V.w;6 M=3Z+1l.V.h;6 4D=3K(3T,3Z,O,M,2t);6 4s=v(I,14){14.4X(3T,3Z,O,M)}}8(4D){3c.3v(3B,4s,9)}1b{8(!A){3c.3v(3D)}}}}};E.B.33=v(e,f,d,a,b,c){8(c&&!9.3K(f,d,f+a,d+b,e)){u K}8(9.3m&&9.2c>0){9.3m.1a="7b A 7f 1G ["+f+","+d+"] R 7h ["+a+"x"+b+"]"}9.5B(e,f,d,a,b);u J},E.B.4l=v(5I,43,24,3u,5j){8(1m 43=="1o"){43=J}8(1m 24=="1o"){24=J}8(1m 3u=="1o"){3u=1}R(9){8(z){4V()}z=5I;8(!z){73.72("E.4l 76 78 z");u K}8(z.5e=="77"){D=z;z=3U?C:Q.1T(3b(D));8(!z){3U=J;8(!D.2O){D.2O=1r+"-7i-2O-"+(++5m)}z=Q.1T(3b(D))||Q.2y("3k");z.2O=3b(D);z.F.2z="A";z.F.5r="5n";z.F.5q="0 5n";z.F.1G=D.F.1G;z.F.1V=D.F.1V;z.F.1D=D.F.1D;z.F.26=D.F.26;z.F.21=D.F.21;D.F.3o="4z";D.F.2z="";D.F.1G="";D.F.1V="";D.F.1D="";D.F.26="";D.F.21="";D.2r.57(z,D);D.2r.3G(D);z.2V(D)}D.4q("7v","38");D.4q("7u","38");D.F.7t="28";8(D.F.5o){D.F.5o="59-7y"}D.F.7s="38"}8(69(z)){z.F.1G="7r"}2N=24?0:-2e;2w=24?0:-2e;2b=24?2a(z.2L):2e;2d=24?2a(z.2F):2e;8(D){8(54.5F.1p("5x")!=-1&&54.5F.1p("5x 7")!=-1){6 41=\'<7l 7o="../7q/7p.6S" 6J="" 5J="\'+3u+\'" 5a="1" 6W="0" 6Z="0">\';41="&6L;";8(1m 6R=="v"){$(D.4S[0]).6Q("7d").81(41)}1b{6 1d=D.4S[0].42("6F");L(6 r=0;r<1d.G;r++){1t=1d[r].42("6r");L(6 c=0;c<1t.G;c++){8(4N(1t[c].1a)==""){1t[c].1a=41}}}}}8(!5j){S=1v 1z(9,{2K:2K,3r:3r});6 2h=D.6u.2h;8(24){2b=2h.x+2h.w}8(24){2d=2h.y+2h.h}}}1M=D?43:K}6 1K=9;1y(9.z,"5h",v(e){1K.4y(e)});1y(Q,"5g",v(e){1K.4B(e)});1y(Q,"5k",v(e){1K.4j(e)});1y(Q,"5l",v(e){1K.4d(e)});1y(Q,"5p",v(e){1K.4e(e)})};E.B.8d=v(){R(9){L(6 i=0;i<1I.G;i++){6 A=1I[i];8(1m A.2o=="1o"){23}6 c=9.2M(A.2o,A.3a,A.2B,A.3f);8(c){9.33(A,c.P,c.N,c.O-c.P,c.M-c.N,K)}}}};E.B.4V=v(){8(!9.z){u}2q(9.z,"5h",v(e){1K.4y(e)});2q(Q,"5g",v(e){1K.4B(e)});2q(Q,"5k",v(e){1K.4j(e)});2q(Q,"5l",v(e){1K.4d(e)});2q(Q,"5p",v(e){1K.4e(e)});R(9){8(D&&3U){D.F.3o=z.F.3o;D.F.2z=z.F.2z;D.F.1G=z.F.1G;D.F.1V=z.F.1V;D.F.1D=z.F.1D;D.F.26=z.F.26;D.F.21=z.F.21;8(z){L(6 i=0;i<z.55.G;i++){8(z.55[i]==D){z.3G(D);1X}}8(z.2r){z.2r.57(D,z)}z.F.2z="5R"}}z=C;D=C;S=C;I=C;15=C}};E.B.8g=v(b){6 a=Q.1T(9.3b(b));8(a){8(a==9.z){9.4V()}a.2r.3G(a)}9.53()};E.B.3b=v(a){u a.2O+"-"+9.1r+"-z"};E.B.39=v(A,2G,2A,2I,2H,3w,5K){8(1m 3w=="1o"){3w=J}8(!9.z||2G==2I||2A==2H){u C}6 P=2G<2I?2G:2I;6 O=2G<2I?2I:2G;6 N=2A<2H?2A:2H;6 M=2A<2H?2H:2A;A.F.1G="4p";A.F.59="38";A.F.5q="38";A.F.5r="4G";A.F.1U=++9.1U;8(!9.33(A,P,N,O-P,M-N,3w)){u C}9.z.2V(A);8(9.2g==5H){9.2k(A,J)}9.2J(A,K);A.14=9;1y(A,"8b",v(e){R(9.14){2J(9,J);8(2g==36){2k(9,J)}}});1y(A,"86",v(e){R(9.14){2J(9,K);8(2g==36){2k(9,K)}}});9.1I.1Q(A);8(!5K){9.5O(A)}u A};E.B.5N=v(b,j,a,i,f,h,e,c){6 d=Q.2y("3k");d.T=(f||"")+" "+9.1r+"-A";d.2W=h||"";d.2l=[];8(e){L(6 g 2Q e){d.2l.1Q(g);d[g]=e[g]}}u 9.39(d,b,j,a,i,c)};E.B.85=v(h,b,g,a,e,f,d){6 i=9.2M(h,b,g,a);6 c=i?9.5N(i.P,i.N,i.O,i.M,e,f,d):C;8(c){c.2o=h;c.3a=b;c.2B=g;c.3f=a}u c};E.B.3P=v(b){6 c=Q.2y("3k");c.T=b.T;c.2W=b.2W;c.F.5L=b.F.5L;c.2l=b.2l;L(6 a=0;a<b.2l.G;a++){c[b.2l[a]]=b[b.2l[a]]}9.5E(b,c);u c};E.B.3g=v(f,b,e,a,c,d){u 9.39(9.3P(f),b,e,a,c,d)};E.B.88=v(g,d,e,a,c,b){6 f=9.2M(d,e,a,c);u f?9.3g(g,f.P,f.N,f.O,f.M,b):C};E.B.4X=v(P,N,O,M){R(9){8(!1l){u K}1b{8(1l.2C){6 5s=39(1l.A,P,N,O,M)?J:K;1l.A=3P(1l.A);u 5s}1b{6 A=39(1l.A,P,N,O,M,J,J);8(A){1l=C;2R=J;8(1n){1n(A,4I)}u J}}}}u K};E.B.5C=v(c,d,a,b){6 e=9.2M(c,d,a,b);u e?9.4X(e.P,e.N,e.O,e.M):K};E.B.2M=v(f,b,e,a){8(!9.z||!9.D){u C}6 i=f<e?f:e;6 g=f<e?e:f;6 d=b<a?b:a;6 c=b<a?a:b;6 j=9.4i(i,d);8(!j){u C}6 h=9.4i(g,c);8(!h){u C}u{P:j.P,N:j.N,O:h.O,M:h.M}};E.B.3l=v(a){9.z.3G(a);8(a==9.I){9.I=C}8(9.1I.1p(a)>=0){9.1I.8i(9.1I.1p(a),1)}u J};E.B.1A=v(d){6 a=9.4K(d);6 e=9.4J(d);6 b=d.2L;6 c=d.2F;u{x:a,y:e,w:b,h:c,P:a,N:e,O:a+b,M:e+c}};E.B.3C=v(c,b){6 a=9.52(9.1A(c),b);8(c&&a){c.2o=a.2o;c.3a=a.3a;c.2B=a.2B;c.3f=a.3f}u a};E.B.52=v(a,c){8(!9.S){u C}8(1m c=="1o"){c="8s"}6 h=9.S.3s(a.N,a.M,c=="x");8(h.G<1){h=9.S.5c(a.N,a.M,c=="x");8(h.G<1){u C}}6 f=9.S.3p(a.P,a.O,h[0],c=="y");8(f.G<1){u C}6 i=h.G==1?f:9.S.3p(a.P,a.O,h[h.G-1],c=="y");8(i.G<1){u C}6 g=f[0];6 d=f[f.G-1];6 b=i[0];6 e=i[i.G-1];u{8r:g,8t:d,8v:b,8q:e,P:g.P,N:g.N,O:e.O,M:e.M,r:g.r,c:g.c,w:f.G,h:h.G,2o:g.r,3a:g.c,2B:e.r,3f:e.c}};E.B.8p=v(e){6 d=e.6j||e.6i+Q.2X.1h;6 b=e.6k||e.3O+Q.2X.1k;6 c=d-9.3t(9.z)+2a(9.z.1h);6 a=b-9.3x(9.z)+2a(9.z.1k);u 9.4t(c,a)};E.B.4t=v(a,b){u 9.S?9.S.6B(a,b):C};E.B.4i=v(a,d){6 b=9.D?9.D.1d[a]:C;u b?b.U[d]:C};E.B.8l=v(b){6 a=9.3C(b,"x");u a?a.w:0};E.B.8k=v(b){6 a=9.3C(b,"y");u a?a.h:0};E.B.8m=v(A){R(9){8(!S){u K}6 25=[];6 V=1A(A);6 1R=S.3s(V.N,V.M,J);6 1t=1R.G>0?S.3p(V.P,V.O,1R[0]):[];L(6 c=0;c<1t.G;c++){25.1Q(3g(A,1t[c].P,V.N,1t[c].O,V.M,K))}8(!3l(A)){u K}u 25}};E.B.8n=v(A){R(9){8(!S){u K}6 25=[];6 V=1A(A);6 1R=S.3s(V.N,V.M);L(6 i=0;i<1R.G;i++){25.1Q(3g(A,V.P,1R[i].1J.N,V.O,1R[i].1J.M,K))}8(!3l(A)){u K}u 25}};E.B.8o=v(A){R(9){8(!S){u K}6 25=[];6 V=1A(A);6 1R=S.3s(V.N,V.M);L(6 r=0;r<1R.G;r++){6 1t=S.3p(V.P,V.O,1R[r]);L(6 c=0;c<1t.G;c++){25.1Q(3g(A,1t[c].P,1t[c].N,1t[c].O,1t[c].M,K))}}8(!3l(A)){u K}u 25}};E.B.7O=v(a){9.1w.1Q(a)};E.B.3K=v(4m,4o,4n,4h,2t){R(9){8(5d){u J}L(6 i=0;i<1I.G;i++){6 A=1I[i];8(2t&&A==2t){23}6 1Y=1A(A);8(Z&&2c>=2){Z.1a=""+4m+" < "+1Y.O+"<1c/>";Z.1a+=""+4n+" > "+1Y.P+"<1c/>";Z.1a+=""+4o+" < "+1Y.M+"<1c/>";Z.1a+=""+4h+" > "+1Y.N+"<1c/>"}8(47(4m,4o,4n,4h,1Y.P,1Y.N,1Y.O,1Y.M)==31){23}8(3m&&2c>0){3m.1a="7B 7D"}u K}u J}};E.B.5z=v(d,f,b,c,a){6 e=9.2M(d,f,b,c);u e?9.3K(e.P,e.N,e.O,e.M,a):K};E.B.5w=v(A,1q,28){R(9){8(!A){u}8(!A.1w){A.1w={}}28=28&&!15;8(1m A.1w[1q.1r]=="1o"){6 1F=Q.2y("3k");1F.T=1r+"-"+1q.1r+"-1q";1F.F.1G="4p";1F.1q=1q;1F.A=A;8(1q.4A){1F.4q("7E",1q.4A)}8(1q.4C){1F.7F=v(){9.1q.4C(A)}}A.1w[1q.1r]=A.2V(1F)}A.1w[1q.1r].F.3o=1q.5v(A,28)?"4z":"4G"}};E.B.2J=v(A,28){R(9){L(6 i=0;i<1w.G;i++){5w(A,1w[i],28)}}};E.B.7H=v(5D){R(9){L(6 i=0;i<1w.G;i++){8(1w[i].1r==5D){u 1w[i]}}}u C};E.B.2k=v(A,28){R(9){8(!A||15){u}8(!A.1C){A.1C={}}L(6 h=0;h<1C.G;h++){8(1m A.1C[1C[h]]!="1o"){23}6 1F=Q.2y("3k");1F.T=27+" "+27+"-"+1C[h];A.1C[1C[h]]=A.2V(1F)}L(6 h=0;h<1C.G;h++){A.1C[1C[h]].F.3o=(28&&5G(A))?"4z":"4G"}}};E.B.7Y=v(e){6 b=e.F.1U;6 d=e.F.1U;6 c=9.58();L(6 a=0;a<c.G;a++){6 f=2a(c[a].F.1U);8(f<d){d=f}8(f<b){c[a].F.1U=f+1}}e.F.1U=d};E.B.5Q=v(1S){R(9){8(!Q.1T||!2D){u}8(1S&&(1S!=I)){I=1S;I.F.1U=++1U;8(2g==4b){2k(I,J)}6 1W=1A(I);11=1W.x;12=1W.y;18=1W.w;19=1W.h;8(1n){1n(I,5f)}}}};E.B.4Z=v(5b){R(9){8(!Q.1T||!2D){u}8(5b){8(I!=C&&1n){1n(I,67)}8(I!=C&&2g==4b){2k(I,K)}I=C}15=C;1P=0;1O=0}};E.B.4d=v(a){a=a||1L.3j;8(1L.3j){2E=a.6q}1b{8(a.44){2E=a.44}}8(2E==17&&9.4F){9.2v=J}};E.B.4e=v(a){a=a||1L.3j;8(1L.3j){2E=a.6q}1b{8(a.44){2E=a.44}}8(2E==17&&9.4F){9.2v=K}};E.B.4y=v(e){R(9){8(!Q.1T||!2D||e.1q==2){u J}6 1x=e.82||e.7X,1S=C,3i=C,3J=1v 1E(27+"-([3I]{2})$","");L(6 i=0;i<1w.G;i++){8(1x.T==1r+"-"+1w[i].1r+"-1q"){u}}2P(1x){8(1x.T){8(!3i&&(3J.3M(1x.T)||(48(1x)&&4c(1x)))){3i=1x}8(48(1x)&&4c(1x)){1S=1x;1X}}1x=1x.2r}8(I&&(I!=1S)&&6p){4Z(J)}8(1S&&(!I||(1S==I))){8(3i){4Q(e)}5Q(1S);15=3i;8(15&&1n){1n(I,6t)}2R=K;6 2f=3C(I,"y");8(2f!==C){3z=2f.2o;49=2f.2B}2J(I,K);6E(I,I.2W||"")}}};E.B.4B=v(e){R(9){8(!Q.1T||!2D){u J}22=e.6j||e.6i+Q.2X.1h;1Z=e.6k||e.3O+Q.2X.1k;8(22==3E&&1Z==3N){u}6 16=22-3E+1P;6 13=1Z-3N+1O;8(6l&&e.8w){8(!9.2S){9.2S=1g.1H(16)>1g.1H(13)?"X":"Y"}8(9.2S=="X"){13=0}1b{16=0}}1P=1O=0;3E=22;3N=1Z;8(!15){u J}8(e.3O<2p){1L.6v(0,-34)}8(e.3O>(1L.7U||Q.5V.7Z)-2p){1L.6v(0,34)}6 1B=9.2u();6 6D=13<0&&(!1B||9.2u("t"));6 6C=13>0&&(!1B||9.2u("b"));6 6w=16<0&&(!1B||9.2u("l"));6 6y=16>0&&(!1B||9.2u("r"));8((13<0&&(12+19)<=(z.1k+2p))||(6D&&12<=(z.1k+2p))){6 3L=z.1k;z.1k=1g.6x(z.1k-34,0);13-=(3L-z.1k)}8((13>0&&(12+2p)>=(z.1k+z.2F))||(6C&&(12+19+2p)>=(z.1k+z.2F))){6 3L=z.1k;z.1k=1g.6z(z.1k+34,z.7P);13+=(z.1k-3L)}8((16<0&&(11+18)<=(z.1h+2U))||(6w&&11<=(z.1h+2U))){6 3F=z.1h;z.1h=1g.6x(z.1h-4g,0);16-=(3F-z.1h)}8((16>0&&(11+2U)>=(z.1h+z.2L))||(6y&&(11+18+2U)>=(z.1h+z.2L))){6 3F=z.1h;z.1h=1g.6z(z.1h+4g,z.7G);16+=(z.1h-3F)}1B=(9.4P&&9.4P(16,13));8(!1B){6 1s=16,1u=13;8(11+1s<2N){1P=(1s-(16=2N-11))}1b{8(11+18+1s>2b){1P=(1s-(16=2b-11-18))}}8(12+1u<2w){1O=(1u-(13=2w-12))}1b{8(12+19+1u>2d){1O=(1u-(13=2d-12-19))}}11+=16;12+=13}6 2i=K;8(!1M||2v){2i=33(I,11,12,18,19,J)}1b{8(1B){2i=6h()}1b{2i=3Q()}}8(1L.7C&&Q.2X){6 2n=Q.1T("61-62-5X");8(!2n){6 2n=Q.2y("7J");2n.2O="61-62-5X";2n.F.2z="5R";Q.5V.2V(2n)}2n.8u()}8(2i&&1n){1n(I,1B?4H:51,1M&&!2v)}2R=2R||2i;4Q(e)}};E.B.4j=v(e){R(9){8(!Q.1T||!2D||!I){u}6 3J=1v 1E(27+"-([3I]{2})$","");6 1B=(15!=C)&&3J.3M(15.T);8(1M&&2v){6 2i=1B?3Q():3Q();8(1n){1n(I,1B?4H:51,J)}}8(I){6 1W=1A(I);11=1W.x;12=1W.y;18=1W.w;19=1W.h}6 6g=(15);4Z(K);9.2S=C;5Y(I,I.2W||"");6 4O=(22>=30(I)&&22<=(30(I)+18)&&1Z>=(32(I))&&1Z<=(32(I)+19));6 4M=(22>=30(z)&&22<=(30(z)+z.2L)&&1Z>=(32(z))&&1Z<=(32(z)+z.2F));2J(I,4O&&4M);8(2g==36){9.2k(I,4O&&4M)}8(6g&&1n){1n(I,4I)}}};E.B.3Q=v(){R(9){u 4Y(11,12,18,19)}};E.B.6h=v(){R(9){6 2Y=1A(I);6 1e=2Y.x;6 1f=2Y.y;6 1i=2Y.w;6 1j=2Y.h;6 1N=15&&15.T&&15.T.37(1v 1E(27+"-([6b]{2})$"))?1E.$1:"";6 x=1N.1p("r")>=0?"26":(1N.1p("l")>=0?"1V":C);6 y=1N.1p("b")>=0?"21":(1N.1p("t")>=0?"1D":C);8(x=="1V"){6 2j=S.5M(11,I);8(2j!=C){1e=11-2j;1i=18+2j}}8(x=="26"){6 2j=S.5i(11+18,I);8(2j!=C){1i=18-2j}}8(y=="1D"){6 2m=S.5y(12,I);8(2m!=C){1f=12-2m;1j=19+2m}}8(y=="21"){6 2m=S.5P(12+19,I);8(2m!=C){1j=19-2m}}u 4Y(1e,1f,1i,1j)}};E.B.4Y=v(1e,1f,1i,1j){R(9){6 35=6e(1e,1f,1i,1j);1e=35.x;1f=35.y;1i=35.w;1j=35.h;8(Z&&2c>=4){Z.1a="<1c/>X: "+11+"=> "+1e;Z.1a+="<1c/>W: "+18+"=> "+1i;Z.1a+="<1c/>X+W: "+(1e+1i)+" 5W. "+2b;Z.1a+="<1c/>Y: "+12+"=> "+1f;Z.1a+="<1c/>H: "+19+"=> "+1j;Z.1a+="<1c/>Y+H: "+(1f+1j)+" 5W. "+2d}6 5U=1A(I);8(!33(I,1e,1f,1i,1j,J)){u K}u!63(5U,1A(I),["x","y","w","h"])}};E.B.6e=v(1e,1f,1i,1j){R(9){8(Z&&2c>=3){Z.1a="<1c/>X: "+1e;Z.1a+="<1c/>W: "+1i;Z.1a+="<1c/>Y: "+1f;Z.1a+="<1c/>H: "+1j}1e=1e+S.4w(1e,"1V");1f=1f+S.4f(1f,"1D");1i=1i+S.4w(1e+1i,"26",1e);1j=1j+S.4f(1f+1j,"21",1f);8(Z&&2c>=3){Z.1a+="<1c/>X\': "+1e;Z.1a+="<1c/>W\': "+1i;Z.1a+="<1c/>Y\': "+1f;Z.1a+="<1c/>H\': "+1j}u{x:1e,y:1f,w:1i,h:1j}}};E.B.2u=v(a){6 b=1v 1E(9.27+"-([3I]{2})$","");8(9.15==C||9.15.T==C||!9.15.T.37(b)){u K}u 1m a=="1o"||1E.$1.1p(a)>=0};E.B.4P=v(16,13){R(9){6 1N=15&&15.T&&15.T.37(1v 1E(27+"-([6b]{2})$"))?1E.$1:"";6 1u=13,1s=16,2x=K;8(1N.1p("t")>=0){8(!1M){8(19-1u<2Z){1O=(1u-(13=19-2Z))}1b{8(12+1u<2w){1O=(1u-(13=2w-12))}}}12+=13;19-=13;2x=J}8(1N.1p("b")>=0){8(!1M){8(19+1u<2Z){1O=(1u-(13=2Z-19))}1b{8(12+19+1u>2d){1O=(1u-(13=2d-12-19))}}}19+=13;2x=J}8(1N.1p("l")>=0){8(!1M){8(18-1s<3n){1P=(1s-(16=18-3n))}1b{8(11+1s<2N){1P=(1s-(16=2N-11))}}}11+=16;18-=16;2x=J}8(1N.1p("r")>=0){8(!1M){8(18+1s<3n){1P=(1s-(16=3n-18))}1b{8(11+18+1s>2b){1P=(1s-(16=2b-11-18))}}}18+=16;2x=J}u 2x}};v 1z(a,f){6 i={2K:0,3r:0,3q:0.45};L(6 e 2Q i){9[e]=(1m f[e]=="1o")?i[e]:f[e]}9.14=a;9.D=a.D;9.3W=a.6A;9.D.1d=9.D.4S[0].42("6F");9.D.4a=9.D.1d.G>0?9.D.1d[0]:C;9.D.6u=9.D.1d.G>0?9.D.1d[9.D.1d.G-1]:C;6 m=[];6 j=0;6 g=9.D.1d.G;L(6 b=0;b<g;b++){6 n=9.D.1d[b];n.U=n.42("6r");n.1J=n.U.G>0?n.U[0]:C;n.2h=n.U.G>0?n.U[n.U.G-1]:C;6 d=9.14.4J(n.1J);6 l=n.1J.2F;8(b==0){L(6 h=0;h<n.U.G;h++){m.1Q(9.14.4K(n.U[h]))}j=n.U[n.U.G-1].2L}L(6 h=0;h<n.U.G;h++){6 k=n.U[h];k.7L=n;k.x=m[h];k.y=d;k.w=h<n.U.G-1?(m[h+1]-k.x-9.2K):j-9.2K;k.h=l-9.3r;k.P=k.x;k.N=k.y;k.O=k.x+k.w;k.M=k.y+k.h;k.r=b;k.c=h;8(9.14.2c>=5){8((h<1||h==n.U.G-1)&&(b<1||b==9.D.1d.G-1)){7N(b+","+h+" => "+k.x+","+k.y+" "+k.w+"x"+k.h)}}k.8f=v(c,o){u 9.P<=c&&9.O>=c&&9.N<=o&&9.M>=o};k.6s=v(c){u 9.P<=c&&9.O>=c};k.6o=v(c){u 9.N<=c&&9.M>=c};k.47=v(o,q,c,p){u 47(9.P,9.N,9.O,9.M,o,q,c,p)};k.8j=v(o,c){u 4W(9.P,9.O,o,c)};k.7K=v(o,c){u 7M(9.N,9.M,o,c)};k.5t=v(o,c){u 4U(9.P,9.O,o,c)};k.4x=v(o,c){u 4U(9.N,9.M,o,c)}}}}1z.B.6B=v(a,f){6 d=9.D.1d;L(6 b=0;b<d.G;b++){8(d[b].1J.6o(f)){L(6 e=0;e<d[b].U.G;e++){8(d[b].U[e].6s(a)){u d[b].U[e]}}1X}}u C};1z.B.3s=v(c,a,f){6 b=[];6 e=9.D.1d;L(6 d=0;d<e.G;d++){8(e[d].1J.4x(c,a)>50){b.1Q(e[d]);8(f){1X}}}u b};1z.B.5c=v(b,a,f){6 d=[];6 e=9.D.1d;L(6 c=0;c<e.G;c++){8(e[c].1J.4x(b,a)>0){d.1Q(e[c]);8(f){1X}}}u d};1z.B.3p=v(b,a,f,e){6 d=[];L(6 g=0;g<f.U.G;g++){8(f.U[g].5t(b,a)>50){d.1Q(f.U[g]);8(e){1X}}}u d};1z.B.5M=v(e,d){6 b=9.D.4a.U;L(6 c=0;c<b.G;c++){6 a=b[c];8(1g.1H(a.x-e)<(a.w*9.3q)){u(e-a.x)}}u C};1z.B.5i=v(e,d){6 b=9.D.4a.U;L(6 c=0;c<b.G;c++){6 a=b[c];8(1g.1H(a.x+a.w-e)<(a.w*9.3q)){u(e-a.x-a.w)}}u C};1z.B.5y=v(e,c){6 d=9.D.1d;L(6 b=d.G-1;b>=0;b--){8(1g.1H(b-9.14.3z)%9.3W>0){23}6 a=d[b].1J;8(1g.1H(a.y-e)<(a.h*9.3q)){u(e-a.y)}}u C};1z.B.5P=v(e,c){6 d=9.D.1d;L(6 b=d.G-1;b>=0;b--){8(1g.1H(b-9.14.49)%9.3W>0){23}6 a=d[b].1J;8(1g.1H(a.y+a.h-e)<(a.h*9.3q)){u(e-a.y-a.h)}}u C};1z.B.4w=v(g,f,d){6 a=-1;6 b=J;6 k=9.D.4a.U;L(6 e=0;e<k.G;e++){6 j=k[e];6 c=0;8(f=="1V"){c=j.x}1b{8(f=="26"){c=j.x+j.w;8(c<d){23}}}6 h=1g.1H(g-c);8(a<0||h<a){a=h;b=(c<g)}8(c>=g){1X}}8(b){u-1*a}1b{u a}};1z.B.4f=v(h,g,e){6 a=-1;6 c=J;6 m=9.D.1d;L(6 f=0;f<m.G;f++){6 b=1v 1E(9.14.27+"-([3I]{2})","");6 j=(9.14.15!=C)&&b.3M(9.14.15.T);8(j&&1g.1H(f-(g=="1D"?9.14.3z:9.14.49))%9.3W>0){23}6 l=m[f].1J;6 d=0;8(g=="1D"){d=l.N}1b{8(g=="21"){d=l.M;8(d<e){23}}}6 k=1g.1H(h-d);8(a<0||k<a){a=k;c=(d<h)}8(d>=h){1X}}8(c){u-1*a}1b{u a}};8(1m 5A$=="1o"){5A$=v(a){u Q.1T(a)}}6 31=0;6 3X=1;6 4T=2;6 46=3;6 4R=4;v 47(f,b,e,a,h,d,g,c){8(f>=g||e<=h||b>=c||a<=d){u 31}8(f==h&&e==g&&b==d&&a==c){u 3X}8(f>=h&&e<=g&&b>=d&&a<=c){u 46}8(f<=h&&e>=g&&b<=d&&a>=c){u 4R}u 4T}v 4W(b,a,d,c){8(b>=c||a<=d){u 31}8(b==d&&a==c){u 3X}8(b>=d&&a<=c){u 46}8(b<=d&&a>=c){u 4R}u 4T}v 4U(c,b,e,d){6 a=4W(c,b,e,d);8(a==31){u 0}8(a==3X||a==46){u 5T}u 1g.83(5T*(c<e?(b-e)/(b-c):(d-c)/(b-c)))}E.B.63=v(d,c,b){8(!d){u c?K:J}8(!c){u K}L(6 a=0;a<b.G;a++){8(d[b[a]]!==c[b[a]]){u K}}u J};E.B.3t=v(b,c){6 a=0;2P(b!=C&&b!=c){3A{a+=b.6c;b=b.3y}3S(d){b=C}}u a};E.B.3x=v(b,c){6 a=0;2P(b!=C&&b!=c){3A{a+=b.66;b=b.3y}3S(d){b=C}}u a};E.B.30=v(b){6 a=0;6 e=J;2P(b!=C){3A{6 d=2a(b.1h);d=6a(d)||e?0:d;a+=b.6c-d;e=K;b=b.3y}3S(c){b=C;e=K}}u a};E.B.32=v(b){6 a=0;6 e=J;2P(b!=C){3A{6 d=2a(b.1k);d=6a(d)||e?0:d;a+=b.66-d;e=K;b=b.3y}3S(c){b=C;e=K}}u a};E.B.4K=v(a){u 9.3t(a,9.z)};E.B.4J=v(a){u 9.3x(a,9.z)};E.B.4N=v(a){u a.2T(/^\\s+/,"").2T(/\\s+$/,"")},E.B.4L=v(a,b){u(a.T.G>0&&(a.T==b||1v 1E("(^|\\\\s)"+b+"(\\\\s|$)").3M(a.T)))};E.B.6E=v(a,b){8(!9.4L(a,b)){a.T+=(a.T?" ":"")+b}};E.B.5Y=v(a,b){a.T=9.4N(a.T.2T(1v 1E("(^|\\\\s+)"+b+"(\\\\s+|$)")," "))};E.B.68=v(b,a){8(b.5S){u b.5S[a]}1b{8(1L.6f){u Q.7I.6f(b,C).8c(a)}}u b.F[a]};E.B.69=v(b){6 a=9.68(b,"1G");u(!a||a=="87")};4v.B.89=v(){u(9.2T(/^[\\s\\5Z]+/,"").2T(/[\\s\\5Z]+$/,""))};4v.B.7Q=v(a){u(9.37("^"+a)==a)};4v.B.7V=v(a){u(9.37(a+"$")==a)};8(!3h.B.1p){3h.B.1p=v(b,c){6 a=9.G;6 c=c||0;c=(c<0?a+1g.7T(c):1g.7R(c));L(;c<a;c++){8(c 2Q 9&&9[c]===b){u c}}u-1}}8(1m 1y!="v"){6 1y=v(b,m,h,g){6 i="7S",c="7W"+m,k=b,j=m,e=h,a=g;8(b[i]&&!g){u b[i](m,h,K)}8(!b.29){b.29={}}8(!b.29[m]){b.29[m]=b[c]?{b:b[c]}:{};b[c]=1v 80("e",\'6 r=J,o=9,a=o.29["\'+m+\'"],i;L(i 2Q a){o.4E=a[i];r=o.4E(e||1L.3j)!=K&&r;o.4E=C}u r\');8(m!="5u"){1y(1L,"5u",v(){2q(k,j,e,a)})}}8(!h.2s){h.2s=1y.2s++}b.29[m][h.2s]=h};1y.2s=1;6 2q=v(g,b,c,a){6 e="84";8(g[e]&&!a){u g[e](b,c,K)}8(g.29&&g.29[b]&&c.2s){8a g.29[b][c.2s]}}}v 4Q(a,b){a.8h=K;8(a.56){a.56()}8(b){a.8e=J;8(a.60){a.60()}}};',62,529,'||||||var||if|this|||||||||||||||||||||return|function||||container|block|prototype|null|grid|Blocks|style|length||element|true|false|for|y2|y1|x2|x1|document|with|blocksnap|className|tdcells|bounds||||debugZone||elmX|elmY|diffY|blocks|handle|diffX||elmW|elmH|innerHTML|else|br|bodyrows|snapped_elmX|snapped_elmY|Math|scrollLeft|snapped_elmW|snapped_elmH|scrollTop|clipboard|typeof|handleDragEvent|undefined|indexOf|button|name|dX|cells|dY|new|buttons|elm|addEvent|BlockSnap|getBlockBounds|isResize|handles|top|RegExp|hDiv|position|abs|blockList|firstCell|obj|window|snapToGrid|hClass|mOffY|mOffX|push|rows|newElement|getElementById|zIndex|left|elmBounds|break|block_bounds|mouseY||bottom|mouseX|continue|limitToContainer|new_blocks|right|handle_style|show|_evts|parseInt|maxLeft|debugLevel|maxTop|9999|boundsInGrid|resizeHandleMode|lastCell|hasReallyMoved|snapx|updateResizeHandles|_attributeNames|snapy|oDF|r1|autoscroll_threshold|removeEvent|parentNode|_i|blockToIgnore|isResizing|freeMove|minTop|processed|createElement|display|_y1|r2|isCopy|enabled|keynum|offsetHeight|_x1|_y2|_x2|updateButtons|xSpace|offsetWidth|getGridCoordinates|minLeft|id|while|in|hasMoved|fixedDirection|replace|autoscroll_threshold_hor|appendChild|movingClassName|documentElement|snapped_bounds|minHeight|getXToPage|Intersect_NONE|getYToPage|_formatBlock|autoscroll_step|snapped_dimensions|ResizeHandle_ONMOUSEOVER|match|0px|_createBlock|c1|_getTableContainerId|popupMenu|mouseRowIndex|mouseColIndex|c2|copyBlock|Array|newHandle|event|div|deleteBlock|debugLineZone|minWidth|visibility|getCellsInside|attraction|ySpace|getRowsInside|getXToParent|minCellWidthInIE|addMenuItem|checkIfPositionAllowed|getYToParent|offsetParent|r1_start|try|pasteLabel|getBlockBoundsInGrid|cannotPasteLabel|lastMouseX|scrollLeft_before|removeChild|px|trmbl|hRE|isPositionAllowed|scrollTop_before|test|lastMouseY|clientY|_cloneBlock|snapToGridMove|cutLabel|catch|relMouseX|containerIsGenerated|Block|spanRows|Intersect_ALL|copyLabel|relMouseY||workaroundBlankImage|getElementsByTagName|enableSnapIfTable|which||Intersect_A_IN_B|intersect|isBlock|r2_start|firstRow|ResizeHandle_ONSELECT|moveEnabled|onKeyDown|onKeyUp|findSnappingCellClosestY|autoscroll_step_hor|candidate_y2|getCellAtRC|mouseUp|storeBlockInClipboard|apply|candidate_x1|candidate_x2|candidate_y1|absolute|setAttribute|colIndex2|pasteCommand|getCellAtXY|rowIndex2|String|findSnappingCellClosestX|intersectPartY|mouseDown|visible|tooltip|mouseMove|actionPerformed|isPasteAllowed|_f|allowFreeMove|hidden|DragEvent_DRAGRESIZE|DragEvent_DRAGEND|getY|getX|hasClassName|overContainer|strip|overBlock|resizeHandleDrag|cancelEvent|Intersect_B_IN_A|tBodies|Intersect_PART|intersectPart|release|intersectXY|pasteBlock|snapToGridFormat|deselect||DragEvent_DRAGMOVE|getBoundsInGrid|clearBlocks|navigator|childNodes|preventDefault|insertBefore|getBlocks|border|height|delHandles|getRowsOutside|allowOverlap|tagName|DragEvent_SELECTED|mousemove|mousedown|findSnappingCellAttractingXRight|dontCompute|mouseup|keydown|lastId|auto|borderCollapse|keyup|margin|overflow|success|intersectPartX|unload|isVisible|updateButton|MSIE|findSnappingCellAttractingYTop|isPositionAllowedInGrid|_|formatBlock|pasteBlockInGrid|buttonName|blockCloned|appVersion|resizeEnabled|ResizeHandle_ALWAYS|_container|width|ignoreCallback|backgroundColor|findSnappingCellAttractingXLeft|createBlock|blockCreated|findSnappingCellAttractingYBottom|select|none|currentStyle|100|element_bounds_prev|body|vs|fix|removeClassName|xA0|stopPropagation|op|drag|compare|Drag|DragEvents|offsetTop|DragEvent_BLURRED|getStyle|isStatic|isNaN|tmblr|offsetLeft|populatePopupMenu|snapBlockToGrid|getComputedStyle|callback|snapToGridResize|clientX|pageX|pageY|allowGuidedMove|canCut|canCopy|containsY|allowBlur|keyCode|TD|containsX|DragEvent_DRAGSTART|lastRow|scrollBy|goingLeft|max|goingRight|min|spanEachAtResize|getCellAtPosition|goingDown|goingUp|addClassName|TR|tr|tm|ml|alt|mr|nbsp|unselected|started|selected|ResizeHandle_NEVER|find|jQuery|gif|moved|Button|default|hspace|stopped|resized|vspace|tl|createPopupMenu|error|console|Cut|canPaste|called|TABLE|without|Copy|Paste|Formatting|here|td|paste|at|cannot|dimensions|generated|addCopyPasteEntriesInPopupMenu|DIV|img|getEventText|bm|src|blank|images|relative|borderSpacing|emptyCells|cellpadding|cellspacing|clickedElement|populate|collapse|PopupMenu|bl|Overlap|opera|detected|title|onclick|scrollWidth|getButton|defaultView|input|intersectY|row|intersectYY|alert|addButton|scrollHeight|startsWith|floor|addEventListener|ceil|innerHeight|endsWith|on|srcElement|sendToBack|clientHeight|Function|html|target|round|removeEventListener|createBlockInGrid|mouseout|static|copyBlockInGrid|trim|delete|mouseover|getPropertyValue|reformatAllBlocks|cancelBubble|contains|deleteTableContainer|returnValue|splice|intersectX|getHeightInGrid|getWidthInGrid|splitBlockInColumns|splitBlockInRows|explodeBlock|getCellAtMouse|cell_br|cell_tl|xy|cell_tr|focus|cell_bl|shiftKey'.split('|'),0,{}))
/**
 * Hiflow Suite 5.4.0-21 - uiMin.js
 * Generated on 25/10/2016 18:43:48
 */

sprintfWrapper={init:function(){if(typeof arguments=="undefined"){return null;}
if(arguments.length<1){return null;}
if(typeof arguments[0]!="string"){return null;}
if(typeof RegExp=="undefined"){return null;}
var string=arguments[0];var exp=new RegExp(/(%([%]|(\-)?(\+|\x20)?(0)?(\d+)?(\.(\d)?)?([bcdfosxX])))/g);var matches=new Array();var strings=new Array();var convCount=0;var stringPosStart=0;var stringPosEnd=0;var matchPosEnd=0;var newString='';var match=null;while(match=exp.exec(string)){if(match[9]){convCount+=1;}
stringPosStart=matchPosEnd;stringPosEnd=exp.lastIndex-match[0].length;strings[strings.length]=string.substring(stringPosStart,stringPosEnd);matchPosEnd=exp.lastIndex;matches[matches.length]={match:match[0],left:match[3]?true:false,sign:match[4]||'',pad:match[5]||' ',min:match[6]||0,precision:match[8],code:match[9]||'%',negative:parseInt(arguments[convCount])<0?true:false,argument:String(arguments[convCount])};}
strings[strings.length]=string.substring(matchPosEnd);if(matches.length==0){return string;}
if((arguments.length-1)<convCount){return null;}
var code=null;var match=null;var i=null;for(i=0;i<matches.length;i++){if(matches[i].code=='%'){substitution='%'}
else if(matches[i].code=='b'){matches[i].argument=String(Math.abs(parseInt(matches[i].argument)).toString(2));substitution=sprintfWrapper.convert(matches[i],true);}
else if(matches[i].code=='c'){matches[i].argument=String(String.fromCharCode(parseInt(Math.abs(parseInt(matches[i].argument)))));substitution=sprintfWrapper.convert(matches[i],true);}
else if(matches[i].code=='d'){matches[i].argument=String(Math.abs(parseInt(matches[i].argument)));substitution=sprintfWrapper.convert(matches[i]);}
else if(matches[i].code=='f'){matches[i].argument=String(Math.abs(parseFloat(matches[i].argument)).toFixed(matches[i].precision?matches[i].precision:6));substitution=sprintfWrapper.convert(matches[i]);}
else if(matches[i].code=='o'){matches[i].argument=String(Math.abs(parseInt(matches[i].argument)).toString(8));substitution=sprintfWrapper.convert(matches[i]);}
else if(matches[i].code=='s'){matches[i].argument=matches[i].argument.substring(0,matches[i].precision?matches[i].precision:matches[i].argument.length)
substitution=sprintfWrapper.convert(matches[i],true);}
else if(matches[i].code=='x'){matches[i].argument=String(Math.abs(parseInt(matches[i].argument)).toString(16));substitution=sprintfWrapper.convert(matches[i]);}
else if(matches[i].code=='X'){matches[i].argument=String(Math.abs(parseInt(matches[i].argument)).toString(16));substitution=sprintfWrapper.convert(matches[i]).toUpperCase();}
else{substitution=matches[i].match;}
newString+=strings[i];newString+=substitution;}
newString+=strings[i];return newString;},convert:function(match,nosign){if(nosign){match.sign='';}else{match.sign=match.negative?'-':match.sign;}
var l=match.min-match.argument.length+1-match.sign.length;var pad=new Array(l<0?0:l).join(match.pad);if(!match.left){if(match.pad=="0"||nosign){return match.sign+pad+match.argument;}else{return pad+match.sign+match.argument;}}else{if(match.pad=="0"||nosign){return match.sign+match.argument+pad.replace(/0/g,' ');}else{return match.sign+match.argument+pad;}}}}
sprintf=sprintfWrapper.init;;if(typeof _$=='undefined'){function _$(elementId){return document.getElementById(elementId);}}
$.isTouch='ontouchstart'in window;$.isSmall=$(window).width()<'1400';function tinyMceInit(setup){if(typeof tinymce!='undefined')tinymce.init({theme:"modern",menubar:true,statusbar:false,plugins:["pagebreak","textcolor","table","searchreplace","image"],toolbar1:"undo redo | fontselect fontsizeselect | bold italic underline strikethrough forecolor backcolor | bullist numlist | alignleft aligncenter alignright alignjustify | outdent indent | pagebreak",pagebreak_separator:"<!--TTBREAK-->",setup:function(editor){editor.on('load',function(){});editor.on('blur',function(e){if(typeof ui!='undefined'){$('#'+e.target.id).val(tinymce.activeEditor.getContent());ui.updateModel();}});if(setup)setup.call(this,editor);}});}
var isIE=(!!(window.attachEvent&&navigator.userAgent.indexOf('Opera')===-1))||(/Trident/.test(navigator.userAgent));var UserAgentBrowser={IE:isIE,IE6:isIE&&(navigator.appVersion.indexOf("MSIE 6")!=-1||navigator.appVersion.indexOf("MSIE 5")!=-1||navigator.appVersion.indexOf("MSIE 4")!=-1),IE7:isIE&&navigator.appVersion.indexOf("MSIE 7")!=-1,IE8:isIE&&navigator.appVersion.indexOf("MSIE 8")!=-1,IE9:isIE&&navigator.appVersion.indexOf("MSIE 9")!=-1,Opera:navigator.userAgent.indexOf('Opera')>-1,WebKit:navigator.userAgent.indexOf('AppleWebKit/')>-1,Gecko:navigator.userAgent.indexOf('Gecko')>-1&&navigator.userAgent.indexOf('KHTML')===-1,MobileSafari:!!navigator.userAgent.match(/Apple.*Mobile.*Safari/)};function urlparam(name,href)
{href=href||window.location.href;name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(href);return results==null?"":decodeURIComponent(results[1]);};function merge()
{var merged={};for(var i=0;i<arguments.length;i++)if(arguments[i])for(var p in arguments[i])if(arguments[i].hasOwnProperty(p))merged[p]=arguments[i][p];return merged;};var MD5=function(s){function L(k,d){return(k<<d)|(k>>>(32-d))}function K(G,k){var I,d,F,H,x;F=(G&2147483648);H=(k&2147483648);I=(G&1073741824);d=(k&1073741824);x=(G&1073741823)+(k&1073741823);if(I&d){return(x^2147483648^F^H)}if(I|d){if(x&1073741824){return(x^3221225472^F^H)}else{return(x^1073741824^F^H)}}else{return(x^F^H)}}function r(d,F,k){return(d&F)|((~d)&k)}function q(d,F,k){return(d&k)|(F&(~k))}function p(d,F,k){return(d^F^k)}function n(d,F,k){return(F^(d|(~k)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(G){var Z;var F=G.length;var x=F+8;var k=(x-(x%64))/64;var I=(k+1)*16;var aa=Array(I-1);var d=0;var H=0;while(H<F){Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=(aa[Z]|(G.charCodeAt(H)<<d));H++}Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=aa[Z]|(128<<d);aa[I-2]=F<<3;aa[I-1]=F>>>29;return aa}function B(x){var k="",F="",G,d;for(d=0;d<=3;d++){G=(x>>>(d*8))&255;F="0"+G.toString(16);k=k+F.substr(F.length-2,2)}return k}function J(k){k=k.replace(/rn/g,"n");var d="";for(var F=0;F<k.length;F++){var x=k.charCodeAt(F);if(x<128){d+=String.fromCharCode(x)}else{if((x>127)&&(x<2048)){d+=String.fromCharCode((x>>6)|192);d+=String.fromCharCode((x&63)|128)}else{d+=String.fromCharCode((x>>12)|224);d+=String.fromCharCode(((x>>6)&63)|128);d+=String.fromCharCode((x&63)|128)}}}return d}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=J(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}var i=B(Y)+B(X)+B(W)+B(V);return i.toLowerCase()};function get_gravatar(email,size){var size=size||48;return'https://www.gravatar.com/avatar/'+MD5(email)+'.jpg?s='+size+'&d=https%3A%2F%2Fwimm.hiflowsuite.com%2Fimages%2Fnobody.png';}
function openPopup(url){var w=640;var h=480;var left=parseInt((screen.availWidth/2)-(w/2));var top=parseInt((screen.availHeight/2)-(h/2));var windowFeatures='width='+w+',height='+h+',dependent=yes,directories=no,location=no,menubar=no,toolbar=no,status=no,scrollbars=yes,resizable=yes,left='+left+',top='+top+"screenX="+left+",screenY="+top;hw=window.open(url,'details',windowFeatures);hw.focus();}
function showDialog(title,message,type){jalert(message,type=="error",title,500);}
function jalert(message,error,title,w,h)
{var aDiv=$("<div class='jalert'>").html("<center>"+translate(message)+"<center>").css('padding-top','10px').dialog({width:w||350,modal:!jQuery.browser.msie,autoOpen:true,buttons:{"OK":function(){$(this).dialog("close");}},title:title||translate(translate(error?"Error":"Information"))}).dialog('moveToTop');if(typeof blocks=='object'&&blocks!=null)$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));if(typeof h!='undefined'&&h>0)aDiv.css('max-height',h+'px');}
function jconfirm(message,title,oncancel,onok,canceltext,oktext,w,h)
{var buttons={};buttons[canceltext||translate("Cancel")]=function(){$(this).dialog("close");if(oncancel)oncancel();};buttons[oktext||translate("OK")]=function(){$(this).dialog("close");if(onok)onok();};$("<div>").html("<center>"+translate(message)+"<center>").dialog({width:w||350,modal:true,autoOpen:true,buttons:buttons,title:translate(title||"Confirmation")}).dialog('moveToTop');if(typeof blocks=='object'&&blocks!=null)$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));}
function jprompt(message,title,defval,oncancel,onok,canceltext,oktext,w,h)
{var buttons={};buttons[canceltext||translate("Cancel")]=function(){$(this).dialog("close");if(oncancel)oncancel();};buttons[oktext||translate("OK")]=function(){$(this).dialog("close");if(onok)onok($(this).find('input').val());};$("<div>").html("<center>"+translate(message)+" : <p><input type='text' style='margin-top: 10px;width:"+((w||350)-30)+"px'/></p><center>").dialog({width:w||400,modal:true,autoOpen:true,buttons:buttons,open:function(){$(this).find('input').val(defval).select();},title:translate(title||"Question")}).dialog('moveToTop');if(typeof blocks=='object'&&blocks!=null)$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));}
function jinfo(message,title,w,h){jalert(message,false,title,w,h);}
function jerror(message,title,w,h){jalert(message,true,title,w,h);}
function get_performance_class(performance,blue_if_null)
{if(isNaN(performance)||!isFinite(performance))return blue_if_null?'blue':'';if(performance<50)return'red warning';if(performance<80)return'red';if(performance<95)return'orange';if(performance<105)return'blue';return'green';}
function getFloat(str)
{return parseFloat(str.replace(',','.').replace(/[^\.0-9]/g,''));}
function isAllowed(resource,privilege)
{if(typeof rights[resource]=='undefined')return false;if(typeof rights[resource][privilege]=='undefined')return false;return rights[resource][privilege];}
function isEnabled(resource,privilege)
{if(typeof rights[resource]=='undefined')return false;if(typeof rights[resource][privilege]=='undefined')return false;return true;}
function getInfoHeaderRenderer(message,title,w,tooltip)
{if(typeof InfoHeaderRenderer=='undefined')
{InfoHeaderRenderer=function(message,title,w,tooltip){this.message=message;this.title=title;this.w=w;this.tooltip=tooltip;};InfoHeaderRenderer.prototype=new CellRenderer();InfoHeaderRenderer.prototype.render=function(cell,value)
{if(value){if(!this.editablegrid.enableSort||this.column.datatype=="html")CellRenderer.prototype.render.call(this,cell,value);var link=document.createElement("a");link.message=this.message;link.boxtitle=this.title;link.boxw=this.w;$(link).append("<span class='fa fa-info-circle'/>").css('cursor','pointer');if(this.tooltip)$(link).find('span').attr('title',this.message);else link.onclick=function(){jalert(this.message,false,this.boxtitle,this.boxw);};cell.appendChild(document.createTextNode("\u00a0\u00a0"));cell.appendChild(link);}};}
return new InfoHeaderRenderer(message,title,w,tooltip);}
function truncate_nolink(trunc,len)
{return trunc.length>(len+3)?trunc.substring(0,len)+"...":trunc;}
function truncate(trunc,len)
{if(!trunc)return'';var original=trunc;if(trunc.length>(len+3)){trunc=trunc.substring(0,len);trunc=trunc.replace(/\w+$/,'');trunc+='<a href="#" onclick="this.parentNode.innerHTML=unescape(\''+escape(original)+'\');return false;">...<\/a>';}
return trunc;}
function truncateCell(cell,len)
{var str=$(cell).html();if(str.length>(len+3)){var truncated=str.substring(0,len);truncated=truncated.replace(/[\w&;]+$/,'');$(cell).attr('original',str).attr('truncated',truncated).attr('expanded','1');var toggle=function(){if($(cell).attr('expanded'))$(cell).html($(cell).attr('truncated')).removeAttr('expanded').append($('<a>').html('...&nbsp;&raquo;').css('cursor','pointer').click(toggle));else $(cell).html($(cell).attr('original')).attr('expanded','1').append($('<a>').html('&nbsp;&laquo;').css('cursor','pointer').click(toggle));};toggle();}}
function strip_header_footer(html)
{return html.replace(/<head(?:.|\s)*?head>/g,"").replace(/<!-- START HEADER(?:.|\s)*?END HEADER -->/g,"").replace(/<!-- START FOOTER(?:.|\s)*?END FOOTER -->/g,"");}
function toHTML(text)
{if(text.match(/.*<html.*/))return strip_header_footer(text);return text.replace(/\n/g,"<br/>");}
function onAjaxError(XMLHttpRequest,textStatus,exception)
{if(typeof hideWait!='undefined')hideWait();var errortext=toHTML(XMLHttpRequest.responseText);if(errortext.length>0){if(applicationEnv!='production'&&typeof exception!="undefined"){errortext="<b>Response body</b><br/>"+errortext;errortext+="<br/><br/><b>Exception message</b><br/>"+(exception.message?toHTML(exception.message):exception);errortext+="<br/><br/><b>Stack Trace</b><br/>"+_getStackTrace(exception);}
if(errortext.length>4096)errortext=errortext.substr(0,4096)+"...";var logmein=translate('Log me in');if(errortext.match(/.*(must be logged|allowed for user|devez être connecté|autorisé pour l'utilisateur).*/))errortext+="<br/><b><a href='"+baseUrl+'/login?url='+encodeURIComponent('/ui/'+Backbone.history.fragment)+"'>"+logmein+"</a></b>";jerror(errortext,translate("Error"),750,480);}}
function _ajax(action,parameter,sync)
{return $.ajax({url:baseUrl+'/ajax/'+action,type:'POST',contentType:'application/json; charset=UTF-8',data:$.toJSON(parameter),dataType:"json",error:onAjaxError,async:(sync?false:true)}).then(function(response){if(response&&response.globals){for(var name in response.globals)window[name]=response.globals[name];if(typeof ui!='undefined'&&ui)try{ui.set(response.globals);}catch(ex){}
if(typeof menu!='undefined'&&menu){menu.set(response.globals);menu.hilite();}
if(typeof menutop!='undefined'&&menutop){menutop.set(response.globals);menutop.hilite();}}
if(response&&response._error){$("<div>").ractive({path:'ajax_error.ractive',data:response}).dialog({width:500,title:translate("Error"),buttons:{"OK":function(){$(this).dialog("close");}}}).dialog('moveToTop');if(typeof blocks=='object'&&blocks!=null)$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));hideWait();return $.Deferred().reject();}
return response;});}
function _updatecell(grid,controller,rowIndex,columnIndex,newValue)
{return _ajax(controller+'/updatecell',{id:grid.getRowId(rowIndex),newvalue:grid.getColumnType(columnIndex)=="boolean"?(newValue?1:0):newValue,colname:grid.getColumnName(columnIndex),coltype:grid.getColumnType(columnIndex)});}
function ajax(relativeUrl,parameter,onSuccess,dataType,method,afterError)
{return $.ajax({url:baseUrl+relativeUrl,type:method||'POST',dataType:dataType||"html",data:parameter?{request:$.toJSON(parameter),_is_ajax:true}:{_is_ajax:true},success:onSuccess||null,error:function(XMLHttpRequest,textStatus,exception){onAjaxError(XMLHttpRequest,textStatus,exception);if(afterError)afterError();},async:true});}
function syncAjax(relativeUrl,parameter,onSuccess,dataType,method)
{$.ajax({url:baseUrl+relativeUrl,type:method||'POST',dataType:dataType||"html",data:parameter?{request:$.toJSON(parameter),_is_ajax:true}:null,success:onSuccess,error:onAjaxError,async:false});}
function reload(divid,relativeUrl,parameter)
{_$(divid).innerHTML="<center>"+img('wait')+"</center>";ajax(relativeUrl,parameter,function(html){_$(divid).innerHTML=html;});}
function updateCellValue(editableGrid,action,rowIndex,columnIndex,oldValue,newValue,row,onResponse,dontHighlight)
{if(jQuery.browser.msie&&typeof newValue=='number'&&isNaN(newValue))newValue=null;ajax(action,{id:editableGrid.getRowId(rowIndex),newvalue:editableGrid.getColumnType(columnIndex)=="boolean"?(newValue?1:0):newValue,colname:editableGrid.getColumnName(columnIndex),coltype:editableGrid.getColumnType(columnIndex)},function(response)
{var success=onResponse?onResponse(response):(response=="ok"||!isNaN(parseInt(response)));if(!success)editableGrid.setValueAt(rowIndex,columnIndex,oldValue);if(!dontHighlight)highlightRow(row,success?"ok":"error");});}
function getYToParent(oElement,parent)
{var iReturnValue=0;while(oElement!=null&&oElement!=parent){try
{iReturnValue+=oElement.offsetTop;oElement=oElement.offsetParent;}
catch(err){oElement=null;}}
return iReturnValue;}
function getXToParent(oElement,parent)
{var iReturnValue=0;while(oElement!=null&&oElement!=parent){try
{iReturnValue+=oElement.offsetLeft;oElement=oElement.offsetParent;}
catch(err){oElement=null;}}
return iReturnValue;}
function randomColor()
{return{red:Math.floor(Math.random()*255),green:Math.floor(Math.random()*255),blue:Math.floor(Math.random()*255)};}
function getFrontColor(rgbColor,threshold)
{var a=1-(0.299*rgbColor.red+0.587*rgbColor.green+0.114*rgbColor.blue)/255;return a>=(threshold||0.35)?toRGB('ffffff'):toRGB('000000');}
function dimColor(rgbColor,alpha)
{if(typeof alpha=='undefined')alpha=0.3;return combineColors(rgbColor,{red:255,green:255,blue:255},alpha);}
function toRGB(color)
{if(typeof color=='undefined'){return{red:0,green:0,blue:0};}
rgbcolor={red:parseInt(color.substr(0,2),16),green:parseInt(color.substr(2,2),16),blue:parseInt(color.substr(4,2),16)};return rgbcolor;}
function convertToGrayScale(color)
{var gray=Math.round(color.red*0.3+color.green*0.59+color.blue*0.11);return{red:gray,green:gray,blue:gray};}
function combineColors(color1,color2,alpha)
{var r=Math.round(alpha*color1.red+(1-alpha)*color2.red);var g=Math.round(alpha*color1.green+(1-alpha)*color2.green);var b=Math.round(alpha*color1.blue+(1-alpha)*color2.blue);return{red:r,green:g,blue:b};}
function rgb2hex(rgb,alpha){if(/^#[0-9A-F]{6}$/i.test(rgb))return rgb;rgb=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function hex(x){return("0"+parseInt(x).toString(16)).slice(-2);}
return"#"+hex(alpha*rgb[1]+(1-alpha)*255)+hex(alpha*rgb[2]+(1-alpha)*255)+hex(alpha*rgb[3]+(1-alpha)*255);}
function cssColor(color,alpha){if(typeof alpha=='undefined')alpha=1.0;if($.browser.msie&&($.browser.version.substr(0,1)=="7"||$.browser.version.substr(0,1)=="8"))return'rgb('+color.red+','+color.green+','+color.blue+')';return'rgba('+color.red+','+color.green+','+color.blue+','+alpha+')';}
function today(){var today=new Date();return(today.getYear()+1900)+'-'+(today.getMonth()+1)+"-"+today.getDate();}
function getDate(timestamp,tz_offset){var date=new Date();date.setTime((timestamp*1000)+((tz_offset||0)*1000));return date;}
function getUTCTime(date){return pad(''+date.getUTCDate(),2,'0')+'/'+pad(''+(date.getUTCMonth()+1),2,'0')+'@'+getUTCTimeInDay(date)+' UTC';}
function getUTCTimeInDay(date){return date.format(locale.time_format_php,true);}
function amount_format(amount,precision)
{value=number_format(parseFloat(amount),precision||locale.amount_decimals,locale.decimal_point,locale.thousands_separator);return locale.currency_before_amount==1?locale.currency_symbol+' '+value:value+' '+locale.currency_symbol;}
var STR_PAD_LEFT=1;var STR_PAD_RIGHT=2;var STR_PAD_BOTH=3;function pad(str,len,pad,dir){if(typeof(len)=="undefined"){var len=0;}
if(typeof(pad)=="undefined"){var pad=' ';}
if(typeof(dir)=="undefined"){var dir=STR_PAD_LEFT;}
if(len+1>=str.length){switch(dir){case STR_PAD_LEFT:str=Array(len+1-str.length).join(pad)+str;break;case STR_PAD_BOTH:var right=Math.ceil((padlen=len-str.length)/2);var left=padlen-right;str=Array(left+1).join(pad)+str+Array(right+1).join(pad);break;default:str=str+Array(len+1-str.length).join(pad);break;}}
return str;}
function getDisplayTime(seconds){var hours=Math.floor(seconds/3600);var minutes=(seconds%3600)/60;return number_format(hours,0)+'h'+pad(''+Math.round(minutes),2,"0",STR_PAD_LEFT);}
Array.prototype.inArray=function(value)
{for(var i=0;i<this.length;i++)if(this[i]==value)return true;return false;};Array.prototype.remove=function(from,to){var rest=this.slice((to||from)+1||this.length);this.length=from<0?this.length+from:from;return this.push.apply(this,rest);};function camel_case(str,firstUpper){return str.camelCase(firstUpper);};String.prototype.camelCase=function(firstUpper){var camel=this.toLowerCase().replace(/(?:[-_])(.)/g,function(match,group1){return group1.toUpperCase();});return firstUpper?camel.charAt(0).toUpperCase()+camel.slice(1):camel;};String.prototype.replaceAt=function(indexAt,replacement){return this.substr(0,indexAt)+replacement+this.substr(indexAt+replacement.length);};jQuery.fn.containsPoint=function(x,y,tolerance)
{var offset=$(this).offset();return offset.left<=x&&offset.top<=y&&((offset.left+$(this).width())>=x)&&((offset.top+$(this).height()+(tolerance?tolerance:0))>=y);};jQuery.fn.containsX=function(x)
{var offset=$(this).offset();return offset.left<=x&&((offset.left+$(this).width())>=x);};jQuery.fn.containsY=function(y)
{var offset=$(this).offset();return offset.top<=y&&((offset.top+$(this).height())>=y);};jQuery.fn.firstHalfContainsPoint=function(x,y)
{var offset=$(this).offset();return offset.left<=x&&offset.top<=y&&((offset.left+$(this).width())>=x)&&((offset.top+$(this).height()/2)>=y);};jQuery.fn.secondHalfContainsPoint=function(x,y,tolerance)
{var offset=$(this).offset();return offset.left<=x&&(offset.top+$(this).height()/2)<=y&&((offset.left+$(this).width())>=x)&&((offset.top+$(this).height()+tolerance)>=y);};jQuery.fn.highlight=function(after)
{$(this).css("opacity",0.25).fadeTo(400,1,function(){$(this).css("opacity",'');if(after)after(this);});};function highlightRow(row,style)
{if($(row).find("td").css('position')=='relative'||$(row).find("td:visible").css('display')=='block')return;$(row).find("td:visible").each(function(){$(this).attr('background-color-backup',this.style.backgroundColor);});$(row).find("td:visible").css("background-color",style=="error"?"#e5afaf":(style=="warning"?"#ffcc00":"#8dc70a"));$(row).find("td:visible").highlight(function(element){$(element).css("background-color",$(element).attr('background-color-backup'));$(element).removeAttr('background-color-backup');});}
function changeBlock(fromId,toId)
{if(!fromId)$('#'+toId).show();else if(!toId)$('#'+fromId).hide();else $('#'+fromId).hide('fast',function(){$('#'+toId).show();});}
function trim(strtotrim)
{if(!strtotrim)return'';return strtotrim.replace(/^\s+/g,'').replace(/\s+$/g,'');}
function roundNumber(rnum,ndec)
{var rlength=ndec;if(rnum>8191&&rnum<10485){rnum=rnum-5000;var newnumber=Math.round(rnum*Math.pow(10,rlength))/Math.pow(10,rlength);newnumber=newnumber+5000;}else{var newnumber=Math.round(rnum*Math.pow(10,rlength))/Math.pow(10,rlength);}
return newnumber;}
function getStackTrace()
{try{i.dont.exist+=0;}
catch(e){return _getStackTrace(e);}}
function _getStackTrace(e)
{var isCallstackPopulated=false;var callstack=[];if(e.stack){var lines=e.stack.split("\n");for(var i=0,len=lines.length;i<len;i++){if(lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)){callstack.push(lines[i]);}}
callstack.shift();isCallstackPopulated=true;}
else if(window.opera&&e.message){var lines=e.message.split("\n");for(var i=0,len=lines.length;i<len;i++){if(lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)){var entry=lines[i];if(lines[i+1]){entry+=" at "+lines[++i];callstack.push(entry);}}
callstack.shift();isCallstackPopulated=true;}}
if(!isCallstackPopulated){var currentFunction=arguments.callee.caller;while(currentFunction){var fn=currentFunction.toString();var fname=fn.substring(fn.indexOf("function")+8,fn.indexOf("("))||"anonymous";callstack.push(fname);currentFunction=currentFunction.caller;}}
return callstack.join("\n");}
function helpbox(id){if(typeof helpboxes=='undefined')return"helpboxes not set!";if(typeof helpboxes[id]=='undefined')return true||applicationEnv=='production'?'':"<b>["+id+"]</b>"+helpboxes['error'];return helpboxes[id];}
function translate(str,escape){var ret=typeof translations=='undefined'||typeof translations[str]=='undefined'?str:translations[str];if(escape==='html'){ret=ret.replace(/\'/g,"&#39;");ret=ret.replace(/"/g,"&quot;");}
else if(escape===true){ret=ret.replace(/\'/g,"\\'");}
return ret;}
function imgpath(key){if(key&&key.startsWith("fa-"))return key;if(typeof icons=='undefined'||typeof icons[key]=='undefined')return baseUrl+'/images/key_notfound.png';if(icons[key].startsWith("fa-"))return icons[key];return skinUrl+'/'+icons[key]+(typeof versionParam=='undefined'?'':versionParam);}
function img(key,alt,title,style){if(typeof title=='undefined')title=alt;if(typeof alt=='undefined')alt=key;if(!alt)alt='';if(!title)title='';var path=imgpath(key);if(path.startsWith("fa-"))return"<i class='fa "+path+"'"+(title?" title=\""+translate(title,'html')+"\"":'')+"></i>";return"<img "+(style?"style=\""+style+"\"":"")+"src=\""+path+"\" alt='"+translate(alt,'html')+"' title='"+translate(title,'html')+"'/>";}
String.prototype.startsWith=function(str){return(this.match("^"+str)==str);};String.prototype.endsWith=function(str){return(this.match(str+"$")==str);};String.prototype.ucfirst=function(){return this.toLocaleLowerCase().replace(/(^|\s)([a-z])/g,function(m,p1,p2){return p1+p2.toLocaleUpperCase();});};var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function base64_decode(input)
{var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64)output=output+String.fromCharCode(chr2);if(enc4!=64)output=output+String.fromCharCode(chr3);}
return output;}
function getCookie(check_name)
{var a_all_cookies=document.cookie.split(';');var a_temp_cookie='';var cookie_name='';for(i=0;i<a_all_cookies.length;i++){a_temp_cookie=a_all_cookies[i].split('=');cookie_name=a_temp_cookie[0].replace(/^\s+|\s+$/g,'');if(cookie_name==check_name)return a_temp_cookie.length<=1?'':unescape(a_temp_cookie[1].replace(/^\s+|\s+$/g,''));}
return null;}
function placeholderSupported(){return typeof document.createElement('input').placeholder!='undefined';}
function setHelperText_aux(input,text,clear)
{if(!placeholderSupported()){input.style.color=clear?'':'#BBBBBB';input.value=clear?'':text;input.setAttribute('ignorevalue',clear?'0':'1');}}
function setRealValue(inputId)
{if(_$(inputId).getAttribute('ignorevalue')=='1')_$(inputId).value='';}
function getRealValue(inputId)
{return _$(inputId)===null?'':_$(inputId).getAttribute('ignorevalue')=='1'?'':$('#'+inputId).val();}
function setHelperText(inputId,text)
{if(placeholderSupported())$("#"+inputId).attr('placeholder',text);else{var input=_$(inputId);input.onfocus=function(){if(this.getAttribute('ignorevalue')=='1')setHelperText_aux(this,text,true);};input.onblur=function(){if(this.value=='')setHelperText_aux(this,text,false);};if(!input.value||input.value.length==0)
setHelperText_aux(input,text,false);}}
function strip_tags(input,allowed)
{if(!input)return"";allowed=(((allowed||'')+'').toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join('');var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return input.replace(commentsAndPhpTags,'').replace(tags,function($0,$1){return allowed.indexOf('<'+$1.toLowerCase()+'>')>-1?$0:'';});}
function window_height()
{var wHeight=window.innerHeight;if(document.documentElement&&document.documentElement.clientHeight)wHeight=document.documentElement.clientHeight;else if(document.body&&document.body.clientHeight)wHeight=document.body.clientHeight;return wHeight;}
function window_width()
{var wWidth=window.innerWidth;if(document.documentElement&&document.documentElement.clientWidth)wWidth=document.documentElement.clientWidth;else if(document.body&&document.body.clientWidth)wWidth=document.body.clientWidth;return wWidth;}
function hasvscrollbar(elem){return(elem.clientHeight<elem.scrollHeight);}
function hashscrollbar(elem){return(elem.clientWidth<elem.scrollWidth);}
function alternate(containerid)
{$("#"+containerid+" tbody tr").removeClass('alt').removeClass('last');$("#"+containerid+" tbody tr:odd").addClass('alt');if(jQuery.browser.msie)$("#"+containerid+" tbody tr:even").addClass('odd');$("#"+containerid+" tbody tr:last-child").addClass('last');}
function selectText(objId)
{deselectText();if(document.selection){var range=document.body.createTextRange();range.moveToElementText(document.getElementById(objId));range.select();}
else if(window.getSelection){var range=document.createRange();range.selectNode(document.getElementById(objId));window.getSelection().addRange(range);}}
function deselectText()
{if(document.selection)document.selection.empty();else if(window.getSelection)window.getSelection().removeAllRanges();}
function clear_form_elements(form){$(form).find(':input').each(function(){switch(this.type){case'password':case'select-multiple':case'select-one':case'text':case'textarea':$(this).val('');break;case'checkbox':case'radio':this.checked=false;}});}
Date.prototype.format=function(format,isUTC){var returnStr='';var replace=isUTC?Date.replaceCharsUTC:Date.replaceCharsLocal;for(var i=0;i<format.length;i++){var curChar=format.charAt(i);if(i-1>=0&&format.charAt(i-1)=="\\"){returnStr+=curChar;}
else if(replace[curChar]){returnStr+=replace[curChar].call(this);}else if(curChar!="\\"){returnStr+=curChar;}}
return returnStr;};Date.replaceCharsUTC={shortMonths:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],longMonths:['January','February','March','April','May','June','July','August','September','October','November','December'],shortDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],longDays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],d:function(){return(this.getUTCDate()<10?'0':'')+this.getUTCDate();},D:function(){return Date.replaceChars.shortDays[this.getDay()];},j:function(){return this.getUTCDate();},l:function(){return Date.replaceChars.longDays[this.getDay()];},N:function(){return this.getDay()+1;},S:function(){return(this.getDate()%10==1&&this.getDate()!=11?'st':(this.getDate()%10==2&&this.getDate()!=12?'nd':(this.getDate()%10==3&&this.getDate()!=13?'rd':'th')));},w:function(){return this.getDay();},z:function(){var d=new Date(this.getFullYear(),0,1);return Math.ceil((this-d)/86400000);},W:function(){var d=new Date(this.getFullYear(),0,1);return Math.ceil((((this-d)/86400000)+d.getDay()+1)/7);},F:function(){return Date.replaceChars.longMonths[this.getMonth()];},m:function(){return(this.getUTCMonth()<9?'0':'')+(this.getUTCMonth()+1);},M:function(){return Date.replaceChars.shortMonths[this.getUTCMonth()];},n:function(){return this.getUTCMonth()+1;},t:function(){var d=new Date();return new Date(d.getFullYear(),d.getMonth(),0).getDate();},L:function(){var year=this.getFullYear();return(year%400==0||(year%100!=0&&year%4==0));},o:function(){var d=new Date(this.valueOf());d.setDate(d.getDate()-((this.getDay()+6)%7)+3);return d.getFullYear();},Y:function(){return this.getUTCFullYear();},y:function(){return(''+this.getUTCFullYear()).substr(2);},a:function(){return this.getUTCHours()<12?'am':'pm';},A:function(){return this.getUTCHours()<12?'AM':'PM';},B:function(){return Math.floor((((this.getUTCHours()+1)%24)+this.getUTCMinutes()/60+this.getUTCSeconds()/3600)*1000/24);},g:function(){return this.getUTCHours()%12||12;},G:function(){return this.getUTCHours();},h:function(){return((this.getUTCHours()%12||12)<10?'0':'')+(this.getUTCHours()%12||12);},H:function(){return(this.getUTCHours()<10?'0':'')+this.getUTCHours();},i:function(){return(this.getUTCMinutes()<10?'0':'')+this.getUTCMinutes();},s:function(){return(this.getSeconds()<10?'0':'')+this.getSeconds();},u:function(){var m=this.getMilliseconds();return(m<10?'00':(m<100?'0':''))+m;},e:function(){return"Not Yet Supported";},I:function(){return"Not Yet Supported";},O:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+'00';},P:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+':00';},T:function(){var m=this.getMonth();this.setMonth(0);var result=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,'$1');this.setMonth(m);return result;},Z:function(){return-this.getTimezoneOffset()*60;},c:function(){return this.format("Y-m-d\\TH:i:sP",true);},r:function(){return this.toString();},U:function(){return this.getTime()/1000;}};Date.replaceCharsLocal={shortMonths:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],longMonths:['January','February','March','April','May','June','July','August','September','October','November','December'],shortDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],longDays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],d:function(){return(this.getDate()<10?'0':'')+this.getDate();},D:function(){return Date.replaceChars.shortDays[this.getDay()];},j:function(){return this.getDate();},l:function(){return Date.replaceChars.longDays[this.getDay()];},N:function(){return this.getDay()+1;},S:function(){return(this.getDate()%10==1&&this.getDate()!=11?'st':(this.getDate()%10==2&&this.getDate()!=12?'nd':(this.getDate()%10==3&&this.getDate()!=13?'rd':'th')));},w:function(){return this.getDay();},z:function(){var d=new Date(this.getFullYear(),0,1);return Math.ceil((this-d)/86400000);},W:function(){var d=new Date(this.getFullYear(),0,1);return Math.ceil((((this-d)/86400000)+d.getDay()+1)/7);},F:function(){return Date.replaceChars.longMonths[this.getMonth()];},m:function(){return(this.getMonth()<9?'0':'')+(this.getMonth()+1);},M:function(){return Date.replaceChars.shortMonths[this.getMonth()];},n:function(){return this.getMonth()+1;},t:function(){var d=new Date();return new Date(d.getFullYear(),d.getMonth(),0).getDate();},L:function(){var year=this.getFullYear();return(year%400==0||(year%100!=0&&year%4==0));},o:function(){var d=new Date(this.valueOf());d.setDate(d.getDate()-((this.getDay()+6)%7)+3);return d.getFullYear();},Y:function(){return this.getFullYear();},y:function(){return(''+this.getFullYear()).substr(2);},a:function(){return this.getHours()<12?'am':'pm';},A:function(){return this.getHours()<12?'AM':'PM';},B:function(){return Math.floor((((this.getHours()+1)%24)+this.getMinutes()/60+this.getSeconds()/3600)*1000/24);},g:function(){return this.getHours()%12||12;},G:function(){return this.getHours();},h:function(){return((this.getHours()%12||12)<10?'0':'')+(this.getHours()%12||12);},H:function(){return(this.getHours()<10?'0':'')+this.getHours();},i:function(){return(this.getMinutes()<10?'0':'')+this.getMinutes();},s:function(){return(this.getSeconds()<10?'0':'')+this.getSeconds();},u:function(){var m=this.getMilliseconds();return(m<10?'00':(m<100?'0':''))+m;},e:function(){return"Not Yet Supported";},I:function(){return"Not Yet Supported";},O:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+'00';},P:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+':00';},T:function(){var m=this.getMonth();this.setMonth(0);var result=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,'$1');this.setMonth(m);return result;},Z:function(){return-this.getTimezoneOffset()*60;},c:function(){return this.format("Y-m-d\\TH:i:sP",false);},r:function(){return this.toString();},U:function(){return this.getTime()/1000;}};if($.blockUI)$.blockUI.defaults.applyPlatformOpacityRules=false;__in_wait__=false;function showWait(message,size)
{message=message||translate('Loading')+'...';if(true){if(__in_wait__){$(".blockUI.blockMsg p").html(message);return true;}
else __in_wait__=true;size=size||200;spinner=new Spinner({lines:10,length:size/10,width:size/16.67,radius:size/6.67,trail:32,speed:1.0,shadow:true,color:'#fff'}).spin();var content=$("<div>");if(message)content.append("<p style='color:#fff;font-size:12px'>"+message+"</p>");content.append($(spinner.el));$.blockUI({message:content,baseZ:(typeof blocks=='object'&&blocks!=null)?1000+blocks.zIndex:1000,css:{border:'none',padding:'5px',top:($(window).height()-size)/2+'px',left:($(window).width()-size)/2+'px',height:size+'px',width:size+'px',backgroundColor:'#000',borderRadius:'10px','-webkit-border-radius':'10px','-moz-border-radius':'10px',opacity:.7,color:'#fff'}});$(spinner.el).css({left:(size/2)+'px',top:((size/2)+(message?-6:0))+'px'});}
else{$('#wait .banner').html(message);$('#wait').show();$.blockUI({message:'',overlayCSS:{opacity:0}});}}
function hideWait()
{$('#wait').hide().find('.first').remove();$('body').removeClass('wait');if(typeof spinner!='undefined')spinner.stop();if($.unblockUI)$.unblockUI();__in_wait__=false;}
function getScrollBarWidth()
{var wide_scroll_html='<div id="wide_scroll_div_one" style="width:50px;height:50px;overflow-y:scroll;position:absolute;top:-200px;left:-200px;"><div id="wide_scroll_div_two" style="height:100px;width:100%"></div></div>';$("body").append(wide_scroll_html);var scroll_w1=$("#wide_scroll_div_one").width();var scroll_w2=$("#wide_scroll_div_two").innerWidth();$("#wide_scroll_div_one").remove();return scroll_w1-scroll_w2;}
function getFileExtension(filename){var ext=(/[.]/.exec(filename))?/[^.]+$/.exec(filename):undefined;if(typeof ext[0]=='string')ext[0]=ext[0].toLowerCase();return ext;}
function updatePaginator(grid,divId,slidingWindow,showTableEvenIfEmpty)
{var paginator=$("#"+divId).empty();var nbPages=grid.getPageCount();var interval=grid.getSlidingPageInterval(slidingWindow||15);if(interval!=null){var pages=grid.getPagesInInterval(interval,function(pageIndex,isCurrent){if(isCurrent)return"<span class='current_page'>"+(pageIndex+1)+"</span>";return $("<a>").css("cursor","pointer").html(pageIndex+1).click(function(event){grid.setPageIndex(parseInt($(this).html())-1);});});var link=$("<a>").css('text-decoration','none').html(img('gofirst')+"&nbsp;");if(!grid.canGoBack())link.css({opacity:0.4,filter:"alpha(opacity=40)"});else link.css("cursor","pointer").click(function(event){grid.firstPage();});paginator.append(link);link=$("<a>").css('text-decoration','none').html(img('goprevious')+"&nbsp;");if(!grid.canGoBack())link.css({opacity:0.4,filter:"alpha(opacity=40)"});else link.css("cursor","pointer").click(function(event){grid.prevPage();});paginator.append(link);for(p=0;p<pages.length;p++)paginator.append(" ").append(pages[p]).append(" ").append(p<pages.length-1?" ":"&nbsp;");link=$("<a>").css('text-decoration','none').html(img('gonext')+"&nbsp;");if(!grid.canGoForward())link.css({opacity:0.4,filter:"alpha(opacity=40)"});else link.css("cursor","pointer").click(function(event){grid.nextPage();});paginator.append(link);link=$("<a>").css('text-decoration','none').html(img('golast')+"&nbsp;");if(!grid.canGoForward())link.css({opacity:0.4,filter:"alpha(opacity=40)"});else link.css("cursor","pointer").click(function(event){grid.lastPage();});paginator.append(link);}
if(grid.getUnfilteredRowCount()==0)paginator.append($("<div>").addClass('empty').html("<i>"+(grid.noResult?grid.noResult:translate("No result"))+"</i>"));else if(grid.getRowCount()==0)paginator.append($("<div>").addClass('empty').html("<i>"+(grid.noResultMatchingFilter?grid.noResultMatchingFilter:translate("No result is passing the filter"))+"</i>"));if(!showTableEvenIfEmpty&&grid.getRowCount()==0&&typeof grid.table!="undefined"&&grid.table!=null)$(grid.table).parent().empty();}
function gridWait(id)
{if(!id)return;$(".ui-tooltip").remove();$('#'+id).html("<div style='margin-top:60px'><center>"+img('wait')+"</center></div>");var paginatorId=id.replace(/tablecontent/,'paginator');if(paginatorId!=id)$('#'+paginatorId).empty();}
function bytesToSize(bytes,precision)
{var kilobyte=1024;var megabyte=kilobyte*1024;var gigabyte=megabyte*1024;var terabyte=gigabyte*1024;if((bytes>=0)&&(bytes<kilobyte)){return bytes+' B';}else if((bytes>=kilobyte)&&(bytes<megabyte)){return(bytes/kilobyte).toFixed(precision)+' KB';}else if((bytes>=megabyte)&&(bytes<gigabyte)){return(bytes/megabyte).toFixed(precision)+' MB';}else if((bytes>=gigabyte)&&(bytes<terabyte)){return(bytes/gigabyte).toFixed(precision)+' GB';}else if(bytes>=terabyte){return(bytes/terabyte).toFixed(precision)+' TB';}else{return bytes+' B';}}
function comment2html(_comment)
{var comment=_comment?_comment:'';comment=comment.replace(/<hr>\n/g,"<hr>");return nl2br(comment);}
function nl2br(_comment)
{var comment=_comment?_comment:'';comment=comment.replace(/\n/g,"<br/>");comment=comment.replace(/u000a/g,"<br/>");comment=comment.replace(/u0009/g,"&nbsp;&nbsp;");return comment;}
jQuery.fn.scrolltip=function(config)
{this.each(function(){$(this).append($('<div>').addClass('ui-tooltip ui-widget ui-corner-all ui-widget-content scrolltip').css('display','none'));});$(this).hoverIntent({sensitivity:10,interval:250,timeout:100,over:function(e){var content=config.content.call(this);if(content&&content.length>0){var tip=$(this).find('div.scrolltip').html($('<div>').addClass('ui-tooltip-content').html(content));if(tip.size()<1){$(this).append($('<div>').addClass('ui-tooltip ui-widget ui-corner-all ui-widget-content scrolltip').css('display','none'));tip=$(this).find('div.scrolltip').html($('<div>').addClass('ui-tooltip-content').html(content));}
if(config.noanimation)tip.show();else tip.slideDown('fast');if(config.onshow)config.onshow.call(this,tip);this.scrolltip_tip=tip;}},out:function(){var tip=this.scrolltip_tip;if(tip){if(config.noanimation)tip.hide();else tip.slideUp('fast');if(config.onhide)config.onhide.call(this,tip);}}});};jQuery.fn.exportSelect=function(grid)
{$(this).find("a[format]").each(function(){$(this).attr('target','export').attr('href',$(this).attr('href_static')||!grid?$(this).attr('href_static'):grid.exportUrl($(this).attr('format'),$(this).attr('extension')));});};if(typeof MultiselectCellRenderer!='undefined'){function TagCellRenderer(config)
{this.init(config);}
TagCellRenderer.prototype=new MultiselectCellRenderer({noneText:translate('(no tag)')});TagCellRenderer.prototype.render=function(cell,value){var self=this;var values=value?value.split(","):[];$(cell).html('');if(values.length==0)$(cell).html(this.noneText.replace(' ','&nbsp;')).css('color','#ddd');else for(var i=0;i<values.length;i++){var id_tag=values[i];var label=EnumCellRenderer.prototype.getLabel.call(this,cell.rowIndex,id_tag);var color=tag_colors[id_tag];if(!color)color='0089e0';$(cell).append($li=$('<li>').attr('id_tag',id_tag).addClass('tags').append($a=$('<a>').html(label)));if(color){$a.css({"background-color":"#"+color,"border-color":"transparent #"+color+" transparent transparent","color":cssColor(getFrontColor(toRGB(color)))}).attr('tag_color',color);$a.hover(function(){$(this).css({"background-color":"#555","border-right-color":"#555","color":"#FFF"});},function(){$(this).css({"background-color":"#"+$(this).attr("tag_color"),"border-color":"transparent #"+$(this).attr("tag_color")+" transparent transparent","color":cssColor(getFrontColor(toRGB($(this).attr("tag_color"))))});});}}
if($('.tag_select').size()>0)$(cell).find('li[id_tag]').on('click',function(){$('.tag_select').val([$(this).attr('id_tag')]);$('.tag_select').multiselect('refresh');self.editablegrid.refresh();});}}
if(typeof TextCellEditor!='undefined'){function ColorCellEditor(config)
{this.init(config);}
ColorCellEditor.prototype=new TextCellEditor();ColorCellEditor.prototype.displayEditor=function(element,htmlInput)
{$(htmlInput).addClass('color');this.colorPicker=new jscolor.color(htmlInput);TextCellEditor.prototype.displayEditor.call(this,element,htmlInput);htmlInput.onblur_backup=htmlInput.onblur;htmlInput.onblur=null;this.colorPicker._hidePicker=this.colorPicker.hidePicker;this.colorPicker.hidePicker=function(){this._hidePicker();if(htmlInput.onblur_backup!=null)htmlInput.onblur_backup();};this.colorPicker.showPicker();};ColorCellEditor.prototype._clearEditor=function(element)
{TextCellEditor.prototype._clearEditor.call(this,element);this.colorPicker._hidePicker();};function DialogCellEditor(config){this.init(config);}
DialogCellEditor.prototype=new CellEditor();DialogCellEditor.prototype.init=function(config)
{this.width=480;this.height=null;this.dialog=null;this.autoOpen=true;CellEditor.prototype.init.call(this,config);};DialogCellEditor.prototype.getValue=function(){return null;};DialogCellEditor.prototype.create=function(){};DialogCellEditor.prototype.open=function(cell,value){};DialogCellEditor.prototype.close=function(){};DialogCellEditor.prototype.resize=function(event,ui){};DialogCellEditor.prototype.resizeStart=function(event,ui){};DialogCellEditor.prototype.getDialogTitle=function(cell,value){return this.column.label;};DialogCellEditor.prototype.getEditor=function(cell,value){var self=this;$(this.dialog).dialog({width:this.width,height:(this.height?this.height:"auto"),maxHeight:window_height()-200,modal:true,autoOpen:this.autoOpen,create:function(event){self.create(cell,value);},open:function(event){self.open(cell,value);},close:function(event){self.close();$(this).dialog('destroy');},beforeClose:function(event,ui){if(cell&&cell.isEditing)self.cancelEditing(cell);return true;},resize:function(event,ui){self.resize(event,ui);},resizeStart:function(event,ui){self.resizeStart(event,ui);},buttons:[{text:translate("Save"),click:function(){if(self.applyEditing(cell,self.getValue()))
$(this).dialog("close");}}],title:this.getDialogTitle(cell,value)});return null;};function TextAreaCellEditor(config){this.init(config);}
TextAreaCellEditor.prototype=new DialogCellEditor();TextAreaCellEditor.prototype.init=function(config)
{this.useTinyMce=false;this.placeHolder=null;this.tinyMceHeight=300;if(!config)config={};if(!config.width)config.width=config&&config.useTinyMce?700:600;DialogCellEditor.prototype.init.call(this,config);if(typeof tinymce=='undefined')this.useTinyMce=false;this.dialog=$('<div>').css({'text-align':'left','display':'none'});var innerDiv=$('<div>').css({'padding':'0px','margin-top':'7px'});this.textArea=$('<textarea>').css({padding:'0px',width:'100%',height:this.tinyMceHeight+'px'}).addClass('dialog').attr('id','TextAreaCellEditor_textarea');if(this.placeHolder)this.textArea.attr('placeholder',this.placeHolder);this.dialog.append(innerDiv.append(this.textArea));};TextAreaCellEditor.prototype.open=function(cell,value){this.textArea.val(value).focus();if(this.useTinyMce)tinymce.execCommand('mceAddEditor',false,'TextAreaCellEditor_textarea');};TextAreaCellEditor.prototype.close=function(){if(this.useTinyMce)tinymce.execCommand('mceRemoveEditor',false,'TextAreaCellEditor_textarea');};TextAreaCellEditor.prototype.resize=function(event,ui){if(!this.useTinyMce)$(this.textArea).height(ui.size.height-differenceBetweenDialogAndTextArea);};TextAreaCellEditor.prototype.resizeStart=function(event,ui){if(!this.useTinyMce&&typeof differenceBetweenDialogAndTextArea=='undefined')differenceBetweenDialogAndTextArea=ui.size.height-$(this.textArea).height();};TextAreaCellEditor.prototype.getValue=function(){return this.useTinyMce?tinymce.get('TextAreaCellEditor_textarea').getContent():this.textArea.val();};}
function ObjectEditor(config){this.init(config);}
ObjectEditor.prototype.init=function(config)
{this.name="object";this.controller="objects";this.resource=null;this.id_object=0;this.width=750;this.dialog=$('<div>');this.forceEdit=false;if(config)for(var p in config)this[p]=config[p];if(config&&config['id_'+this.name])this.id_object=config['id_'+this.name];};ObjectEditor.prototype.save=function()
{var self=this;showWait(translate("Saving..."));var parameters={};this.dialog.find('form').populateParameters(parameters);_ajax(this.controller+'/save',{id:this.id_object,parameters:parameters}).done(function(response){hideWait();if(response){if(self.afterSave)self.afterSave.call(self);$(self.dialog).dialog("close");}});};ObjectEditor.prototype.getParameters=function()
{return{};};ObjectEditor.prototype.initForm=function(readonly)
{var self=this;showWait(translate("Loading..."));var parameter=this.getParameters();parameter.id=this.id_object;parameter.readonly=readonly;ajax('/'+this.controller+'/form',parameter).done(function(response){self.dialog.html(response);if(self.id_object>0)self.dialog.find('textarea:first').attr('autofocus',1);self.dialog.find('input,textarea,select').not('.datepicker').not('[type=checkbox]').css('width','450px');self.dialog.find('textarea').css('height','250px');self.dialog.find('select').select2({dropdownAutoWidth:true,minimumResultsForSearch:10,dropdownCssClass:'ui-dialog'});self.dialog.find('.datepicker').datepicker({dateFormat:locale['date_format_jquery']});if(readonly){self.dialog.dialog({buttons:self.resource===null||isAllowed(self.resource,'edit')?[{text:translate("Edit"),click:function(){self.initForm(false);}},{text:translate("Close"),click:function(){$(this).dialog("close");}}]:[{text:translate("Close"),click:function(){$(this).dialog("close");}}]});}
else{self.dialog.dialog({buttons:[{text:translate("Save"),click:function(){self.save();}}]});}
if(self.beforeOpen)self.beforeOpen();hideWait();self.dialog.dialog('open').dialog('moveToTop');if(typeof blocks=='object'&&blocks!=null)$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));});};ObjectEditor.prototype.open=function(){var self=this;$(this.dialog).dialog({width:this.width,height:"auto",maxHeight:window_height()-200,modal:true,autoOpen:false,create:function(event){self.initForm(!self.forceEdit&&self.id_object>0);},close:function(event){if(self.beforeClose)self.beforeClose();$(this).dialog('destroy');},title:this.id_object?translate(this.name.ucfirst())+' #'+this.id_object:translate("Create "+this.name)});return null;};function TaskEditor(config){this.init(config);}
TaskEditor.prototype=new ObjectEditor();TaskEditor.prototype.init=function(config)
{if(!config)config={};config.name="task";config.controller="task";config.resource="tasks";ObjectEditor.prototype.init.call(this,config);};TaskEditor.prototype.beforeOpen=function()
{var self=this;$("a.mail_link").unbind('click').click(function(){var id_mail=$(this).attr('rel');new MailEditor({id_mail:id_mail,afterSave:function(){self.initForm(true);}}).open();return true;});};function MailEditor(config){this.init(config);}
MailEditor.prototype=new ObjectEditor();MailEditor.prototype.init=function(config)
{if(!config)config={};config.name="mail";config.controller="email";config.resource=null;config.width=775;ObjectEditor.prototype.init.call(this,config);};MailEditor.prototype.save=function(send)
{var self=this;showWait(translate(send?"Sending...":"Saving..."));var parameters={};this.dialog.find('form').populateParameters(parameters);parameters["body"]=tinyMCE.get(this.id_textarea).getContent();parameters["html"]=1;return _ajax('email/save',{id:this.id_object,parameters:parameters,send:send||false}).done(function(response){if(self.afterSave)self.afterSave.call(self);hideWait();});};MailEditor.prototype.deleteMail=function()
{var self=this;showWait(translate("Deleting..."));_ajax('email/delete',{id:this.id_object}).done(function(response){if(self.afterSave)self.afterSave.call(self);hideWait();});};MailEditor.prototype.answer=function(send)
{var self=this;showWait(translate("Loading..."));_ajax('email/answer',{id:this.id_object}).done(function(id_mail_response){if(self.afterSave)self.afterSave.call(self);hideWait();if(id_mail_response)new MailEditor({id_mail:id_mail_response,afterSave:self.afterSave}).open();});};MailEditor.prototype.beforeOpen=function()
{var self=this;if(this.dialog.find('textarea').size()==0){var buttons=[{text:translate("Close"),click:function(){$(this).dialog("close");}}];if(this.dialog.find('input[name=direction]').val()=='IN')buttons.push({text:translate("Answer"),click:function(){self.answer();$(this).dialog("close");}});this.dialog.dialog({buttons:buttons,minHeight:null});}
else{this.dialog.dialog({minHeight:735,buttons:[{text:translate("Save"),click:function(){self.save();$(this).dialog("close");}},{text:translate("Send"),click:function(){if(confirm(translate("Are you sure you want to send this mail ?"))){self.save(true);$(this).dialog("close");}}},{text:translate("PDF"),click:function(){window.open(baseUrl+'/ajax/email/pdfmail/id/'+self.id_object);}},{text:translate("Delete"),click:function(){if(confirm(translate("Are you sure you want to delete this mail ?"))){self.deleteMail();$(this).dialog("close");}}}]});this.id_textarea='MailCellEditor_textarea_'+this.id_object;this.dialog.find('textarea').attr('id',this.id_textarea);tinymce.execCommand('mceAddEditor',false,this.id_textarea);}};MailEditor.prototype.beforeClose=function()
{if(this.id_textarea)tinymce.execCommand('mceRemoveEditor',false,this.id_textarea);};function NoteEditor(config){this.init(config);}
NoteEditor.prototype=new ObjectEditor();NoteEditor.prototype.init=function(config)
{if(!config)config={};config.name="note";config.controller="note";config.resource=null;ObjectEditor.prototype.init.call(this,config);};function BelgiumdaysEditor(config){this.init(config);}
BelgiumdaysEditor.prototype=new ObjectEditor();BelgiumdaysEditor.prototype.init=function(config)
{if(!config)config={};config.name="entry";config.controller="belgiumdays";config.resource="configuration";config.width=650;ObjectEditor.prototype.init.call(this,config);};if(typeof TextCellEditor!='undefined'){function ObjectCellEditor(config){this.init(config);}
ObjectCellEditor.prototype=new DialogCellEditor();ObjectCellEditor.prototype.init=function(config)
{var self=this;this.forceEdit=false;DialogCellEditor.prototype.init.call(this,config);this.width=750;this.autoOpen=false;this.afterSave=function(){self.editablegrid.refreshGrid();};this.dialog=$('<div>');};ObjectCellEditor.prototype.getDialogTitle=function(cell,value)
{this.id_object=this.editablegrid?this.editablegrid.getRowId(cell.rowIndex):0;return this.id_object?translate(this.name.ucfirst())+' #'+this.id_object:translate("Create "+this.name);};ObjectCellEditor.prototype.create=function(cell,value)
{this.id_object=this.editablegrid?this.editablegrid.getRowId(cell.rowIndex):0;this.initForm(!this.forceEdit&&this.id_object>0);};ObjectCellEditor.prototype.close=function()
{if(this.beforeClose)this.beforeClose();};function NoteCellEditor(config){this.init(config);}
NoteCellEditor.prototype=new ObjectCellEditor();NoteCellEditor.prototype.getParameters=NoteEditor.prototype.getParameters;NoteCellEditor.prototype.initForm=NoteEditor.prototype.initForm;NoteCellEditor.prototype.save=NoteEditor.prototype.save;NoteCellEditor.prototype.init=function(config)
{ObjectCellEditor.prototype.init.call(this,config);this.name="note";this.controller="note";this.resource=null;};function TaskCellEditor(config){this.init(config);}
TaskCellEditor.prototype=new ObjectCellEditor();TaskCellEditor.prototype.getParameters=TaskEditor.prototype.getParameters;TaskCellEditor.prototype.beforeOpen=TaskEditor.prototype.beforeOpen;TaskCellEditor.prototype.initForm=TaskEditor.prototype.initForm;TaskCellEditor.prototype.save=TaskEditor.prototype.save;TaskCellEditor.prototype.init=function(config)
{ObjectCellEditor.prototype.init.call(this,config);this.name="task";this.controller="task";this.resource="tasks";};function MailCellEditor(config){this.init(config);}
MailCellEditor.prototype=new ObjectCellEditor();MailCellEditor.prototype.beforeOpen=MailEditor.prototype.beforeOpen;MailCellEditor.prototype.beforeClose=MailEditor.prototype.beforeClose;MailCellEditor.prototype.initForm=MailEditor.prototype.initForm;MailCellEditor.prototype.save=MailEditor.prototype.save;MailCellEditor.prototype.answer=MailEditor.prototype.answer;MailCellEditor.prototype.deleteMail=MailEditor.prototype.deleteMail;MailCellEditor.prototype.init=function(config)
{ObjectCellEditor.prototype.init.call(this,config);this.name="mail";this.controller="email";this.resource=null;this.width=875;};}
function _bootstrap(helpbox,nohide)
{wait=$('#wait').ractive({path:'wait.ractive'}).instance();if(!nohide)$('#content').hide();$('#content').css('padding','8px');$('#wait .first').hide();$('#wait').show();menutop=$('#menutop').ractive({path:'menutop-'+version,ractiveClass:MenuRactive}).instance();menu=$('#menu').ractive({path:'menu-'+version,ractiveClass:MenuRactive}).instance();$(".helpbox").attr('rel',helpbox);menu.set({'ui':'_old_','menu':'menu'});menutop.set({'ui':'_old_','menutop':'menu'});$(window).resize(function(){$('#nav').height(Math.max($('#wrap').height(),window_height())-parseInt($('#nav').css('padding-top'))-parseInt($('#nav').css('padding-bottom')));});$(window).trigger("resize");$(document).tooltip({items:"td, th, th div, img, .row input, td input, th a, li a, a, span.total, p>span, li, i, a.tooltip",content:function(){var element=$(this);if(element.is("[tooltip]"))return element.attr("tooltip");if(element.is("[title]"))return element.attr("title");if(element.is("img"))return element.attr("alt");}});}
function _init_screen()
{if(this.grid)this.grid.fetch();$("select.export_select").exportSelect(this.grid);$('#menutop i.toggle').unbind('click').click(function(){$('#menu, #wrap').toggleClass('on');});$("[on-tap=clear-filter]").click(function(event){$(this).siblings('.search_div.stringfilter > input.searchfield').tagit('removeAll');});if($(".helpbox h1").size()==0)$(".helpbox .helpbox_inner_box").prepend($('<h1>').html(document.title));if($(".helpbox").size()>0){if($('.boxtitle h1').size()>1)$('.boxtitle').append("<div class='right'><i style='margin-left: 10px;cursor: pointer;font-size: 1.8em' class='fa fa-life-ring'></i></div>");else $('.boxtitle h1:first').after("<i style='margin-left: 10px;cursor: pointer;font-size: 1.8em' class='fa fa-life-ring'></i>");}
$('[on-tap=hide-helpbox]').click(function(event){$(".helpbox").fadeOut('slow');});$('[on-tap=close-helpbox]').click(function(event){_ajax('helpbox/close',{id:$(this).parents('.helpbox').attr('rel')}).done(function(){$(".helpbox").fadeOut('fast');});});$('.boxtitle .fa-life-ring').click(function(){$(".helpbox").fadeIn('fast');});menu.hilite();if(!menu.hilited()){menu.set('full',true);menu.hilite();if(!menu.hilited())menu.set('full',false);}
$('body').prepend($(".helpbox").css('display',$(".helpbox").attr('display')));$('#menu').show();$('#wait').hide().find('.first').remove();$('#content, #footer, .box').show();}
function selectedText(header,noActiveState,N)
{var N=N||3;return function(numChecked,numTotal,checkedItems){var text='';if(numChecked<=N){var names=[];for(var c=0;c<=N&&c<checkedItems.length;c++)names.push(htmlspecialchars($(checkedItems[c]).attr('title')));text=names.join(', ');}
else text=(header?header+': ':'')+translate("# of #").replace('#',numChecked).replace('#',numTotal);return numChecked!=numTotal&&!noActiveState?"<span class='filter filter-active'>"+text+"</span>":"<span class='filter'>"+text+"</span>";};};function noneSelectedText(header){return"<span class='filter filter-empty'>"+header+"</span>";};function feedback_message(text,type,delay)
{var html='<div class=\'notification '+type+'\' style=\'margin:0\'>'+text+'</div>';$('#feedback_message').html(html).slideDown().delay(delay||2500).slideUp('slow');}
function message(type,message){feedback_message(message,type);}
function clone(obj){var copy;if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date){copy=new Date();copy.setTime(obj.getTime());return copy;}
if(obj instanceof Array){copy=[];for(var i=0,len=obj.length;i<len;i++){copy[i]=clone(obj[i]);}
return copy;}
if(obj instanceof Object){copy={};for(var attr in obj){if(obj.hasOwnProperty(attr))copy[attr]=clone(obj[attr]);}
return copy;}
throw new Error("Unable to copy obj! Its type isn't supported.");}
function arrayEqual(a,b)
{if(a===b)return true;if(a==null||b==null)return false;if(a.length!=b.length)return false;for(var i=0;i<a.length;++i)if(a[i]!==b[i])return false;return true;}
if(typeof FastClick!='undefined'){$(function(){FastClick.attach(document.body);});}
var time_start=null;var time_t0=null;var timer_infos='';function _time(){return new Date().getTime();}
function _start(){timer_infos='';time_start=_time();time_t0=_time();}
function _step(what){if(_time()-time_start>2)timer_infos+=what+": "+(_time()-time_start)+" ms<br/>";time_start=_time();}
function _stop(){_step("Last step");timer_infos+="<hr/>Total: "+(_time()-time_t0)+" ms<br/>";jalert(timer_infos,false,null,600,480);};var google_maps_api_loaded=false;function google_maps_load_callback(){router.screen_controller.start(router.parameter);}
function DefaultScreen(){}
DefaultScreen.prototype.bootstrap=function(parameter)
{var self=this;document.title=strip_tags($('.boxtitle h1:first').text());tinyMceInit();$(".helpbox:first").css('display',$(".helpbox:first").attr('display'));ui.on("toggle-filter",function(event){$(event.node).find('.toggle-filter').toggleClass('fa-toggle-up');$(event.node).siblings('.actionbar-filters').slideToggle('fast');});ui.on("hide-filter",function(event){$('.toggle-filter').removeClass('fa-toggle-up');$('.actionbar-filters').hide();});ui.on("clear-filter",function(event){$(event.node).siblings('.search_div.stringfilter > input.searchfield').tagit('removeAll');});var SINGLE_SELECT_MODE=true;ui.on('apply-status-bubble',function(event){var candidate=$(event.node).attr('data-filter');if(SINGLE_SELECT_MODE){var nb=$('.bubble-filters .filtercount:visible').size();var nb_on=$('.bubble-filters .filtercount.active:visible').size();var nb_off=nb-nb_on;if(event.original.ctrlKey||event.original.metaKey||nb_on==0||nb_off==0)ui.set('parameters.id_statuses',[candidate]);else{var index=ui.get('parameters.id_statuses').indexOf(candidate);if(index<0){if(nb_off==1)ui.set('parameters.id_statuses',[candidate]);else ui.get('parameters.id_statuses').push(candidate);}
else ui.get('parameters.id_statuses').splice(index,1);var nb_on=$('.bubble-filters .filtercount.active:visible').size();if(nb_on==0){var all_statuses=[];for(var i=0;i<ui.get('status_select_options').length;i++)all_statuses.push(ui.get('status_select_options')[i].value);ui.set('parameters.id_statuses',all_statuses);}}
if(self.grid)self.grid.bubble_post();}
else{if(event.original.ctrlKey||event.original.metaKey){var index=ui.get('parameters.id_statuses').indexOf(candidate);if(index<0)ui.get('parameters.id_statuses').push(candidate);else ui.get('parameters.id_statuses').splice(index,1);}
else if(ui.get('parameters.id_statuses').length>1||ui.get('parameters.id_statuses').length==0||ui.get('parameters.id_statuses')[0]!=candidate)ui.set('parameters.id_statuses',[candidate]);else{var all_statuses=[];for(var i=0;i<ui.get('status_select_options').length;i++)all_statuses.push(ui.get('status_select_options')[i].value);ui.set('parameters.id_statuses',all_statuses);}}
$('.status_select').multiselect('refresh');self.grid.refresh();});ui.on('apply-year-bubble',function(event,from,to){var selector=$(event.node).closest('div.stringfilter');selector.find('.searchfield.from').val(from);selector.find('.searchfield.to').val(to);self.grid.refresh();});ui.on("toggle-export",function(event){$("#export_content").css('margin-left',($("#export_content a").size()*-36-25)+'px');$(".ui-tooltip").remove();$("#export_overlay").toggle();});$('select.quick-access').each(function(){var $select=$(this);$(this).select2({width:500,formatNoMatches:translate("no match found"),placeholder:$(this).attr('placeholder')?$(this).attr('placeholder'):translate("Quick access"),ajax:{url:baseUrl+"/ajax/"+router._controller+"/quickaccess",delay:250,type:'POST',dataType:'json',contentType:'application/json; charset=UTF-8',data:function(params){if($select.attr('target'))params.target=$select.attr('target');return $.toJSON(params);}},language:{errorLoading:function(){return'';},loadingMore:function(){return translate('Loading more results…');},noResults:function(){return translate('No results found');},searching:function(){return translate('Searching…');}},escapeMarkup:function(markup){return markup;},minimumInputLength:0,templateResult:function(item){if(item.loading)return item.text;if(item.text_ext)return"<div><b>"+item.text+"</b><p>"+item.text_ext+"</p></div>";return"<div><b>"+item.text+"</b></div>";},templateSelection:function(item){return item.text}});});router.observers.push(ui.observe('job.mode',function(oldV,newV){if(oldV&&newV&&ui.get('job.mode'))_ajax('job/setmode',{id:ui.get('job.id'),mode:ui.get('job.mode')}).done(function(new_mode){if(ui.get('job.mode')!=new_mode){console.error("Mode not correctly set ?!");return false;}
menu.hilite();if($('ul.tabmenu li.active').size()==0){router.navigate('/job/'+ui.get('job.id')+'/general',true);}
else if(ui.get('ui')=='job_estimate'){try{tinymce.execCommand('mceRemoveEditor',false,'EstimateEditGeneral_description');}catch(ex){}
$('.estimate_general_tab textarea[name=description]').show().attr('id','EstimateEditGeneral_description').parent().show();$('#EstimateEditGeneral_description').css('border','1px solid red');tinymce.execCommand('mceAddEditor',false,'EstimateEditGeneral_description');}
else if(ui.get('ui')=='job_job_item')router.screen_controller.reload();});},{defer:true}));$('div.actionbar').addClass('ui-widget');if($(".helpbox:first h1").size()==0)$(".helpbox:first .helpbox_inner_box").prepend($('<h1>').html(document.title));if(ui.get('ui')!='wizard_index'&&helpbox(ui.get('ui'))){if($('.boxtitle h1').size()>1)$('.boxtitle').append("<div class='statusbar'><i style='margin-left: 10px;cursor: pointer;font-size: 1.8em' class='fa fa-life-ring'></i></div>");else $('.boxtitle h1:first').after("<i style='margin-left: 10px;cursor: pointer;font-size: 1.8em' class='fa fa-life-ring'></i>");}
ui.on('hide-helpbox',function(event){$(".helpbox").fadeOut('fast');});ui.on('close-helpbox',function(event){_ajax('helpbox/close',{id:$(event.node).parents('.helpbox:first').attr('rel')}).done(function(){$(".helpbox:first").fadeOut('fast');});});ui.on('open-helpbox',function(event){adapt_heights();$(".helpbox:first").fadeIn('fast');});$('.boxtitle .fa-life-ring').click(function(){$(".helpbox:first").fadeIn('fast');});$(".statusbar_amount_total").mouseenter(function(){$(this).siblings(".statusbar_amount_detail").show();}).mouseleave(function(){$(this).siblings(".statusbar_amount_detail").hide();});if(this.needGoogleMaps()&&!google_maps_api_loaded){var script=document.createElement('script');script.type='text/javascript';script.src='https://maps.googleapis.com/maps/api/js?callback=google_maps_load_callback';document.body.appendChild(script);google_maps_api_loaded=true;console.log('Injected Google Maps API JS script tag');}
else this.start(parameter);};DefaultScreen.prototype.start=function(parameter)
{this.init(parameter);if(this.grid)this.grid.fetch();if(this.showAsap())this.show();};DefaultScreen.prototype.showAsap=function()
{return true;};DefaultScreen.prototype.show=function()
{$('#content').show();hideWait();adapt_heights();};DefaultScreen.prototype.needGoogleMaps=function()
{return false;};DefaultScreen.prototype.dispose=function()
{$(".statusbar_amount_total").unbind('mouseleave').unbind('mouseenter');};;function localset(key,value){return EditableGrid.prototype._localset(key,value);}
function localunset(key){return EditableGrid.prototype._localunset(key);}
function localget(key){return EditableGrid.prototype._localget(key);}
function localisset(key){return EditableGrid.prototype._localisset(key);}
function TimetrackEditableGrid(name,config){if(name)this.init(name,config);}
TimetrackEditableGrid.prototype=new EditableGrid();TimetrackEditableGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.alternate=='undefined')config.alternate=true;if(typeof config.serverSide=='undefined')config.serverSide=true;if(typeof config.container_id=='undefined')config.container_id='tablecontent';if(typeof config.updatecellaction=='undefined')config.updatecellaction='updatecell';if(typeof config.actionbar=='undefined')config.actionbar=$('.actionbar');if(typeof config.statusbar=='undefined')config.statusbar=$('.statusbar');if(typeof config.showTableEvenIfEmpty=='undefined')config.showTableEvenIfEmpty=false;config.dateFormat=locale['date_style'];config.shortMonthNames=short_month_names;EditableGrid.prototype.init.call(this,name,config);this.bind(this.actionbar,this.statusbar);};TimetrackEditableGrid.prototype._createCellEditor=function(column)
{EditableGrid.prototype._createCellEditor.call(this,column);if(column.datatype=="text")column.cellEditor=new TextAreaCellEditor();else if(column.datatype=="html"&&column.editable)column.cellEditor=new TextAreaCellEditor({useTinyMce:true,width:680,height:400});if(column.cellEditor){column.cellEditor.editablegrid=this;column.cellEditor.column=column;}};TimetrackEditableGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),[])>-1;};TimetrackEditableGrid.prototype.getParameters=function()
{return{};};TimetrackEditableGrid.prototype.onChange=function()
{};TimetrackEditableGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;var parameter=this.getParameters();parameter.id=this.getRowId(rowIndex);parameter.newvalue=(this.getColumnType(columnIndex)=="boolean"?(newValue?1:0):newValue);parameter.colname=this.getColumnName(columnIndex);parameter.coltype=this.getColumnType(columnIndex);return _ajax(this.controller+'/'+this.updatecellaction,parameter).then(function(response){if(!response){self.setValueAt(rowIndex,columnIndex,oldValue);highlightRow(row,"error");return $.Deferred().reject();}
highlightRow(row,"ok");self.onChange();if(self.mustReload(rowIndex,columnIndex)){if(self.serverSide)self.refresh(true);else self.fetch();}
return response;},function(response){self.setValueAt(rowIndex,columnIndex,oldValue);highlightRow(row,"error");return response;});};TimetrackEditableGrid.prototype.checkboxAction=function(rowIndex,checkbox)
{var self=this;var row=this.getRow(rowIndex);return _ajax(this.controller+'/'+this.updatecellaction,{id:this.getRowId(rowIndex),newvalue:(checkbox.is(':checked')?1:0),colname:checkbox.attr('attribute'),coltype:'boolean'}).done(function(response){if(!response){checkbox.prop(checkbox.is(':checked')?0:1);highlightRow(row,"error");}
else{highlightRow(row,"ok");self.onChange();self.refresh(true);}});};TimetrackEditableGrid.prototype.bubble_post=function()
{var nb=$('.actionbar .statusbar .bubble-filters .filtercount:visible').size();var nb_on=$('.actionbar .statusbar .bubble-filters .filtercount.active:visible').size();if(nb>0&&nb_on==nb)$('.actionbar .statusbar .bubble-filters').addClass('initial_state');else $('.actionbar .statusbar .bubble-filters').removeClass('initial_state');};TimetrackEditableGrid.prototype.updatePaginator=function()
{if(this.container_id)updatePaginator(this,this.container_id.replace(/tablecontent/,'paginator'),null,this.showTableEvenIfEmpty);$(this.statusbar).css('display',this.getUnfilteredRowCount()>0?'block':'none');$(this.statusbar).find('span.total.count').html(this.getTotalRowCount()==this.getUnfilteredRowCount()?this.getTotalRowCount():this.getTotalRowCount()+" / "+this.getUnfilteredRowCount());for(var attribute in this.paginatorAttributes){if(this.paginatorAttributes[attribute]===null)$(this.actionbar).add($(this.statusbar)).find('span.total.'+attribute).closest('div').hide();else $(this.actionbar).add($(this.statusbar)).find('span.total.'+attribute).html(this.paginatorAttributes[attribute]).closest('div').show();}
var SINGLE_SELECT_MODE=true;if(SINGLE_SELECT_MODE)this.bubble_post();$("#export_content").exportSelect(this);};TimetrackEditableGrid.prototype.applyColumnVisibility=function()
{if(this.colSelector){var hiddenColumns=null;try{hiddenColumns=$.parseJSON(localget(this.name+'-hidden-columns'));}catch(e){console.error(e);}
if(!hiddenColumns)this.colSelector.find('p.reset-columns a').trigger('click');else for(var c=0;c<hiddenColumns.length;c++){var colname=hiddenColumns[c];this.colSelector.find('input[type=checkbox][value="'+colname+'"]').attr('checked',false);$('.editablegrid-'+colname).hide();}}};TimetrackEditableGrid.prototype.tableRendered=function(containerid,className,tableid)
{EditableGrid.prototype.tableRendered.call(this,containerid,className,tableid);if(this.alternate)alternate(containerid);this.updatePaginator();this.updateCheckedRows();this.applyColumnVisibility();$(".ui-tooltip").remove();hideWait();$("#"+containerid).append("<div class='grid_bottom_anchor'></div>");};TimetrackEditableGrid.prototype.tableLoaded=function()
{this.render();};TimetrackEditableGrid.prototype.isCheckable=function(rowIndex)
{if(this.isDeletable&&!this.isDeletable(rowIndex))return false;return true;};TimetrackEditableGrid.prototype.updateCheckedRows=function()
{var checked=[];$("td.editablegrid-selector input[type=checkbox]:checked").each(function(){checked.push($(this).attr('id_row'));});if(typeof ui!='undefined')ui.set('rows_checked',checked);};TimetrackEditableGrid.prototype.checkAllRows=function(checked)
{$(this.table).find("td.editablegrid-selector input[type=checkbox]").each(function(){if(!$(this).is(':disabled'))$(this).attr('checked',checked);});this.updateCheckedRows();};TimetrackEditableGrid.prototype.isColumnHideable=function(colIndex)
{return colIndex>0&&trim(this.getColumnSelectorLabel(colIndex))!='';};TimetrackEditableGrid.prototype.getColumnSelectorLabel=function(colIndex)
{var label=trim(this.getColumnLabel(colIndex));if(!label&&this.getColumnName(colIndex)=='description')return translate("Description");return label;};TimetrackEditableGrid.prototype.render=function()
{var self=this;if(this.hasColumn('selector')){this.setCellRenderer("selector",new CellRenderer({render:function(cell,dummy){var checkbox=$('<input type="checkbox">').css('cursor','pointer').attr('id_row',self.getRowId(cell.rowIndex)).click(function(){self.updateCheckedRows();});if(!self.isCheckable(cell.rowIndex))checkbox.css('cursor','not-allowed').attr('disabled',true);$(cell).append(checkbox).css('width','16px');}}));this.setHeaderRenderer("selector",new CellRenderer({render:function(cell,dummy){var checkbox=$('<input type="checkbox">').css('cursor','pointer').click(function(){self.checkAllRows($(this).is(':checked'));});$(cell).append(checkbox).css('width','16px').attr('title',translate('Check all rows'));}}));ui.observe('rows_checked',function(value){$(self.table).find('th.editablegrid-selector input[type=checkbox]').attr('checked',$(self.table).find("td.editablegrid-selector input[type=checkbox]").not(":disabled").size()>0&&$(self.table).find("td.editablegrid-selector input[type=checkbox]").not(":disabled").not(':checked').size()==0);});}
if(this.hasColumn('action')){this.colSelector=$('<div>').addClass('column-selector');var colSelectorWrapper=$('<div>').addClass('column-selector-wrapper');$('#'+this.container_id).parent().append(colSelectorWrapper);colSelectorWrapper.append(this.colSelector.hide());colSelectorWrapper.append($('#'+this.container_id).css('overflow','auto'));colSelectorWrapper.append($('#'+this.container_id.replace(/tablecontent/,'paginator')));if(this.getActions)this.setCellRenderer("action",new CellRenderer({render:function(cell,id_row){$(cell).empty().css({'white-space':'nowrap','width':'16px'});self.renderActions(cell);}}));var ul=$('<ul>');this.colSelector.append(ul).append('<p class="reset-columns"><a>'+translate("Reset")+'</a></p>');for(var c=0;c<this.getColumnCount();c++){if(this.isColumnHideable(c)){var colname=this.getColumnName(c);if(colname!='action'){var checkbox=$('<input type="checkbox">').val(colname).attr('checked',true);var li=$('<li>').append(checkbox).append($('<label>').html(this.getColumnSelectorLabel(c)));ul.append(li);}}}
this.setHeaderRenderer("action",new CellRenderer({render:function(cell,dummy){self.colSelector.hide();$(cell).empty().addClass('number').css({'white-space':'nowrap','width':'16px','padding-right':'10px'}).append(translate("Actions")+" &nbsp; <i style='cursor:pointer' class='toggle-column-selector fa fa-table fa-lg'/>");$(cell).on($.isTouch?'touchstart':'click',function(){self.colSelector.toggle();});self.colSelector.find('input[type=checkbox]').unbind('click').on('click',function(){$('.editablegrid-'+$(this).val()).toggle();var hiddenColumns=[];self.colSelector.find('input[type=checkbox]').not(':checked').each(function(){hiddenColumns.push($(this).val());});localset(self.name+'-hidden-columns',$.toJSON(hiddenColumns));});self.colSelector.find('p.reset-columns a').unbind('click').on('click',function(){for(var c=0;c<self.getColumnCount();c++){self.colSelector.find('input[type=checkbox][value="'+self.getColumnName(c)+'"]').attr('checked',!self.getColumn(c).hidden);if(self.getColumn(c).hidden)$('.editablegrid-'+self.getColumnName(c)).hide();else $('.editablegrid-'+self.getColumnName(c)).show();}
localunset(self.name+'-hidden-columns');});}}));}
this.renderGrid(this.container_id,"datagrid");};TimetrackEditableGrid.prototype.renderActions=function(cell,zone)
{zone=zone||cell;var actions=this.getActions(cell,this.getRowId(cell.rowIndex));for(var c=0;c<actions.length;c++){var action=actions[c];if(action.checkbox){var checkbox=$('<input type="checkbox">').css('cursor','pointer');if(action.active===false)checkbox.css('cursor','not-allowed').attr('disabled',true);if(action.title)checkbox.attr('title',action.title);if(action.attribute)checkbox.prop('checked',self.getRowAttribute(cell.rowIndex,action.attribute)==1).attr('attribute',action.attribute).click(function(){self.checkboxAction(cell.rowIndex,$(this));});else if(action.click)checkbox.click(action.click);$(zone).append(checkbox);}
else{if(action.active===false)$(zone).append($('<a>').html(action.icon).css('cursor','not-allowed').addClass('not_allowed'));else if(action.href)$(zone).append($('<a>').html(action.icon).attr('href',action.href).attr('target',action.target?action.target:''));else $(zone).append($('<a>').html(action.icon).css('cursor','pointer').click(action.click));}}};TimetrackEditableGrid.prototype._url=function()
{return baseUrl+"/ajax/"+this.controller+"/grid?request="+encodeURIComponent($.toJSON(this.getParameters()));};TimetrackEditableGrid.prototype.exportUrl=function(format,extension)
{var parameter=this.getUrlParameters();parameter.title=document.title;return baseUrl+'/ajax/'+this.controller+"/"+format+'/'+encodeURIComponent(document.title+'.'+(extension||format))+'?request='+encodeURIComponent($.toJSON(parameter));};TimetrackEditableGrid.prototype.getUrlParameters=function()
{var parameter=this.getParameters();parameter.filter=(this.currentFilter?this.currentFilter:'');parameter.sort=this.sortedColumnName&&this.sortedColumnName!=-1?this.sortedColumnName:"";parameter.asc=this.sortDescending?0:1;return parameter;};TimetrackEditableGrid.prototype.wait=function()
{gridWait(this.container_id);};TimetrackEditableGrid.prototype.fetch=function(silent)
{if(!silent)this.wait();this.updateAutoTags();this.loadJSON(this._url());};TimetrackEditableGrid.prototype.refresh=function(silent)
{if(!silent)this.wait();this.updateAutoTags();return this.refreshGrid(this._url());};TimetrackEditableGrid.prototype._getFilter=function()
{var tags=[];$(this.actionbar).find('li.tagit-choice:not(.auto-tag) > span.tagit-label').each(function(){tags.push($(this).text());});return tags.join(',');};TimetrackEditableGrid.prototype.bind=function(actionbar,statusbar)
{this.actionbar=actionbar;this.statusbar=statusbar;var self=this;$(actionbar).find('.stringfilter > .searchfield').val(this.currentFilter?this.currentFilter:'').focus();$(actionbar).find('i.toggle-filter').parent().css('display',$(actionbar).find('div.actionbar-filters').children().size()==0?'none':'');$(actionbar).find("[rel=refresh-filter]").click(function(event){if(self.serverSide)self.refresh();else self.fetch();});this.tagFilter=$(actionbar).find(".search_div.stringfilter > input.searchfield");this.tagFilter.tagit({allowSpaces:true,placeholderText:this.tagFilter.attr('placeholder'),afterTagAdded:function(event,ui){if($(ui.tag).hasClass('auto-tag')){}
else if(!self.serverSide||self.currentContainerid)self.filter(self._getFilter());},afterTagRemoved:function(event,ui){if($(ui.tag).hasClass('auto-tag')){if(ui.tag.get(0).onRemove){ui.tag.get(0).onRemove();if(!ui.removingAll)self.refresh();}}
else if(!ui.removingAll&&(!self.serverSide||self.currentContainerid))self.filter(self._getFilter());},afterAllTagsRemoved:function(event,ui){if(!self.serverSide||self.currentContainerid)self.filter(self._getFilter());}});$(actionbar).find('ul.tagit').on('click','li.auto-tag',function(event){if(!$(event.target).is('.tagit-close, .ui-icon'))ui.fire('toggle-filter',{node:$(actionbar).find('.toggle-filter').parent().get(0)});});return this;};AutoTagMultiSelect=function(){};AutoTagMultiSelect.prototype.getSelector=function(){return'button.ui-multiselect';};AutoTagMultiSelect.prototype.isActive=function(){return $(this).find('span.filter').is(".filter-active");};AutoTagMultiSelect.prototype.isImpossible=function(){return $(this).find('span.filter').is(".filter-empty")&&$(this).siblings('select').find('option').size()>0;};AutoTagMultiSelect.prototype.onRemove=function(){$(this).siblings('select').multiselect('checkAll');if($(this).siblings('select').attr('keypath'))ui.set($(this).siblings('select').attr('keypath'),$(this).siblings('select').val()||[]);};AutoTagMultiSelect.prototype.getLabel=function(){return $(this).find('span.filter').text();};AutoTagDatefilter=function(){};AutoTagDatefilter.prototype.getSelector=function(){return'div.datefilter';};AutoTagDatefilter.prototype.isActive=function(){return $(this).find('input.from').val()!=''||$(this).find('input.to').val()!='';};AutoTagDatefilter.prototype.isImpossible=function(){return false;};AutoTagDatefilter.prototype.onRemove=function(){$(this).find('input.from,input.to').val('');};AutoTagDatefilter.prototype.getLabel=function(){var dateFrom=$(this).find('input.from').val();var dateTo=$(this).find('input.to').val();if(dateFrom=='')return translate('before_date')+' '+dateTo;if(dateTo=='')return translate('after_date')+' '+dateFrom;var thisYear=new Date().getFullYear();for(var year=thisYear+1;year>=thisYear-10;year--){var yearStart=new Date(year,0,1);var yearEnd=new Date(year,11,31);if(dateFrom==yearStart.format(locale.date_format_php)&&dateTo==yearEnd.format(locale.date_format_php))return''+year;}
return translate('from')+' '+dateFrom+' '+translate('to')+' '+dateTo;};AutoTagCheckbox=function(){};AutoTagCheckbox.prototype.getSelector=function(){return'input[type=checkbox]:not(.notag)';};AutoTagCheckbox.prototype.isActive=function(){return $(this).is(':checked');};AutoTagCheckbox.prototype.isImpossible=function(){return false;};AutoTagCheckbox.prototype.onRemove=function(){$(this).attr('checked',false);};AutoTagCheckbox.prototype.getLabel=function(){return $(this).attr('filter_label')?$(this).attr('filter_label'):"[missing filter_label in checkbox]";};TimetrackEditableGrid.prototype._getLastTag=function()
{var lis=$(this.actionbar).find('li.tagit-choice');if(lis.size()<=0)return null;return lis.get(lis.size()-1);};TimetrackEditableGrid.prototype.updateAutoTags=function()
{this._updateAutoTags(AutoTagMultiSelect.prototype);this._updateAutoTags(AutoTagDatefilter.prototype);this._updateAutoTags(AutoTagCheckbox.prototype);};TimetrackEditableGrid.prototype._updateAutoTags=function(API)
{var self=this;$(this.actionbar).find(API.getSelector()).each(function(){var source=this;var toRemove=!API.isActive.call(source)&&!API.isImpossible.call(source);var label=API.getLabel.call(source);var tag=null;$(self.actionbar).find('li.tagit-choice').each(function(){if(this.source==source){tag=this;return false;}});if(toRemove){if(tag){tag.onRemove=null;self.tagFilter.tagit('removeTag',tag,true);}}
else{if(!tag){self.tagFilter.tagit('createTag',label,"auto-tag");var tag=self._getLastTag();tag.source=source;tag.onRemove=function(){API.onRemove.call(this.source);};}
$(tag).find("span.tagit-label").html(label);$(tag).find("span.tagit-label").removeClass('filter-active').removeClass('filter-empty').addClass(!API.isImpossible.call(source)?'filter-active':'filter-empty');}});};TimetrackEditableGrid.prototype.filter=function(filter,cols)
{if(this.serverSide){this.wait();if(this.container_id)this.lastURL=this._url();}
return EditableGrid.prototype.filter.call(this,filter,cols);};;function TrackerBasedGrid(name,config){if(name)this.init(name,config);}
TrackerBasedGrid.prototype=new TimetrackEditableGrid();TrackerBasedGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No tracker found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No tracker found matching your search criteria');config.serverSide=false;config.enableSort=false;config.alternate=false;TimetrackEditableGrid.prototype.init.call(this,name,config);};TrackerBasedGrid.prototype.setupTreeTable=function()
{var self=this;$(this.table).addClass("treetable");for(var r=0;r<this.getRowCount();r++){var row=this.getRow(r);row.setAttribute("indent",this.getRowAttribute(r,"indent"));var expanded=this.getRowAttribute(r,"expanded")||this.getRowAttribute(r,"indent")<1;if(this.treeTable&&row.id in this.treeTable.expandedRowIds)expanded=this.treeTable.expandedRowIds[row.id];if(this.getRowAttribute(r,"nb_children")>0)row.setAttribute("expanded",expanded?'1':'');}
this.treeTable=new TreeTable(this.table);};TrackerBasedGrid.prototype.setDefaultRenderers=function()
{var self=this;this.setCellRenderer("name",new CellRenderer({render:function(cell,name){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");$(cell).empty();var content=name;if(isAllowed('jobs','view')&&name&&data_tracker&&data_tracker.id_job>0&&data_tracker.id_job!=ui.get('job.id'))content="<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/job/"+data_tracker.id_job+"/"+ui.get('action')+"'>"+name+"</a>";$(cell).append(content);if(isAllowed('jobs','list')&&name&&data_tracker&&data_tracker.id_template>0&&data_tracker.id_template!=ui.get('template.id')){var color=toRGB('92cdef');var content="<a class='customer_link tooltip' title='"+translate('This tracker is the root of a template. Click to go into this template.','html')+"'  href='"+baseUrl+"/ui/template/"+data_tracker.id_template+"/"+ui.get('action')+"'>"+data_tracker.template_name+"</a>";$(cell).append(" &nbsp; <span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+content+"</span> ");}
if(name.length<=40)$(cell).css('white-space','nowrap');else $(cell).css('white-space','');if(cell.toggleLink)cell.insertBefore(cell.toggleLink,cell.firstChild);$(cell).parent().removeClass("unpaid paid").addClass(self.getRowAttribute(cell.rowIndex,'disabled')==true?"paid":"unpaid");}}));};;function TeamGrid(name,config){if(name)this.init(name,config);}
TeamGrid.prototype=new TrackerBasedGrid();TeamGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No tracker found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No tracker found matching your search criteria');if(typeof config.controller=='undefined')config.controller='team';config.serverSide=false;config.enableSort=false;TrackerBasedGrid.prototype.init.call(this,name,config);this.img_access=img('user_granted');this.img_noaccess=img('user_refused');};TeamGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed(ui.get('job.id')?'jobs':'customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
return true;};TeamGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return this.getColumnName(columnIndex).startsWith('access');};TeamGrid.prototype.tableLoaded=function()
{var self=this;this.setDefaultRenderers();this.setCellRenderer('access',new CellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");var img=data_tracker.access_value_inherited==1?self.img_access:self.img_noaccess;CellRenderer.prototype.render.call(this,cell,img);if(data_tracker.access_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));for(var c=0;c<this.getColumnCount();c++)if(this.getColumnName(c).startsWith("access-")){var id_user=self.getColumnName(c).substr("access-".length);this.setHeaderRenderer(c,new CellRenderer({id_user:id_user,render:function(cell,value){var response=$.evalJSON(value);if(self.getColumnCount()>=10)$(cell).html(response.initials).attr('title',response.fullname+'<br/>'+response.category+'<br/>'+response.tags).css('font-family','Courier').css('font-size','1.15em');else $(cell).html(response.fullname).attr('title',response.category+'<br/>'+response.tags).css('font-family','').css('font-size','');}}));this.setCellRenderer(c,new CellRenderer({id_user:id_user,render:function(cell,dummy){var access=self.getRowAttribute(cell.rowIndex,"access_by_user")[this.id_user];var img=access.user_access_value_inherited==1?self.img_access:self.img_noaccess;CellRenderer.prototype.render.call(this,cell,img);if(access.user_access_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));}
this.render();this.setupTreeTable();};;Ractive.DEBUG=(applicationEnv=='production'?false:true);(function($){var methods={init:function(options){var self=this;if(!options.path&&!options.tag)$.error("jQuery.ractive: 'path' or 'tag' option is mandatory");else{var cache=true;var data=TimetrackRactive.prototype._data(options.path,options.data);var ractiveClass=options.ractiveClass||TimetrackRactive;var ractiveInstance=null;if(options.tag)ractiveInstance=new ractiveClass({el:self,template:'#'+options.tag,data:data});else{if(options.path.endsWith('.ractive')){$.ajax(baseUrl+'/ractive/'+options.path+versionParam,{dataType:"text",cache:cache,async:false}).done(function(template){ractiveInstance=new ractiveClass({el:self,template:template,data:data});});}
else{$.ajax(baseUrl+'/ractive/'+options.path+'.json',{dataType:"json",cache:cache,async:false}).done(function(response){if(response&&response.template&&response.partials){ractiveInstance=new ractiveClass({el:self,template:response.template,partials:response.partials,data:data});for(partial in response.partials)Ractive.partials[partial]=response.partials[partial];}
else ractiveInstance=new ractiveClass({el:self,template:response,data:data});});}}}
this.instance=function(){return ractiveInstance;};return this;}};$.fn.ractive=function(options)
{if(typeof options==='object'||!options)return methods.init.apply(this,arguments);$.error('There are no methods available on jQuery.ractive');};})(jQuery);var TimetrackRactive=Ractive.extend({onrender:function(options){this._setup(options);},_data:function(name,data){var data=data||{};data['_name']=name;data['version']=version;data['baseUrl']=baseUrl;data['avatarUrl']=avatarUrl;data['skinUrl']=skinUrl;data['applicationEnv']=applicationEnv;data['id_logged_user']=id_logged_user;data['managed_users']=managed_users;data['isAllowed']=isAllowed;data['isEnabled']=isEnabled;data['translate']=translate;data['cssColor']=cssColor;data['toRGB']=toRGB;data['dimColor']=dimColor;data['getFrontColor']=getFrontColor;data['getDisplayTime']=getDisplayTime;data['amount_format']=amount_format;data['number_format']=number_format;data['camel_case']=camel_case;data['helpboxhtml']=helpbox;data['img']=img;data['imgsrc']=imgpath;data['get_gravatar']=get_gravatar;data['nl2br']=nl2br;data['config']=config;data['locale']=locale;data['AppConfig']=AppConfig;data['now']=function(){return new Date();};data['toJSON']=function(o){return jQuery.toJSON(o);};data['wWidth']=function(){return $(window).width();};data['wHeight']=function(){return $(window).height();};return data;},reset:function(data){Ractive.prototype.reset.call(this,this._data(this.get('_name'),data));}});TimetrackRactive.prototype.dispose=function()
{};TimetrackRactive.prototype._dispose=function()
{this.dispose();};TimetrackRactive.prototype.setup=function(options)
{};TimetrackRactive.prototype._setup=function(options)
{this.on('teardown',function(){this._dispose();});this.setup(options);};function buildTopMenu()
{if(config.menutop.length==0){var hrefs=[];$('#menu .left_menu:not(.back) div a[href][favorite]').each(function(){hrefs.push($(this).attr('href'));});return hrefs.length>0?_ajax('config/usermenu',{hrefs:hrefs,ordered:true}):true;}
$('#menutop ul li').remove();for(var i=0;i<config.menutop.length;i++)$('#menu .left_menu:not(.back) div a[href]').each(function(){if($(this).attr('href').endsWith(config.menutop[i]))$('#menutop ul').append($('<li>').append($('<a>').attr('href',$(this).attr('href')).attr('hilite',$(this).attr('hilite')).html($(this).html())));});$('#menu .favorite').remove();$('#menu .left_menu:not(.back) div a[href]').each(function(){var favorite=$('#menutop a[href="'+$(this).attr('href')+'"]').size()>0;$(this).before($('<div>').addClass('favorite').addClass(favorite?"on":"").html(img('favorite')).click(function(){$(this).toggleClass('on');var hrefs=[];$('#menu .favorite.on').each(function(){hrefs.push($(this).next('a').attr('href'));});_ajax('config/usermenu',{hrefs:hrefs,ordered:false});}));});var removeIntent=false;$('#menutop ul').sortable({distance:5,over:function(){removeIntent=false;},out:function(){removeIntent=true;},beforeStop:function(event,ui){if(removeIntent)ui.item.remove();},stop:function(event,ui){var hrefs=[];$('#menutop li a').each(function(){hrefs.push($(this).attr('href'));});_ajax('config/usermenu',{hrefs:hrefs,ordered:true});}});}
var MenuRactive=TimetrackRactive.extend({hilite:function(){var activeUrl=Backbone.history.fragment?baseUrl+'/ui/'+Backbone.history.fragment:window.location.href.toString().split(window.location.host)[1];activeUrl=activeUrl.replace('/ui/','/');$('#menu .left_menu:not(.back) li a[href]').removeClass('active').each(function(){var menuUrl=($(this).attr('hilite')||$(this).attr('href')).replace('/ui/','/');if(activeUrl==menuUrl||activeUrl.startsWith(menuUrl+'/')){$('#menu .left_menu li').removeClass('active');$(this).parent().addClass('active');}});$('#menutop ul a[href]').removeClass('active').each(function(){var menuUrl=($(this).attr('hilite')||$(this).attr('href')).replace('/ui/','/');if(activeUrl==menuUrl||activeUrl.startsWith(menuUrl+'/')){$('#menutop li a').removeClass('active');$(this).addClass('active');}
if(activeUrl==menuUrl)return false;});var compactTabs=$('ul.tabmenu li a[href]').size()>=12;if(compactTabs)$('ul.tabmenu li a[href]').each(function(){if(!this.icon){this.icon=$(this).find('i');this.hasIcon=this.icon.size()>0;this.tabname=$(this).addBack().contents().filter(function(){return this.nodeType==3;}).text();}});$('ul.tabmenu li').removeClass('active').find('a[href]').each(function(){var menuUrl=($(this).attr('hilite')||$(this).attr('href')).replace('/ui/','/');if(activeUrl==menuUrl||activeUrl.startsWith(menuUrl+'/')){$('ul.tabmenu li').removeClass('active');$(this).closest('li').addClass('active');if(compactTabs){$('ul.tabmenu li a[href]').each(function(){if(this.hasIcon)$(this).html(this.icon.attr('tooltip',this.tabname));});if(this.hasIcon)$(this).html(this.icon.removeAttr('tooltip')).append(this.tabname);}}});$('div.subtabmenu a[href]').removeClass('blue').each(function(){var menuUrl=($(this).attr('hilite')||$(this).attr('href')).replace('/ui/','/');if(activeUrl==menuUrl||activeUrl.startsWith(menuUrl+'/')){$('div.subtabmenu a').removeClass('blue');$(this).addClass('blue');}});},hilited:function(){return $('#menu .left_menu:not(.back) div a[href].active').size()>0;}});var MenuDecorator=function(node,content){$(".ui-tooltip").remove();$(node).find('h3').each(function(){if($(this).next().find('a').size()==0)$(this).hide().next().hide();else $(this).show().next().show();});if(applicationEnv=='development')$(node).find('a[href]').each(function(){if(!$(this).attr('href').startsWith(baseUrl+'/ui'))$(this).after(' <i class="fa fa-warning fa-inverse" style="font-size:0.7em"></i>');});buildTopMenu();if(menutop)menutop.observe('config.menutop',buildTopMenu);return{teardown:function(){}};};Ractive.decorators.menu_links=MenuDecorator;var DatePickerDecorator=function(node,content)
{$(node).datepicker({dateFormat:locale.date_format_jquery,changeMonth:true,changeYear:true}).on('change',function(){ui.updateModel();});return{teardown:function(){}};};Ractive.decorators.datepicker=DatePickerDecorator;var TinyMCEDecorator=function(node,content)
{if(!$(node).attr('id'))$(node).attr('id',"TinyMCE_"+Math.ceil(Math.random()*100000)+'_'+(new Date().getTime()));tinyMceInit();try{tinymce.execCommand('mceAddEditor',false,$(node).attr('id'));}catch(ex){}
return{teardown:function(){try{tinymce.execCommand('mceRemoveEditor',false,$(node).attr('id'));}catch(ex){}}};};Ractive.decorators.tinymce=TinyMCEDecorator;Ractive.decorators.select2.type.standard={minimumResultsForSearch:10,dropdownCssClass:'ui-dialog'};Ractive.decorators.select2.type.form={width:400,minimumResultsForSearch:10,dropdownCssClass:'ui-dialog'};Ractive.decorators.select2.type.form320={width:320,minimumResultsForSearch:10,dropdownCssClass:'ui-dialog'};$(function(){$.ajax(baseUrl+'/ractive/components-'+version+'.json',{dataType:"json",cache:true,async:false}).done(function(components){for(var comp in components){Ractive.components[comp]=TimetrackRactive.extend({isolated:comp=="multiselect",template:components[comp],data:function(){return TimetrackRactive.prototype._data(comp);}});}});});;var MainRouter=Backbone.Router.extend({observers:[],routes:{"(/)":"_default","customer(/)":"customer_index","customer/index(/)":"customer_index","customer/tracker/:id(/:panel)(/)":"customer_view_tracker","customer/:id/followup(/:panel)(/)":"customer_view_followup","customer/:id(/:panel)(/)":"customer_view","customer/:id/custom/:id_table(/)":"customer_customtable","supplier(/)":"supplier_index","supplier/index(/)":"supplier_index","supplier/:id(/:panel)(/)":"supplier_view","job(/)":"job_index","job/index/merge(/)":"job_index","job/index(/)":"job_index","job/gantt(/)":"job_gantt","job/:id/estimate/index(/)":"job_view_estimate_index","job/:id/estimate/:id_estimate(/)":"job_view_estimate_view","job/:id/followup(/:panel)(/)":"job_view_followup","job/:id(/:panel)(/)":"job_view","dueschedule/customer/:id_customer(/:year)(/)":"dueschedule_customer","dueschedule/task/:id_task(/:year)(/)":"dueschedule_task","staffcost/index(/:year)(/)":"staffcost_index","forecastcustomerfees/index(/:year)(/)(:id_customer)(/)":"forecastcustomerfees_index","user(/index)(/)":"user_index","user/pricecategory":"user_pricecategory","user/:id_user(/:panel)(/)":"user_view","template(/index)(/)":"template_index","template/:id_template(/:panel)(/)":"template_view","estimate(/index)(/)":"estimate_index","estimate/:id_estimate(/:tab)(/)":"estimate_view","invoice/add(/tracker/:id_tracker)(/)":"invoice_add","invoice/recurrent(/)":"invoice_recurrent","invoice/block/:id_block(/:tab)(/)":"invoice_view_block","invoice/index/:status(/)":"invoice_index","invoice(/index)(/)":"invoice_index","invoice/recurrent/:id_invoice(/:tab)(/)":"invoice_view_recurrent","invoice/:id_invoice(/:tab)(/)":"invoice_view","contact/index/:id_event(/)":"contact_index","contact(/index)(/)":"contact_index","contact/:id_contact(/:panel)(/)":"contact_view","report(/)(:category)(/)(:id_report)(/)(:params)(/)":"report_index","timesheet(/index)(/user/:id_user)(/date/:date)(/)":"timesheet_index","dashboard(/widgets/:widgets)(/)":"dashboard_index","config/account(/)":"config_account","config(/:tab)(/)":"config_index",":controller(/)(:action)(/)":"_default"},_default:function(controller,action){router.navigate((controller||'dashboard')+(action?'/'+action:''),{trigger:false,replace:true});this._route(controller||'dashboard',action||'index');},customer_index:function(){this._route('customer','index');},customer_view_tracker:function(id_tracker,panel){if(isNaN(id_tracker))jerror("Invalid URL: non-numerical ID found in customer/tracker/:id_tracker(/:panel)");else this._route('customer',(panel||'general'),{id_tracker:id_tracker});},customer_view_followup:function(id,panel){var default_panel=isAllowed('timesheet','list')?'timesheet_entry':(isAllowed('items','list')?'item_entry':'cost_entry');if(!panel)router.navigate('/customer/'+id+'/followup/'+default_panel,{trigger:false,replace:true});return this.customer_view(id,panel||default_panel);},customer_view:function(id,panel){if(isNaN(id))jerror("Invalid URL: non-numerical ID found in customer/:id(/:panel)");else{if(!panel)router.navigate('/customer/'+id+'/overview',{trigger:false,replace:true});this._route('customer',(panel||'overview'),{id:id});}},customer_customtable:function(id,id_table){if(isNaN(id)||isNaN(id_table))jerror("Invalid URL: non-numerical ID found in supplier/:id/custom/:id_table");else this._route('customer',"customtable",{id:id,id_table:id_table});},supplier_index:function(){this._route('supplier','index');},supplier_view:function(id,panel){if(isNaN(id))jerror("Invalid URL: non-numerical ID found in supplier/:id(/:panel)");else{if(!panel)router.navigate('/supplier/'+id+'/general',{trigger:false,replace:true});this._route('supplier',(panel||'general'),{id:id});}},job_index:function(){this._route('job','index');},job_gantt:function(){this._route('job','gantt');},job_view_estimate_index:function(id){if(isNaN(id))jerror("Invalid URL: non-numerical ID found in job/:id/estimate/index");else this._route('job','estimate',{id:id,id_estimate:'list'});},job_view_estimate_view:function(id,id_estimate){if(isNaN(id)||isNaN(id_estimate))jerror("Invalid URL: non-numerical ID found in job/:id/estimate/:id_estimate");else this._route('job','estimate',{id:id,id_estimate:id_estimate});},job_view_followup:function(id,panel){var default_panel=isAllowed('timesheet','list')?'timesheet_entry':(isAllowed('items','list')?'item_entry':'cost_entry');if(!panel)router.navigate('/job/'+id+'/followup/'+default_panel,{trigger:false,replace:true});return this.job_view(id,panel||default_panel);},job_view:function(id,panel){if(isNaN(id))jerror("Invalid URL: non-numerical ID found in job/:id(/:panel)");else{if(!panel)router.navigate('/job/'+id+'/overview',{trigger:false,replace:true});this._route('job',(panel||'overview'),{id:id});}},dueschedule_customer:function(id_customer,year){if(isNaN(id_customer))jerror("Invalid URL: non-numerical ID found in dueschedule/customer/:id_customer");else this._route('dueschedule','customer',{year:isNaN(year)?new Date().getFullYear():year,id_customer:id_customer});},dueschedule_task:function(id_task,year){if(isNaN(id_task))jerror("Invalid URL: non-numerical ID found in dueschedule/task/:id_task");else this._route('dueschedule','task',{year:isNaN(year)?new Date().getFullYear():year,id_task:id_task});},staffcost_index:function(year){this._route('staffcost','index',{year:isNaN(year)?null:year});},forecastcustomerfees_index:function(year,id_customer){this._route('forecastcustomerfees','index',{year:isNaN(year)||year==0?null:year,id_customer:isNaN(id_customer)?null:id_customer});},user_pricecategory:function(){this._route('user','pricecategory');},user_index:function(){this._route('user','index');},user_view:function(id_user,tab){if(isNaN(id_user))jerror("Invalid URL: non-numerical ID found in user/:id_user(/:tab)");else if(ui.get('ui')=='user_view'&&ui.get('user.id')==id_user)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/user/'+id_user+'/history',{trigger:false,replace:true});this._route('user','view',{id:id_user,tab:tab||'history'});}},template_index:function(){var id_template=config.tracker.id_root_template;var default_panel=isAllowed('timesheet','list')?'tracker':'item_pattern';router.navigate('/template/'+id_template+'/'+default_panel,{trigger:false,replace:true});this._route('template',default_panel,{id_template:id_template});},template_view:function(id_template,panel){if(isNaN(id_template))jerror("Invalid URL: non-numerical ID found in template/:id_template(/:panel)");else{var default_panel=isAllowed('timesheet','list')?'tracker':'item_pattern';if(!panel)router.navigate('/template/'+id_template+'/'+default_panel,{trigger:false,replace:true});this._route('template',(panel||default_panel),{id_template:id_template});}},estimate_index:function(){this._route('estimate','index');},estimate_view:function(id_estimate,tab){if(isNaN(id_estimate))jerror("Invalid URL: non-numerical ID found in estimate/:id_estimate(/:tab)");else if(ui.get('ui')=='estimate_view'&&ui.get('estimate.id')==id_estimate)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/estimate/'+id_estimate+'/general',{trigger:false,replace:true});this._route('estimate','view',{id_estimate:id_estimate,tab:tab||'general'});}},invoice_index:function(status){this._route('invoice','index',{status_type:status?AppConfig['INVOICE_STATUS_'+status.toUpperCase()]:null});},invoice_add:function(id_tracker){this._route('invoice','add',{id_tracker:id_tracker});},invoice_recurrent:function(){this._route('invoice','recurrent');},invoice_view:function(id_invoice,tab){if(id_invoice!='last'&&isNaN(id_invoice))jerror("Invalid URL: non-numerical ID found in invoice/:id_invoice(/:tab)");else if(ui.get('ui')=='invoice_view'&&ui.get('invoice.id')==id_invoice)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/invoice/'+id_invoice+'/general',{trigger:false,replace:true});this._route('invoice','view',{id_invoice:id_invoice,tab:tab||'general'});}},invoice_view_recurrent:function(id_invoice,tab){if(id_invoice!='last'&&isNaN(id_invoice))jerror("Invalid URL: non-numerical ID found in invoice/:id_invoice(/:tab)");else if(ui.get('ui')=='invoice_view'&&ui.get('invoice.id')==id_invoice)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/invoice/recurrent/'+id_invoice+'/general',{trigger:false,replace:true});this._route('invoice','view',{id_invoice:id_invoice,tab:tab||'general'});}},invoice_view_block:function(id_block,tab){if(isNaN(id_block))jerror("Invalid URL: non-numerical ID found in invoice/block/:id_block(/:tab)");else if(ui.get('ui')=='invoice_view'&&ui.get('id_block')==id_block)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/invoice/block/'+id_block+'/general',{trigger:false,replace:true});this._route('invoice','view',{id_block:id_block,tab:tab||'general'});}},contact_index:function(id_event){this._route('contact','index',{id_event:id_event?id_event:null});},contact_view:function(id_contact,tab){if(isNaN(id_contact))jerror("Invalid URL: non-numerical ID found in contact/:id_contact(/:tab)");else if(ui.get('ui')=='contact_view'&&ui.get('contact.id')==id_contact)this.screen_controller.setTab(tab);else{if(!tab)router.navigate('/contact/'+id_contact+'/general',{trigger:false,replace:true});this._route('contact','view',{id:id_contact,tab:tab||'general'});}},report_index:function(category,id_report,params){var parameter=null;try{parameter={category:category,id_report:id_report,params:$.parseJSON(params)};}
catch(e){console.error(e);parameter={category:category,id_report:id_report};}
if(ui.get('ui')=='report_index')this.screen_controller.go(parameter);else this._route('report','index',parameter);},timesheet_index:function(id_user,date){this._route('timesheet','index',{id_user:id_user,date:date});},dashboard_index:function(widgets){this._route('dashboard','index',{widgets:widgets});},config_account:function(){this._route('config','account');},config_index:function(tab){this._route('config','index',{mode:'config',tab:(tab=='index'?null:tab)});},_route:function(controller,action,parameter)
{this._controller=controller;var self=this;var screen=controller+'_'+action;var url=controller.replace('_','')+'/'+action;if(menu){if(parameter)menu.set(parameter);menu.hilite();if(parameter)menutop.set(parameter);menutop.hilite();}
$('body, #wrap').removeClass('on');showWait();if(this.screen_controller){this.screen_controller.dispose();delete this.screen_controller;}
_ajax(url,parameter).done(function(data){self.parameter=parameter;for(i=0;i<self.observers.length;i++)self.observers[i].cancel();ui.reset();ui.off();$('#clone_table, .ui-multiselect-menu, .ui-widget').remove();ui.set($.extend(parameter,data,{ui:screen,action:action}));if(menu){menu.set(data);menu.hilite();}
var classname=screen.camelCase(true);if(typeof window[classname]!='function')$('#content').append($('<div>').css('color','red').html("Missing class: "+classname)).show();else{self.screen_controller=new window[classname]();if(typeof self.screen_controller.bootstrap!='function')$('#content').append($('<div>').css('color','red').html("Missing function: "+classname+'.bootstrap(parameter)')).show();else{self.screen_controller.reload=function(_parameter){console.info('Reloading '+controller+'/'+action+'...');self._route(controller,action,_parameter?merge(parameter,_parameter):parameter);};self.screen_controller.refresh=function(_parameter){console.info('Refreshing '+controller+'/'+action+'...');return _ajax(url,_parameter?merge(parameter,_parameter):parameter).done(function(data){ui.set(data);});};self.screen_controller.bootstrap(parameter);}}
console.info('Done loading '+controller+'/'+action);});}});;function TrackerSelector(config){this.init(config);}
TrackerSelector.prototype.init=function(config)
{this.cell_from=null;this.cell_to=null;this.showTrackerAction=null;this.renderText=function(node,info,trackerText){return trackerText;};this.renderTooltip=function(node,info,tooltip){return tooltip;};this.name='trackerSelector';this.prefix='';for(var p in config)this[p]=config[p];this.tree=null;this.flatNodes=null;this.block=null;var selector=this;this.blocks=new Blocks('selector',{handle_style:'selector-handle',handles:['ml','mr'],xSpace:0,ySpace:0,resizeHandleMode:ResizeHandle_ALWAYS,handleDragEvent:function(block,eventType,isSnapping){return selector.handleDragEvent(block,eventType,isSnapping);}});};TrackerSelector.prototype.getTimeInterval=function()
{with(this){var boundsInGrid=blocks.getBlockBoundsInGrid(block,"x");if(boundsInGrid!=null&&boundsInGrid.cell_tl!=null&&boundsInGrid.cell_br!=null){$('#'+this.prefix+'dateinterval_from').val(getFormattedDate(boundsInGrid.cell_tl));$('#'+this.prefix+'dateinterval_to').val(getFormattedDate(boundsInGrid.cell_br));cell_from=boundsInGrid.cell_tl;cell_to=boundsInGrid.cell_br;return{start:parseInt(cell_from.id),end:parseInt(cell_to.id)};}
console.error("TrackerSelector: no time interval found!");}};TrackerSelector.prototype.handleDragEvent=function(block,eventType,isSnapping)
{if(eventType==DragEvent_DRAGMOVE||eventType==DragEvent_DRAGRESIZE){this.getTimeInterval();}
else if(eventType==DragEvent_DRAGEND&&this.blocks.hasMoved){this.onTimePeriodChanged();}};TrackerSelector.prototype.getFormattedDate=function(cell)
{var ts=parseInt(cell.id);var tz_offset=parseInt($(cell).attr('tzo'));return getDate(ts,tz_offset).format(locale.date_format_php,true);};TrackerSelector.prototype.getCell=function(formattedDate)
{var cell=null;var selector=this;$('#calendar_table_body td').each(function(){if(selector.getFormattedDate(this).replace(/^0/,"").replace("/0","/")==formattedDate.replace(/^0/,"").replace("/0","/")){cell=this;return false;}});return cell;};TrackerSelector.prototype.dateChanged=function(formattedDate,id)
{var cellForDate=this.getCell(formattedDate);if(cellForDate==null)this.getTimeInterval();else{if(id=='dateinterval_from')this.cell_from=cellForDate;else this.cell_to=cellForDate;this._dateSet();}};TrackerSelector.prototype.dateShortcut=function(shortcut)
{var cellForDateFrom=null;var cellForDateTo=null;if(!shortcut){cellForDateFrom=$('#calendar_table_body td:first').get(0);cellForDateTo=$('#calendar_table_body td:last').get(0);}
else{cellForDateFrom=shortcut['from']?this.getCell(shortcut['from']):$('#calendar_table_body td:first').get(0);cellForDateTo=shortcut['to']?this.getCell(shortcut['to']):$('#calendar_table_body td:last').get(0);}
if(cellForDateFrom==null||cellForDateTo==null)this.getTimeInterval();else{this.cell_from=cellForDateFrom;this.cell_to=cellForDateTo;this._dateSet();}};TrackerSelector.prototype._dateSet=function()
{if(parseInt(this.cell_from.id)>parseInt(this.cell_to.id)){var tmp_cell=this.cell_from;this.cell_from=this.cell_to;this.cell_to=tmp_cell;}
this.blocks.deleteBlock(this.block);this.block=this.blocks.createBlockInGrid(0,this.cell_from.c,0,this.cell_to.c,'SelectorBlock SelectorMoveableBlock','SelectorMovingBlock',null);this.onTimePeriodChanged();};TrackerSelector.prototype.apply=function(cell_start,cell_end)
{var getLocalJsDateForCell=function(cell){var date=getDate(parseInt(cell.id),parseInt($(cell).attr('tzo')));date.setTime(date.getTime()+date.getTimezoneOffset()*60000);return date;};var selector=this;$(".datepicker").datepicker({dateFormat:locale['date_format_jquery'],minDate:getLocalJsDateForCell($('#calendar_table_body td:first').get(0)),maxDate:getLocalJsDateForCell($('#calendar_table_body td:last').get(0)),onSelect:function(){selector.dateChanged($(this).val(),$(this).attr('id'));}});$(".datepicker").change(function(){selector.dateChanged($(this).attr(),$(this).attr('id'));});$('.button.shortcut').click(function(){selector.dateShortcut(window['shortcut_'+$(this).attr('rel')]);});with(this){blocks.apply(_$('calendar_table'),true,true,10);window.onresize=function(e){var blockList=blocks.getBlocks();for(var i=0;i<blockList.length;i++)blocks.getBlockBoundsInGrid(blockList[i]);blocks.apply(_$('calendar_table'),true,true,10);blocks.reformatAllBlocks();};if(UserAgentBrowser.IE7&&hashscrollbar(blocks.container))$(blocks.container).css({height:($(blocks.container).height()+17)+'px'});block=blocks.createBlockInGrid(0,cell_start.c,0,cell_end.c,'SelectorBlock SelectorMoveableBlock','SelectorMovingBlock',null);blocks.container.scrollLeft=blocks.container.scrollWidth;this.onTimePeriodChanged(true);}};TrackerSelector.prototype.getSelectedTrackers=function()
{var selector=this;var trackerIds=[];$("img.checkbox").each(function(){if(Math.floor($(this).attr("img_checked"))>=1)trackerIds.push(Math.floor(this.id.substr(selector.prefix.length+4)));});return trackerIds;};TrackerSelector.prototype.hasTrackers=function()
{return $("img.checkbox").size()>0;};TrackerSelector.prototype.getSelectedUsers=function()
{var userIds=[];$(':checkbox.user_select_checkbox').each(function(){if($(this).is(":checked"))userIds.push($(this).val());});return userIds;};TrackerSelector.prototype.wait=function(message)
{$('#'+this.prefix+'select_header').css('display','none');$('#'+this.prefix+'noselect_header').css('display','none');$('#'+this.prefix+'buttons').css('display','none');$('#'+this.prefix+'trackers').html("<center><div style='width:250px;text-align:center'>"+img('wait','','','margin-top:10px;margin-bottom:10px')+"<br/>"+translate(message)+"...</div></center>");};TrackerSelector.prototype.fixTrackerHeight=function()
{if($('#'+this.prefix+'sidepanel').size()>0)$('#'+this.prefix+'trackers').css('min-height',($('#'+this.prefix+'sidepanel').height()-25)+'px');var fillInHeight=window_height()-$('#'+this.prefix+"trackers").offset().top-parseInt($("#content").css("padding-bottom"))-parseInt($(".boxcontent").css("padding-bottom"));if($('#tabs').size()>0)fillInHeight=fillInHeight-parseInt($('#tabs').css("padding-bottom"))-parseInt($('#tabs-selector').css("padding-bottom"))-2;$('#'+this.prefix+"trackers").css('max-height',fillInHeight+'px');$('#'+this.prefix+"sidepanel").css('right',hasvscrollbar(_$(this.prefix+'trackers'))?'50px':'30px');};TrackerSelector.prototype.reload=function(restoreSelection,additionalTrackerIds,additionalUserIds,after)
{var selector=this;with(this){var selection={};if(restoreSelection){$("img.checkbox").each(function(){selection[Math.floor(this.id.substr(4))]=Math.floor($(this).attr("img_checked"));});}
wait("Loading trackers");var interval=getTimeInterval();if(interval){interval.userIds=this.getSelectedUsers();if(additionalUserIds&&interval.userIds!==null)interval.userIds=interval.userIds.concat(additionalUserIds);ajax(showTrackerAction,interval,function(result){selector.renderTrackers(result,restoreSelection?selection:false,additionalTrackerIds);selector.renderUsers(result);selector.fixTrackerHeight();if(after)after();},"json");}}};TrackerSelector.prototype.onTimePeriodChanged=function(firstTime)
{var self=this;var selection={};if(!firstTime)$("img.checkbox").each(function(){selection[Math.floor(this.id.substr(4))]=Math.floor($(this).attr("img_checked"));});var interval=this.getTimeInterval();interval.userIds=null;this.wait("Loading trackers");$('#'+this.prefix+'users').empty().removeClass("user_box");ajax(this.showTrackerAction,interval,function(result){self.renderTrackers(result,firstTime?false:selection);self.renderUsers(result);self.fixTrackerHeight();},"json");};TrackerSelector.prototype.setCheckbox=function(image,checked)
{$(image).attr("img_checked",checked);image.src=imgpath(checked==1?'selector_tracker_selected':(checked==2?'selector_tracker_partly_selected':'selector_tracker_not_selected'));};TrackerSelector.prototype.toggleCheckbox=function(node_index)
{var start_level=this.flatNodes[node_index].level;var image=_$(this.flatNodes[node_index].img_id);var curcheck=Math.floor(image.getAttribute("img_checked"));var checked=curcheck==1?0:1;this.setCheckbox(image,checked);for(var index=node_index+1;index<this.flatNodes.length&&this.flatNodes[index].level>start_level;index++)this.setCheckbox(_$(this.flatNodes[index].img_id),checked);for(var index=this.flatNodes[node_index].parent_index;index!==null;index=this.flatNodes[index].parent_index)if(!this.flatNodes[index].worked)this._updateParent(index);};TrackerSelector.prototype._updateParent=function(node_index)
{var checked=-1;var start_level=this.flatNodes[node_index].level;for(var index=node_index+1;index<this.flatNodes.length&&this.flatNodes[index].level>start_level&&checked!=2;index++){var image=_$(this.flatNodes[index].img_id);var this_checked=Math.floor(image.getAttribute("img_checked"));if(checked<0)checked=this_checked;else if(this_checked!=checked)checked=2;}
if(checked>=0){var image=_$(this.flatNodes[node_index].img_id);this.setCheckbox(image,checked);}};TrackerSelector.prototype.buildTree=function(nodes,id_parent,matchingTrackers,level)
{with(this){var parent_index=id_parent=="root_search_result_tracker"?null:flatNodes.length-1;for(var index=0;index<nodes.length;index++)
{var node=nodes[index];var img_id=this.prefix+'chk_'+node.id;var imgClass='checkbox';var tooltip='';var title=typeof node.title=='undefined'||node.title===node.name?'':node.title;var description=(node.description===node.name||node.description===title)?'':node.description;if(title!='')tooltip+=title+"<br/>";if(description!='')tooltip+=description;var trackerText=node.name==null?"[no name]":htmlspecialchars(node.name);var worked=false;var info=null;if(node.id in matchingTrackers){info=matchingTrackers[node.id];worked=info.worked;if(info.selected)imgClass+=' selected';}
trackerText=renderText(node,info,trackerText);tooltip=renderTooltip(node,info,tooltip);if(level==0&&nodes.length==1)imgClass+=' selected';var input='<img class="'+imgClass+'" src="'+imgpath('selector_tracker_not_selected')+'" id_tracker="'+node.id+'" id="'+img_id+'" position="'+flatNodes.length+'" img_checked=0 style="cursor:pointer"'+'/>&nbsp;';flatNodes.push({img_id:img_id,level:level,parent_index:parent_index,worked:worked});tree.add(node.id,id_parent,trackerText,input,'',tooltip,'','','',node.expanded,false);if(node.children)buildTree(node.children,node.id,matchingTrackers,level+1);}}};TrackerSelector.prototype.renderTrackers=function(result,selection,additionalTrackerIds)
{var self=this;if(result)with(this){var rootNodes=result.trees;var matchingTrackers=result.matchingTrackers?result.matchingTrackers:{};var totalAmount=result.totalAmount?result.totalAmount:0;tree=new dTree(this.name+'.tree');tree.config.inOrder=true;tree.config.useSelection=false;tree.config.useCookies=false;tree.config.useLines=false;tree.config.folderLinks=true;tree.add("root_search_result_tracker",-1,'','','','','','',false);flatNodes=[];buildTree(rootNodes,"root_search_result_tracker",matchingTrackers,0);if(totalAmount)$('#totalAmount').show().find('span').html(totalAmount);else $('#totalAmount').hide();$('#'+this.prefix+'trackers').html(rootNodes.length>0?tree.toString():'');$('#'+this.prefix+'buttons').css('display',($('#buttons a').size()>0&&rootNodes.length>0)?'block':'none');$('#actionbar').css('display',rootNodes.length>0?'block':'none');$('#'+this.prefix+'select_header').css('display',rootNodes.length>0?'block':'none');$('#'+this.prefix+'noselect_header').css('display',rootNodes.length>0?'none':'block');$('img.checkbox').click(function(){self.toggleCheckbox(parseInt($(this).attr('position'),10));});$('img.selected').each(function(){if(selection&&typeof selection[$(this).attr("id_tracker")]=='undefined')selection[$(this).attr("id_tracker")]=1;if(Math.floor($(this).attr("img_checked"))!=1)$(this).trigger('click');});$('#'+this.prefix+'trackers div.dTreeNode[title]').each(function(){$(this).attr('tooltip',$(this).attr('title')).attr('title','');}).scrolltip({noanimation:true,content:function(){return $(this).attr("tooltip");},onshow:function(tip){var indent=tip.parent().find('>img').size()+tip.parent().find('a.collapse').size();tip.css('max-width','640px').position({my:'left top',at:'left+'+(indent*18+150)+' bottom',of:tip.parent()});}});if(selection){selectAllTrackers(false);for(var trackerId in selection){var image=_$(this.prefix+'chk_'+trackerId);if(image)setCheckbox(image,selection[trackerId]);}
if(additionalTrackerIds)for(var c=0;c<additionalTrackerIds.length;c++){var image=_$(this.prefix+'chk_'+additionalTrackerIds[c]);var curcheck=Math.floor($(image).attr("img_checked"));if(curcheck!=1)$(image).trigger('click');}}
return(rootNodes.length>0);}
return false;};TrackerSelector.prototype.renderUsers=function(result)
{$('#'+this.prefix+"users").empty().removeClass("user_box");var self=this;if(result)with(this){for(id_user in result.users){if(typeof result.users[id_user]=='function')continue;var checkbox=$("<input>").attr('type','checkbox').addClass('user_select_checkbox').val(id_user).click(function(){reload(false);});$('#'+this.prefix+"users").addClass("user_box").append($("<p>").append(checkbox).append(' '+result.users[id_user]));checkbox.attr('checked',$.inArray(id_user,result.selectedUsers)>=0);}
if($('#'+this.prefix+"users :checkbox").size()>0)$('#'+this.prefix+"users").prepend($("<p>").append($('<a>').css('cursor','pointer').html(translate("Select none")).click(function(){$('#'+self.prefix+"users :checkbox").attr('checked',false);self.reload(false);})).append(' / ').append($('<a>').css('cursor','pointer').html(translate("Select all")).click(function(){$('#'+self.prefix+"users :checkbox").attr('checked',true);self.reload(false);})));}};TrackerSelector.prototype.collapseAllTrackers=function()
{this.tree.closeAll();};TrackerSelector.prototype.expandAllTrackers=function()
{this.tree.openAll();};TrackerSelector.prototype.selectAllTrackers=function(checked)
{var selector=this;$("img").each(function(){if(this.id.startsWith(selector.prefix+"chk_"))selector.setCheckbox(this,checked?1:0);});};TrackerSelector.prototype.invertTrackerSelection=function()
{var selector=this;$("img").each(function(){if(this.id.startsWith(selector.prefix+"chk_")){var curcheck=Math.floor($(this).attr("img_checked"));var checked=curcheck==1?0:(curcheck==0?1:2);selector.setCheckbox(this,checked);}});};function ItemSelector(config){this.init(config);}
ItemSelector.prototype=new TrackerSelector();ItemSelector.prototype.init=function(config)
{this.onload=function(){};this.hourly=null;for(var p in config)this[p]=config[p];};ItemSelector.prototype.refresh=function(first)
{var self=this;$(this.container).find(".selector_content").hide();$(this.container).find(".selector_wait").show();this.selector=new TrackerSelector({name:'itemSelector.selector',prefix:'item_'});ajax('/item/selector?_html',null,function(result){self.result_selector=result;ajax('/item/tree',{hourly:self.hourly},function(result){self.result_tree=result;self.render();if(first)self.onload.call(self);},"json");});};ItemSelector.prototype.refreshTree=function(filter)
{var self=this;ajax('/item/tree',{hourly:self.hourly,filter:filter},function(result){self.result_tree=result;self.selector.renderTrackers(self.result_tree);if(trim(filter))self.selector.expandAllTrackers();},"json");};ItemSelector.prototype.render=function()
{var self=this;$(this.container).find(".selector_content").html(this.result_selector);this.selector.renderTrackers(this.result_tree);this.selector.collapseAllTrackers();this.selector.selectAllTrackers(false);$('input.tree_quick_filter').unbind('keyup').val('').keyup(function(){self.refreshTree($(this).val());});$(this.container).find(".selector_wait").hide();$(this.container).find(".selector_content").show();};ItemSelector.prototype.getSelectedItems=function()
{var selector=this.selector;var itemIds=[];$("img.checkbox").each(function(){if(Math.floor($(this).attr("img_checked"))==1){var id=this.id.substr(selector.prefix.length+4);itemIds.push(id);}});return itemIds;};function ItemSelectorDialog(config){this.init(config);}
ItemSelectorDialog.prototype.add=function(type,id_items){alert('add not implemented');return true;};ItemSelectorDialog.prototype.init=function(config)
{this.width=670;this.height=400;this.autoOpen=true;this.title=translate('Add items');this.url=null;this.parameters=null;CellEditor.prototype.init.call(this,config);};ItemSelectorDialog.prototype.open=function()
{var self=this;if(typeof this.dialog=='undefined'){showWait(translate("Loading..."));self.dialog=$('<div>').addClass('item_create_dialog').load(baseUrl+this.url,this.parameters,function(){$(document.body).append(self.dialog.hide());$(self.dialog).find('.manual_form').before($('<div>').addClass('radio_zone').append($('<input>').attr('type','radio').attr('name','manual_or_items').attr('value','items').attr('checked',true)).append('&nbsp;&nbsp;'+translate('Catalogue')+'&nbsp;&nbsp;').append($('<input>').attr('type','radio').attr('name','manual_or_items').attr('value','manual')).append('&nbsp;&nbsp;'+translate('Manual item')));$(self.dialog).find('.manual_form').before($('<div>').addClass('selector_wait').append("<center>"+img('wait')+"</center>"));$(self.dialog).find('.manual_form').before($('<div>').addClass('selector_content'));$(self.dialog).find('select[name=id_tracker]').select2({width:500});if(typeof itemSelector!='undefined'){self.itemSelector=itemSelector;$(itemSelector.container).find('.selector_content').html('');itemSelector.container=this;}
else itemSelector=self.itemSelector=new ItemSelector({container:this});self.itemSelector.onload=function(){if(self.itemSelector.result_tree.trees.length==0||!isEnabled('items','list')){$(self.dialog).find(".radio_zone").hide();$(self.dialog).find("input[value='items']:radio").attr('checked',false);$(self.dialog).find("input[value='manual']:radio").attr('checked',true);$(self.dialog).find(".manual_form").show();$(self.dialog).find(".selector_content").hide();}
self.initialize();};self.itemSelector.refresh(true);});}
else{this.dialog.dialog('open');this.itemSelector.selector.selectAllTrackers(false);}};ItemSelectorDialog.prototype.onOpen=function()
{};ItemSelectorDialog.prototype.initialize=function()
{var self=this;hideWait();$(this.dialog).dialog({width:this.width,height:'auto',minHeight:(this.height?this.height:"150"),modal:true,autoOpen:this.autoOpen,title:this.title,open:function(){$(this).find('[name=label]').val('');$(this).find('[name=description]').val('');if($(this).find("input[value='items']:radio").is(':checked'))$(this).find('input.tree_quick_filter').focus();else $(this).find('[name=label]').val('').focus();$(this).find("input[type='radio']").change(function(){if($(this).val()=='manual'){$(self.dialog).find(".selector_content").hide();$(self.dialog).find(".manual_form").show();$(self.dialog).find("[name=label]").focus();}
else if($(this).val()=='items'){$(self.dialog).find(".manual_form").hide();$(self.dialog).find(".selector_content").show();}});self.onOpen();},buttons:[{text:translate("OK"),click:function(){if(self.add(self.dialog.find("input[type='radio']:checked").val(),self.itemSelector.getSelectedItems()))$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});};;function TaskGrid(name,config){if(name)this.init(name,config);}
TaskGrid.prototype=new TimetrackEditableGrid();TaskGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No task found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No task found matching your search criteria');if(typeof config.tracker_enum_provider=='undefined')config.tracker_enum_provider='task/customertrackers';config.controller='task';TimetrackEditableGrid.prototype.init.call(this,name,config);};TaskGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};TaskGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('tasks','edit')){jinfo("You are not authorized to modify tasks.");return false;}
return true;};TaskGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_customer_tracker','id_tracker','id_user','id_status','id_priority','due_date','estimated_hours'])>=0;};TaskGrid.prototype.getActions=function(cell,id_task)
{var self=this;var actions=[];if(isAllowed('tasks','view'))
actions.push({icon:img('invoice_history','history',translate('History')),click:function(){self.showHistory(id_task);}});if(isAllowed('tasks','create'))
actions.push({icon:img('customer_copytracker','copy',translate('Duplicate')),click:function(){self.copyTask(id_task);}});if(isAllowed('tasks','delete'))
actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this task ?',true)))self.deleteTask(id_task);}});return actions;};TaskGrid.prototype.tableLoaded=function()
{var self=this;this.setCellEditor("id",new TaskCellEditor({getParameters:self.getParameters}));this.setCellEditor("title",new TaskCellEditor({getParameters:self.getParameters,forceEdit:isAllowed('tasks','edit')}));this.setCellEditor("created",new TaskCellEditor({getParameters:self.getParameters}));this.setCellEditor("modified",new TaskCellEditor({getParameters:self.getParameters}));if(this.hasColumn('id_customer_tracker'))this.setCellEditor("id_customer_tracker",new TaskCellEditor({getParameters:self.getParameters,forceEdit:isAllowed('tasks','edit')}));this.setCellRenderer("title",new CellRenderer({render:function(cell,value){$(cell).css('text-decoration','underline');CellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description");}}));if(this.tracker_enum_provider)this.setEnumProvider("id_tracker",new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var optionValues=null;_ajax(self.tracker_enum_provider,{id_tracker:self.getValueAt(rowIndex,column.columnIndex)},true).done(function(response){optionValues=response;});return optionValues;}}));this.setCellRenderer('due_date',new DateCellRenderer({render:function(cell,value){DateCellRenderer.prototype.render.call(this,cell,value);var days_late=self.getRowAttribute(cell.rowIndex,'days_late');$(cell).css('color',days_late>0?'red':(days_late>-3?'orange':'green'));}}));if(this.hasColumn('id_status'))this.setCellRenderer("id_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);$(cell.parentNode).addClass(status_type==AppConfig.TASK_STATUS_DONE?"paid":"unpaid").removeClass(status_type==AppConfig.TASK_STATUS_DONE?"unpaid":"paid");if(color=self.getRowAttribute(cell.rowIndex,'status_color')){color=toRGB(color);$(cell).html("<span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+$(cell).html()+"</span>");}
else switch(status_type){case AppConfig.TASK_STATUS_ASSIGNED:$(cell).html("<span class='task_status_assigned'>"+$(cell).html()+"</span>");break;case AppConfig.TASK_STATUS_IN_PROGRESS:$(cell).html("<span class='task_status_in_progress'>"+$(cell).html()+"</span>");break;}
$(cell).css('white-space','nowrap');}}));if(this.hasColumn('id_priority'))this.setCellRenderer("id_priority",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);if(color=self.getRowAttribute(cell.rowIndex,'priority_color')){color=toRGB(color);if(status_type==AppConfig.TASK_STATUS_DONE)color=dimColor(color);$(cell).html("<span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+$(cell).html()+"</span>");}
$(cell).css('white-space','nowrap');}}));if(this.getColumnType('id_user')=="list"){this.setCellEditor("id_user",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No user created yet!")}));this.setCellRenderer("id_user",new MultiselectCellRenderer({noneText:translate('(none_)'),render:function(cell,value){MultiselectCellRenderer.prototype.render.call(this,cell,value);if(!value)$(cell).html('?').parent().css('font-weight','bold');}}));}
else{this.setCellRenderer("id_user",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);if(!value)$(cell).html('?').parent().css('font-weight','bold');}}));}
if(this.hasColumn("tags")){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No tag was created yet. To create a tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
this.render();};TaskGrid.prototype.copyTask=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('task/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the task from database","Error");else{self.refresh();self.onChange();}});};TaskGrid.prototype.deleteTask=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('task/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the task from database","Error");else{self.refresh();self.onChange();}});};TaskGrid.prototype.showHistory=function(id)
{var self=this;ajax('/task/history',{id:id}).done(function(response){jalert(response,false,translate("History"),640);});};;function TaskPanel(){};TaskPanel.prototype=new DefaultScreen();TaskPanel.prototype.getParameters=function()
{return{};};TaskPanel.prototype.init=function(name)
{var self=this;this.grid=new TaskGrid(name+"Grid",{getParameters:function(){var parameter=self.getParameters();parameter.id_users=$('.user_select').val()||[];parameter.id_statuses=$('.status_select').val()||[];parameter.id_tags=$('.tag_select').val()||[];parameter.dfilter=ui.get('parameters.dfilter');return parameter;}});$('a.button.add').click(function(){new TaskEditor({getParameters:function(){return self.getParameters();},afterSave:function(){self.grid.refresh();}}).open();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose assignees")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Assignees"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});ui.on('apply-dfilter',function(event){var candidate=$(event.node).attr('data-filter');ui.set('parameters.dfilter',candidate==ui.get('parameters.dfilter')?null:candidate);self.grid.refresh();});};;function FolderBrowser(){}
FolderBrowser.prototype.getParameters=function()
{return{};}
FolderBrowser.prototype.init=function(controller,grid,accept)
{var self=this;this.controller=controller;this.grid=grid;this.accept=accept;$('#folder_tree').jstree({"core":{"animation":0,'check_callback':function(operation,node,node_parent,node_position,more){if(operation==='copy_node')return false;if(!node.id_folder)return operation!=='create_node';return true;},"themes":{"stripes":true},"icon":"fa fa-folder-o",'data':{type:'POST',dataType:'json',contentType:'application/json; charset=UTF-8',url:function(node){return baseUrl+'/ajax/'+self.controller+'/tree';},data:function(node){return $.toJSON($.extend(self.getParameters(),{'id':node.id}));}},},"contextmenu":{"items":{"create":{label:translate("New folder"),icon:"fa fa-folder-o",action:function(data){var inst=$.jstree.reference(data.reference);var obj=inst.get_node(data.reference);var name=translate("New folder");_ajax(self.controller+'/newfolder',$.extend(self.getParameters(),{id_folder:obj.original.id_folder,name:name})).done(function(response){if(!response)jerror("An error occured while creating the folder");else{inst.create_node(obj,{id:"FOLDER_"+response,id_folder:response,text:name},"last",function(new_node){setTimeout(function(){inst.edit(new_node);},0);});}});}},"rename":{label:translate("Rename"),icon:"fa fa-edit",_disabled:function(data){var inst=$.jstree.reference(data.reference);var obj=inst.get_node(data.reference);return obj.original.id_folder?false:true;},action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.edit(obj);}},"remove":{label:translate("Delete"),icon:"fa fa-times red",_disabled:function(data){var inst=$.jstree.reference(data.reference);var obj=inst.get_node(data.reference);return obj.original.id_folder?false:true;},action:function(data){if(confirm(translate("Are you sure you want to delete this folder ?"))){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);if(inst.is_selected(obj))inst.delete_node(inst.get_selected());else inst.delete_node(obj);}}},}},"plugins":["contextmenu","dnd","wholerow"]});$("#folder_tree").bind("load_node.jstree",function(event,data){if(data.node.id=='#'){if(self.grid.currentFilter)$('#folder_tree').jstree('open_all');else $("#folder_tree").jstree('open_node','#FOLDER_0');}});var _make_droppable=function(event,data){if(!self.grid)return false;var sel=$("#folder_tree div.jstree-wholerow");try{sel.droppable('destroy');}catch(e){}
sel.droppable({accept:self.accept||'tr',tolerance:"pointer",over:function(event,ui){$(this).siblings('a').css('text-decoration','underline');},out:function(event,ui){$(this).siblings('a').css('text-decoration','');},drop:function(event,ui){$(this).siblings('a').css('text-decoration','');var tr=ui.draggable.closest('tr').get(0);var parameter=self.getParameters();parameter['id_'+controller]=self.grid.getRowId(self.grid.getRowIndex(tr));parameter['parent']=$(this).closest('li').attr('id');_ajax(self.controller+'/move'+self.controller,parameter).done(function(response){self.grid.refresh();});}});};$("#folder_tree").on("ready.jstree",_make_droppable);$("#folder_tree").on("after_open.jstree",_make_droppable);$('#folder_tree').on("rename_node.jstree",function(e,data){_ajax(self.controller+'/renamefolder',$.extend(self.getParameters(),{id_folder:data.node.original.id_folder,name:data.text})).done(function(response){_make_droppable.call(e,data);});});$('#folder_tree').on("delete_node.jstree",function(e,data){_ajax(self.controller+'/deletefolder',$.extend(self.getParameters(),{id_folder:data.node.original.id_folder})).done(function(response){_make_droppable.call(e,data);});});$('#folder_tree').on("move_node.jstree",function(e,data){_ajax(self.controller+'/movefolder',$.extend(self.getParameters(),{id_folder:data.node.original.id_folder,parent:data.parent})).done(function(response){_make_droppable.call(e,data);});});$('#folder_tree').on("select_node.jstree",function(e,data){ui.set('id_folder',data.node.original.id_folder);if(self.grid)self.grid.refresh();});};FolderBrowser.prototype.refresh=function()
{$('#folder_tree').jstree(true).refresh();};;function FileBrowser(table){this.init(table);}
FileBrowser.prototype=new FolderBrowser();FileBrowser.prototype.getParameters=function(node)
{return{'table':this.table,'root':ui.get(this.table+'.id')};}
FileBrowser.prototype.init=function(table)
{var self=this;this.table=table;this.filenamesInUpload={};this.grid=new FileGrid(camel_case(table)+"ViewFileGrid",{getParameters:function(){var params={id_folder:ui.get('id_folder')};params["id_"+self.table]=ui.get(table+'.id');return params;},noResult:translate('No file found in this folder'),noResultMatchingFilter:translate('No file found in this folder matching your search criteria'),tableRendered:function(containerid,className,tableid){FileGrid.prototype.tableRendered.call(this,containerid,className,tableid);$("#"+containerid+" tbody tr a.tooltip").draggable({delay:150,helper:'clone'});}});if(isAllowed(self.table+"s","edit")&&isAllowed('files','upload')){var uploader=new qq.FileUploader({element:$('#file-upload')[0],allowedExtensions:['jpg','jpeg','gif','png','bmp','pdf','odp','csv','doc','docx','xls','xlsx','odt','ods','html','txt','pps','mp3','avi','mpg','pptx','numbers','pages'],dropText:translate("Drop a file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Add files (max 10 MB)"),action:baseUrl+'/'+self.table+'/uploadfile',onSubmitFiles:function(){uploader.setParams({id:ui.get(self.table+'.id'),id_folder:ui.get('id_folder')?ui.get('id_folder'):''});$.blockUI({message:"<div id='upload-progress'></div>",css:{border:'none',padding:'5px',top:($(window).height()-200)/2+'px',left:($(window).width()-480)/2+'px',height:'240px',width:'480px',backgroundColor:'#FFF',borderRadius:'10px','-webkit-border-radius':'10px','-moz-border-radius':'10px',opacity:1,color:'#000'}});$('#upload-progress').append("<h3>"+translate("Uploading files...")+"</h3>").append($('#qq-upload-list-div-file-upload').show());},onSubmit:function(_id,fileName){self.filenamesInUpload[fileName]=true;},onCancel:function(_id,fileName){this._onComplete(_id,fileName);},onComplete:function(_id,fileName,responseJSON){this._onComplete(_id,fileName);},_onComplete:function(_id,fileName){delete self.filenamesInUpload[fileName];for(var f in self.filenamesInUpload)return;$('body').append($('#qq-upload-list-div-file-upload').hide());$.unblockUI();$('#upload-progress').remove();self.grid.refresh();},showMessage:function(message){jerror(message);}});}
FolderBrowser.prototype.init.call(this,'file',this.grid,'a.tooltip');};;function JobIndex(){}
JobIndex.prototype=new DefaultScreen();JobIndex.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val(),true);});this.grid=new JobGrid("JobGrid",{getParameters:function(){var parameter=JobGrid.prototype.getParameters.call(this);parameter.id_users=$('.user_select').size()==0?null:($('.user_select').val()||[]);parameter.id_statuses=ui.get('parameters.id_statuses');parameter.id_tags=$('.tag_select').val()||[];parameter.show_value=$('[name=show_value]').val();return parameter;}});this.setupCreateJobDialog();$("a.add").click(function(){self.onAdd();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$("select[name=show_value]").dropkick({width:100,change:function(value,label){ui.set('parameters.show_value',value);self.grid.refresh();}});};JobIndex.prototype.setupCreateJobDialog=function(id_parent_selected)
{var self=this;$("#job_create_dialog").dialog({width:685,minHeight:650,modal:true,autoOpen:false,open:function(event){tinymce.execCommand('mceAddEditor',false,'job_create_description');if(id_parent_selected)$('#job_create_dialog [name=id_parent]').val(id_parent_selected).trigger('change');},close:function(event){tinymce.execCommand('mceRemoveEditor',false,'job_create_description');},buttons:[{text:translate("OK"),click:function(){if(self.add($('#job_create_dialog [name=id_parent]').val(),($('#job_create_dialog [name=name]').is(':hidden')?null:$('#job_create_dialog [name=name]').val()),$('#job_create_dialog [name=id_owner]').val(),$('#job_create_dialog [name=title]').val(),tinymce.get('job_create_description').getContent()))$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});$("#job_create_dialog .smartselect").select2({width:450,placeholder:translate('select a customer'),dropdownCssClass:'ui-dialog',dropdownAutoWidth:true});$('#job_create_dialog [name=id_template] option').remove();for(var c=0;c<config.tracker.templates.length;c++){var _template=config.tracker.templates[c];if(_template.id_parent==config.tracker.id_root_default_tracker)$('#job_create_dialog [name=id_template]').append($("<option>").attr('value',_template.id).attr('template_type',_template.template_type).attr('default_name',_template.default_name).html(htmlspecialchars(_template.name)));}
var no_template_available=$('#job_create_dialog [name=id_template] option').size()==0;if(no_template_available||config.tracker.allow_job_manual==1)$('#job_create_dialog [name=id_template]').prepend($("<option>").attr('value',0).attr('template_type','manual').html(translate("(no template)")));if($('#job_create_dialog [name=id_template] option').size()<=1&&$('#job_create_dialog [name=id_template] option').attr('value')>0)$('#job_create_dialog .row.job_template').hide();else $('#job_create_dialog .row.job_template').show();$('#job_create_dialog [name=id_template]').change(function(){var option=$(this).find('option[value='+$(this).val()+"]");if(option.size()==0)return;var template_type=option.attr('template_type');var default_name=option.attr('default_name');if(template_type=='automatic')$('#job_create_dialog .row.job_name').hide();else{$('#job_create_dialog .row.job_name').show();$('#job_create_dialog input[name=name]').val(default_name);}}).trigger('change');};JobIndex.prototype.onAdd=function()
{var self=this;_ajax('customer/getlist',{hide_archived:true,for_create_job:true}).done(function(customers){$('#job_create_dialog [name=name]').val('');$('#job_create_dialog [name=title]').val(config.estimate.default_customer_ref);$('#job_create_dialog [name=description]').val(config.estimate.default_note);$('#job_create_dialog [name=id_template]').trigger('change');var parent_selector=$('#job_create_dialog [name=id_parent]').empty();if(customers.length>1)parent_selector.append($("<option>"));for(var c=0;c<customers.length;c++){var target=customers[c];parent_selector.append($("<option>").attr('value',target.id_tracker).html(target.name+' '+target.firstname));}
$(".smartselect").trigger('change');$('#job_create_dialog').dialog('open');if(customers.length<=1)$('#job_create_dialog [name=name]').select().focus();});};JobIndex.prototype.add=function(id_parent,name,id_owner,title,description)
{if(!id_parent){jalert(translate("Please select a customer"));return false;}
if($('#job_create_dialog [name=name]').is(':visible')&&!name){jalert(translate("Please enter an identifier for this %template").replace(/%template/,config.tracker.job_label.toLocaleLowerCase()));return false;}
var self=this;showWait(translate("Creating")+"...");_ajax('job/create',{id_template:$('#job_create_dialog [name=id_template]').val(),id_parent:id_parent,name:name,id_owner:id_owner,title:title,description:description}).done(function(response){hideWait();router.navigate('/job/'+response.id_job+'/'+config.tracker.default_tab,true);});return true;};;function JobOverview(){}
JobOverview.prototype=new DefaultScreen();JobOverview.prototype.showAsap=function(){return true;};JobOverview.prototype.init=function()
{var self=this;this.probe();$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/overview',true);});$('tr.invoiced-details').hide();ui.on("toggle-invoiced-details",function(){$('tr.invoiced-details').toggle();});var chart={chart:{type:'pie',width:500,margin:[0,0,0,0],spacingTop:0,spacingBottom:0,spacingLeft:0,spacingRight:0,plotBackgroundColor:null,plotBorderWidth:0,plotShadow:false,options3d:{enabled:false,alpha:45}},credits:{enabled:false},title:{align:'center',verticalAlign:'middle',y:75},tooltip:{pointFormat:'{series.name}: <b>{point.percentage:.1f}%</b>'},plotOptions:{pie:{colors:['#ff4500','#ffa500','#048dc4','#000080','#808080'],dataLabels:{enabled:true,format:(locale.currency_before_amount!=1?'<b>{point.name}</b><br/>{point.y:.'+locale.amount_decimals+'f} '+locale.currency_symbol:'<b>{point.name}</b><br/>'+locale.currency_symbol+' {point.y:.'+locale.amount_decimals+'f}')},startAngle:-90,endAngle:90,center:['50%','75%']}}};chart.series=ui.get('financial_chart.series');chart.title.text=ui.get('financial_chart.title');$('#chart-container').highcharts(chart);setTimeout(function(){self.probe();$('div.overview').imagesLoaded(function(){self.layout();});},0);};JobOverview.prototype.probe=function()
{var w=$(window).width();var activity=(w>=1600?'left':'bottom');var columnWidth=60;var gutter=Math.round(columnWidth/4);if(typeof this.activity=='undefined'||this.activity!=activity||this.columnWidth!=columnWidth||this.gutter!=gutter){this.activity=activity;this.columnWidth=columnWidth;this.gutter=gutter;return true;}};JobOverview.prototype.layout=function()
{var self=this;if(this.activity=='left')$('div.overview').prepend($('div.widget.activity').css('max-width','800px'));else $('div.overview').append($('div.widget.activity').css('max-width',''));$('div.overview').prepend($('div.widget.empty'));$('div.overview').masonry({columnWidth:self.columnWidth,gutter:self.gutter,itemSelector:'div.widget'});$(window).on('resize',self.arrange);};JobOverview.prototype.arrange=function()
{if(router.screen_controller.probe()){$(window).unbind('resize',router.screen_controller.arrange);$('div.overview').masonry('destroy');router.screen_controller.layout();}};JobOverview.prototype.dispose=function()
{$(window).unbind('resize',this.arrange);};;function JobTracker(){};JobTracker.prototype=new DefaultScreen();JobTracker.prototype.init=function()
{var self=this;this.prev_default_name=null;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/tracker',true);});this.trackerModule=new TrackerModule(1,"tablecontent","customers");this.trackerModule.trackerId=ui.get('tracker.id');this.trackerModule.addCustomTrackerActions=function(cell,id_tracker){self.addCustomTrackerActions(cell,id_tracker);};trackerModule=this.trackerModule;JobIndex.prototype.setupCreateJobDialog.call(this,ui.get('tracker.id'));ui.on('actionbar-add-job',function(){JobIndex.prototype.onAdd.call(self);});this.trackerModule.grid.fetch();};JobTracker.prototype.addCustomTrackerActions=function(cell,id_tracker){};JobTracker.prototype.add=JobIndex.prototype.add;;function JobBilling(){};JobBilling.prototype=new DefaultScreen();JobBilling.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/billing',true);});this.grid=new BillingGrid("JobBillingGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){if(ui.get('job.status_type')==AppConfig.TRACKER_STATUS_IN_PROGRESS)self.refresh();}});};;function JobTeam(){};JobTeam.prototype=new DefaultScreen();JobTeam.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/team',true);});this.grid=new TeamGrid("JobTeamGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};}});router.observers.push(ui.observe('team_mode',function(oldV,newV){if(ui.get('team_mode')=='advanced')self.grid.wait();else showWait();if(oldV&&newV&&ui.get('team_mode'))_ajax('job/setteammode',{id_tracker:ui.get('tracker.id'),mode:ui.get('team_mode')}).done(function(response){if(ui.get('team_mode')!=response.team_mode){console.error("Team mode not correctly set ?!");return false;}
ui.set(response);if(ui.get('team_mode')=='advanced')self.grid.fetch();else hideWait();});}));ui.on('team-add',function(e){self.setteam(e.node,1);});ui.on('team-remove',function(e){self.setteam(e.node,0);});$('ul.team li').draggable({revert:true});$('ul.team.available').droppable({accept:'li.selected',drop:function(event,ui){return self.setteam(ui.draggable,0);}});$('ul.team.selected').droppable({accept:'li.available',drop:function(event,ui){return self.setteam(ui.draggable,1);}});};JobTeam.prototype.setteam=function(node,value)
{if(!isAllowed(ui.get('job.id')?'jobs':'customers','edit')){jinfo("You are not authorized to modify this.");return false;}
showWait();_ajax('job/setteam',{id_tracker:ui.get('tracker.id'),id_user:$(node).attr('rel'),value:value}).done(function(response){ui.set(response);hideWait();});};;function JobPlanning(){};JobPlanning.prototype=new DefaultScreen();JobPlanning.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/planning',true);});this.grid=new PlanningGrid("JobPlanningGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){self.refresh();}});};;function JobTask(){}
JobTask.prototype=new TaskPanel();JobTask.prototype.getParameters=function()
{return{id_tracker:ui.get('tracker.id')};};JobTask.prototype.init=function()
{ui.set('filter',{hint:translate('user, title, description, tags')});$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/task',true);});return TaskPanel.prototype.init.call(this,"JobTask");};;function JobItemEntry(){};JobItemEntry.prototype=new DefaultScreen();JobItemEntry.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/followup/item_entry',true);});this.grid=new ItemEntryGrid("JobItemEntryGrid",{tracker_enum_provider:null,getParameters:function(){return{id_tracker:ui.get('tracker.id'),followup:true,id_users:$('.user_select').val()||[],id_statuses:$('.status_select').val()||[]};},onChange:function(){if(ui.get('job.status_type')==AppConfig.TRACKER_STATUS_IN_PROGRESS)self.refresh();}});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});this.dialog=new ItemEntryDialog({parameters:{id_tracker:ui.get('tracker.id')},onAdd:function(){self.grid.onChange();self.grid.refresh();}});ui.on('actionbar-add',function(){self.dialog.open();});};;function JobTimesheetEntry(){};JobTimesheetEntry.prototype=new DefaultScreen();JobTimesheetEntry.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/followup/timesheet_entry',true);});this.grid=new TimesheetGrid("JobViewTimesheetGrid",{tracker_enum_provider:null,getParameters:function(){return{id_tracker:ui.get('tracker.id'),userIds:$('.user_select').val()||[]};},onChange:function(){if(ui.get('job.status_type')==AppConfig.TRACKER_STATUS_IN_PROGRESS)self.refresh();}});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.grid.refresh();});ui.on('time-report',function(event){var today=new Date();var param={id_job:ui.get('job.id'),matrixmode:'pivot_first',maxcols:0,valuekey:'hours,budget',id_unit:config.calendar.default_unit,groupkey:'path_sort_relative_to_customer',pivotkey:'login',chart:'horizontal',past_only:1,from:'',to:''};router.navigate('/report/time/time/'+encodeURIComponent($.toJSON(param)),true);});};;function JobCostEntry(){};JobCostEntry.prototype=new DefaultScreen();JobCostEntry.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/followup/cost_entry',true);});this.grid=new CostEntryGrid("JobCostEntryGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id'),followup:true,id_users:$('.user_select').val()||[],id_statuses:$('.status_select').val()||[]};},onChange:function(){if(ui.get('job.status_type')==AppConfig.TRACKER_STATUS_IN_PROGRESS)self.refresh();}});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});};;function JobJobItemBilling(){};JobJobItemBilling.prototype=new DefaultScreen();JobJobItemBilling.prototype.init=function(parameter)
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/job_item_billing',true);});this.grid=new JobItemGrid("JobJobItemBillingGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){self.refresh();}});this.dialog=new ItemEntryDialog({controller:'jobitem',parameters:{id_tracker:ui.get('tracker.id')},onAdd:function(){self.grid.onChange();self.grid.refresh();},onOpen:function(){$('select#id_tracker').val(0).parent().hide();}});ui.on({'actionbar-add':function(){self.dialog.open();},'create-invoice':function(){self.createInvoice();},'create-advance-invoice':function(){self.createAdvanceInvoice();},'list-invoiceable':function(event){self.listInvoiceable(event);}});$("#content").append($('<form>').attr({'id':'export_invoiceable_form','method':'POST','action':baseUrl+'/invoice/invoiceable'}).append($('<input>').attr({'type':'hidden','name':'request'})));};JobJobItemBilling.prototype.createInvoice=function()
{var self=this;showWait("Creating invoice");_ajax('job/createinvoice',{id_tracker:ui.get('tracker.id')}).done(function(id_invoice){hideWait();if(id_invoice)router.navigate('invoice/'+id_invoice,true);});};JobJobItemBilling.prototype.createAdvanceInvoice=function()
{var self=this;jprompt(translate("Enter the advance percentage"),translate("Invoice an advance"),30,function(){},function(percent){percent=parseInt(percent,10);if(percent<=0)return false;showWait("Creating invoice");_ajax('job/createadvanceinvoice',{id_tracker:ui.get('tracker.id'),percent:percent}).done(function(id_invoice){hideWait();if(id_invoice)router.navigate('invoice/'+id_invoice,true);});});};JobJobItemBilling.prototype.listInvoiceable=function(event)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$('#export_invoiceable_form').attr('target',event.ctrlKey||event.metaKey?'_blank':'listing_invoiceable');else $('#export_invoiceable_form').removeAttr('target');$("#export_invoiceable_form [name=request]").val($.toJSON({start:null,end:null,trackerIds:[ui.get('tracker.id')],userIds:null,includeChildren:true}));$("#export_invoiceable_form").submit();};;function EstimateGrid(name,config){if(name)this.init(name,config);}
EstimateGrid.prototype=new TimetrackEditableGrid();EstimateGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.inJob=='undefined')config.inJob=false;if(typeof config.noResult=='undefined')config.noResult=translate('No estimate found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No estimate found matching your search criteria');config.controller='estimate';TimetrackEditableGrid.prototype.init.call(this,name,config);$('input[name=estimate_send_to]').autocomplete({source:baseUrl+'/customer/listcontactemail'});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected estimates ?',true)))self.deleteEstimate(ui.get('rows_checked'));});};EstimateGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};EstimateGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('estimates','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify estimates.");return false;}
if(this.hasColumn('id_status')&&config.estimate.freeze_sent_estimates==1&&parseInt(this.getRowAttribute(rowIndex,"status_type"),10)>AppConfig.ESTIMATE_STATUS_READY&&columnIndex!=this.getColumnIndex("id_status")&&columnIndex!=this.getColumnIndex("id_owner")&&columnIndex!=this.getColumnIndex("id_customer_contact")&&columnIndex!=this.getColumnIndex("tags")){jinfo("The estimate cannot be modified. If you wish to modify it, set the estimate back to 'Draft' status.",null,400);return false;}
return true;};EstimateGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_status','id_owner'])>=0;};EstimateGrid.prototype.readonlyWarning=function(column)
{if(column.name=='amount')jinfo("The amount is not editable directly: you have to edit the estimate entries.");else if(column.name=='vat')jinfo("The VAT amount is not editable: you have to edit the estimate entries and change their VAT rate.");};EstimateGrid.prototype.updatePaginator=function()
{var self=this;TimetrackEditableGrid.prototype.updatePaginator.call(this);$("a.tooltip").scrolltip({content:function(){var rowIndex=self.getRowIndex(this.parentNode.parentNode);return self.getRowAttribute(rowIndex,"tooltip");}});};EstimateGrid.prototype.getActions=function(cell,id_estimate)
{var self=this;var actions=[];var status_type=parseInt(this.getRowAttribute(cell.rowIndex,"status_type"),10);if(isAllowed('estimates','export')){actions.push({icon:img('estimate_export_pdf16','pdf','Export as PDF'),href:baseUrl+'/estimate/getpdf/id/'+id_estimate+"/"+this.getRowAttribute(cell.rowIndex,'estimate_filename')+'.pdf',target:config.ui.open_reports_in_new_tab==1?'_blank':''});actions.push({icon:img('estimate_send','send',translate('Send estimate')),click:function(){self.sendEstimate(id_estimate);}});}
if(isAllowed('invoices','create'))
actions.push({icon:img('estimate_invoice','invoice','Invoice_verb'),href:baseUrl+'/ui/estimate/'+id_estimate+"/billing"});if(isAllowed('estimates','delete')&&(config.estimate.freeze_sent_estimates==0||status_type<=AppConfig.ESTIMATE_STATUS_READY))
actions.push({icon:img('estimate_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this estimate ?',true)))self.deleteEstimate(id_estimate);}});return actions;};EstimateGrid.prototype.getViewLink=function(id_estimate,rowIndex)
{var is_manual=this.getRowAttribute(rowIndex,'is_manual');if(is_manual==1)return{'class':'customer_link tooltip','url':baseUrl+"/ui/estimate/"+id_estimate};return{'class':'customer_link tooltip','url':baseUrl+"/ui/job/"+this.getRowAttribute(rowIndex,'id_job')+'/estimate/'+id_estimate};};EstimateGrid.prototype.tableLoaded=function()
{var self=this;if(this.hasColumn('estimate_ref'))this.setCellRenderer("estimate_ref",new CellRenderer({render:function(cell,estimate_ref){if(!isAllowed('estimates','view'))cell.innerHTML=estimate_ref;else{var link=self.getViewLink(self.getRowId(cell.rowIndex),cell.rowIndex);cell.innerHTML="<a class='"+link['class']+"' title='' href='"+link.url+"'>"+estimate_ref+"</a>";}
$(cell).css('white-space','nowrap');}}));if(this.hasColumn('description'))this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));if(this.hasColumn('description'))this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:true,getDialogTitle:function(cell,value){return translate("Description")+" : "+self.getValueAt(cell.rowIndex,self.getColumnIndex('estimate_ref'));}}));if(this.hasColumn('id_customer_contact'))this.setEnumProvider('id_customer_contact',new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var values=null;syncAjax('/customer/getcontacts',{id_customer:self.getValueAt(rowIndex,self.getColumnIndex('id_customer'))},function(response){values=response;},'json');return values;}}));this.setCellRenderer("amount",new CellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).css('font-weight',ui.get('parameters.show_value')=='amount'?'bold':'');}}));this.setCellRenderer("vatincl",new CellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).css('font-weight',ui.get('parameters.show_value')=='vatincl'?'bold':'');}}));if(this.hasColumn("gross_margin"))this.setCellRenderer("gross_margin",new CellRenderer({render:function(cell,gross_margin){NumberCellRenderer.prototype.render.call(this,cell,gross_margin);$(cell).css('font-weight',ui.get('parameters.show_value')=='gross_margin'?'bold':'');}}));if(this.hasColumn('id_status'))this.setCellRenderer("id_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);$(cell.parentNode).addClass(status_type>=AppConfig.ESTIMATE_STATUS_REJECTED?"paid":"unpaid").removeClass(status_type>=AppConfig.ESTIMATE_STATUS_REJECTED?"unpaid":"paid");if(color=self.getRowAttribute(cell.rowIndex,'status_color')){color=toRGB(color);$(cell).html("<span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+$(cell).html()+"</span>");}
$(cell).css('white-space','nowrap');self.setValueAt(cell.rowIndex,self.getColumnIndex("action"),self.getValueAt(cell.rowIndex,self.getColumnIndex("action")));}}));if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No estimate tag was created yet. To create an estimate tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
this.render();};EstimateGrid.prototype.deleteEstimate=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('estimate/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the estimate from database","Error");else{self.refresh();self.onChange();}});};EstimateGrid.prototype._setEstimateStatus=function(id,id_status)
{if(!id_status)return this.refresh(true);var rowIndex=this.getRowIndex(id);var columnIndex=this.getColumnIndex("id_status");var row=this.getRow(rowIndex);var oldValue=this.getValueAt(rowIndex,columnIndex);this.setValueAt(rowIndex,columnIndex,id_status);this.modelChanged(rowIndex,columnIndex,oldValue,id_status,row);};EstimateGrid.prototype._sendMail=function(id)
{var self=this;showWait(translate("Sending mail")+'...');_ajax('estimate/send',{id:id,subject:$("input[name=estimate_send_subject]").val(),message:tinymce.get('estimate_send_message').getContent(),to:$("input[name=estimate_send_to]").val(),copy:$("input[name=estimate_send_copy]").is(':checked')}).done(function(response){if(response.status!="ok")jerror(response.message);else self._setEstimateStatus(id,response.estimate.id_status);hideWait();});};EstimateGrid.prototype.sendEstimate=function(id)
{var self=this;var buttons={};buttons[translate('Send')]=function(){self._sendMail(id);$(this).dialog('close');};buttons[translate('Cancel')]=function(){$(this).dialog('close');};var data=null;_ajax('estimate/sendformdata',{id:id}).done(function(data){$("input[name=estimate_send_subject]").val(data.ref_display);$("input[name=estimate_send_to]").val(data.email?data.email:'');if(data.body)$("textarea[name=estimate_send_message]").val(data.body);self._setEstimateStatus(id);$("#estimate_send_dialog").dialog({autoOpen:true,width:700,minHeight:650,modal:true,resizable:false,buttons:buttons,open:function(event){if(UserAgentBrowser.IE)$("#pdf_viewer").hide();tinymce.execCommand('mceAddEditor',false,'estimate_send_message');},close:function(event){if(UserAgentBrowser.IE)$("#pdf_viewer").show();tinymce.execCommand('mceRemoveEditor',false,'estimate_send_message');}});});};;function EstimateIndex(){}
EstimateIndex.prototype=new DefaultScreen();EstimateIndex.prototype.init=function()
{var self=this;$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$("select[name=show_value]").dropkick({width:100,change:function(value,label){self.grid.refresh();}});this.grid=new EstimateGrid("EstimateIndexGrid",{getParameters:function(){var from=$('.searchfield.from').val();var to=$('.searchfield.to').val();localset(this.name+'DateFrom',from);localset(this.name+'DateTo',to);ui.set('parameters.show_value',$('[name=show_value]').val());return{from:from,to:to,id_users:$('.user_select').val()||[],id_statuses:$('.status_select').val()||[],id_tags:$('.tag_select').val()||[],show_value:ui.get('parameters.show_value')};},getActions:function(cell,id_estimate){var actions=EstimateGrid.prototype.getActions.call(this,cell,id_estimate);if(isAllowed('estimates','edit')&&config.estimate.allow_estimate_manual==1)actions.splice(0,0,{icon:img('customer_copytracker','copy',translate('Duplicate estimate')),click:function(){self.createEstimate(self.grid.getRowId(cell.rowIndex));}});return actions;}});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$('.searchfield:not(.from):not(.to)').autocomplete({source:baseUrl+'/customer/listcustomername',select:function(event,ui){self.grid.filter(ui.item.value);}});ui.on('create-estimate',function(){self.createEstimate();});};EstimateIndex.prototype.createEstimate=function(id_estimate)
{showWait((id_estimate>0?translate("Duplicating"):translate("Creating"))+"...");_ajax('estimate/create',{id_estimate:id_estimate}).done(function(response){if(response=="error"){hideWait();jerror("An error occured while creating the estimate","Error");}
else router.navigate('/estimate/'+response,true);});return true;};;function EstimateView(){}
EstimateView.prototype=new DefaultScreen();EstimateView.prototype.init=function(parameter)
{var self=this;this.disposed=false;$('input[name=estimate_send_to]').autocomplete({source:baseUrl+'/customer/listcontactemail'});this.setup_autosave();this.tabControllers={'general':new EstimateViewGeneral(),'entry':new EstimateViewEntry(),'billing':new EstimateViewBilling()};this.tabControllers['billing'].refresh=function(){self.refresh();};ui.on("toggle-status",function(event){$(".ui-tooltip").remove();$("#status_overlay").css('min-height',$(window).height()+'px').toggle();});ui.on('autosave-estimate',function(){self.autosave();});ui.on('set-status-estimate',function(event,id_status){self.setStatus(id_status);});ui.on('send-estimate',function(){self.sendEstimate(ui.get('estimate.id'));});ui.on('delete-estimate',function(){jconfirm(translate("Are you sure you want to delete this estimate ?"),null,null,function(){self.deleteEstimate();});});ui.on('copy-estimate',function(){self.copyEstimate(ui.get('estimate.id'));});this.setTab(ui.get('tab'),true);};EstimateView.prototype.setTab=function(tab,first)
{var self=this;if(!first&&ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onhide){console.info("Hiding "+ui.get('tab'));self.tabControllers[ui.get('tab')].onhide();}
menu.hilite();ui.set('tab',tab);if(ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onshow){console.info("Showing "+ui.get('tab'));self.tabControllers[ui.get('tab')].onshow();}};EstimateView.prototype._sendMail=EstimateGrid.prototype._sendMail;EstimateView.prototype.sendEstimate=EstimateGrid.prototype.sendEstimate;EstimateView.prototype._setEstimateStatus=function(id,id_status)
{var self=this;if(!id_status)return this.refresh();_ajax('estimate/updateview',{id:id,id_status:id_status}).done(function(response){self.autosave_observer.cancel();ui.set(response);if(ui.get('tab')=='entry')self.tabControllers['entry'].grid.fetch();self.setup_autosave();});};EstimateView.prototype.setStatus=function(id_status)
{$(".ui-tooltip").remove();this._setEstimateStatus(ui.get('estimate.id'),id_status);$("#status_overlay").hide();};EstimateView.prototype.setup_autosave=function()
{var self=this;if(self.disposed)return false;this.autosave_observer=ui.observe('estimate.id_customer estimate.id_customer_contact estimate.estimate_date estimate.id_signer estimate.id_owner estimate.id_status estimate.description',function(newValue,oldValue,keypath){if(!oldValue&&!newValue)return false;console.info(keypath+' changed from '+oldValue+' to '+newValue);self.autosave();},{init:false});};EstimateView.prototype.getEstimateData=function()
{var data={};var properties=['id','id_customer','id_customer_contact','estimate_date','estimate_ref','customer_ref','id_signer','id_owner','id_status','description'];for(var i=0;i<properties.length;i++)data[properties[i]]=ui.get('estimate.'+properties[i]);return data;};EstimateView.prototype.autosave=function()
{var self=this;_ajax('estimate/updateview',this.getEstimateData()).done(function(response){if(self.disposed)return false;self.autosave_observer.cancel();ui.set(response);self.setup_autosave();});};EstimateView.prototype.deleteEstimate=function()
{showWait(translate("Deleting")+"...");_ajax('estimate/delete',{id:ui.get('estimate.id')}).done(function(){router.navigate('/estimate/index',true);});};EstimateView.prototype.copyEstimate=EstimateIndex.prototype.createEstimate;EstimateView.prototype.dispose=function()
{this.disposed=true;ui.off('autosave-estimate');this.autosave_observer.cancel();for(var tab in this.tabControllers){if(this.tabControllers[tab].dispose){console.info("Disposing "+tab);this.tabControllers[tab].dispose();}}};;function WizardIndex(){}
WizardIndex.prototype=new DefaultScreen();WizardIndex.prototype.init=function(parameters)
{var self=this;this.mode=ui.get('mode');var startIndex=(parameters&&parameters.tab)?$('section').index($('section[tab='+parameters.tab+']')):self.mode=='config'&&localisset(self.mode+'_lastTab')?$('section').index($('section[tab='+localget(self.mode+'_lastTab')+']')):0;var tabName=$('section:eq('+startIndex+')').attr('tab');if(self.mode=='config')router.navigate("/config/"+tabName,{trigger:false,replace:true});if(this.mode=='wizard')$("#menutop").hide();$('#wizard_container').addClass(this.mode).steps({headerTag:"h3",bodyTag:"section",transitionEffect:(this.mode=="wizard"?"slideLeft":"none"),enableAllSteps:this.mode=='config',saveState:false,showFinishButtonAlways:this.mode=='config',titleTemplate:(this.mode=='wizard'?"<span class='number'>#index#.</span> #title#":"#title#"),startIndex:(startIndex>0?startIndex:0),labels:{cancel:translate("Cancel"),current:translate("current step:"),pagination:translate("Pagination"),finish:"<i class='fa fa-save'/> &nbsp; "+(this.mode=='config'?translate("Save"):translate("Save and start using")+" "+camel_case(config.ui.product,true)+"!"),next:translate("Next")+" &raquo;",previous:"&laquo; "+translate("Previous"),loading:translate("Loading...")},onStepChanging:function(event,currentIndex,newIndex){var tabName=$('section:eq('+newIndex+')').attr('tab');var invoiceTabIndex=$('section').index($('section[tab=invoice]'));if(newIndex==1){if($('[name=company_country]').val()==''||$('[name=company_country]').val()=='XX')$('[name=company_country]').val($("[name=country]").val()).trigger('change');$('div.if_use_vat').css('display',$("[name=use_vat]").val()==1?'':'none');$('.currency_value').html($("#currency").val());}
var valid=true;$('form').not('.apart').each(function(){$(this).validate().settings.ignore=":disabled,:hidden";valid=valid&&$(this).valid();});if(valid&&(tabName=='invoice'||tabName=='credit_note'||tabName=='estimate')){if(currentIndex<invoiceTabIndex)self.updatePDFPreview();}
if(valid&&self.mode=='config')router.navigate("/config/"+tabName,false);localset(self.mode+'_lastTab',tabName);return valid;},onFinishing:function(event,currentIndex){var valid=true;$('form').not('.apart').each(function(){$(this).validate().settings.ignore=":disabled,:hidden";valid=valid&&$(this).valid();});return valid;},onFinished:function(event,currentIndex){if(self.mode=='config')$("li.current").removeClass("done");self.saveSettings();}});$('input[type=checkbox][is_checked=true]').attr('checked','checked');$('form').not('.apart').each(function(){$(this).validate({errorPlacement:function errorPlacement(error,element){element.after(error);}});});$('#index_rates').click(function(){$('#indexrates_dialog').dialog('open');});$("#indexrates_dialog").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,title:translate("Index rates"),buttons:[{text:translate("Apply"),click:function(){self.indexRates();}},{text:translate("Cancel"),click:function(){$(this).dialog('close')}}]});$('[name="calendar_pricing_overtime_mode"],[name="calendar_pricing_normal_mode"],[name="calendar_pricing_weekend_mode"], [name=calendar_default_unit]').change(function(){self.updatePricingSymbols();});this.updatePricingSymbols();if(this.mode=='wizard'){var tz_info=determine_timezone();if(typeof(tz_info.timezone)!='undefined'){tz_info.timezone.ambiguity_check();this.initAccordingToTimezone(tz_info.timezone.olson_tz);}}
var updateAmountFormatLabel=function(){$("[name=amount_format] option").each(function(){var label_currency=$(this).attr('label_original').replace('%CUR',($('[name=currency] option:selected').attr('label').split(' (')[1]).replace(')',''));$(this).attr('label',label_currency).text(label_currency);});};$("[name=amount_format] option").each(function(){$(this).attr('label_original',$(this).attr('label'));});updateAmountFormatLabel();$("[name=currency]").change(updateAmountFormatLabel);this.users=ui.get('users');this.renderUsers();$('form.user_form').validate({errorPlacement:function errorPlacement(error,element){element.after(error);}});$("a.add-user").click(function(){if($('form.user_form').valid()){self.users.push({id:0,name:$('[name=user_name]').val(),firstname:$('[name=user_firstname]').val(),email:$('[name=user_email]').val(),id_role:$('[name=user_id_role]').val(),role:$('[name=user_id_role] option:selected').text()});$('form.user_form input').val('');self.renderUsers();}});this.trackers=ui.get('trackers');this.renderTrackers();$('form.tracker_form').validate({errorPlacement:function errorPlacement(error,element){element.after(error);}});$('form.tracker_form').on('submit',function(){return false;});$("a.add-tracker").click(function(){self.addTracker();});$("[name=tracker_name]").on('keyup',function(event){if(event.keyCode==13){self.addTracker();return false;}});this.onSubmitFiles=function(elementId){$.blockUI({message:"<div id='upload-progress'></div>",css:{border:'none',padding:'5px',top:($(window).height()-200)/2+'px',left:($(window).width()-480)/2+'px',height:'200px',width:'480px',backgroundColor:'#FFF',borderRadius:'10px','-webkit-border-radius':'10px','-moz-border-radius':'10px',opacity:1,color:'#000'}});$('#upload-progress').append("<h3>"+translate("Uploading file...")+"</h3>").append($('#qq-upload-list-div-'+elementId).show());};var uploader=new qq.FileUploader({element:$('#logo-upload')[0],multiple:false,allowedExtensions:['jpg','jpeg','gif','png'],dropText:translate("Drop an image file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Select image file"),action:baseUrl+'/ajax/wizard/uploadlogo?request={}',showMessage:jerror,onSubmitFiles:function(){self.onSubmitFiles('logo-upload');},onCancel:function(_id,fileName){$('body').append($('#qq-upload-list-div-logo-upload').hide());$.unblockUI();$('#upload-progress').remove();},onComplete:function(_id,fileName,response){$('body').append($('#qq-upload-list-div-logo-upload').hide());$.unblockUI();$('#upload-progress').remove();$("#logocompany").attr("src",response.url+"?"+(new Date()).getTime());self.reloadViewer();}});if($('#pdf-upload-invoice').size()>0)var uploader=new qq.FileUploader({element:$('#pdf-upload-invoice')[0],multiple:false,allowedExtensions:['pdf'],dropText:translate("Drop a pdf file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Select PDF file"),showMessage:jerror,action:baseUrl+'/ajax/wizard/uploadpdf?request={"type":"invoice","mode":"'+self.mode+'"}',onSubmitFiles:function(){self.onSubmitFiles('pdf-upload-invoice');},onCancel:function(_id,fileName){$('body').append($('#qq-upload-list-div-pdf-upload-invoice').hide());$.unblockUI();$('#upload-progress').remove();},onComplete:function(_id,fileName,response){$('body').append($('#qq-upload-list-div-pdf-upload-invoice').hide());$.unblockUI();$('#upload-progress').remove();self.reloadViewer('invoice');}});if($('#pdf-upload-credit_note').size()>0)var uploader=new qq.FileUploader({element:$('#pdf-upload-credit_note')[0],multiple:false,allowedExtensions:['pdf'],dropText:translate("Drop a pdf file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Select PDF file"),showMessage:jerror,action:baseUrl+'/ajax/wizard/uploadpdf?request={"type":"credit_note","mode":"'+self.mode+'"}',onSubmitFiles:function(){self.onSubmitFiles('pdf-upload-credit_note');},onCancel:function(_id,fileName){$('body').append($('#qq-upload-list-div-pdf-upload-credit_note').hide());$.unblockUI();$('#upload-progress').remove();},onComplete:function(_id,fileName,response){$('body').append($('#qq-upload-list-div-pdf-upload-credit_note').hide());$.unblockUI();$('#upload-progress').remove();self.reloadViewer('credit_note');}});if($('#pdf-upload-estimate').size()>0)var uploader=new qq.FileUploader({element:$('#pdf-upload-estimate')[0],multiple:false,allowedExtensions:['pdf'],dropText:translate("Drop a pdf file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Select PDF file"),action:baseUrl+'/ajax/wizard/uploadpdf?request={"type":"estimate","mode":"'+self.mode+'"}',showMessage:jerror,onSubmitFiles:function(){self.onSubmitFiles('pdf-upload-estimate');},onCancel:function(_id,fileName){$('body').append($('#qq-upload-list-div-pdf-upload-estimate').hide());$.unblockUI();$('#upload-progress').remove();},onComplete:function(_id,fileName,response){$('body').append($('#qq-upload-list-div-pdf-upload-estimate').hide());$.unblockUI();$('#upload-progress').remove();self.reloadViewer('estimate');}});$('a.pdf-remove-invoice').click(function(){_ajax('wizard/removepdf',{type:'invoice'}).done(function(response){self.reloadViewer('invoice');});});$('a.pdf-remove-credit_note').click(function(){_ajax('wizard/removepdf',{type:'credit_note'}).done(function(response){self.reloadViewer('credit_note');});});$('a.pdf-remove-estimate').click(function(){_ajax('wizard/removepdf',{type:'estimate'}).done(function(response){self.reloadViewer('estimate');});});$("#slider_invoice_logowidth").slider({value:config.invoice.logowidth,min:1,max:200,step:1,slide:function(event,ui){$(this).siblings('span').html(ui.value+" mm");},stop:function(event,ui){self.updatePDFPreview('invoice');}});$("[name=invoice_logo_original_width]").on('click',function(){$("#slider_invoice_logowidth, #invoice_logowidth").toggleClass('hidden');if(!$(this).is(':checked')){var logo_width=parseInt($("#slider_invoice_logowidth").slider('value'),10)<=1?80:parseInt($("#slider_invoice_logowidth").slider('value'),10);$("#slider_invoice_logowidth").slider('value',logo_width).siblings('span').html(logo_width+" mm");}
self.updatePDFPreview('invoice');});$("#slider_invoice_logowidth_nc").slider({value:config.invoice.logowidth_nc,min:1,max:200,step:1,slide:function(event,ui){$(this).siblings('span').html(ui.value+" mm");},stop:function(event,ui){self.updatePDFPreview('invoice');}});$("[name=invoice_logo_original_width_nc]").on('click',function(){$("#slider_invoice_logowidth_nc, #invoice_logowidth_nc").toggleClass('hidden');if(!$(this).is(':checked')){var logo_width=parseInt($("#slider_invoice_logowidth_nc").slider('value'),10)<=1?80:parseInt($("#slider_invoice_logowidth_nc").slider('value'),10);$("#slider_invoice_logowidth_nc").slider('value',logo_width).siblings('span').html(logo_width+" mm");}
self.updatePDFPreview('invoice');});$("#slider_estimate_logowidth").slider({value:config.estimate.logowidth,min:1,max:200,step:1,slide:function(event,ui){$(this).siblings('span').html(ui.value+" mm");},stop:function(event,ui){self.updatePDFPreview('estimate');}});$("[name=estimate_logo_original_width]").on('click',function(){$("#slider_estimate_logowidth, #estimate_logowidth").toggleClass('hidden');if(!$(this).is(':checked')){var logo_width=parseInt($("#slider_estimate_logowidth").slider('value'),10)<=1?80:parseInt($("#slider_estimate_logowidth").slider('value'),10);$("#slider_estimate_logowidth").slider('value',logo_width).siblings('span').html(logo_width+" mm");}
self.updatePDFPreview('estimate');});$('.row.templateclass').each(function(){if($(this).find('select option').size()<=1)$(this).hide();});$("#wizard_container .content").prepend($("#wizard_container .actions"));$("textarea[name=invoice_default_mail_body]").attr("id",'invoice_default_mail_body');tinymce.execCommand('mceAddEditor',false,'invoice_default_mail_body');$("textarea[name=invoice_default_mail_body_reminder]").attr("id",'invoice_default_mail_body_reminder');tinymce.execCommand('mceAddEditor',false,'invoice_default_mail_body_reminder');$("textarea[name=estimate_default_mail_body]").attr("id",'estimate_default_mail_body');tinymce.execCommand('mceAddEditor',false,'estimate_default_mail_body');if(this.mode=='config')$("a[href='#previous'],a[href='#next']").hide();else $("a[href='#previous'],a[href='#next']").show();$("a[href='#finish']").addClass('green');$('select[name=invoice_show]').change(function(){$('.row.if_invoice_logo').css('display',$(this).val()<=1||$(this).val()==3?'':'none');}).trigger('change');$('select[name=invoice_show_nc]').change(function(){$('.row.if_credit_note_logo').css('display',$(this).val()<=1||$(this).val()==3?'':'none');}).trigger('change');$('select[name=estimate_show]').change(function(){$('.row.if_estimate_logo').css('display',$(this).val()<=1||$(this).val()==3?'':'none');}).trigger('change');$('.row.impact_on_pdf select, .numbering select').change(function(){self.updatePDFPreview();});$('.row.impact_on_pdf input, .numbering input[type=text]').change(function(){self.updatePDFPreview();});$('.margins a.update').click(function(){self.updatePDFPreview();});$('select[name=mail_method]').change(function(){$('.mail_method.'+$(this).val()).show();$('.mail_method:not(.'+$(this).val()+')').hide();}).trigger('change');$('select[name=imap_method]').change(function(){var classname=$(this).val()?$(this).val():'none';$('.imap_method.'+classname).show();$('.imap_method:not(.'+classname+')').hide();}).trigger('change');$('select[name=sms_service]').change(function(){var classname=$(this).val()?$(this).val():'none';$('.sms_service.'+classname).show();$('.sms_service:not(.'+classname+')').hide();}).trigger('change');$('select[name=invoice_export_book]').change(function(){$('.book.'+$(this).val()).show();$('.book:not(.'+$(this).val()+')').hide();}).trigger('change');$('section[tab=locale] select, section[tab=company] select').select2({width:400,dropdownAutoWidth:true,minimumResultsForSearch:10});$('[name=company_country]').change(function(){if($("[name=company_phone]").val()==''||$("[name=company_phone]").val().replace(/[^0-9]/g,"").length<5){var indicatifs=[{"name":"Israel","dial_code":"+972","code":"IL"},{"name":"Afghanistan","dial_code":"+93","code":"AF"},{"name":"Albania","dial_code":"+355","code":"AL"},{"name":"Algeria","dial_code":"+213","code":"DZ"},{"name":"AmericanSamoa","dial_code":"+1 684","code":"AS"},{"name":"Andorra","dial_code":"+376","code":"AD"},{"name":"Angola","dial_code":"+244","code":"AO"},{"name":"Anguilla","dial_code":"+1 264","code":"AI"},{"name":"Antigua and Barbuda","dial_code":"+1268","code":"AG"},{"name":"Argentina","dial_code":"+54","code":"AR"},{"name":"Armenia","dial_code":"+374","code":"AM"},{"name":"Aruba","dial_code":"+297","code":"AW"},{"name":"Australia","dial_code":"+61","code":"AU"},{"name":"Austria","dial_code":"+43","code":"AT"},{"name":"Azerbaijan","dial_code":"+994","code":"AZ"},{"name":"Bahamas","dial_code":"+1 242","code":"BS"},{"name":"Bahrain","dial_code":"+973","code":"BH"},{"name":"Bangladesh","dial_code":"+880","code":"BD"},{"name":"Barbados","dial_code":"+1 246","code":"BB"},{"name":"Belarus","dial_code":"+375","code":"BY"},{"name":"Belgium","dial_code":"+32","code":"BE"},{"name":"Belize","dial_code":"+501","code":"BZ"},{"name":"Benin","dial_code":"+229","code":"BJ"},{"name":"Bermuda","dial_code":"+1 441","code":"BM"},{"name":"Bhutan","dial_code":"+975","code":"BT"},{"name":"Bosnia and Herzegovina","dial_code":"+387","code":"BA"},{"name":"Botswana","dial_code":"+267","code":"BW"},{"name":"Brazil","dial_code":"+55","code":"BR"},{"name":"British Indian Ocean Territory","dial_code":"+246","code":"IO"},{"name":"Bulgaria","dial_code":"+359","code":"BG"},{"name":"Burkina Faso","dial_code":"+226","code":"BF"},{"name":"Burundi","dial_code":"+257","code":"BI"},{"name":"Cambodia","dial_code":"+855","code":"KH"},{"name":"Cameroon","dial_code":"+237","code":"CM"},{"name":"Canada","dial_code":"+1","code":"CA"},{"name":"Cape Verde","dial_code":"+238","code":"CV"},{"name":"Cayman Islands","dial_code":"+ 345","code":"KY"},{"name":"Central African Republic","dial_code":"+236","code":"CF"},{"name":"Chad","dial_code":"+235","code":"TD"},{"name":"Chile","dial_code":"+56","code":"CL"},{"name":"China","dial_code":"+86","code":"CN"},{"name":"Christmas Island","dial_code":"+61","code":"CX"},{"name":"Colombia","dial_code":"+57","code":"CO"},{"name":"Comoros","dial_code":"+269","code":"KM"},{"name":"Congo","dial_code":"+242","code":"CG"},{"name":"Cook Islands","dial_code":"+682","code":"CK"},{"name":"Costa Rica","dial_code":"+506","code":"CR"},{"name":"Croatia","dial_code":"+385","code":"HR"},{"name":"Cuba","dial_code":"+53","code":"CU"},{"name":"Cyprus","dial_code":"+537","code":"CY"},{"name":"Czech Republic","dial_code":"+420","code":"CZ"},{"name":"Denmark","dial_code":"+45","code":"DK"},{"name":"Djibouti","dial_code":"+253","code":"DJ"},{"name":"Dominica","dial_code":"+1 767","code":"DM"},{"name":"Dominican Republic","dial_code":"+1 849","code":"DO"},{"name":"Ecuador","dial_code":"+593","code":"EC"},{"name":"Egypt","dial_code":"+20","code":"EG"},{"name":"El Salvador","dial_code":"+503","code":"SV"},{"name":"Equatorial Guinea","dial_code":"+240","code":"GQ"},{"name":"Eritrea","dial_code":"+291","code":"ER"},{"name":"Estonia","dial_code":"+372","code":"EE"},{"name":"Ethiopia","dial_code":"+251","code":"ET"},{"name":"Faroe Islands","dial_code":"+298","code":"FO"},{"name":"Fiji","dial_code":"+679","code":"FJ"},{"name":"Finland","dial_code":"+358","code":"FI"},{"name":"France","dial_code":"+33","code":"FR"},{"name":"French Guiana","dial_code":"+594","code":"GF"},{"name":"French Polynesia","dial_code":"+689","code":"PF"},{"name":"Gabon","dial_code":"+241","code":"GA"},{"name":"Gambia","dial_code":"+220","code":"GM"},{"name":"Georgia","dial_code":"+995","code":"GE"},{"name":"Germany","dial_code":"+49","code":"DE"},{"name":"Ghana","dial_code":"+233","code":"GH"},{"name":"Gibraltar","dial_code":"+350","code":"GI"},{"name":"Greece","dial_code":"+30","code":"GR"},{"name":"Greenland","dial_code":"+299","code":"GL"},{"name":"Grenada","dial_code":"+1 473","code":"GD"},{"name":"Guadeloupe","dial_code":"+590","code":"GP"},{"name":"Guam","dial_code":"+1 671","code":"GU"},{"name":"Guatemala","dial_code":"+502","code":"GT"},{"name":"Guinea","dial_code":"+224","code":"GN"},{"name":"Guinea-Bissau","dial_code":"+245","code":"GW"},{"name":"Guyana","dial_code":"+595","code":"GY"},{"name":"Haiti","dial_code":"+509","code":"HT"},{"name":"Honduras","dial_code":"+504","code":"HN"},{"name":"Hungary","dial_code":"+36","code":"HU"},{"name":"Iceland","dial_code":"+354","code":"IS"},{"name":"India","dial_code":"+91","code":"IN"},{"name":"Indonesia","dial_code":"+62","code":"ID"},{"name":"Iraq","dial_code":"+964","code":"IQ"},{"name":"Ireland","dial_code":"+353","code":"IE"},{"name":"Israel","dial_code":"+972","code":"IL"},{"name":"Italy","dial_code":"+39","code":"IT"},{"name":"Jamaica","dial_code":"+1 876","code":"JM"},{"name":"Japan","dial_code":"+81","code":"JP"},{"name":"Jordan","dial_code":"+962","code":"JO"},{"name":"Kazakhstan","dial_code":"+7 7","code":"KZ"},{"name":"Kenya","dial_code":"+254","code":"KE"},{"name":"Kiribati","dial_code":"+686","code":"KI"},{"name":"Kuwait","dial_code":"+965","code":"KW"},{"name":"Kyrgyzstan","dial_code":"+996","code":"KG"},{"name":"Latvia","dial_code":"+371","code":"LV"},{"name":"Lebanon","dial_code":"+961","code":"LB"},{"name":"Lesotho","dial_code":"+266","code":"LS"},{"name":"Liberia","dial_code":"+231","code":"LR"},{"name":"Liechtenstein","dial_code":"+423","code":"LI"},{"name":"Lithuania","dial_code":"+370","code":"LT"},{"name":"Luxembourg","dial_code":"+352","code":"LU"},{"name":"Madagascar","dial_code":"+261","code":"MG"},{"name":"Malawi","dial_code":"+265","code":"MW"},{"name":"Malaysia","dial_code":"+60","code":"MY"},{"name":"Maldives","dial_code":"+960","code":"MV"},{"name":"Mali","dial_code":"+223","code":"ML"},{"name":"Malta","dial_code":"+356","code":"MT"},{"name":"Marshall Islands","dial_code":"+692","code":"MH"},{"name":"Martinique","dial_code":"+596","code":"MQ"},{"name":"Mauritania","dial_code":"+222","code":"MR"},{"name":"Mauritius","dial_code":"+230","code":"MU"},{"name":"Mayotte","dial_code":"+262","code":"YT"},{"name":"Mexico","dial_code":"+52","code":"MX"},{"name":"Monaco","dial_code":"+377","code":"MC"},{"name":"Mongolia","dial_code":"+976","code":"MN"},{"name":"Montenegro","dial_code":"+382","code":"ME"},{"name":"Montserrat","dial_code":"+1664","code":"MS"},{"name":"Morocco","dial_code":"+212","code":"MA"},{"name":"Myanmar","dial_code":"+95","code":"MM"},{"name":"Namibia","dial_code":"+264","code":"NA"},{"name":"Nauru","dial_code":"+674","code":"NR"},{"name":"Nepal","dial_code":"+977","code":"NP"},{"name":"Netherlands","dial_code":"+31","code":"NL"},{"name":"Netherlands Antilles","dial_code":"+599","code":"AN"},{"name":"New Caledonia","dial_code":"+687","code":"NC"},{"name":"New Zealand","dial_code":"+64","code":"NZ"},{"name":"Nicaragua","dial_code":"+505","code":"NI"},{"name":"Niger","dial_code":"+227","code":"NE"},{"name":"Nigeria","dial_code":"+234","code":"NG"},{"name":"Niue","dial_code":"+683","code":"NU"},{"name":"Norfolk Island","dial_code":"+672","code":"NF"},{"name":"Northern Mariana Islands","dial_code":"+1 670","code":"MP"},{"name":"Norway","dial_code":"+47","code":"NO"},{"name":"Oman","dial_code":"+968","code":"OM"},{"name":"Pakistan","dial_code":"+92","code":"PK"},{"name":"Palau","dial_code":"+680","code":"PW"},{"name":"Panama","dial_code":"+507","code":"PA"},{"name":"Papua New Guinea","dial_code":"+675","code":"PG"},{"name":"Paraguay","dial_code":"+595","code":"PY"},{"name":"Peru","dial_code":"+51","code":"PE"},{"name":"Philippines","dial_code":"+63","code":"PH"},{"name":"Poland","dial_code":"+48","code":"PL"},{"name":"Portugal","dial_code":"+351","code":"PT"},{"name":"Puerto Rico","dial_code":"+1 939","code":"PR"},{"name":"Qatar","dial_code":"+974","code":"QA"},{"name":"Romania","dial_code":"+40","code":"RO"},{"name":"Rwanda","dial_code":"+250","code":"RW"},{"name":"Samoa","dial_code":"+685","code":"WS"},{"name":"San Marino","dial_code":"+378","code":"SM"},{"name":"Saudi Arabia","dial_code":"+966","code":"SA"},{"name":"Senegal","dial_code":"+221","code":"SN"},{"name":"Serbia","dial_code":"+381","code":"RS"},{"name":"Seychelles","dial_code":"+248","code":"SC"},{"name":"Sierra Leone","dial_code":"+232","code":"SL"},{"name":"Singapore","dial_code":"+65","code":"SG"},{"name":"Slovakia","dial_code":"+421","code":"SK"},{"name":"Slovenia","dial_code":"+386","code":"SI"},{"name":"Solomon Islands","dial_code":"+677","code":"SB"},{"name":"South Africa","dial_code":"+27","code":"ZA"},{"name":"South Georgia and the South Sandwich Islands","dial_code":"+500","code":"GS"},{"name":"Spain","dial_code":"+34","code":"ES"},{"name":"Sri Lanka","dial_code":"+94","code":"LK"},{"name":"Sudan","dial_code":"+249","code":"SD"},{"name":"Suriname","dial_code":"+597","code":"SR"},{"name":"Swaziland","dial_code":"+268","code":"SZ"},{"name":"Sweden","dial_code":"+46","code":"SE"},{"name":"Switzerland","dial_code":"+41","code":"CH"},{"name":"Tajikistan","dial_code":"+992","code":"TJ"},{"name":"Thailand","dial_code":"+66","code":"TH"},{"name":"Togo","dial_code":"+228","code":"TG"},{"name":"Tokelau","dial_code":"+690","code":"TK"},{"name":"Tonga","dial_code":"+676","code":"TO"},{"name":"Trinidad and Tobago","dial_code":"+1 868","code":"TT"},{"name":"Tunisia","dial_code":"+216","code":"TN"},{"name":"Turkey","dial_code":"+90","code":"TR"},{"name":"Turkmenistan","dial_code":"+993","code":"TM"},{"name":"Turks and Caicos Islands","dial_code":"+1 649","code":"TC"},{"name":"Tuvalu","dial_code":"+688","code":"TV"},{"name":"Uganda","dial_code":"+256","code":"UG"},{"name":"Ukraine","dial_code":"+380","code":"UA"},{"name":"United Arab Emirates","dial_code":"+971","code":"AE"},{"name":"United Kingdom","dial_code":"+44","code":"GB"},{"name":"United States","dial_code":"+1","code":"US"},{"name":"Uruguay","dial_code":"+598","code":"UY"},{"name":"Uzbekistan","dial_code":"+998","code":"UZ"},{"name":"Vanuatu","dial_code":"+678","code":"VU"},{"name":"Wallis and Futuna","dial_code":"+681","code":"WF"},{"name":"Yemen","dial_code":"+967","code":"YE"},{"name":"Zambia","dial_code":"+260","code":"ZM"},{"name":"Zimbabwe","dial_code":"+263","code":"ZW"},{"name":"land Islands","dial_code":"","code":"AX"},{"name":"Antarctica","dial_code":null,"code":"AQ"},{"name":"Bolivia, Plurinational State of","dial_code":"+591","code":"BO"},{"name":"Brunei Darussalam","dial_code":"+673","code":"BN"},{"name":"Cocos (Keeling) Islands","dial_code":"+61","code":"CC"},{"name":"Congo, The Democratic Republic of the","dial_code":"+243","code":"CD"},{"name":"Cote d'Ivoire","dial_code":"+225","code":"CI"},{"name":"Falkland Islands (Malvinas)","dial_code":"+500","code":"FK"},{"name":"Guernsey","dial_code":"+44","code":"GG"},{"name":"Holy See (Vatican City State)","dial_code":"+379","code":"VA"},{"name":"Hong Kong","dial_code":"+852","code":"HK"},{"name":"Iran, Islamic Republic of","dial_code":"+98","code":"IR"},{"name":"Isle of Man","dial_code":"+44","code":"IM"},{"name":"Jersey","dial_code":"+44","code":"JE"},{"name":"Korea, Democratic People's Republic of","dial_code":"+850","code":"KP"},{"name":"Korea, Republic of","dial_code":"+82","code":"KR"},{"name":"Lao People's Democratic Republic","dial_code":"+856","code":"LA"},{"name":"Libyan Arab Jamahiriya","dial_code":"+218","code":"LY"},{"name":"Macao","dial_code":"+853","code":"MO"},{"name":"Macedonia, The Former Yugoslav Republic of","dial_code":"+389","code":"MK"},{"name":"Micronesia, Federated States of","dial_code":"+691","code":"FM"},{"name":"Moldova, Republic of","dial_code":"+373","code":"MD"},{"name":"Mozambique","dial_code":"+258","code":"MZ"},{"name":"Palestinian Territory, Occupied","dial_code":"+970","code":"PS"},{"name":"Pitcairn","dial_code":"+872","code":"PN"},{"name":"Réunion","dial_code":"+262","code":"RE"},{"name":"Russia","dial_code":"+7","code":"RU"},{"name":"Saint Barthélemy","dial_code":"+590","code":"BL"},{"name":"Saint Helena, Ascension and Tristan Da Cunha","dial_code":"+290","code":"SH"},{"name":"Saint Kitts and Nevis","dial_code":"+1 869","code":"KN"},{"name":"Saint Lucia","dial_code":"+1 758","code":"LC"},{"name":"Saint Martin","dial_code":"+590","code":"MF"},{"name":"Saint Pierre and Miquelon","dial_code":"+508","code":"PM"},{"name":"Saint Vincent and the Grenadines","dial_code":"+1 784","code":"VC"},{"name":"Sao Tome and Principe","dial_code":"+239","code":"ST"},{"name":"Somalia","dial_code":"+252","code":"SO"},{"name":"Svalbard and Jan Mayen","dial_code":"+47","code":"SJ"},{"name":"Syrian Arab Republic","dial_code":"+963","code":"SY"},{"name":"Taiwan, Province of China","dial_code":"+886","code":"TW"},{"name":"Tanzania, United Republic of","dial_code":"+255","code":"TZ"},{"name":"Timor-Leste","dial_code":"+670","code":"TL"},{"name":"Venezuela, Bolivarian Republic of","dial_code":"+58","code":"VE"},{"name":"Viet Nam","dial_code":"+84","code":"VN"},{"name":"Virgin Islands, British","dial_code":"+1 284","code":"VG"},{"name":"Virgin Islands, U.S.","dial_code":"+1 340","code":"VI"}];for(var i=0;i<indicatifs.length;i++){if(indicatifs[i].code==$('[name=company_country]').val()){$("[name=company_phone]").val(indicatifs[i].dial_code);break;}}}
if($('[name=company_vat]').val()==''||$('[name=company_vat]').val().replace(/[^0-9]/g,"").length==0){$('[name=company_vat]').val($("[name=company_country]").val().toUpperCase()+" ");}}).trigger('change');$("[name=company_vat]").change(function(){self.validateVAT();}).trigger('change');ui.set('steps_enabled',true);};WizardIndex.prototype.updatePricingSymbols=function()
{$('#calendar_pricing_overtime_mode_symbol').html($('[name=calendar_pricing_overtime_mode]').val()=='%'?'%':locale.currency_symbol+ui.get('unit_symbols')[$("[name=calendar_default_unit]").val()]);$('#calendar_pricing_normal_mode_symbol').html($('[name=calendar_pricing_normal_mode]').val()=='%'?'%':locale.currency_symbol+ui.get('unit_symbols')[$("[name=calendar_default_unit]").val()]);$('#calendar_pricing_weekend_mode_symbol').html($('[name=calendar_pricing_weekend_mode]').val()=='%'?'%':locale.currency_symbol+ui.get('unit_symbols')[$("[name=calendar_default_unit]").val()]);};WizardIndex.prototype.indexRates=function()
{ajax('/config/indexrates',{percentage:$("#index_pct").val()},function(response)
{$("#indexrates_dialog").dialog("close");if(response=="ok")feedback_message(translate("The rates have been successfully updated.","success"));else feedback_message(response=="error"?translate("An error occured while updating the rates"):response,"error");},"json");};WizardIndex.prototype.addTracker=function()
{var self=this;if($('form.tracker_form').valid()){self.trackers.push({id:0,name:$('[name=tracker_name]').val()});$('form.tracker_form input').val('');self.renderTrackers();}}
WizardIndex.prototype.renderUsers=function()
{var self=this;$('div#user_list').empty();for(var c=0;c<this.users.length;c++){var u=this.users[c];var udiv=$('<div>').append($('<img>').attr('title',u.email).attr('src',get_gravatar(u.email))).append($('<strong>').html(u.name+' '+u.firstname)).append(', '+u.role);if(!u.id)udiv.append($('<a>').attr('data-index',c).append($('<i>').addClass("fa fa-lg fa-times red")).click(function(){self.users.splice($(this).attr('data-index'),1);self.renderUsers();}))
$('div#user_list').append(udiv);}};WizardIndex.prototype.renderTrackers=function()
{var self=this;$('div#tracker_list').empty();for(var c=0;c<this.trackers.length;c++){var tracker=this.trackers[c];$('div#tracker_list').append($('<div>').append('<span>'+tracker.name+'</span>').append($('<a>').attr('data-index',c).append($('<i>').addClass("fa fa-lg fa-times red")).click(function(){self.trackers.splice($(this).attr('data-index'),1);self.renderTrackers();})));}};WizardIndex.prototype.initAccordingToTimezone=function(timezone)
{var parts=timezone.split('/');var continent=parts.length>0?parts[0]:'';$("[name=timezone]").val(timezone);$("[name=amount_format], [name=date_format], [name=time_format]").find("option").attr('selected',false);if(continent=="Europe"){$("[name=country]").val('BE');$("[name=currency]").val('EUR');$("[name=amount_format] option:nth-child(1)").attr('selected','selected');$("[name=date_format] option:nth-child(1)").attr('selected','selected');$("[name=time_format] option:nth-child(1)").attr('selected','selected');$("[name=use_vat] option:nth-child(1)").attr('selected','selected');ui.updateModel();}
else if(continent=="Australia"){$("[name=country]").val('AU');$("[name=currency]").val('AUD');$("[name=amount_format] option:nth-child(3)").attr('selected','selected');$("[name=date_format] option:nth-child(7)").attr('selected','selected');$("[name=time_format] option:nth-child(5)").attr('selected','selected');$("[name=use_vat] option:nth-child(2)").attr('selected','selected');ui.updateModel();}
else if(continent=="Asia"){$("[name=country]").val('CN');$("[name=currency]").val('CNY');$("[name=amount_format] option:nth-child(3)").attr('selected','selected');$("[name=date_format] option:nth-child(7)").attr('selected','selected');$("[name=time_format] option:nth-child(5)").attr('selected','selected');$("[name=use_vat] option:nth-child(2)").attr('selected','selected');}
else{$("[name=country]").val('US');$("[name=currency]").val('USD');$("[name=amount_format] option:nth-child(3)").attr('selected','selected');$("[name=date_format] option:nth-child(7)").attr('selected','selected');$("[name=time_format] option:nth-child(5)").attr('selected','selected');$("[name=use_vat] option:nth-child(2)").attr('selected','selected');}};WizardIndex.prototype.getData=function(quick)
{var hours_ok=true;var form=$('[name=calendar_daystart]').parents('form').get(0);if(form&&form.calendar_daystart){hours_ok=false;if(parseInt(form.calendar_daystart.value)<0||parseInt(form.calendar_daystart.value)>24)jalert(translate("The day start hour must be between 0 and 24"),true);else if(parseInt(form.calendar_dayend.value)<1||parseInt(form.calendar_dayend.value)>24)jalert(translate("The day end hour must be between 1 and 24"),true);else if(parseInt(form.calendar_workstart.value)<0||parseInt(form.calendar_workstart.value)>24)jalert(translate("The work start hour must be between 0 and 24"),true);else if(parseInt(form.calendar_workend.value)<1||parseInt(form.calendar_workend.value)>24)jalert(translate("The work end hour must be between 1 and 24"),true);else if(parseInt(form.calendar_dayend.value)<=parseInt(form.calendar_daystart.value))jalert(translate("The day end hour must be &gt; day start hour"),true);else if(parseInt(form.calendar_workstart.value)<parseInt(form.calendar_daystart.value))jalert(translate("The work start must be &gt;= day start hour"),true);else if(parseInt(form.calendar_workend.value)>parseInt(form.calendar_dayend.value))jalert(translate("The work end must be &lt;= day end hour"),true);else hours_ok=true;}
if(!hours_ok)return false;var calendar_constraining_providers=[];$('input[type=checkbox]').each(function(){if(this.name.match(/calendar_constraining_providers\[\]$/)){if(!$(this).is(':checked'))calendar_constraining_providers.push($(this).val());}});var company_vat=trim($("[name=company_vat]").val());if(company_vat.replace(/[^0-9]/g,"")=='')company_vat='';var company_phone=trim($("[name=company_phone]").val());var data={mode:this.mode,locale:{id_country:$("[name=country]").val(),currency:$("[name=currency]").val(),timezone:$("[name=timezone]").val(),date_format:$("[name=date_format]").val(),time_format:$("[name=time_format]").val(),amount_format:$("[name=amount_format]").val(),pdf_format:$("[name=pdf_format]").val(),use_vat:$("[name=use_vat]").val(),invoice_reference_label:$("[name=invoice_reference_label]").val()},company:{name:$("[name=company_name]").val(),address:$("[name=company_address]").val(),zip:$("[name=company_zip]").val(),city:$("[name=company_city]").val(),country:$("[name=company_country]").val(),phone:company_phone,vat:company_vat,iban:$("[name=company_iban]").val(),bic:$("[name=company_bic]").val(),bank:$("[name=company_bank]").val()},invoice:{default_date:$("[name=invoice_default_date]").val(),default_due_date:$("[name=invoice_default_due_date]").val(),export_book:$('[name=invoice_export_book]').val(),templateclass:$("[name=invoice_templateclass]").val(),show:$("[name=invoice_show]").val(),logowidth:($('[name=invoice_logo_original_width]').is(':checked')?0:($("#slider_invoice_logowidth").size()>0?$("#slider_invoice_logowidth").slider("value"):0)),invoice_numbering:$("[name=invoice_numbering]").val(),invoice_ref_next:$("[name=invoice_ref_next]").val(),need_approval:$("[name=invoice_need_approval]").is(':checked'),margin_top:$('[name=invoice_margin_top]').val(),margin_bottom:$('[name=invoice_margin_bottom]').val(),margin_left:$('[name=invoice_margin_left]').val(),margin_right:$('[name=invoice_margin_right]').val(),show_nc:$("[name=invoice_show_nc]").val(),logowidth_nc:($('[name=invoice_logo_original_width_nc]').is(':checked')?0:($("#slider_invoice_logowidth_nc").size()>0?$("#slider_invoice_logowidth_nc").slider("value"):0)),credit_note_numbering:$("[name=credit_note_numbering]").val(),credit_note_ref_next:$("[name=credit_note_ref_next]").val(),margin_top_nc:$('[name=invoice_margin_top_nc]').val(),margin_bottom_nc:$('[name=invoice_margin_bottom_nc]').val(),margin_left_nc:$('[name=invoice_margin_left_nc]').val(),margin_right_nc:$('[name=invoice_margin_right_nc]').val(),freeze_sent_invoices:$('[name=invoice_freeze_sent_invoices]').is(':checked'),default_mail_body:(tinymce.get('invoice_default_mail_body')?tinymce.get('invoice_default_mail_body').getContent():null),default_mail_body_reminder:(tinymce.get('invoice_default_mail_body_reminder')?tinymce.get('invoice_default_mail_body_reminder').getContent():null),group_by_secondary:$('[name=invoice_group_by_secondary]').val()},estimate:{templateclass:$("[name=estimate_templateclass]").val(),show:$("[name=estimate_show]").val(),logowidth:($('[name=estimate_logo_original_width]').is(':checked')?0:($("#slider_estimate_logowidth").size()>0?$("#slider_estimate_logowidth").slider("value"):0)),estimate_numbering:$("[name=estimate_numbering]").val(),estimate_ref_next:$("[name=estimate_ref_next]").val(),margin_top:$('[name=estimate_margin_top]').val(),margin_bottom:$('[name=estimate_margin_bottom]').val(),margin_left:$('[name=estimate_margin_left]').val(),margin_right:$('[name=estimate_margin_right]').val(),freeze_sent_estimates:$('[name=estimate_freeze_sent_estimates]').is(':checked'),default_mail_body:tinymce.get('estimate_default_mail_body')?tinymce.get('estimate_default_mail_body').getContent():null,},calendar:{default_duration:$("[name='calendar_default_duration']").val(),daystart:$("[name='calendar_daystart']").val(),dayend:$("[name='calendar_dayend']").val(),workstart:$("[name='calendar_workstart']").val(),workend:$("[name='calendar_workend']").val(),allowoverlap:$("[name='calendar_allowoverlap']").is(':checked'),default_unit:$("[name='calendar_default_unit']").val(),max_hours_day:$("[name='calendar_max_hours_day']").val(),max_hours_week:$("[name='calendar_max_hours_week']").val(),max_hours_month:$("[name='calendar_max_hours_month']").val(),day_in_month_freeze:$("[name='calendar_day_in_month_freeze']").val(),day_in_week_freeze:$("[name='calendar_day_in_week_freeze']").val(),pricing_normal:$("[name='calendar_pricing_normal']").val(),pricing_normal_mode:$("[name='calendar_pricing_normal_mode']").val(),pricing_overtime:$("[name='calendar_pricing_overtime']").val(),pricing_overtime_mode:$("[name='calendar_pricing_overtime_mode']").val(),pricing_weekend:$("[name='calendar_pricing_weekend']").val(),pricing_weekend_mode:$("[name='calendar_pricing_weekend_mode']").val(),constraining_providers:calendar_constraining_providers,allow_work_on_non_leaf_trackers:$("[name='allow_work_on_non_leaf_trackers']").is(':checked'),user_set_prices_by:$("[name='user_set_prices_by']").val(),tracker_set_prices_by:$("[name='tracker_set_prices_by']").val()},bob:{user:$('[name=bob_user]').val(),dossier:$('[name=bob_dossier]').val(),journal_facture:$('[name=bob_journal_facture]').val(),journal_nc:$('[name=bob_journal_nc]').val(),fiscal_month:$('[name=bob_fiscal_month]').val(),compte_general:$('[name=bob_compte_general]').val(),boblink_path:$('[name=bob_boblink_path]').val(),autonum:$('[name=bob_autonum]').is(':checked'),intemp:$('[name=bob_intemp]').is(':checked'),},jvsoft:{journal_facture:$('[name=jvsoft_journal_facture]').val(),journal_nc:$('[name=jvsoft_journal_nc]').val(),fiscal_month:$('[name=jvsoft_fiscal_month]').val(),compte_general:$('[name=jvsoft_compte_general]').val(),compte_clients:$('[name=jvsoft_compte_clients]').val(),compte_tva:$('[name=jvsoft_compte_tva]').val(),},clogic:{journal_facture:$('[name=clogic_journal_facture]').val(),journal_nc:$('[name=clogic_journal_nc]').val(),compte_general:$('[name=clogic_compte_general]').val()},winbooks:{journal_facture:$('[name=winbooks_journal_facture]').val(),journal_nc:$('[name=winbooks_journal_nc]').val(),fiscal_month:$('[name=winbooks_fiscal_month]').val(),compte_general:$('[name=winbooks_compte_general]').val(),compte_clients:$('[name=winbooks_compte_clients]').val(),compte_tva:$('[name=winbooks_compte_tva]').val()},mail:{method:$('[name=mail_method]').val(),read_receipt:$('[name=mail_read_receipt]').is(':checked'),host:$('[name=mail_host]').val(),port:$('[name=mail_port]').val(),domain:$('[name=mail_domain]').val(),secure:$('[name=mail_secure]').val(),auth:$('[name=mail_auth]').is(':checked'),username:$('[name=mail_username]').val(),password:$('[name=mail_password]').val(),from:$('[name=mail_from]').val()},imap:{method:$('[name=imap_method]').val(),host:$('[name=imap_host]').val(),port:$('[name=imap_port]').val(),secure:$('[name=imap_secure]').val(),mailbox_name:$('[name=imap_mailbox_name]').val(),username:$('[name=imap_username]').val(),password:$('[name=imap_password]').val()},sms:{service:$('[name=sms_service]').val(),username:$('[name=sms_username]').val(),password:$('[name=sms_password]').val()},default_profile:{lang:$("[name=default_profile_lang]").val(),calendar_timeunit:$("[name=default_profile_calendar_timeunit]").val(),calendar_showweekends:$("[name=default_profile_calendar_showweekends]").is(':checked'),},first_user:{name:$('[name=first_user_name]').val(),firstname:$('[name=first_user_firstname]').val(),email:$('[name=first_user_email]').val()},users:this.users,default_unitary_price:$("[name=default_unitary_price]").val(),default_unit:$("[name=default_unit]").val(),trackers:this.trackers,quick:quick?true:false};return data;};WizardIndex.prototype.reloadViewer=function(type)
{if(!type){this.reloadViewer('invoice');this.reloadViewer('credit_note');this.reloadViewer('estimate');}
else{var pdf_selector=$('#pdf_viewer_'+type);var parent=pdf_selector.parent();pdf_selector.remove();pdf_selector.attr('data',baseUrl+'/'+(type=='estimate'?type:'invoice')+'/getpdf/id/'+type+'/'+(new Date().getTime())+'/'+ui.get(type+'_filename')+'.pdf#view=fitW');parent.append(pdf_selector);}};WizardIndex.prototype.updatePDFPreview=function()
{var self=this;var data=this.getData(true);if(data===false)return false;_ajax('wizard/save',data).done(function(response){ui.set(response);$('.row.ref_next input').each(function(){$(this).val(ui.get($(this).attr('name')));});self.reloadViewer();hideWait();});};WizardIndex.prototype.validateVAT=function()
{var self=this;$('i.vat-check').removeClass('fa-exclamation-circle red fa-check-circle green fa-spin-custom').attr('title','');var vat=trim($("[name=company_vat]").val());if(vat.replace(/[^0-9]/g,"")=='')return true;$('i.vat-check').addClass('fa-spinner fa-spin-custom');var number=vat.replace(/[^0-9a-zA-Z]/g,'').toUpperCase();$("input[name=company_vat]").val(number);$.getJSON('https://www.apilayer.net/api/validate?access_key=439b46644eeb97e50ecf1fd7c84a7ef6&vat_number='+number+'&callback=?',function(response){if(response.valid){var message=translate('The VAT number has been successfully validated by the VAT number validation system provided by APILAYER LTD and based on European Commission\'s databases.');$('i.vat-check').removeClass('fa-spinner fa-spin-custom fa-exclamation-circle red').addClass('fa-check-circle green').attr('title',message);$("input[name=company_vat]").val(response.country_code+' '+response.vat_number);}
else{var message=translate('The VAT number could not be validated by the VAT number validation system provided by APILAYER LTD and based on European Commission\'s databases.');$('i.vat-check').removeClass('fa-check-circle green fa-spinner fa-spin-custom').addClass('fa-exclamation-circle red').attr('title',message);}});};WizardIndex.prototype.saveSettings=function()
{var self=this;showWait(translate("Saving..."));var data=this.getData(false);if(data===false)return false;_ajax('wizard/save',data).done(function(response){if(!response)jerror(translate("An error occured while saving your settings"));else{hideWait();feedback_message(translate("Your settings have been saved."),"success");if(self.mode=='wizard'){router.navigate('/dashboard',true);menutop.fire('toggle-menu');}}});};WizardIndex.prototype.dispose=function()
{$("#menutop").show();try{tinymce.execCommand('mceRemoveEditor',false,'invoice_default_mail_body');tinymce.execCommand('mceRemoveEditor',false,'invoice_default_mail_body_reminder');tinymce.execCommand('mceRemoveEditor',false,'estimate_default_mail_body');}catch(ex){}};;function AccountOrderGrid(name,config){if(name)this.init(name,config);}
AccountOrderGrid.prototype=new TimetrackEditableGrid();AccountOrderGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No order found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No order found matching your search criteria');config.controller='accountorder';TimetrackEditableGrid.prototype.init.call(this,name,config);};AccountOrderGrid.prototype.getActions=function(cell,id_order)
{var actions=[];var status=this.getValueAt(cell.rowIndex,this.getColumnIndex('status'));if(parseInt(status,10)==2)actions.push({icon:img('invoice_export_pdf16','download pdf invoice',translate('Download PDF invoice')),href:baseUrl+'/ajax/accountorder/pdf/id/'+id_order});return actions;};;var AUTOMATOR_ENABLED=false;function Automator()
{this.mouseX=0;this.mouseY=0;this.active=false;if(AUTOMATOR_ENABLED&&this.get('automator')!=''){obj=this;$(document.body).append($('<div>').attr('id','autocursor').css({display:'none',position:'absolute'}).append($(img('cursor'))));$(document).mousemove(function(e){obj.mouseX=e.pageX||e.clientX+document.documentElement.scrollLeft;obj.mouseY=e.pageY||e.clientY+document.documentElement.scrollTop;obj.position();});this.index=0;this.macro=[{field:'name',value:"Webismymind Auto"},{field:'email',value:"info@webismymind.be"},{field:'phone',value:"+32495784565"},{field:'website',value:"http://www.webismymind.be"},{field:'note',value:"Des solutions innovantes pour des entreprises innovantes"}];alert("Dan The Automator va maintenant prendre le contrôle de votre ordinateur et créer un client pour vous!");setTimeout("obj.start()",100);}}
Automator.prototype.get=function(name)
{name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);return results==null?"":results[1];};Automator.prototype.step=function()
{if(this.index==this.macro.length){this.follow(_$('submit'));return;}
this.fill(_$(this.macro[this.index].field),this.macro[this.index].value);this.index++;};Automator.prototype.follow=function(element)
{this.position(element,30);setTimeout("if (obj.element && obj.element.href) window.location.href = obj.element.href; else obj.element.click()",1500);};Automator.prototype.fill=function(element,value)
{this.position(element,5);this.value=value;this.element.focus();if(typeof tinyMCE!='undefined'&&tinyMCE.get(element.id)){setTimeout("if (obj.element) { tinyMCE.get(obj.element.id).setContent(obj.value); tinyMCE.get(obj.element.id).setProgressState(0); }",500);}
else setTimeout("if (obj.element) obj.element.value = obj.value",500);setTimeout("obj.step()",1500);};Automator.prototype.position=function(element,offset)
{if(this.active){if(typeof element!='undefined')this.element=element;$('#autocursor').show().css(typeof element=='undefined'?{left:obj.mouseX,top:obj.mouseY}:{left:$(element).offset().left+(offset||0),top:$(element).offset().top+4});}};Automator.prototype.start=function()
{$("*").css('cursor','none');this.active=true;this.position();setTimeout("obj.step()",1000);};Automator.prototype.end=function()
{$('#autocursor').hide();$("*").css('cursor','normal');this.active=false;};;function BelgiumdaysGrid(name,config){if(name)this.init(name,config);}
BelgiumdaysGrid.prototype=new TimetrackEditableGrid();BelgiumdaysGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No entry found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No entry found matching your search criteria');config.controller='belgiumdays';TimetrackEditableGrid.prototype.init.call(this,name,config);};BelgiumdaysGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};BelgiumdaysGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify entries.");return false;}
return true;};BelgiumdaysGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_user'])>=0;};BelgiumdaysGrid.prototype.getActions=function(cell,id_belgiumdays)
{var self=this;var actions=[];if(isAllowed('configuration','edit')){actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this entry ?',true)))self.deleteBelgiumday(id_belgiumdays);}});}
return actions;};BelgiumdaysGrid.prototype.deleteBelgiumday=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('belgiumdays/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the entry from database","Error");else{self.refresh();self.onChange();}});};;function BelgiumdaysIndex(){};BelgiumdaysIndex.prototype=new DefaultScreen();BelgiumdaysIndex.prototype.init=function(name)
{var self=this;this.grid=new BelgiumdaysGrid("BelgiumdaysGrid",{getParameters:function(){var parameter={};parameter.id_users=$('.user_select').val()||[];return parameter;}});$('a.button.add').click(function(){new BelgiumdaysEditor({afterSave:function(){self.grid.refresh();}}).open();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:200,noneSelectedText:noneSelectedText(translate("Choose users")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Users"))}).on('multiselectclose',function(){self.grid.refresh();});};;function BillingGrid(name,config){if(name)this.init(name,config);}
BillingGrid.prototype=new TrackerBasedGrid();BillingGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No tracker found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No tracker found matching your search criteria');if(typeof config.controller=='undefined')config.controller='billing';config.serverSide=false;config.enableSort=false;TrackerBasedGrid.prototype.init.call(this,name,config);};BillingGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed(ui.get('job.id')?'jobs':'customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
if(this.hasColumn('time_billing')&&columnIndex==this.getColumnIndex("time_billing")&&this.getRowAttribute(rowIndex,"data_tracker").covered==1){return false;}
return true;};BillingGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return true;};BillingGrid.prototype.tableLoaded=function()
{var self=this;this.setDefaultRenderers();for(var columnIndex=0;columnIndex<this.getColumnCount();columnIndex++){var columName=this.getColumnName(columnIndex);if(helpboxes['item_time_'+columName])this.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes['item_time_'+columName],trim(this.getColumnLabel(columnIndex))?this.getColumnLabel(columnIndex):translate("Information"),480,true));}
if(this.hasColumn('label'))this.setCellRenderer('label',new CellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");CellRenderer.prototype.render.call(this,cell,data_tracker.label_value_inherited);if(data_tracker.label_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));if(this.hasColumn('label'))this.setCellEditor('label',new TextCellEditor(null,null,{getEditor:function(cell,value){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");var editor=TextCellEditor.prototype.getEditor.call(this,cell,value);$(editor).attr('placeholder',data_tracker.label_placeholder);return editor;}}));if(this.hasColumn('description'))this.setCellRenderer('description',new CellRenderer({render:function(cell,value){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");$(cell).html(img('customer_note','note',data_tracker.description_value_inherited)).css('text-align','left').css('width','16px');;$(cell).find('img').css('opacity',data_tracker.description_inherited==0&&value?'1':'.3');}}));if(this.hasColumn('description'))this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,create:function(cell,value){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");$(this.textArea).attr('placeholder',data_tracker.description_placeholder);},getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('name'))+'"';}}));if(this.hasColumn('time_billing'))this.setCellRenderer('time_billing',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");EnumCellRenderer.prototype.render.call(this,cell,data_tracker.time_billing_value_inherited);if(data_tracker.time_billing_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');if(data_tracker.covered==1)$(cell).append("&nbsp;&nbsp;"+img('headerinfo','',translate("You cannot bill time on this tracker since you are billing the time budgets instead. In order to enable time billing on this tracker, you have to delete the budget lump sums first.")));}}));if(this.hasColumn('unitary_price'))this.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");var time_billing=data_tracker.time_billing_value_inherited;var invoiceable=data_tracker.invoiceable;NumberCellRenderer.prototype.render.call(this,cell,parseFloat(data_tracker.unitary_price_value_inherited));if(data_tracker.unitary_price_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');if(time_billing=='none')$(cell).css('text-decoration','line-through');if(invoiceable!=1)$(cell).attr("title",translate("This tracker is of a non invoiceable type"));else if(time_billing=='none')$(cell).attr("title",translate("Time billing is not enabled on this tracker"));else $(cell).removeAttr("title");}}));if(this.hasColumn('id_unit'))this.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");EnumCellRenderer.prototype.render.call(this,cell,data_tracker.id_unit_value_inherited);$(cell).prepend('/ ').css('white-space','nowrap');if(data_tracker.id_unit_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));if(this.hasColumn('id_vat_type'))this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=self.getRowAttribute(cell.rowIndex,"data_tracker");EnumCellRenderer.prototype.render.call(this,cell,data_tracker.id_vat_type_value_inherited);if(data_tracker.id_vat_type_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));for(var c=0;c<this.getColumnCount();c++)if(this.getColumnName(c).startsWith("unitary_price_category-")){var id_price_category=self.getColumnName(c).substr("unitary_price_category-".length);this.setHeaderRenderer(c,new CellRenderer({id_price_category:id_price_category,render:function(cell,value){var response=$.evalJSON(value);$(cell).html(response.name).attr('title',response.users).css('font-family','').css('font-size','');}}));this.setCellRenderer(c,new NumberCellRenderer({id_price_category:id_price_category,render:function(cell,dummy){var price=self.getRowAttribute(cell.rowIndex,"price_by_category")[this.id_price_category];NumberCellRenderer.prototype.render.call(this,cell,parseFloat(price.user_price_value_inherited));if(price.category_price_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));}
for(var c=0;c<this.getColumnCount();c++)if(this.getColumnName(c).startsWith("unitary_price_user-")){var id_user=self.getColumnName(c).substr("unitary_price_user-".length);this.setHeaderRenderer(c,new CellRenderer({id_user:id_user,render:function(cell,value){var response=$.evalJSON(value);if(self.getColumnCount()>=11)$(cell).html(response.initials).attr('title',response.fullname+'<br/>'+response.category+'<br/>'+response.tags).css('font-family','Courier').css('font-size','1.15em');else $(cell).html(response.fullname).attr('title',response.category+'<br/>'+response.tags).css('font-family','').css('font-size','');}}));this.setCellRenderer(c,new NumberCellRenderer({id_user:id_user,render:function(cell,dummy){var price=self.getRowAttribute(cell.rowIndex,"price_by_user")[this.id_user];NumberCellRenderer.prototype.render.call(this,cell,parseFloat(price.user_price_value_inherited));if(price.user_price_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));}
this.render();this.setupTreeTable();};;function CalendarIndex(){}
CalendarIndex.prototype=new DefaultScreen();CalendarIndex.prototype.init=function()
{gridWait('wait_loading');_ajax('calendar/loadjobs').done(function(response){ui.set(response);$('.progress').progressbar().each(function(){var percent=parseInt($(this).attr('data-value'),10);$(this).progressbar("value",percent);$(this).find('.ui-widget-header').attr('title',percent+' %').css('background-color','#'+$(this).attr('data-color'));$(this).find('.progress-label').css('color',cssColor(getFrontColor(toRGB($(this).attr('data-color')))));});});ui.on('toggle-late-tasks',function(event){var task_area=$(event.node).siblings('[data-role=area]');var hiding=task_area.is(':visible');task_area.toggle();if(hiding)$(event.node).addClass('collapsed');else $(event.node).removeClass('collapsed');});this.show();this.nbWeeks=4;this.show_weekends=true;this.calendarObject=$("#calendar-calendar");this.fullCalendarInit();};CalendarIndex.prototype.makeLateTasksDraggable=function()
{if(ui.get('late_tasks').length)$('.calendar-late-tasks').show();else $('.calendar-late-tasks').hide();$('.calendar-late-tasks [data-role=item]').each(function(){try{$(this).draggable('destroy');}catch(ex){}});$(".calendar-late-tasks [data-role=item]").draggable({helper:function(){return $(this).find('h3').clone().css('width',$(this).width()+'px').attr('rel',$(this).attr('rel')).addClass('calendar-late-tasks-helper').appendTo(document.body);},opacity:0.5,revert:true,revertDuration:250,zIndex:100000});};CalendarIndex.prototype.fullCalendarInit=function()
{var self=this;this.calendarObject.fullCalendar({lazyFetching:true,firstDay:1,editable:true,eventLimit:true,droppable:true,defaultView:'calendarMultiWeekView',events:function(start,end,timezone,callback)
{showWait(translate("Loading..."));_ajax('calendar/loadinterval',{start:start,end:self.momentoffset(end,-1)}).done(function(response){ui.set(response);self.makeLateTasksDraggable();self.events=[];self._addTasks(ui.get('tasks'));self._addTimesheetEntries(ui.get('timesheet_entries'));callback(self.events);hideWait();});},customButtons:{next:{text:translate('Next'),click:function(){self.calendarObject.fullCalendar('next');}},prev:{text:translate('Previous'),click:function(){self.calendarObject.fullCalendar('prev');}},today:{text:translate('Today'),click:function(){self.calendarObject.fullCalendar('today');}}},header:{left:'',center:'title',right:'prev,next today'},views:{calendarMultiWeekView:{type:'basic',duration:{days:this.nbWeeks*7},weekends:this.show_weekends},timesheetWeekView:{type:'agenda',duration:{days:7},weekends:this.show_weekends}},eventClick:function(calEvent,jsEvent,view)
{if(calEvent.type=="task"){var id_task=parseInt(calEvent.id.substr(2),10);new TaskEditor({id_task:id_task,forceEdit:false,afterSave:function(){self._refresh();}}).open();}
else if(calEvent.type=="timesheet_entry"){var timesheet_entry=self.getTimesheetEntry(calEvent.id);$('#calendar-dialog').html(comment2html(timesheet_entry['comment'])).dialog({width:600,title:timesheet_entry['path'],buttons:[{text:"OK",click:function(){$(this).dialog("close");}}]});}
return true;},eventDrop:function(event,delta,revertFunc){var id_task=parseInt(event.id.substr(2),10);self.setTaskDueDate(id_task,event.start.format());},drop:function(date,jsEvent,ui,resourceId){var id_task=parseInt($(ui.helper).attr('rel'),10);self.setTaskDueDate(id_task,date,true);},eventAfterAllRender:function(){self.updateTotals();}});};CalendarIndex.prototype.updateTotals=function()
{var tasks=ui.get('tasks');var timesheet_entries=ui.get('timesheet_entries');$('.fc-bg td[data-date]').each(function(){var totalSeconds=0;var date_mysql=$(this).attr('data-date');if(tasks)for(var index=0;index<tasks.length;index++){var task=tasks[index];if(task['estimated_hours']&&task['_due_date']==date_mysql)totalSeconds+=parseFloat(task['estimated_hours'])*3600;}
if(timesheet_entries)for(var index=0;index<timesheet_entries.length;index++){var timesheet_entry=timesheet_entries[index];if(timesheet_entry['seconds']&&timesheet_entry['date_start'].substr(0,10)==date_mysql)totalSeconds+=parseInt(timesheet_entry['seconds'],10);}
if(totalSeconds>0)$(this).html('<span class=\'calendar-hours\'>'+getDisplayTime(totalSeconds)+'</span>');else $(this).html('');});};CalendarIndex.prototype.setTaskDueDate=function(id,newdate,refresh)
{var self=this;_ajax('calendar/settaskduedate',{id:id,newdate:newdate}).done(function(){if(refresh)self._refresh();else _ajax('calendar/loadinterval',{start:self.calendarObject.fullCalendar('getView').intervalStart,end:self.momentoffset(self.calendarObject.fullCalendar('getView').intervalEnd,-1)}).done(function(response){ui.set('late_tasks',response.late_tasks);self.makeLateTasksDraggable();ui.set('tasks',response.tasks);self.updateTotals();});});};CalendarIndex.prototype.momentoffset=function(_moment,modDay,modMonth,modYear)
{var moment=_moment.clone();if(modDay)moment.add(modDay,'days');if(modMonth)moment.add(modMonth,'months');if(modYear)moment.add(modYear,'years');return moment;};CalendarIndex.prototype._refresh=function()
{this.calendarObject.fullCalendar('refetchEvents');};CalendarIndex.prototype._addTasks=function(tasks)
{for(var index=0;index<tasks.length;index++){var task=tasks[index];this._addEvent("task",task['id'],task['title'],task['_due_date'],true,task['_due_date']>=moment().format("YYYY-MM-DD")?undefined:'#CC0000');}};CalendarIndex.prototype._addTimesheetEntries=function(timesheetEntries)
{for(var index=0;index<timesheetEntries.length;index++){var timesheetEntry=timesheetEntries[index];this._addEvent("timesheet_entry",timesheetEntry['id'],timesheetEntry['path'],timesheetEntry['date_start'],false,'#00AA00',undefined,'#00AA00',timesheetEntry['date_end']);}};CalendarIndex.prototype._addEvent=function(ev_type,ev_id,ev_title,ev_start,ev_editable,ev_backgroundColor,ev_textColor,ev_borderColor,ev_end)
{this.events.push({id:ev_id,title:ev_title,start:ev_start,backgroundColor:ev_backgroundColor,textColor:ev_textColor,borderColor:ev_borderColor,end:ev_end,editable:ev_editable,type:ev_type,durationEditable:false,startEditable:ev_editable});};CalendarIndex.prototype.getTask=function(id)
{for(var index=0;index<ui.get('tasks').length;index++)if(ui.get('tasks')[index]['id']==id)return ui.get('tasks')[index];return null;};CalendarIndex.prototype.getTimesheetEntry=function(id)
{for(var index=0;index<ui.get('timesheet_entries').length;index++)if(ui.get('timesheet_entries')[index]['id']==id)return ui.get('timesheet_entries')[index];return null;};;function CategoriesModule(){this.init=function()
{var self=this;this.tabLoaded={};this.createGrids();$("#tabs").tabs().find(".ui-tabs-nav").sortable({axis:'x'});$("#tabs").on("tabsbeforeactivate",function(e,ui){self.loadTab(ui.newPanel.attr('id'));});if(localisset('categories_currentTabIndex')&&parseInt(localget('categories_currentTabIndex'))>0&&$("#tabs").tabs('option','active')==0)$("#tabs").tabs('option','active',parseInt(localget('categories_currentTabIndex')));else self.loadTab($('div.tabs-config:first').attr('id'));$("#tabs").on("tabsactivate",function(event,ui){localset('categories_currentTabIndex',$(this).tabs('option','active'));});if(!isAllowed('configuration','edit'))$('input,select,textarea').attr('disabled','1');$('p.categories_add a.button').addClass("disabled").attr('disabled',true);};this.loadTab=function(id_panel)
{var self=this;if(typeof self.tabLoaded[id_panel]!='undefined')return true;if(id_panel=='tabs-config-trackertypes')self.trackerTypesEditableGrid.loadJSON(baseUrl+'/config/generatetrackertypejson');if(id_panel=='tabs-config-trackerunits')self.trackerUnitsEditableGrid.loadJSON(baseUrl+'/config/generatetrackerunitjson');if(id_panel=='tabs-config-trackerstatus')self.trackerStatusEditableGrid.loadJSON(baseUrl+'/config/generatetrackerstatusjson');if(id_panel=='tabs-config-tags')self.tagsEditableGrid.loadJSON(baseUrl+'/config/generatetagjson');if(id_panel=='tabs-config-customerroles')self.customerRolesEditableGrid.loadJSON(baseUrl+'/config/generatecustomerrolejson');if(id_panel=='tabs-config-vattypes')self.vatTypesEditableGrid.loadJSON(baseUrl+'/config/generatevattypejson');if(id_panel=='tabs-config-expensetypes')self.expenseTypesEditableGrid.loadJSON(baseUrl+'/config/generateexpensetypejson');self.tabLoaded[id_panel]=true;};this.createGrids=function()
{var self=this;this.trackerTypesEditableGrid=new TimetrackEditableGrid("TrackerTypesGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeTrackerTypesGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatetrackertypecellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){return response=="ok";});}});this.trackerUnitsEditableGrid=new TimetrackEditableGrid("TrackerUnitsGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeTrackerUnitsGrid(this);},isEditable:function(rowIndex,columnIndex){if(columnIndex==3){if(this.getValueAt(rowIndex,2)!='hourly')return false;}
return isAllowed('configuration','edit')&&this.getRowId(rowIndex)!=1000;},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatetrackerunitcellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){if(columnIndex>=2)self.trackerUnitsEditableGrid.loadJSON(baseUrl+'/config/generatetrackerunitjson');return response=="ok";});}});this.tagsEditableGrid=new TimetrackEditableGrid("TagsGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeTagsGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatetagcellvalue',rowIndex,columnIndex,oldValue,newValue,row);}});this.customerRolesEditableGrid=new TimetrackEditableGrid("CustomerRolesGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeCustomerRolesGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatecustomerrolecellvalue',rowIndex,columnIndex,oldValue,newValue,row);}});this.vatTypesEditableGrid=new TimetrackEditableGrid("VatTypesGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeVatTypesGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatevattypecellvalue',rowIndex,columnIndex,oldValue,newValue,row);}});this.expenseTypesEditableGrid=new TimetrackEditableGrid("ExpenseTypesGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeExpenseTypesGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updateexpensetypecellvalue',rowIndex,columnIndex,oldValue,newValue,row);}});this.trackerStatusEditableGrid=new TimetrackEditableGrid("TrackerStatusGrid",{serverSide:false,alternate:true,tableLoaded:function(){self.initializeTrackerStatusGrid(this);},isEditable:function(rowIndex,columnIndex){return isAllowed('configuration','edit');},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/config/updatetrackerstatuscellvalue',rowIndex,columnIndex,oldValue,newValue,row);}});};this.initializeTrackerTypesGrid=function(grid)
{for(var columnIndex=0;columnIndex<grid.getColumnCount();columnIndex++){var columName=grid.getColumnName(columnIndex);if(helpboxes['tracker_type_'+columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes['tracker_type_'+columName],grid.getColumnLabel(columnIndex),480,true));}
grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_tracker_type){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var confmessage=translate('Are you sure to delete this tracker type ? If some trackers use this type, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletetrackercategory("+id_tracker_type+");";if(id_tracker_type!=1&&isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletetrackertype','delete',translate('Delete tracker type'))+"</a>";}}));grid.setCellEditor("color",new ColorCellEditor());grid.setCellRenderer("color",new CellRenderer({render:function(cell,color){color=color?color.toLocaleUpperCase():color;CellRenderer.prototype.render.call(this,cell,color);$(cell).css('background-color',color?'#'+color:'');}}));grid.renderGrid("tablecontent_trackertypes","datagrid");};this.initializeTrackerUnitsGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_unit){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var confmessage=translate('Are you sure to delete this unit ? If some trackers use this unit, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletetrackerunit("+id_unit+");";if(isAllowed('configuration','edit')&&id_unit!=1000)cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletetrackerunit','delete',translate('Delete unit'))+"</a>";}}));grid.renderGrid("tablecontent_trackerunits","datagrid");};this.initializeTagsGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellEditor("tablenames",new MultiselectCellEditor({closeText:translate('Apply')}));grid.setCellRenderer("tablenames",new MultiselectCellRenderer({noneText:translate('(none_)')}));grid.setCellEditor("color",new ColorCellEditor());grid.setCellRenderer("color",new CellRenderer({render:function(cell,color){color=color?color.toLocaleUpperCase():color;CellRenderer.prototype.render.call(this,cell,color);$(cell).css('background-color',color?'#'+color:'');}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_tag){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var confmessage=translate('Are you sure to delete this tag ? This will NOT delete objects using this tag.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletetag("+id_tag+");";if(isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletetag','delete','Delete tag')+"</a>";}}));grid.renderGrid("tablecontent_tags","datagrid");};this.initializeCustomerRolesGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_customer_role){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var confmessage=translate('Are you sure to delete this customer role ? If some contacts use this role, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletecustomerrole("+id_customer_role+");";if(isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletecustomerrole','delete','Delete customer role')+"</a>";}}));grid.renderGrid("tablecontent_customerroles","datagrid");};this.initializeVatTypesGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_vat_type){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var id_country=grid.getRowAttribute(cell.rowIndex,"id_country");var confmessage=translate('Are you sure to delete this VAT rate ? If some invoices use this rate, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletevattype("+id_vat_type+");";if(id_country!='XX'&&isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletevattype','delete','Delete VAT rate')+"</a>";}}));grid.renderGrid("tablecontent_vattypes","datagrid");};this.initializeTrackerStatusGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellEditor("color",new ColorCellEditor());grid.setCellRenderer("color",new CellRenderer({render:function(cell,color){color=color?color.toLocaleUpperCase():color;CellRenderer.prototype.render.call(this,cell,color);$(cell).css('background-color',color?'#'+color:'');}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_status){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var confmessage=translate('Are you sure to delete this status ? If some trackers use this status, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deletetrackerstatus("+id_status+");";if(isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deletecustomerrole','delete','Delete tracker status')+"</a>";}}));grid.renderGrid("tablecontent_trackerstatus","datagrid");};this.initializeExpenseTypesGrid=function(grid)
{grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_vat_type){$(cell).empty().css({'white-space':'nowrap','width':'16px'});var id_country=grid.getRowAttribute(cell.rowIndex,"id_country");var confmessage=translate('Are you sure to delete this expense type ? If some expenses use this type, deletion will be refused.',true);var delTrackerCode="if (confirm('"+confmessage+"')) categories.deleteexpensetype("+id_vat_type+");";if(id_country!='XX'&&isAllowed('configuration','edit'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delTrackerCode+"\">"+img('config_deleteexpensetype','delete','Delete expense type')+"</a>";}}));grid.renderGrid("tablecontent_expensetypes","datagrid");};this.updateAltRows=function()
{alternate("tablecontent_trackertypes");alternate("tablecontent_trackerunits");alternate("tablecontent_customerroles");alternate("tablecontent_tags");alternate("tablecontent_vattypes");alternate("tablecontent_expensetypes");};this.addtrackercategory=function(field)
{ajax('/config/addtrackertype',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the tracker type in database"),"error");return;}
var id=parseInt(response);categories.trackerTypesEditableGrid.addRow(id,{name:field.value,invoiceable:true,action:id});field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletetrackercategory=function(id)
{ajax('/config/deletetrackertype',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete tracker type"),translate("An error occured while deleting the tracker type from database. Most common cause is that existing trackers are using this tracker type."),"warning");else categories.trackerTypesEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addtrackerstatus=function(field)
{ajax('/config/addtrackerstatus',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the tracker status in database"),"error");return;}
categories.trackerStatusEditableGrid.loadJSON(baseUrl+'/config/generatetrackerstatusjson');field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletetrackerstatus=function(id)
{ajax('/config/deletetrackerstatus',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete status"),translate("An error occured while deleting the status from database. Most common cause is that existing trackers are using this status."),"warning");else categories.trackerStatusEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addtrackerunit=function(field)
{ajax('/config/addtrackerunit',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the unit in database"),"error");return;}
var id=parseInt(response);categories.trackerUnitsEditableGrid.addRow(id,{name:field.value,symbol:field.value,type:'non_hourly',action:id});field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletetrackerunit=function(id)
{ajax('/config/deletetrackerunit',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete unit"),translate("An error occured while deleting the unit from database. Most common cause is that existing trackers are using this unit."),"warning");else categories.trackerUnitsEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addtag=function(field)
{ajax('/config/addtag',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the tag in database"),"error");return;}
var id=parseInt(response);categories.tagsEditableGrid.addRow(id,{name:field.value,tablenames:'customer',action:id});field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletetag=function(id)
{ajax('/config/deletetag',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete tag"),translate("An error occured while deleting the tag from database."),"warning");else categories.tagsEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addcustomerrole=function(field)
{ajax('/config/addcustomerrole',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the role in database"),"error");return;}
var id=parseInt(response);categories.customerRolesEditableGrid.addRow(id,{name:field.value,action:id});field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletecustomerrole=function(id)
{ajax('/config/deletecustomerrole',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete customer role"),translate("An error occured while deleting the customer role from database. Most common cause is that existing contacts are using this customer role."),"warning");else categories.customerRolesEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addvattype=function(field)
{ajax('/config/addvattype',{name:trim($(field).val()),percentage:getFloat(field.value)},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the rate in database"),"error");return;}
var id=parseInt(response);categories.vatTypesEditableGrid.addRow(id,{name:field.value,percentage:getFloat(field.value),action:id});field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deletevattype=function(id)
{ajax('/config/deletevattype',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete VAT rate"),translate("An error occured while deleting the VAT rate from database. Most common cause is that existing invoices are using this rate."),"warning");else categories.vatTypesEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.addexpensetype=function(field)
{ajax('/config/addexpensetype',{name:trim($(field).val())},function(response)
{if(response=="error"){showDialog(translate("Error"),translate("An error occured while creating the expense type in database"),"error");return;}
categories.expenseTypesEditableGrid.loadJSON(baseUrl+'/config/generateexpensetypejson');field.value='';field.onkeyup();categories.updateAltRows();},"json");};this.deleteexpensetype=function(id)
{ajax('/config/deleteexpensetype',{id:id},function(response){if(response!="ok")showDialog(translate("Could not delete expense type"),translate("An error occured while deleting the expense type from database. Most common cause is that existing expenses are using this type."),"warning");else categories.expenseTypesEditableGrid.removeRow(id);categories.updateAltRows();},"json");};this.init();}
function checkAddButton(field)
{if(trim($(field).val())=='')$(field).siblings('a.button').addClass("disabled").attr('disabled',true);else $(field).siblings('a.button').removeClass("disabled").removeAttr('disabled');};function ConfigAccount(){}
ConfigAccount.prototype=new DefaultScreen();ConfigAccount.prototype.init=function()
{var self=this;$("#tabs").tabs().find(".ui-tabs-nav").sortable({axis:'x'});this.grid=new AccountOrderGrid("OrderHistory");var handler=StripeCheckout.configure({key:'pk_live_7WaedECGwsRPXRB6SSNBOcUi',locale:'auto',token:function(token){showWait(translate("Processing payment"));var price=parseFloat(ui.get('account.monthly_price'))*ui.get('extend_months');_ajax('account/chargestripe',{description:$("select[name=extend-months] option:selected").text(),nb_months:ui.get('extend_months'),token:token.id,email:token.email}).done(function(response){hideWait();feedback_message(translate("Payment successfully processed"),"success");ui.set('account',response.account);});}});$(window).on('popstate',function(){handler.close();});$('#pay-stripe').on('click',function(e){_ajax('account/simorder',{nb_months:ui.get('extend_months')}).done(function(response){handler.open({name:'Hiflow Suite',description:$("select[name=extend-months] option:selected").text(),amount:response.nbcredit,currency:"eur"});});e.preventDefault();});$("#pay-paypal").on('click',function(){if(!confirm(translate("The order is ready to be sent. Should we proceed ?")))return false;_ajax('account/neworder',{nb_months:ui.get('extend_months')}).done(function(response){$("#paypal_form [name=custom]").val(response.id);$("#paypal_form [name=amount]").val(response.amounthtva);$("#paypal_form [name=tax]").val(response.amountvat);$("#paypal_form [name=item_name]").val("Hiflow Suite - "+$("select[name=extend-months] option:selected").text());$("#paypal_form").submit();});});ui.on('go-free',function(){showWait(translate("Switching..."));_ajax('account/gofree').done(function(response){ui.set('account',response.account);hideWait();});});ui.on('go-business',function(){showWait(translate("Switching..."));_ajax('account/gobusiness').done(function(response){ui.set('account',response.account);hideWait();});});ui.on('change-users',function(){var changeUsersSelect=$("select[name=change-users]").removeAttr('disabled',true).empty();for(var nbUsers=parseInt(ui.get("account.maxusers_min"));nbUsers<=100;nbUsers++)changeUsersSelect.append($("<option>").attr('value',nbUsers).html(" "+nbUsers+" "));changeUsersSelect.show().val(parseInt(ui.get("account.maxusers"))).siblings('strong').hide().siblings('a').hide();});ui.observe('account.maxusers',function(){$("select[name=change-users]").attr('disabled',true);if(ui.get("account.maxusers"))_ajax('account/setusers',{maxusers:parseInt(ui.get("account.maxusers"))}).done(function(response){ui.set('account',response.account);$("select[name=change-users]").hide().siblings('strong').show().siblings('a').show();});});$("#button_promocode").on('click',function(){showWait(translate("Applying code")+'...');_ajax('account/applycode',{code:$("#code").val()}).done(function(response){if(response.type=='success')$("#code").val('');ui.set('account',response.account);hideWait();feedback_message(response.message,response.type);});});ui.on('save-account',function(){self.saveAccount();});ui.on('delete-account',function(){if(confirm(translate("Are you sure ? This cannot be undone!"))){showWait(translate("Deleting")+'...');_ajax('account/deleteaccount').done(function(response){ui.set('account',response.account);hideWait();feedback_message(response.message,response.type);setTimeout(function(){location.reload();},1000);});}});};ConfigAccount.prototype._saveAccount=function()
{var parameters={};$("#tab-account-billing").populateParameters(parameters);_ajax('account/update',parameters).done(function(response){hideWait();feedback_message(translate("Billing info successfully saved"),"success");});};ConfigAccount.prototype.saveAccount=function()
{var self=this;showWait(translate("Saving")+'...');var vat=trim($("input[name=vat]").val());if(vat=='')this._saveAccount();else{var number=vat.replace(/[^0-9a-zA-Z]/g,'').toUpperCase();$("input[name=vat]").val(number);$.getJSON('https://www.apilayer.net/api/validate?access_key=439b46644eeb97e50ecf1fd7c84a7ef6&vat_number='+number+'&callback=?',function(response){if(response.valid){if(trim($("input[name=company]").val())=='')$("input[name=company]").val(response.company_name);$("input[name=vat]").val(response.country_code+' '+response.vat_number);self._saveAccount();}
else{hideWait();alert('The entered VAT number could not be validated by the VAT number validation system provided by APILAYER LTD and based on European Commission\'s databases.\nPlease correct it or leave this field empty.');}});}};;function ConfigIndex(){}
ConfigIndex.prototype=new WizardIndex();;function ContactForm(dialog,config)
{var self=this;this.dialog=dialog;for(var p in config)this[p]=config[p];if(dialog){$("#contact_form_div").dialog({width:600,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:[{text:translate("Save"),click:function(){self.saveContact();$(this).dialog("close");}}]});$("#contact_form").submit(function(){if($("#contact_form_div [name=name]").val()=='')return false;self.saveContact();$("#contact_form_div").dialog("close");return false;});}}
ContactForm.prototype.onChange=function()
{};ContactForm.prototype.open=function(id)
{var self=this;_ajax('contact/get',id?{id:id,id_customer:this.id_customer,id_supplier:this.id_supplier}:null).done(function(response){if(!response)jerror("An error occured while retrieving the contact from the database");else self.load(response);});};ContactForm.prototype.load=function(response)
{var self=this;ui.set('in_context',self.id_customer||self.id_supplier?true:false);ui.set('advanced_contact_fields',config.customer.advanced_contact_fields==1);ui.set('invoice_to_contact',config.invoice.invoice_to_contact==1);var cform=_$('contact_form');clear_form_elements(cform);$(cform.id).val(response.id?response.id:0);$(cform.name).val(response.name);$(cform.firstname).val(response.firstname);$(cform.company).val(response.company);$(cform.job_title).val(response.job_title);$(cform.title).val(response.title);$(cform.phone).val(response.phone);$(cform.gsm).val(response.gsm);$(cform.email).val(response.email);if(response.id>0)$(cform.id_type).val(response.id_type);$(cform.id_role).val(response.id_role);$(cform.address).val(response.address);$(cform.cp).val(response.cp);$(cform.city).val(response.city);$(cform.id_country).val(response.id_country);$(cform.vat).val(response.vat);$(cform.natnum).val(response.natnum);$(cform.id_bob).val(response.id_bob);$(cform.mailing_list).attr('checked',response.mailing_list==1);$("select[name=id_tag]").val(response.id_tags);if(this.dialog)$('#contact_form_div').dialog('option','title',response.id?translate("Update contact"):translate("Create contact")).dialog('open');self.setupForm();$("select[name=id_customer]").val(response.id_customers);$("select[name=id_supplier]").val(response.id_suppliers);$("#contact_form_div select").trigger('change');ui.off('quick-add-function');ui.on('quick-add-function',function(){jprompt(translate("Enter name"),translate("Quick add"),"",null,function(name){_ajax('customer/quickadd',{table:'customer_role',name:name}).done(function(response){ui.set('contact_roles',response.options);ui.set('id_role_selected',response.id);});});});ui.off('quick-add-civility');ui.on('quick-add-civility',function(){jprompt(translate("Enter civility"),translate("Quick add"),"",null,function(name){_ajax('customer/quickaddcivility',{name:name,short_name:name}).done(function(response){ui.set('civility_select_options',response.options);ui.set('civility_selected',response.short_name);});});});}
ContactForm.prototype.setupForm=function()
{var self=this;this._updateFormState();$("#contact_form_div [name=name]").keyup(function(e){self._updateFormState();});$("#contact_form_div [name=name]").bind('paste',function(e){self._updateFormState();});$("#contact_form_div [name=name]").focus();$("#contact_form_div [name=id_type]").on('change',function(){ui.set('contact_type',$('option[value='+$(this).val()+'][contact_type]').attr('contact_type'));}).trigger('change');};ContactForm.prototype._updateFormState=function()
{var dlgButtons=$('#contact_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");if($("#contact_form_div [name=name]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');};ContactForm.prototype.saveContact=function()
{var self=this;var form=$('#contact_form_div form').get(0);if(trim($(form.name).val())==''){jalert(translate("Please enter a name for the contact"));return false;}
var update=$(form.id).val()!="0";var action=update?"contact/update":"contact/create";showWait(translate(update?"Updating":"Creating")+"...");_ajax(action,{id_customers:(this.id_customer?undefined:$("select[name=id_customer]").val()),id_suppliers:(this.id_supplier?undefined:$("select[name=id_supplier]").val()),id_customer:this.id_customer,id_supplier:this.id_supplier,id_role:$(form.id_role).val(),id:$(form.id).val(),name:$(form.name).val(),firstname:$(form.firstname).val(),company:$(form.company).val(),job_title:$(form.job_title).val(),title:$(form.title).val(),phone:$(form.phone).val(),gsm:$(form.gsm).val(),email:$(form.email).val(),id_type:$(form.id_type).val(),address:$(form.address).val(),cp:$(form.cp).val(),city:$(form.city).val(),id_country:$(form.id_country).val(),vat:$(form.vat).val(),natnum:$(form.natnum).val(),id_bob:$(form.id_bob).val(),id_tags:$("select[name=id_tag]").val(),mailing_list:$(form.mailing_list).is(":checked")?1:0}).done(function(response){hideWait();if(!response)jerror("An error occured while creating or updating the contact in database","Error");else if(response.status)feedback_message(response.status,"error");else{feedback_message(translate(update?translate("The contact has been updated"):translate("The contact has been created")),"success");self.onChange();}});};;function ContactGrid(name,config){if(name)this.init(name,config);}
ContactGrid.prototype=new TimetrackEditableGrid();ContactGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No contact found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No contact found matching your search criteria');config.controller='contact';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected contacts ?',true)))self.deleteContact(ui.get('rows_checked'));});ui.on('actionbar-add-to-event',function(){self.toEvent(ui.get('rows_checked'),ui.get('add_to_id_events'),true);});ui.on('actionbar-remove-from-event',function(){self.toEvent(ui.get('rows_checked'),ui.get('add_to_id_events'),false);});};ContactGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('contacts','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify contacts.");return false;}
return true;};ContactGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_type'])>=0;};ContactGrid.prototype.getActions=function(cell,id_contact)
{var self=this;var actions=[];if(isAllowed('contacts','create'))actions.push({icon:img('customer_copytracker','duplicate',translate('Duplicate contact')),click:function(){self.copyContact(id_contact);}});if(isAllowed('contacts','delete'))actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this contact ?',true)))self.deleteContact(id_contact);}});return actions;};ContactGrid.prototype.tableLoaded=function()
{var self=this;this.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("name",new CellRenderer({render:function(cell,value){if(!isAllowed('contacts','view'))$(cell).html(value);else $(cell).html(value?"<a title='' href='"+baseUrl+"/ui/contact/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>":"");$(cell).css('white-space','nowrap');}}));this.setCellRenderer("title",new CellRenderer({render:function(cell,value){if(typeof short_titles[value]!='undefined')value=short_titles[value];cell.innerHTML=value;}}));if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No contact tag was created yet. To create a contact tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
if(this.hasColumn('events')){this.setCellEditor("events",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No event was created yet. To create an event, please go to <a href='%URL'>Events</a>").replace(/%URL/,baseUrl+"/ui/event")}));this.setCellRenderer("events",new ContactEventCellRenderer());}
this.render();};ContactGrid.prototype.deleteContact=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('contact/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the contact from database","Error");else{self.refresh();self.onChange();}});};ContactGrid.prototype.toEvent=function(id,id_event,add)
{var self=this;showWait(translate("Saving")+"...");_ajax('contact/toevent',{id:id,id_event:id_event,add:add}).done(function(response){hideWait();if(!response)jerror("An error occured while updating database","Error");else{self.refresh();self.onChange();}});};ContactGrid.prototype.copyContact=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('contact/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the contact from database","Error");else{self.refresh();self.onChange();}});};function ContactEventCellRenderer(config)
{this.init(config);}
ContactEventCellRenderer.prototype=new MultiselectCellRenderer({noneText:translate('(no event)')});ContactEventCellRenderer.prototype.render=function(cell,value){var self=this;var values=value?value.split(","):[];$(cell).html('');if(values.length==0)$(cell).html(this.noneText.replace(' ','&nbsp;')).css('color','#ddd');else for(var i=0;i<values.length;i++){var id_event=values[i];var label=EnumCellRenderer.prototype.getLabel.call(this,cell.rowIndex,id_event);$(cell).append($li=$('<a>').attr('id_event',id_event).html(label));if(i<values.length-1)$(cell).append(', ');}
if($('.event_select').size()>0)$(cell).find('a[id_event]').on('click',function(){$('.event_select').val([$(this).attr('id_event')]);$('.event_select').multiselect('refresh');self.editablegrid.refresh();});};function ContactIndex(){}
ContactIndex.prototype=new DefaultScreen();ContactIndex.prototype.init=function()
{var self=this;$('select.id_contact_change').change(function(){router.navigate('/contact/'+$(this).val(),true);});this.form=new ContactForm(true,{onChange:function(){self.grid.fetch();}});this.grid=new ContactGrid("ContactIndexGrid",{getParameters:function(){var parameter=ContactGrid.prototype.getParameters.call(this);parameter.id_types=$('.status_select').val()||[];parameter.id_tags=$('.tag_select').val()||[];parameter.id_events=$('.event_select').val()||[];parameter.hide_non_mailing_list=$('input[name=hide_non_mailing_list]').is(':checked');return parameter;},getActions:function(cell,id_contact){var actions=ContactGrid.prototype.getActions.call(this,cell,id_contact);if(isAllowed('contacts','edit'))actions.splice(0,0,{icon:img('customer_edit','edit',translate('Edit')),click:function(){self.form.open(id_contact);}});return actions;}});ui.on('actionbar-add',function(){self.form.open();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose types")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Types"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$('.event_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose events")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Events"))}).on('multiselectclose',function(){self.grid.refresh();});$('input[name=hide_non_mailing_list]').click(function(){self.grid.refresh();});};;function ContactView(){}
ContactView.prototype=new DefaultScreen();ContactView.prototype.init=function(parameter)
{var self=this;this.tabControllers={'general':new ContactViewGeneral(),'file':new ContactViewFile()};this.tabControllers['general'].screenController=this;$('select.id_contact_change').change(function(){router.navigate('/contact/'+$(this).val()+'/'+ui.get('tab'),true);});this.setTab(ui.get('tab'),true);};ContactView.prototype.setTab=function(tab,first)
{var self=this;if(!first&&ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onhide){console.info("Hiding "+ui.get('tab'));self.tabControllers[ui.get('tab')].onhide();}
menu.hilite();ui.set('tab',tab);if(ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onshow){console.info("Showing "+ui.get('tab'));self.tabControllers[ui.get('tab')].onshow();}};ContactView.prototype.dispose=function()
{for(var tab in this.tabControllers){if(this.tabControllers[tab].dispose){console.info("Disposing "+tab);this.tabControllers[tab].dispose();}}};;function ContactViewFile(){this.init();}
ContactViewFile.prototype.init=function()
{var self=this;};ContactViewFile.prototype.onshow=function()
{this.fileBrowser=new FileBrowser("contact");this.fileBrowser.grid.fetch();};;function ContactViewGeneral(){this.init();}
ContactViewGeneral.prototype.init=function()
{var self=this;this.form=new ContactForm(false,{onChange:function(){self.screenController.refresh().done(function(response){self.form.load(response.contact);});}});ui.on('save-contact',function(){self.form.saveContact();});ui.on('add-note',function(){new NoteEditor({afterSave:function(){self.screenController.refresh();},beforeOpen:function(){this.dialog.find('select[name=id_contact]').val(ui.get('contact.id')).trigger('change').closest('tr').hide();this.dialog.find('select[name=id_customer]').val(null).trigger('change').closest('tr').hide();}}).open();});ui.on('edit-note',function(event,id_note){new NoteEditor({id_object:id_note,forceEdit:true,afterSave:function(){self.screenController.refresh();},beforeOpen:function(){this.dialog.find('select[name=id_contact]').closest('tr').hide();this.dialog.find('select[name=id_customer]').closest('tr').hide();}}).open();});ui.on('delete-note',function(event,id_note){if(confirm(translate('Are you sure you want to delete this note ?'))){showWait(translate("Deleting")+"...");_ajax('note/delete',{id:id_note}).done(function(response){if(!response){jerror("An error occured while deleting the note from database","Error");hideWait();}
else{self.screenController.refresh().done(function(){hideWait();});}});}});ui.on('add-to-event',function(event){if(!ui.get('add_to_id_events')||ui.get('add_to_id_events').length==0)jalert(translate("Select events in the dropdown list first"));else self.toEvent(ui.get('contact.id'),ui.get('add_to_id_events'),true);});ui.on('delete-from-event',function(event,id_event){if(confirm(translate('Are you sure you want to remove contact from this event ?'))){self.toEvent(ui.get('contact.id'),[id_event],false);}});};ContactViewGeneral.prototype.toEvent=function(id,id_events,add)
{var self=this;showWait(translate("Saving")+"...");_ajax('contact/toevent',{id:id,id_event:id_events,add:add}).done(function(response){if(!response){jerror("An error occured while updating database","Error");hideWait();}
else{self.screenController.refresh().done(function(){hideWait();$('.contact_event_div select').val([]).trigger('change');});}});};ContactViewGeneral.prototype.onshow=function()
{this.form.load(ui.get('contact'));$('div.row input:first').focus();};;function CostEntryGrid(name,config){if(name)this.init(name,config);}
CostEntryGrid.prototype=new TimetrackEditableGrid();CostEntryGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No cost found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No cost found matching your search criteria');if(typeof config.tracker_enum_provider=='undefined')config.tracker_enum_provider='cost/customertrackers';config.controller='cost';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected costs ?',true)))self.deleteCost(ui.get('rows_checked'));});};CostEntryGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('costs','delete'))return false;if(this.hasColumn('invoice_status')){var invoice_status=this.getValueAt(rowIndex,this.getColumnIndex('invoice_status'));if(invoice_status=='invoiced'||invoice_status=='canceled')return false;}
return true;};CostEntryGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_customer_tracker','amount','invoice_status','id_invoice'])>=0;};CostEntryGrid.prototype.getActions=function(cell,id_cost_entry)
{var self=this;var actions=[];var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('costs','create'))actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyCost(id_cost_entry);}});if(isAllowed('costs','delete'))actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this cost ?',true)))self.deleteCost(id_cost_entry);}});return actions;};CostEntryGrid.prototype.tableLoaded=function()
{var self=this;this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getDisplayValueAt(cell.rowIndex,self.getColumnIndex('id_supplier'))+'"';}}));if(this.tracker_enum_provider)this.setEnumProvider("id_tracker",new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var optionValues=null;_ajax(self.tracker_enum_provider,{id_tracker:self.getValueAt(rowIndex,column.columnIndex)},true).done(function(response){optionValues=response;});return optionValues;}}));if(this.hasColumn("id_owner"))this.setCellRenderer('id_owner',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('invoice_status'))this.setCellRenderer("invoice_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');var invoice_status=self.getRowAttribute(cell.rowIndex,'invoice_status');if(invoice_status!='none')$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));if(this.hasColumn('id_invoice'))this.setCellRenderer("id_invoice",new EnumCellRenderer({render:function(cell,id_invoice){var label=this.getLabel(cell.rowIndex,id_invoice);if(!isAllowed('invoices','view'))cell.innerHTML=label;cell.innerHTML=id_invoice?"<a class='customer_link tooltip' target='_blank' href='"+baseUrl+"/ui/invoice/"+id_invoice+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');}}));this.render();};CostEntryGrid.prototype.deleteCost=function(id_cost_entry)
{var self=this;showWait(translate("Deleting")+"...");_ajax('cost/delete',{id:id_cost_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the cost from database","Error");else{self.refresh();self.onChange();}});};CostEntryGrid.prototype.copyCost=function(id_cost_entry)
{var self=this;showWait(translate("Copying")+"...");_ajax('cost/copy',{id:id_cost_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the cost from database","Error");else{self.refresh();self.onChange();}});};;function CostIndex(){}
CostIndex.prototype=new DefaultScreen();CostIndex.prototype.init=function()
{var self=this;this.grid=new CostEntryGrid("CostEntryGrid",{getParameters:function(){var parameter=CostEntryGrid.prototype.getParameters.call(this);parameter.id_owners=$('.owner_select').val()||[];parameter.id_statuses=$('.status_select').val()||[];parameter.warnings_only=$('input[name=warnings_only]').is(':checked');parameter.from=$('.searchfield.from').val();parameter.to=$('.searchfield.to').val();localset(this.name+'DateFrom',parameter.from);localset(this.name+'DateTo',parameter.to);return parameter;}});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$('input[name=warnings_only]').click(function(){self.grid.refresh();});$("a.add:not(.import)").click(function(){dlgButtons=$('div.add_cost').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("div.add_cost textarea,div.add_cost input[type=password],div.add_cost input[type=text],div.add_cost select").val('');$("div.add_cost .datepicker").val('').datepicker({dateFormat:locale['date_format_jquery']});dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("div.add_cost [name=label]").focus();var updateButtonState=function(e){dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("div.add_cost [mandatory]").each(function(){if(!$(this).val()){dlgButtons.attr('disabled','1').addClass('ui-state-disabled');return false;}});};$("div.add_cost [mandatory]").keyup(updateButtonState).change(updateButtonState);});$("div.add_cost").dialog({width:685,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New cost"),buttons:[{text:translate("Add cost"),click:function(){if(self.add($('div.add_cost')))$(this).dialog('close');}}]});$("div.add_cost select").each(function(){$(this).select2({width:450,placeholder:$(this).attr('placeholder'),dropdownCssClass:'ui-dialog',dropdownAutoWidth:true});});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});ui.on('quick-add-supplier',function(){jprompt(translate("Enter supplier name"),translate("Quick add supplier"),"",null,function(name){_ajax('cost/quickaddsupplier',{name:name}).done(function(response){ui.set(response);$("div.add_cost [name=id_supplier]").trigger('change');$("div.add_cost select[name=id_supplier]").select2({width:450,placeholder:$(this).attr('placeholder'),dropdownCssClass:'ui-dialog',dropdownAutoWidth:true});});});});};CostIndex.prototype.add=function(dialog)
{var self=this;var id_tracker=dialog.find('[name=id_tracker]').val();if(!id_tracker){jalert(translate("No project selected!"));return false;}
var id_supplier=dialog.find('[name=id_supplier]').val();if(!id_supplier){jalert(translate("No supplier selected!"));return false;}
showWait(translate("Creating cost")+"...");_ajax('cost/create',merge(this.parameters,{id_tracker:id_tracker,id_supplier:id_supplier,invoice_status:dialog.find('[name=invoice_status]').val(),description:dialog.find('[name=description]').val(),amount:dialog.find('[name=amount]').val(),date:dialog.find('[name=date]').val(),supplier_ref:dialog.find('[name=supplier_ref]').val()})).done(function(response){hideWait();self.grid.fetch();});return true;};;function CSVImporter(config){this.init(config);}
CSVImporter.prototype.init=function(config)
{this.controller=null;this.importButtonText='Import';this.mandatoryFields={};this.recommendedFields={};this.allowDuplicateFields={};for(var p in config)this[p]=config[p];$('form').submit(function(){showWait(translate('Uploading and parsing CSV file')+"...");});};CSVImporter.prototype.loadPreview=function(html)
{$('#import_preview').html(html);$('#import_csv_text').html(this.importButtonText);alternate('import_preview');hideWait();};CSVImporter.prototype.onFrameLoad=function(iframe)
{if(iframe.contentDocument)var doc=iframe.contentDocument;else if(iframe.contentWindow)var doc=iframe.contentWindow.document;else var doc=window.frames[id].document;if(doc.location.href!="about:blank")ajax('/'+this.controller+'/importpreview',null,function(html){csvImporter.loadPreview(html);});};CSVImporter.prototype.setCSVHeader=function(filename,encoding,separator,delimiter,hasHeader)
{showWait(translate('Parsing CSV file')+"...");ajax('/'+this.controller+'/setcsvheader',{filename:filename,encoding:encoding,separator:separator,delimiter:delimiter,hasHeader:hasHeader},function(html){csvImporter.loadPreview(html);});};CSVImporter.prototype.importCSV=function(filename,encoding,separator,delimiter,hasHeader)
{showWait(translate('Importing CSV file')+"...");var self=this;var fields=[];var selectedFields={};var duplicateFields=0;var missingFields={};for(field in this.mandatoryFields)missingFields[field]=this.mandatoryFields[field];var missingRecommendedFields={};for(field in this.recommendedFields)missingRecommendedFields[field]=this.recommendedFields[field];$('#import_preview select').each(function(){var dbfield=$(this).val();if(dbfield in missingFields)delete missingFields[dbfield];if(dbfield in missingRecommendedFields)delete missingRecommendedFields[dbfield];if(dbfield.length>0&&selectedFields[dbfield]==1&&$.inArray(dbfield,self.allowDuplicateFields)<0)duplicateFields++;else selectedFields[dbfield]=1;fields.push(dbfield);});if(duplicateFields>0){hideWait();jerror(sprintf(translate('You have %d duplicate columns'),duplicateFields),translate('Import error'));return;}
var missingFieldsLabels=[];for(field in missingFields)missingFieldsLabels.push('"'+missingFields[field]+'"');if(missingFieldsLabels.length>0){hideWait();jerror(translate('Some mandatory fields were not assigned to a column')+': '+missingFieldsLabels.join(', '),translate('Import error'));return;}
var proceed=function(){csvImporter.proceedImportCSV(fields,filename,encoding,separator,delimiter,hasHeader);};var missingRecommendedFieldsWarnings=[];for(field in missingRecommendedFields)missingRecommendedFieldsWarnings.push(missingRecommendedFields[field]);if(missingRecommendedFieldsWarnings.length>0){hideWait();jconfirm(missingRecommendedFieldsWarnings.join('<br/><br/>'),null,null,function(){showWait(translate('Importing CSV file')+"...");proceed();},translate("Return"),translate("Continue"));}
else proceed();};CSVImporter.prototype.proceedImportCSV=function(fields,filename,encoding,separator,delimiter,hasHeader)
{ajax('/'+this.controller+'/importcsv',{filename:filename,encoding:encoding,separator:separator,delimiter:delimiter,fields:fields,hasHeader:hasHeader,update_only:$('input[name=update_only]').is(":checked"),similarity_threshold:$('input[name=similarity_threshold]').val()},function(html){$('#import_preview').html(html);hideWait();window.scrollTo(0,0);});};;function CustomTableGrid(name,config){if(name)this.init(name,config);}
CustomTableGrid.prototype=new TimetrackEditableGrid();CustomTableGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.pageSize=='undefined')config.pageSize=15;if(typeof config.id_customer=='undefined')config.id_customer=null;if(typeof config.id_custom_table=='undefined')config.id_custom_table=null;if(typeof config.noResult=='undefined')config.noResult=translate('No row found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No row found matching your search criteria');config.serverSide=false;config.controller='customtable';TimetrackEditableGrid.prototype.init.call(this,name,config);};CustomTableGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{this.save();};CustomTableGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit')){jinfo("You are not authorized to modify customers.");return false;}
return true;};CustomTableGrid.prototype.getActions=function(cell,id_contact)
{var self=this;var actions=[];if(isAllowed('customers','edit')){actions.push({icon:img('customer_copytracker','copy','Copy'),click:function(){self.copyRow(cell.rowIndex);}});actions.push({icon:img('customer_deletetracker','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this row ?',true)))self.deleteRow(cell.rowIndex);}});}
return actions;};CustomTableGrid.prototype.tableLoaded=function()
{this.render();};CustomTableGrid.prototype.updatePaginator=function()
{TimetrackEditableGrid.prototype.updatePaginator.call(this);$(this.table).find('td').css('max-width','400px');};CustomTableGrid.prototype.getParameters=function()
{return{id_customer:this.id_customer,id_custom_table:this.id_custom_table};};CustomTableGrid.prototype.save=function()
{var self=this;_ajax('customtable/save',{id_customer:this.id_customer,id_custom_table:this.id_custom_table,data:this.dataUnfiltered==null?this.data:this.dataUnfiltered}).done(function(response){hideWait();self.onChange();});};CustomTableGrid.prototype.addRow=function()
{showWait(translate("Creating")+"...");this.append(this.getRowCount()+1,{});this.save();};CustomTableGrid.prototype.copyRow=function(rowIndex)
{showWait(translate("Creating")+"...");var cellValues={};for(var c=0;c<this.getColumnCount();c++)cellValues[this.columns[c].name]=this.getValueAt(rowIndex,c);this.insert(rowIndex,this.getRowCount()+1,cellValues);this.save();};CustomTableGrid.prototype.deleteRow=function(rowIndex)
{showWait(translate("Deleting")+"...");this.remove(rowIndex);this.save();};;function CustomerForm(dialog,config)
{var self=this;this.dialog=dialog;for(var p in config)this[p]=config[p];if(dialog){$("#customer_form_div").dialog({width:750,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:[{text:translate("Save"),click:function(){self.saveCustomer();$(this).dialog("close");}}],create:function(event){$('#tabs-customer').tabs();},open:function(event){tinymce.execCommand('mceAddEditor',false,'note');},close:function(event){tinymce.execCommand('mceRemoveEditor',false,'note');if(self.colorPicker)self.colorPicker.hidePicker();}});$("#customer_form_div form").submit(function(){if($("#customer_form_div [name=name]").val()=='')return false;self.saveCustomer();$("#customer_form_div").dialog("close");return false;});}
else $('#tabs-customer').tabs();}
CustomerForm.prototype.onChange=function()
{};CustomerForm.prototype.open=function(id)
{var self=this;_ajax('customer/get',id?{id:id}:null).done(function(response){if(!response)jerror("An error occured while retrieving customer rom the database");else ajax('/customer/getcontacts',{id_customer:id},function(contacts){ui.set('invoice_contact_select.options',contacts);self.load(response);},'json');});};CustomerForm.prototype.load=function(response)
{var self=this;var cform=$('#customer_form_div form').get(0);clear_form_elements(cform);$(cform.id).val(response.id?response.id:0);$(cform.name).val(response.name);$(cform.firstname).val(response.firstname);$(cform.title).val(response.title);$(cform.code).val(response.code);$(cform.id_bob).val(response.id_bob);$(cform.vat).val(response.vat);$(cform.retainer_amount).val(response.retainer_amount);$(cform.retainer_label).val(response.retainer_label);$(cform.retainer_description).val(response.retainer_description);$(cform.adress).val(response.adress);$(cform.cp).val(response.cp);$(cform.city).val(response.city);$(cform.country).val(response.id_country);$(cform.lang).val(response.id_lang);$(cform.legal_form).val(response.id_legalform);$(cform.email).val(response.email);$(cform.phone).val(response.phone);$(cform.mobile).val(response.mobile);$(cform.due_date).val(response.due_date);$(cform.id_contact_invoice).val(response.id_contact_invoice);$(cform.id_vat_type).val(response.id_vat_type);$(cform.fax).val(response.fax);$(cform.note).val(response.note);$(cform.website).val(response.website);$(cform.iscompany).attr('checked',response.iscompany==1);$(cform.exclude_from_invoiceable).attr('checked',response.exclude_from_invoiceable==1);$(cform.show_in_forecast).attr('checked',response.show_in_forecast==1);$(cform.dueschedule_is_in_dueschedule).attr('checked',response.dueschedule.is_in_dueschedule==1);$(cform.dueschedule_legal_form).val(response.dueschedule.legal_form);$(cform.dueschedule_vat_status).val(response.dueschedule.vat_status);$(cform.due_date).find("option:first-child").text(translate('(default)')+' '+$(cform.due_date).find("option[value='"+config.invoice.default_due_date+"']").text());for(var field in response.customfields)$(cform[field]).val(response.customfields[field]);if(this.dialog)$('#customer_form_div').dialog('option','title',response.id?translate("Update customer"):translate("Create customer")).dialog('open');self.setupForm();if(_$('color')){self.colorPicker=new jscolor.color(_$('color'),{});self.colorPicker.fromString(response.color);}
ui.off('quick-add-legalform');ui.on('quick-add-legalform',function(){jprompt(translate("Enter name"),translate("Quick add"),"",null,function(name){_ajax('customer/quickadd',{table:'legal_form',name:name}).done(function(response){ui.set('legalform_select.options',response.options);ui.set('legalform_select.values',response.id);});});});};CustomerForm.prototype.setupForm=function()
{var self=this;this._updateFormState();$('#iscompany, #exclude_from_invoiceable').click(function(){self._updateFormState();});$("#customer_form_div [name=name]").keyup(function(e){self._updateFormState();});$("#customer_form_div [name=name]").bind('paste',function(e){self._updateFormState();});$("#customer_form_div [name=name]").focus();};CustomerForm.prototype._updateFormState=function()
{var dlgButtons=$('#customer_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");if($("#customer_form_div [name=name]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');if($('#iscompany').is(':checked')){$('#firstname,#title').attr('disabled','1').addClass('ui-state-disabled');$('#div_person, .row.if_not_is_company').hide();}
else{$('#firstname,#title').removeAttr('disabled').removeClass('ui-state-disabled');$('#div_person, .row.if_not_is_company').show();}
if($('#exclude_from_invoiceable').is(':checked'))$('div.row.billing').hide();else $('div.row.billing').show();};CustomerForm.prototype.saveCustomer=function()
{var self=this;var form=$('#customer_form_div form').get(0);if(trim($(form.name).val())==''){jalert(translate("Please enter a name for the customer"));return false;}
var update=$(form.id).val()!="0";var action=update?"customer/update":"customer/create";showWait(translate(update?"Updating":"Creating")+"...");var parameter={id:$(form.id).val(),name:$(form.name).val(),firstname:$(form.firstname).val(),title:$(form.title).val(),code:$(form.code).val(),id_bob:$(form.id_bob).val(),vat:$(form.vat).val(),retainer_amount:$(form.retainer_amount).val(),retainer_label:$(form.retainer_label).val(),retainer_description:$(form.retainer_description).val(),adress:$(form.adress).val(),cp:$(form.cp).val(),city:$(form.city).val(),id_country:$(form.country).val(),id_lang:$(form.lang).val(),id_legalform:$(form.legal_form).val(),due_date:($(form.due_date).val()?$(form.due_date).val():null),id_contact_invoice:($(form.id_contact_invoice).val()!=""?$(form.id_contact_invoice).val():null),id_vat_type:($(form.id_vat_type).val()!=""?$(form.id_vat_type).val():null),email:$(form.email).val(),phone:$(form.phone).val(),mobile:$(form.mobile).val(),fax:$(form.fax).val(),color:$(form.color).val(),note:tinyMCE.get(form.note.id).getContent(),website:$(form.website).val(),iscompany:($('#iscompany').is(':checked')?1:0),exclude_from_invoiceable:($('#exclude_from_invoiceable').is(':checked')?1:0),show_in_forecast:($('#show_in_forecast').size()==0||$('#show_in_forecast').is(':checked')?1:0)};parameter.dueschedule={};$('div#tabs-customer-dueschedule').populateParameters(parameter.dueschedule);parameter.customfields={};$('div.tabs-customer-custom').populateParameters(parameter.customfields);_ajax(action,parameter).done(function(response){hideWait();if(!response)jerror("An error occured while creating or updating the customer in database","Error");else if(response.status)message("error",response.status);else{message("success",translate(update?translate("The customer has been updated"):translate("The customer has been created")));self.onChange();}});};;function CustomerGrid(name,config){if(name)this.init(name,config);}
CustomerGrid.prototype=new TimetrackEditableGrid();CustomerGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No customer found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No customer found matching your search criteria');config.controller='customer';TimetrackEditableGrid.prototype.init.call(this,name,config);};CustomerGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify customers.");return false;}
return true;};CustomerGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['archive'])>=0;};CustomerGrid.prototype.updatePaginator=function()
{var self=this;TimetrackEditableGrid.prototype.updatePaginator.call(this);$("a.tooltip").scrolltip({content:function(){var rowIndex=self.getRowIndex(this.parentNode.parentNode);return self.getRowAttribute(rowIndex,"note");}});};CustomerGrid.prototype.getActions=function(cell,id_customer)
{return[];};CustomerGrid.prototype.tableLoaded=function()
{var self=this;JobGrid.prototype._tableLoaded.call(this);this.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("id_country",new CellRenderer({render:function(cell,value){$(cell).html(value?"<img src='"+baseUrl+"/images/flags/"+value.toLowerCase()+".png' alt='"+value+"'/>":"");}}));this.setCellRenderer("name",new CellRenderer({render:function(cell,value){$(cell).css('height','24px');if(self.currentFilter){indexSearch=value.toLowerCase().indexOf(self.currentFilter);if(indexSearch>=0)value=value.substring(0,indexSearch)
+"<span class='searchhighlight'>"
+value.substring(indexSearch,indexSearch+self.currentFilter.length)
+"</span>"
+value.substring(indexSearch+self.currentFilter.length);}
if(isAllowed('customers','view'))value="<a title=\"\" class='customer_link tooltip' href='"+baseUrl+"/ui/customer/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>";CellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer("adress",new CellRenderer({render:function(cell,value){CellRenderer.prototype.render.call(this,cell,value);truncateCell(cell,48);}}));this.setCellRenderer("title",new CellRenderer({render:function(cell,value){if(typeof short_titles[value]!='undefined')value=short_titles[value];cell.innerHTML=value;}}));this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=value==''?"#AAAAAA":"black";EnumCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer("archive",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);if(value){$(cell.parentNode).addClass("archived");$(cell).addClass("archived");}
else{$(cell.parentNode).removeClass("archived");$(cell).removeClass("archived");}}}));this.getColumn("id_country").cellEditor.minWidth=200;this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No customer tag was created yet. To create a customer tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());this.render();};;function CustomerIndex(){}
CustomerIndex.prototype=new DefaultScreen();CustomerIndex.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val(),true);});this.form=new CustomerForm(true,{onChange:function(){self.grid.refresh();}});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$("select[name=show_value]").dropkick({width:100,change:function(value,label){ui.set('parameters.show_value',value);self.grid.refresh();}});this.grid=new CustomerGrid("CustomerGrid",{getParameters:function(){return{id_users:($('.owner_select').size()==0?null:($('.owner_select').val()||[])),id_tags:$('.tag_select').val()||[],hide_archived:$('input[name=hide_archived]').is(':checked'),show_value:$('[name=show_value]').val()};},getActions:function(cell,id_customer){var actions=CustomerGrid.prototype.getActions.call(this,cell,id_customer);if(isAllowed('customers','edit'))actions.splice(0,0,{icon:img('customer_edit','edit','Edit'),click:function(){self.form.open(id_customer);}});if(isAllowed('customers','create'))actions.push({icon:img('customer_copytracker','copy',translate('Duplicate')),click:function(){self.copyCustomer(id_customer);}});if(isAllowed('customers','delete'))actions.push({icon:img('customer_delete','delete','Delete'),click:function(){self.showDeleteDialog(id_customer);}});return actions;}});$('input[name=hide_archived]').click(function(){self.grid.refresh();});ui.on('actionbar-add',function(){self.form.open();});$("#transfer_customer_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,title:translate("Delete customer"),buttons:[{text:translate("OK"),click:function(){self.deleteCustomer($('#transfer_customer_form [name=id_customer]').val(),$('#transfer_customer_form [name=id_target]').val());$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected customers ? This will delete all associated projects, invoices and timesheet entries.',true)))self.deleteCustomer(ui.get('rows_checked'));});};CustomerIndex.prototype.showDeleteDialog=function(id)
{if(!this.grid.getRowAttribute(this.grid.getRowIndex(id),"needs_transfer")){if(confirm(translate("Are you sure you want to delete this customer ?")))
this.deleteCustomer(id);}
else _ajax('customer/getlist').done(function(customers){$("#transfer_customer_div").dialog('open');$('#transfer_customer_form [name=id_customer]').val(id);$('#transfer_customer_form [name=id_target]').empty().append($("<option>").attr('value',0).html(translate('(no transfer)'))).css('width','400px');for(var c=0;c<customers.length;c++){var target=customers[c];if(target.id!=id)$('#transfer_customer_form [name=id_target]').append($("<option>").attr('value',target.id).html(target.name+' '+target.firstname));}});};CustomerIndex.prototype.deleteCustomer=function(id,id_target)
{var self=this;showWait(translate("Deleting")+"...");_ajax('customer/delete',{id:id,id_target:id_target}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the customer from database","Error");else{self.grid.refresh();self.grid.onChange();}});};CustomerIndex.prototype.copyCustomer=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('customer/copy',{id:id}).done(function(response){if(!response){hideWait();message("error","An error occured while copying the customer in database");}
else{router.navigate('/customer/'+response+'/general',true);}});};CustomerIndex.prototype.dispose=function(id)
{this.form=null;};;function CustomerActivity(){}
CustomerActivity.prototype=new DefaultScreen();CustomerActivity.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/activity',true);});$('.customer_activities').height(window_height()-192);};;function CustomerBilling(){};CustomerBilling.prototype=new DefaultScreen();CustomerBilling.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/billing',true);});this.grid=new BillingGrid("CustomerBillingGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){self.refresh();}});};;function CustomerContact(){}
CustomerContact.prototype=new DefaultScreen();CustomerContact.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/contact',true);});this.form=new ContactForm(true,{id_customer:ui.get('customer.id'),onChange:function(){self.grid.fetch();}});this.grid=new ContactGrid("CustomerViewContactGrid",{getParameters:function(){return{id_customer:ui.get('customer.id')};},getActions:function(cell,id_contact){var actions=ContactGrid.prototype.getActions.call(this,cell,id_contact);if(isAllowed('customers','edit'))actions.splice(0,0,{icon:img('customer_edit','edit',translate('Edit')),click:function(){self.form.open(id_contact);}});return actions;}});$("a.add").click(function(){self.form.open();});};;function CustomerCostEntry(){};CustomerCostEntry.prototype=new JobCostEntry();CustomerCostEntry.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/followup/cost_entry',true);});this.grid=new CostEntryGrid("CustomerCostEntryGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id'),followup:true,id_users:$('.user_select').val()||[],id_statuses:$('.status_select').val()||[]};},onChange:function(){self.refresh();}});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});};;function CustomerCustomtable(){}
CustomerCustomtable.prototype=new DefaultScreen();CustomerCustomtable.prototype.init=function()
{var self=this;var id_customer=ui.get('customer.id');var id_custom_table=ui.get('custom_table.id');var title=ui.get('custom_table.title');ui.set({title:title});$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/custom/'+id_custom_table,true);});this.grid=new CustomTableGrid("CustomerViewCustomTableGrid_"+id_custom_table,{id_customer:id_customer,id_custom_table:id_custom_table});$("a.add").click(function(){self.grid.addRow();});$('.boxcontent').append($('<form>').attr({'id':'pdf_form','method':'POST','target':'_blank'}).append($('<input>').attr({'type':'hidden','name':'id_custom_table'})).append($('<input>').attr({'type':'hidden','name':'grid_data'})));$("a[name=export_pdf]").click(function(){$("#pdf_form").attr('action',baseUrl+'/customer/pdfcustomtable/'+title+'.pdf');$("#pdf_form [name=id_custom_table]").val(id_custom_table);$("#pdf_form [name=grid_data]").val($.toJSON(self.grid.data));$("#pdf_form").submit();});};;function CustomerFile(){}
CustomerFile.prototype=new DefaultScreen();CustomerFile.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/file',true);});this.fileBrowser=new FileBrowser("customer");this.grid=this.fileBrowser.grid;};;function CustomerGeneral(){}
CustomerGeneral.prototype=new DefaultScreen();CustomerGeneral.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/general',true);});this.form=new CustomerForm(false,{onChange:function(){self.refresh().done(function(response){self.form.load(response.customer);});}});this.form.load(ui.get('customer'));$('textarea[name=note]').attr('id','CustomerEditGeneral_note');tinymce.execCommand('mceAddEditor',false,'CustomerEditGeneral_note');ui.on('save-customer',function(){self.form.saveCustomer();});};CustomerGeneral.prototype.dispose=function()
{try{tinymce.execCommand('mceRemoveEditor',false,'CustomerEditGeneral_note');}catch(ex){}
$('#CustomerEditGeneral_note').hide();};;function CustomerItemEntry(){};CustomerItemEntry.prototype=new JobItemEntry();CustomerItemEntry.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/followup/item_entry',true);});this.grid=new ItemEntryGrid("CustomerItemEntryGrid",{tracker_enum_provider:null,getParameters:function(){return{id_tracker:ui.get('tracker.id'),followup:true,id_users:$('.user_select').val()||[],id_statuses:$('.status_select').val()||[]};},onChange:function(){self.refresh();}});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});this.dialog=new ItemEntryDialog({parameters:{id_tracker:ui.get('tracker.id')},onAdd:function(){self.grid.onChange();self.grid.refresh();}});ui.on('actionbar-add',function(){self.dialog.open();});};;function CustomerMap(){}
CustomerMap.prototype=new DefaultScreen();CustomerMap.prototype.needGoogleMaps=function(){return true;};CustomerMap.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/map',true);});$('#customer_map').height(window_height()-192);var latlng=new google.maps.LatLng(-34.397,150.644);geocoder=new google.maps.Geocoder();geocoder.geocode({'address':ui.get('address')},function(results,status){if(status!=google.maps.GeocoderStatus.OK)feedback_message("Geocode failed with following status : "+status,'error');var waterColor="#d3d3d3";var stylez=[{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":waterColor}]},{"featureType":"transit","stylers":[{"color":"#808080"},{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"visibility":"on"},{"color":"#b3b3b3"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.local","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"weight":1.8}]},{"featureType":"road.local","elementType":"geometry.stroke","stylers":[{"color":"#d7d7d7"}]},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ebebeb"}]},{"featureType":"administrative","elementType":"geometry","stylers":[{"color":"#a7a7a7"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#efefef"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#696969"}]},{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"color":"#737373"}]},{"featureType":"poi","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.arterial","elementType":"geometry.stroke","stylers":[{"color":"#d6d6d6"}]},{"featureType":"road","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"color":"#dadada"}]}];var mapType=new google.maps.StyledMapType(stylez,{name:"Grayscale"});var mapOptions={zoom:13,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};var map=new google.maps.Map(_$("customer_map"),mapOptions);map.mapTypes.set('tehgrayz',mapType);if(results){map.setCenter(results[0].geometry.location);var marker=new google.maps.Marker({map:map,position:results[0].geometry.location});var infowindow=new google.maps.InfoWindow({content:"<p>"+ui.get('address')+"</p>"});google.maps.event.addListener(marker,'click',function(){infowindow.open(map,marker);});}});};;function CustomerOverview(){}
CustomerOverview.prototype=new JobOverview();CustomerOverview.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/overview',true);});var chart={chart:{type:'column',width:500},credits:{enabled:false},title:{text:translate('Turnover')},tooltip:{headerFormat:'{point.key}',pointFormat:(locale.currency_before_amount!=1?' : <b>{point.y:.'+locale.amount_decimals+'f} '+locale.currency_symbol:'<b>{point.name}</b><br/>'+locale.currency_symbol+' {point.y:.'+locale.amount_decimals+'f}</b>'),footerFormat:'',shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}}};chart.xAxis=ui.get('chart.xAxis');chart.yAxis=ui.get('chart.yAxis');chart.series=ui.get('chart.series');$('#chart-container-turnover').highcharts(chart);JobOverview.prototype.init.call(this);};;function CustomerPlanning(){};CustomerPlanning.prototype=new DefaultScreen();CustomerPlanning.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/planning',true);});this.grid=new PlanningGrid("CustomerPlanningGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){self.refresh();}});};;function CustomerTask(){}
CustomerTask.prototype=new TaskPanel();CustomerTask.prototype.getParameters=function()
{return{id_tracker:ui.get('tracker.id')};};CustomerTask.prototype.init=function()
{ui.set('filter',{hint:translate('user, title, description, tags')});$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/task',true);});return TaskPanel.prototype.init.call(this,"CustomerTask");};;function CustomerTeam(){};CustomerTeam.prototype=new JobTeam();CustomerTeam.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/team',true);});JobTeam.prototype.init.call(this);};;function CustomerTimesheetEntry(){};CustomerTimesheetEntry.prototype=new JobTimesheetEntry();CustomerTimesheetEntry.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/followup/timesheet_entry',true);});this.grid=new TimesheetGrid("CustomerViewTimesheetGrid",{tracker_enum_provider:null,getParameters:function(){return{id_tracker:ui.get('tracker.id'),userIds:$('.user_select').val()||[]};},onChange:function(){self.refresh();}});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.grid.refresh();});ui.on('time-report',function(event){var today=new Date();var param={id_customer:ui.get('customer.id'),matrixmode:'pivot_first',maxcols:0,valuekey:'hours,budget',id_unit:config.calendar.default_unit,groupkey:'path_sort_relative_to_customer',pivotkey:'login',chart:'horizontal',past_only:1,from:'',to:''};router.navigate('/report/time/time/'+encodeURIComponent($.toJSON(param)),true);});};;function CustomerTracker(){};CustomerTracker.prototype=new JobTracker();CustomerTracker.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/customer/'+$(this).val()+'/tracker',true);});$("#job_create_dialog_from_tracker").dialog({width:685,minHeight:500,modal:true,autoOpen:false,open:function(event){tinymce.execCommand('mceAddEditor',false,'job_create_from_tracker_description');},close:function(event){tinymce.execCommand('mceRemoveEditor',false,'job_create_from_tracker_description');},buttons:[{text:translate("OK"),click:function(){if(self.addJobFromTracker(ui.get('id_tracker_selected'),$('#job_create_dialog_from_tracker [name=id_owner]').val(),$('#job_create_dialog_from_tracker [name=title]').val(),tinymce.get('job_create_from_tracker_description').getContent()))$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});JobTracker.prototype.init.call(this);};CustomerTracker.prototype.addCustomTrackerActions=function(cell,id_tracker)
{if(isAllowed('jobs','create')&&!ui.get('job.id')&&!this.trackerModule.grid.getRowAttribute(cell.rowIndex,"id_default_tracker")&&this.trackerModule.grid.getRowAttribute(cell.rowIndex,"indent")==1){$(cell).append($('<a>').css('cursor','pointer').html(img('fa-caret-square-o-up','turn into job',translate("Create a %template from this tracker").replace(/%template/,config.tracker.job_label.toLocaleLowerCase()))).click(function(){ui.set('id_tracker_selected',id_tracker);$('#job_create_dialog_from_tracker [name=title]').val(config.estimate.default_customer_ref);$('#job_create_dialog_from_tracker [name=description]').val(config.estimate.default_note);$("#job_create_dialog_from_tracker .smartselect").select2({width:450,dropdownCssClass:'ui-dialog',dropdownAutoWidth:true});$('#job_create_dialog_from_tracker').dialog('open');}));};};CustomerTracker.prototype.addJobFromTracker=function(id_tracker,id_owner,title,description)
{var self=this;showWait(translate("Creating")+"...");_ajax('job/createfromtracker',{id_tracker:id_tracker,id_owner:id_owner,title:title,description:description}).done(function(response){hideWait();router.navigate('/job/'+response.id_job+'/'+config.tracker.default_tab,true);});return true;};;function DashboardIndex(){}
DashboardIndex.prototype=new DefaultScreen();DashboardIndex.prototype.showAsap=function(){return false;};DashboardIndex.prototype.init=function()
{widgetContainer=new WidgetContainer();};;function DefaultBillingGrid(name,config){if(name)this.init(name,config);}
DefaultBillingGrid.prototype=new BillingGrid();DefaultBillingGrid.prototype.init=function(name,config)
{var self=this;config.controller='defaultbilling';BillingGrid.prototype.init.call(this,name,config);};DefaultBillingGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
return true;};;function DefaultItemPatternGrid(name,config){if(name)this.init(name,config);}
DefaultItemPatternGrid.prototype=new TimetrackEditableGrid();DefaultItemPatternGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No item found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No item found matching your search criteria');config.controller='defaultitempattern';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected items ?',true)))self.deleteItem(ui.get('rows_checked'));});};DefaultItemPatternGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify items.");return false;}
if(this.getRowAttribute(rowIndex,'locked')==1&&$.inArray(this.getColumnName(columnIndex),['id_default_tracker'])>=0){if(this.getColumnType(columnIndex)!='boolean')jinfo("You cannot modify the tracker of this default item.");return false;}
return true;};DefaultItemPatternGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('configuration','edit'))return false;if(this.getRowAttribute(rowIndex,'locked')==1)return false;return true;};DefaultItemPatternGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_default_tracker','quantity','id_unit'])>=0;};DefaultItemPatternGrid.prototype.getActions=function(cell,id_item_pattern)
{var self=this;var actions=[];if(isAllowed('configuration','edit'))
actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyItem(id_item_pattern);}});if(isAllowed('configuration','edit'))
actions.push({icon:img('customer_deletetracker','delete','Delete'),active:this.isDeletable(cell.rowIndex),click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_item_pattern);}});return actions;};DefaultItemPatternGrid.prototype.tableLoaded=function()
{var self=this;if(this.hasColumn('recurrence'))this.setCellEditor('recurrence',new ScheduleCellEditor("/customer/getdefaultitempatterneditor",'defaultitempattern/updatepattern'));else{this.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).prepend('/ ').css('white-space','nowrap');}}));}
this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('label'))+'"';}}));this.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=value==''?"#AAAAAA":"black";EnumCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}));this.render();};DefaultItemPatternGrid.prototype.deleteItem=function(id_item_pattern)
{var self=this;showWait(translate("Deleting")+"...");_ajax('defaultitempattern/delete',{id:id_item_pattern}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the item from database","Error");else{self.refresh();self.onChange();}});};DefaultItemPatternGrid.prototype.copyItem=function(id_item_pattern)
{var self=this;showWait(translate("Copying")+"...");_ajax('defaultitempattern/copy',{id:id_item_pattern}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the item from database","Error");else{self.refresh();self.onChange();}});};;function DefaultTeamGrid(name,config){if(name)this.init(name,config);}
DefaultTeamGrid.prototype=new TeamGrid();DefaultTeamGrid.prototype.init=function(name,config)
{config.controller='defaultteam';TeamGrid.prototype.init.call(this,name,config);};DefaultTeamGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
return true;};;var HEMISPHERE_SOUTH='SOUTH';var HEMISPHERE_NORTH='NORTH';var HEMISPHERE_UNKNOWN='N/A';var olson={};olson.timezones={'-720,0':new TimeZone('-12:00','Etc/GMT+12',false),'-660,0':new TimeZone('-11:00','Pacific/Pago_Pago',false),'-600,1':new TimeZone('-11:00','America/Adak',true),'-660,1,s':new TimeZone('-11:00','Pacific/Apia',true),'-600,0':new TimeZone('-10:00','Pacific/Honolulu',false),'-570,0':new TimeZone('-10:30','Pacific/Marquesas',false),'-540,0':new TimeZone('-09:00','Pacific/Gambier',false),'-540,1':new TimeZone('-09:00','America/Anchorage',true),'-480,1':new TimeZone('-08:00','America/Los_Angeles',true),'-480,0':new TimeZone('-08:00','Pacific/Pitcairn',false),'-420,0':new TimeZone('-07:00','America/Phoenix',false),'-420,1':new TimeZone('-07:00','America/Denver',true),'-360,0':new TimeZone('-06:00','America/Guatemala',false),'-360,1':new TimeZone('-06:00','America/Chicago',true),'-360,1,s':new TimeZone('-06:00','Pacific/Easter',true),'-300,0':new TimeZone('-05:00','America/Bogota',false),'-300,1':new TimeZone('-05:00','America/New_York',true),'-270,0':new TimeZone('-04:30','America/Caracas',false),'-240,1':new TimeZone('-04:00','America/Halifax',true),'-240,0':new TimeZone('-04:00','America/Santo_Domingo',false),'-240,1,s':new TimeZone('-04:00','America/Asuncion',true),'-210,1':new TimeZone('-03:30','America/St_Johns',true),'-180,1':new TimeZone('-03:00','America/Godthab',true),'-180,0':new TimeZone('-03:00','America/Argentina/Buenos_Aires',false),'-180,1,s':new TimeZone('-03:00','America/Montevideo',true),'-120,0':new TimeZone('-02:00','America/Noronha',false),'-120,1':new TimeZone('-02:00','Etc/GMT+2',true),'-60,1':new TimeZone('-01:00','Atlantic/Azores',true),'-60,0':new TimeZone('-01:00','Atlantic/Cape_Verde',false),'0,0':new TimeZone('00:00','Etc/UTC',false),'0,1':new TimeZone('00:00','Europe/London',true),'60,1':new TimeZone('+01:00','Europe/Brussels',true),'60,0':new TimeZone('+01:00','Africa/Lagos',false),'60,1,s':new TimeZone('+01:00','Africa/Windhoek',true),'120,1':new TimeZone('+02:00','Asia/Beirut',true),'120,0':new TimeZone('+02:00','Africa/Johannesburg',false),'180,1':new TimeZone('+03:00','Europe/Moscow',true),'180,0':new TimeZone('+03:00','Asia/Baghdad',false),'210,1':new TimeZone('+03:30','Asia/Tehran',true),'240,0':new TimeZone('+04:00','Asia/Dubai',false),'240,1':new TimeZone('+04:00','Asia/Yerevan',true),'270,0':new TimeZone('+04:30','Asia/Kabul',false),'300,1':new TimeZone('+05:00','Asia/Yekaterinburg',true),'300,0':new TimeZone('+05:00','Asia/Karachi',false),'330,0':new TimeZone('+05:30','Asia/Kolkata',false),'345,0':new TimeZone('+05:45','Asia/Kathmandu',false),'360,0':new TimeZone('+06:00','Asia/Dhaka',false),'360,1':new TimeZone('+06:00','Asia/Omsk',true),'390,0':new TimeZone('+06:30','Asia/Rangoon',false),'420,1':new TimeZone('+07:00','Asia/Krasnoyarsk',true),'420,0':new TimeZone('+07:00','Asia/Jakarta',false),'480,0':new TimeZone('+08:00','Asia/Shanghai',false),'480,1':new TimeZone('+08:00','Asia/Irkutsk',true),'525,0':new TimeZone('+08:45','Australia/Eucla',true),'525,1,s':new TimeZone('+08:45','Australia/Eucla',true),'540,1':new TimeZone('+09:00','Asia/Yakutsk',true),'540,0':new TimeZone('+09:00','Asia/Tokyo',false),'570,0':new TimeZone('+09:30','Australia/Darwin',false),'570,1,s':new TimeZone('+09:30','Australia/Adelaide',true),'600,0':new TimeZone('+10:00','Australia/Brisbane',false),'600,1':new TimeZone('+10:00','Asia/Vladivostok',true),'600,1,s':new TimeZone('+10:00','Australia/Sydney',true),'630,1,s':new TimeZone('+10:30','Australia/Lord_Howe',true),'660,1':new TimeZone('+11:00','Asia/Kamchatka',true),'660,0':new TimeZone('+11:00','Pacific/Noumea',false),'690,0':new TimeZone('+11:30','Pacific/Norfolk',false),'720,1,s':new TimeZone('+12:00','Pacific/Auckland',true),'720,0':new TimeZone('+12:00','Pacific/Tarawa',false),'765,1,s':new TimeZone('+12:45','Pacific/Chatham',true),'780,0':new TimeZone('+13:00','Pacific/Tongatapu',false),'840,0':new TimeZone('+14:00','Pacific/Kiritimati',false)}
olson.dst_start_dates={'America/Denver':new Date(2011,2,13,3,0,0,0),'America/Mazatlan':new Date(2011,3,3,3,0,0,0),'America/Chicago':new Date(2011,2,13,3,0,0,0),'America/Mexico_City':new Date(2011,3,3,3,0,0,0),'Atlantic/Stanley':new Date(2011,8,4,7,0,0,0),'America/Asuncion':new Date(2011,9,2,3,0,0,0),'America/Santiago':new Date(2011,9,9,3,0,0,0),'America/Campo_Grande':new Date(2011,9,16,5,0,0,0),'America/Montevideo':new Date(2011,9,2,3,0,0,0),'America/Sao_Paulo':new Date(2011,9,16,5,0,0,0),'America/Los_Angeles':new Date(2011,2,13,8,0,0,0),'America/Santa_Isabel':new Date(2011,3,5,8,0,0,0),'America/Havana':new Date(2011,2,13,2,0,0,0),'America/New_York':new Date(2011,2,13,7,0,0,0),'Asia/Gaza':new Date(2011,2,26,23,0,0,0),'Asia/Beirut':new Date(2011,2,27,1,0,0,0),'Europe/Minsk':new Date(2011,2,27,3,0,0,0),'Europe/Istanbul':new Date(2011,2,27,7,0,0,0),'Asia/Damascus':new Date(2011,3,1,2,0,0,0),'Asia/Jerusalem':new Date(2011,3,1,6,0,0,0),'Africa/Cairo':new Date(2011,3,29,4,0,0,0),'Asia/Yerevan':new Date(2011,2,27,4,0,0,0),'Asia/Baku':new Date(2011,2,27,8,0,0,0),'Pacific/Auckland':new Date(2011,8,26,7,0,0,0),'Pacific/Fiji':new Date(2010,11,29,23,0,0,0),'America/Halifax':new Date(2011,2,13,6,0,0,0),'America/Goose_Bay':new Date(2011,2,13,2,1,0,0),'America/Miquelon':new Date(2011,2,13,5,0,0,0),'America/Godthab':new Date(2011,2,27,1,0,0,0)}
olson.ambiguity_list={'America/Denver':['America/Denver','America/Mazatlan'],'America/Chicago':['America/Chicago','America/Mexico_City'],'America/Asuncion':['Atlantic/Stanley','America/Asuncion','America/Santiago','America/Campo_Grande'],'America/Montevideo':['America/Montevideo','America/Sao_Paolo'],'Asia/Beirut':['Asia/Gaza','Asia/Beirut','Europe/Minsk','Europe/Istanbul','Asia/Damascus','Asia/Jerusalem','Africa/Cairo'],'Asia/Yerevan':['Asia/Yerevan','Asia/Baku'],'Pacific/Auckland':['Pacific/Auckland','Pacific/Fiji'],'America/Los_Angeles':['America/Los_Angeles','America/Santa_Isabel'],'America/New_York':['America/Havana','America/New_York'],'America/Halifax':['America/Goose_Bay','America/Halifax'],'America/Godthab':['America/Miquelon','America/Godthab']};function TimeZone(offset,olson_tz,uses_dst){this.utc_offset=offset;this.olson_tz=olson_tz;this.uses_dst=uses_dst;}
TimeZone.prototype.ambiguity_check=function(){var local_ambiguity_list=olson.ambiguity_list[this.olson_tz];if(typeof(local_ambiguity_list)=='undefined'){return;}
var length=local_ambiguity_list.length;for(var i=0;i<length;i++){var tz=local_ambiguity_list[i]
if(date_is_dst(olson.dst_start_dates[tz])){this.olson_tz=tz;return;}}}
function date_is_dst(date){var base_offset=((date.getMonth()>5?get_june_offset():get_january_offset()))
var date_offset=get_date_offset(date);return(base_offset-date_offset)!=0;}
function get_date_offset(date){return-date.getTimezoneOffset();}
function get_timezone_info(){var january_offset=get_january_offset();var june_offset=get_june_offset();var diff=january_offset-june_offset;if(diff<0){return{'utc_offset':january_offset,'dst':1,'hemisphere':HEMISPHERE_NORTH}}
else if(diff>0){return{'utc_offset':june_offset,'dst':1,'hemisphere':HEMISPHERE_SOUTH}}
return{'utc_offset':january_offset,'dst':0,'hemisphere':HEMISPHERE_UNKNOWN}}
function get_january_offset(){return get_date_offset(new Date(2011,0,1,0,0,0,0));}
function get_june_offset(){return get_date_offset(new Date(2011,5,1,0,0,0,0));}
function determine_timezone(){var timezone_key_info=get_timezone_info();var hemisphere_suffix='';if(timezone_key_info.hemisphere==HEMISPHERE_SOUTH){hemisphere_suffix=',s';}
var tz_key=timezone_key_info.utc_offset+','+timezone_key_info.dst+hemisphere_suffix
return{'timezone':olson.timezones[tz_key],'key':tz_key}};var DDSPEED=10;var DDTIMER=15;function ddMenu(id,d){var h=document.getElementById(id+'-ddheader');var c=document.getElementById(id+'-ddcontent');clearInterval(c.timer);if(d==1){clearTimeout(h.timer);if(c.maxh&&c.maxh<=c.offsetHeight){return}
else if(!c.maxh){c.style.display='block';c.style.zIndex='200000';c.style.height='auto';c.maxh=c.offsetHeight;c.style.height='0px';}
c.timer=setInterval(function(){ddSlide(c,1)},DDTIMER);}else{h.timer=setTimeout(function(){ddCollapse(c)},50);}}
function ddCollapse(c){c.timer=setInterval(function(){ddSlide(c,-1)},DDTIMER);}
function cancelHide(id){var h=document.getElementById(id+'-ddheader');var c=document.getElementById(id+'-ddcontent');clearTimeout(h.timer);clearInterval(c.timer);if(c.offsetHeight<c.maxh){c.timer=setInterval(function(){ddSlide(c,1)},DDTIMER);}}
function ddSlide(c,d){var currh=c.offsetHeight;var dist;if(d==1){dist=(Math.round((c.maxh-currh)/DDSPEED));}else{dist=(Math.round(currh/DDSPEED));}
if(dist<=1&&d==1){dist=1;}
c.style.height=currh+(dist*d)+'px';c.style.opacity=currh/c.maxh;c.style.filter='alpha(opacity='+(currh*100/c.maxh)+')';if((currh<2&&d!=1)||(currh>(c.maxh-2)&&d==1)){clearInterval(c.timer);}};function DuescheduleCommon(){}
DuescheduleCommon.prototype=new DefaultScreen();DuescheduleCommon.prototype.init=function()
{var self=this;$("div.edit_dueschedule").dialog({width:680,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Save"),click:function(){if(self.add($('div.edit_dueschedule'),self.target_cell)){$(this).dialog('close');}}}]});ui.on('edit-history',function(event){self.target_cell=event.node;dlgButtons=$('div.edit_dueschedule').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("div.edit_dueschedule").find("textarea,input[type=password],input[type=text],select").val('');$("div.edit_dueschedule .datepicker").val(ui.get('default_date')).datepicker({maxDate:new Date(),dateFormat:locale['date_format_jquery']});$("div.edit_dueschedule select").each(function(){$(this).select2({width:300});});var status=$(event.node).attr('class');$("div.edit_dueschedule [name=status]").val(status).trigger('change');dlgButtons.attr('disabled','1').addClass('ui-state-disabled');var updateButtonState=function(e){if($("div.edit_dueschedule [name=comment]").val()==''&&$("div.edit_dueschedule [name=status]").val()==status)dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');};$("div.edit_dueschedule [name=comment]").keyup(updateButtonState);$("div.edit_dueschedule [name=status], div.edit_dueschedule [name=comment]").change(updateButtonState);});$('table.dueschedule').tooltip({items:"td[class]",tooltipClass:"large-tooltip",position:{my:"center top+15",at:"center bottom",collision:"flipfit"},content:function(){return $(this).find(".history-tooltip").html();}});$(".datepicker.due_date_year").datepicker({minDate:new Date(ui.get('year'),0,1),maxDate:new Date(ui.get('year'),11,31),dateFormat:locale['date_format_jquery'],onSelect:function(date,inst){showWait(translate("Saving")+"...");_ajax('dueschedule/setduedate',{id_task:$(this).attr('id_task'),id_customer:$(this).attr('id_customer'),date:date}).done(function(response){self.refresh();hideWait();});}});};;function DuescheduleCustomer(){}
DuescheduleCustomer.prototype=new DuescheduleCommon();DuescheduleCustomer.prototype.init=function()
{var self=this;$("select[name=year]").select2({width:100,minimumResultsForSearch:-1}).change(function(){router.navigate('/dueschedule/customer/'+ui.get('customer.id')+'/'+$(this).val(),true);});$('select.id_customer_change').change(function(){router.navigate('/dueschedule/customer/'+$(this).val(),true);});DuescheduleCommon.prototype.init.call(this);};DuescheduleCustomer.prototype.add=function(dialog,cell)
{var self=this;showWait(translate("Saving")+"...");_ajax('dueschedule/addhistory',{id_task:$(cell).parent().attr('rel'),id_customer:ui.get('customer.id'),id_contact:$(cell).parent().attr('id_contact'),year:ui.get('year'),month:$(cell).attr('rel'),date:dialog.find('[name=date]').val(),status:dialog.find('[name=status]').val(),comment:dialog.find('[name=comment]').val()}).done(function(response){self.refresh();hideWait();});return true;};;function DuescheduleIndex(){}
DuescheduleIndex.prototype=new DefaultScreen();DuescheduleIndex.prototype.init=function()
{var self=this;$('select.id_customer_change').change(function(){router.navigate('/dueschedule/customer/'+$(this).val(),true);});$('select.id_task_change').change(function(){router.navigate('/dueschedule/task/'+$(this).val(),true);});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.loadSummary();});this.loadSummary();};DuescheduleIndex.prototype.loadSummary=function()
{var self=this;ui.set('summary',null);gridWait('wait_loading');_ajax('dueschedule/summary',{id_owners:$('.owner_select').size()==0?null:($('.owner_select').val()||[])}).done(function(response){ui.set(response);$(".datepicker.due_date_year").datepicker({minDate:new Date(ui.get('year'),0,1),maxDate:new Date(ui.get('year'),11,31),dateFormat:locale['date_format_jquery'],onSelect:function(date,inst){showWait(translate("Saving")+"...");_ajax('dueschedule/setduedate',{id_task:$(this).attr('id_task'),date:date}).done(function(response){self.loadSummary();hideWait();});}});});};;function DuescheduleTask(){}
DuescheduleTask.prototype=new DuescheduleCommon();DuescheduleTask.prototype.init=function()
{var self=this;$("select[name=year]").select2({width:100,minimumResultsForSearch:-1}).change(function(){router.navigate('/dueschedule/task/'+ui.get('task.id')+'/'+$(this).val(),true);});$('select.id_task_change').change(function(){router.navigate('/dueschedule/task/'+$(this).val(),true);});DuescheduleCommon.prototype.init.call(this);};DuescheduleTask.prototype.add=function(dialog,cell)
{var self=this;showWait(translate("Saving")+"...");_ajax('dueschedule/addhistory',{id_task:ui.get('task.id'),id_customer:$(cell).parent().attr('rel'),id_contact:$(cell).parent().attr('id_contact'),year:ui.get('year'),month:$(cell).attr('rel'),date:dialog.find('[name=date]').val(),status:dialog.find('[name=status]').val(),comment:dialog.find('[name=comment]').val()}).done(function(response){self.refresh();hideWait();});return true;};;function EmailGrid(name,config){if(name)this.init(name,config);}
EmailGrid.prototype=new TimetrackEditableGrid();EmailGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No email found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No email found matching your search criteria');config.controller='email';TimetrackEditableGrid.prototype.init.call(this,name,config);};EmailGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};EmailGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify emails.");return false;}
return true;};EmailGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),[])>=0;};EmailGrid.prototype.getActions=function(cell,id_email)
{var self=this;var actions=[];if(isAllowed('invoices','edit')){actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this email ?',true)))self.deleteEmail(id_email);}});}
return actions;};EmailGrid.prototype.tableLoaded=function()
{var self=this;this.setCellRenderer("subject",new CellRenderer({render:function(cell,value){$(cell).css('text-decoration','underline');CellRenderer.prototype.render.call(this,cell,value);}}));this.setCellEditor("created",new MailCellEditor({getParameters:self.getParameters}));this.setCellEditor("from",new MailCellEditor({getParameters:self.getParameters}));this.setCellEditor("to",new MailCellEditor({getParameters:self.getParameters}));this.setCellEditor("subject",new MailCellEditor({getParameters:self.getParameters}));if(this.hasColumn("is_sent"))this.setCellRenderer("is_sent",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);$(cell.parentNode).addClass(value?"paid":"unpaid").removeClass(value?"unpaid":"paid");}}));this.render();};EmailGrid.prototype.deleteEmail=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('email/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the email from database","Error");else{self.refresh();self.onChange();}});};;function EmailIndex(){};EmailIndex.prototype=new DefaultScreen();EmailIndex.prototype.init=function(name)
{var self=this;this.grid=new EmailGrid("EmailGrid",{getParameters:function(){var parameter={};parameter.id_users=$('.user_select').val()||[];parameter.hide_sent=$('[name=hide_sent]').is(':checked');return parameter;}});$('input[name=hide_sent]').click(function(){self.grid.refresh();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose users")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Users"))}).on('multiselectclose',function(){self.grid.refresh();});ui.on('actionbar-add',function(){new MailEditor({afterSave:function(){self.grid.refreshGrid();}}).open();});};;function EstimateViewBilling(){};EstimateViewBilling.prototype=new JobJobItemBilling();EstimateViewBilling.prototype.onshow=function()
{var self=this;this.onhide();this.init();var has_grid=ui.get('estimate.id_tracker')&&(ui.get('estimate.status_type')==AppConfig.ESTIMATE_STATUS_ACCEPTED||ui.get('estimate.status_type')==AppConfig.ESTIMATE_STATUS_INVOICED);if($('#tablecontent').size()>0&&has_grid)this.grid.fetch();if(typeof this.observer_status=='undefined')this.observer_status=ui.observe('estimate.id_tracker, estimate.status_type',function(){self.onshow();},{init:false,defer:true});};EstimateViewBilling.prototype.onhide=function()
{ui.off('actionbar-add');ui.off('create-invoice');ui.off('create-advance-invoice');ui.off('list-invoiceable');ui.off('actionbar-delete');ui.off('actionbar-discount');};EstimateViewBilling.prototype.dispose=function()
{JobJobItemBilling.prototype.dispose.call(this);if(typeof this.observer_status!='undefined')this.observer_status.cancel();};;function EstimateViewEntry(inJob){this.init(inJob);}
EstimateViewEntry.prototype.init=function(inJob)
{var self=this;this.inJob=inJob;this.dialog=new ItemSelectorDialog({url:'/estimate/entrydialog?_html',title:translate("Add items"),add:function(type,id_items){return self.add(this.dialog,type,id_items);}});};EstimateViewEntry.prototype.createGrid=function()
{var self=this;this.grid=new TimetrackEditableGrid("EstimateViewEntryGrid",{alternate:true,serverSide:false,sortEnabled:!this.inJob,noResult:translate("No entry found"),tableLoaded:function(){self.initializeGrid(this);},tableRendered:function(containerid,className,tableid){TimetrackEditableGrid.prototype.tableRendered.call(this,containerid,className,tableid);if(self.inJob)$(".paginationControl .empty").addClass('tiny');if(self.inJob||this.sortedColumnName==-1){var selfgrid=this;$("#tablecontent tbody").sortable({delay:150,helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index){$(this).width($originals.eq(index).width());});return $helper;},stop:function(){var id_entries_sorted=[];$(this).find('tr').each(function(){id_entries_sorted.push(selfgrid.getRowId(selfgrid.getRowIndex(this)));});ajax('/estimate/sortentries',{id_entries_sorted:id_entries_sorted},function(){selfgrid.fetch();selfgrid.onChange();});}});}},fetch:function(){if($('#tablecontent').size()>0){this.wait();this.loadJSON(baseUrl+"/estimate/generateentryjson?id="+ui.get('estimate.id')+"&in_job="+(self.inJob?1:0));}},onChange:function(){var pdf_selector=$('#pdf_viewer');var parent=pdf_selector.parent();pdf_selector.remove();ui.set('estimate.refresh',(new Date().getTime()));parent.append(pdf_selector);},isEditable:function(rowIndex,columnIndex){var interactive=this.getColumnType(columnIndex)!='boolean';var type=this.getValueAt(rowIndex,this.getColumnIndex('type'));if(!isAllowed('estimates','edit')){if(interactive)jerror("You are not authorized to modify estimates.");return false;}
if(config.estimate.freeze_sent_estimates==1&&ui.get('estimate.status_type')>=AppConfig.ESTIMATE_STATUS_SENT){if(interactive)jinfo("The estimate cannot be modified. If you wish to modify it, set the estimate back to 'Draft' status.",null,400);return false;}
if(self.inJob&&type!='comment'){if(interactive)jinfo(translate("You cannot modify this entry since it is automatically generated from the %template.").replace(/%template/,config.tracker.job_label.toLocaleLowerCase()));return false;}
if(type=='comment'&&$.inArray(this.getColumnName(columnIndex),['type','label','description'])<0){if(interactive)jinfo(translate("You cannot only modify the label and description of comment entries."));return false;}
return true;},readonlyWarning:function(column){if(column.name=='amount')jinfo("The entry amount is not editable directly: you have to edit the quantity and/or unitary price.");},getActions:function(cell,id_entry)
{var actions=[];if(self.inJob&&this.getValueAt(cell.rowIndex,this.getColumnIndex('type'))!='comment')return actions;var active=isAllowed('estimates','edit')&&(config.estimate.freeze_sent_estimates==0||ui.get('estimate.status_type')<=AppConfig.ESTIMATE_STATUS_READY);if(self.inJob){var descriptionColumnIndex=this.getColumnIndex('description');var description=this.getValueAt(cell.rowIndex,descriptionColumnIndex);actions.push({icon:img('customer_note','note',description),active:active,click:function(){self.grid.getColumn(descriptionColumnIndex).cellEditor.edit(cell.rowIndex,descriptionColumnIndex,cell,description);}});}
actions.push({icon:img('customer_copytracker','copy','Duplicate'),active:active,click:function(){self.copyEntry(id_entry);}});actions.push({icon:img('customer_deletetracker','delete','Delete'),active:active,click:function(){if(confirm(translate('Are you sure you want to delete this entry ?',true)))self.deleteEntry(id_entry);}});return actions;},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){var selfgrid=this;updateCellValue(this,'/estimate/updateestimateentrycellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){if(response=="error")return false;self.update(false);selfgrid.onChange();response=eval("("+response+")");if(selfgrid.hasColumn('amount'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("amount"),parseFloat(response.amount));if(selfgrid.hasColumn('quantity'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("quantity"),parseFloat(response.quantity));if(selfgrid.hasColumn('id_unit'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_unit"),response.id_unit);if(selfgrid.hasColumn('unitary_price'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("unitary_price"),parseFloat(response.unitary_price));if(selfgrid.hasColumn('id_vat_type'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_vat_type"),response.id_vat_type);if(selfgrid.hasColumn('unitary_cost'))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("unitary_cost"),parseFloat(response.unitary_cost));if(selfgrid.hasColumn("id_supplier"))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_supplier"),parseFloat(response.id_supplier));return true;});}});};EstimateViewEntry.prototype.onshow=function()
{var self=this;$('#estimate_comment_dialog').dialog({autoOpen:false,width:640,buttons:[{text:translate("OK"),click:function(){self.addComment();$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});$(".create_discount").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.createDiscount();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});ui.on('add-entries',function(){self.dialog.open();});ui.on('add-comment',function(){$('#estimate_comment_dialog').dialog('open');});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected entries ?',true)))self.deleteEntry(ui.get('rows_checked'));});ui.on('actionbar-discount',function(){self.showCreateDiscount();});this.createGrid();this.update(true);};EstimateViewEntry.prototype.onhide=function()
{ui.off('add-entries');ui.off('add-comment');ui.off('actionbar-delete');ui.off('actionbar-discount');};EstimateViewEntry.prototype.showCreateDiscount=function()
{$(".create_discount").dialog('open');$('.create_discount select').select2({width:450});$('.create_discount select[name=id_unit]').select2({width:150});};EstimateViewEntry.prototype.createDiscount=function(id_entry,percent)
{var self=this;showWait(translate("Creating")+"...");_ajax('estimate/creatediscount',{id_estimate:ui.get('estimate.id'),id:ui.get('rows_checked'),percent:$(".create_discount [name=percent]").val(),id_unit:$(".create_discount [name=id_unit]").val()}).done(function(response){hideWait();if(!response)jerror("An error occured while creating the discount","Error");else{self.grid.fetch();self.grid.onChange();}});};EstimateViewEntry.prototype.initializeGrid=function(grid)
{var self=this;for(var columnIndex=0;columnIndex<grid.getColumnCount();columnIndex++){var columName=grid.getColumnName(columnIndex);if(helpboxes[columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes[columName],grid.getColumnLabel(columnIndex),480));}
grid.setCellRenderer("label",new CellRenderer({render:function(cell,value){$(cell).css('max-width','400px');CellRenderer.prototype.render.call(this,cell,value);if(self.inJob){$(cell).css('height','24px').css('overflow','hidden');var actionZone=$('<div>').addClass('right');grid.renderActions(cell,actionZone);$(cell).prepend(actionZone);}}}));grid.setCellRenderer('description',new CellRenderer({render:function(cell,value){if(!self.inJob)$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');else $(cell).html(img('customer_movetracker','move',translate('Drag to move entry'),'cursor:move')+$(cell).html());}}));grid.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+grid.getValueAt(cell.rowIndex,grid.getColumnIndex('label'))+'"';}}));if(grid.hasColumn('quantity'))grid.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else{cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}}));if(grid.hasColumn('unitary_price'))grid.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('unitary_cost'))grid.setCellRenderer('unitary_cost',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('id_unit'))grid.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('id_vat_type'))grid.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('amount'))grid.setCellRenderer('amount',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));grid.render();if(this.inJob)this.grid.sort(-1);};EstimateViewEntry.prototype.update=function(fetch)
{if(fetch){this.grid.fetch();this.grid.onChange();}
ajax('/estimate/getestimate',{id:ui.get('estimate.id')},function(response){$('.statusbar .total.amount').html(response.amount_formatted).attr('title',translate("Gross margin")+': '+response.gross_margin_formatted);},"json");};EstimateViewEntry.prototype.add=function(dialog,type,id_items)
{var self=this;showWait(translate("Creating entry")+"...");if(type=='manual'){var add_catalog=dialog.find('[name=add_catalog]').is(':checked')?1:0;if(add_catalog){ajax('/item/add',{label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()}).done(function(response){ajax('/estimate/createentries',{id_estimate:ui.get('estimate.id'),id_items:JSON.parse(response).id}).done(function(response){hideWait();self.update(true);});});}
else ajax('/estimate/createentry',{id_estimate:ui.get('estimate.id'),label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()}).done(function(response){hideWait();self.update(true);});}
else if(type=='items'){ajax('/estimate/createentries',{id_estimate:ui.get('estimate.id'),id_items:id_items}).done(function(response){hideWait();self.update(true);});}
return true;};EstimateViewEntry.prototype.addComment=function()
{var self=this;showWait(translate("Creating entry")+"...");ajax('/estimate/createentry',{id_estimate:ui.get('estimate.id'),label:$('#estimate_comment_dialog [name=label]').val(),description:$('#estimate_comment_dialog [name=description]').val(),type:'comment'}).done(function(response){hideWait();self.update(true);});return true;};EstimateViewEntry.prototype.copyEntry=function(id_entry)
{var self=this;gridWait('tablecontent');ajax('/estimate/copyentry',{id_entry:id_entry},function(response){if(response!="ok")jerror("An error occured while copying the entry in database","Error");else self.update(true);},'json');};EstimateViewEntry.prototype.deleteEntry=function(id_entry)
{var self=this;showWait(translate("Deleting")+"...");_ajax('estimateentry/delete',{id:id_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the entry from database","Error");else self.update(true);});};;function EstimateViewGeneral(){this.init();}
EstimateViewGeneral.prototype.init=function()
{var self=this;ui.observe('estimate.id_customer',function(newValue){if(newValue){_ajax('customer/customercontactselectoptions',{id_customer:newValue}).done(function(response){ui.set('customer_contact_select_options',response);});}},{init:false});};EstimateViewGeneral.prototype.onshow=function()
{this.setupParameterForm();$('div.row select:first').focus();};EstimateViewGeneral.prototype.setupParameterForm=function()
{var self=this;$('#parameter_form select[multiple]').each(function(){$(this).select2({placeholder:translate("OPTION[none]"),allowClear:true,width:175,dropdownAutoWidth:true,closeOnSelect:false,minimumResultsForSearch:-1}).on('select2:close',function(){self.saveParameterForm();});$(this).select2Sortable({bindOrder:'sortableStop',sortableOptions:{'stop':function(){self.saveParameterForm();}}});});$('#parameter_form select:not([multiple])').each(function(){$(this).select2({width:175,dropdownAutoWidth:true,minimumResultsForSearch:-1});}).on('change',function(){self.saveParameterForm();});$('#parameter_form input[type=text]').change(function(){self.saveParameterForm();});$('#parameter_form textarea').change(function(){self.saveParameterForm();});$('#parameter_form input[type=checkbox]').click(function(){self.saveParameterForm();});};EstimateViewGeneral.prototype.saveParameterForm=function()
{var self=this;var parameters={id_estimate:ui.get('estimate.id'),parameters:{}};$('#parameter_form').populateParameters(parameters.parameters);_ajax('estimate/saveparameters',parameters).done(function(response){ui.set(response);self.setupParameterForm();});};;function EventGrid(name,config){if(name)this.init(name,config);}
EventGrid.prototype=new TimetrackEditableGrid();EventGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No event found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No event found matching your search criteria');config.controller='event';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected events ?',true)))self.deleteEvent(ui.get('rows_checked'));});};EventGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('contacts','delete'))return false;return true;};EventGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),[])>=0;};EventGrid.prototype.getActions=function(cell,id_event)
{var self=this;var actions=[];var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('contacts','create'))actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyEvent(id_event);}});if(isAllowed('contacts','delete'))actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this event ?',true)))self.deleteEvent(id_event);}});return actions;};EventGrid.prototype.tableLoaded=function()
{var self=this;if(isAllowed('contacts','list')&&this.hasColumn('nb_contacts'))this.setCellRenderer("nb_contacts",new NumberCellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).html($('<a>').html($(cell).html()).attr('href',baseUrl+'/ui/contact/index/'+self.getRowId(cell.rowIndex)));}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getDisplayValueAt(cell.rowIndex,self.getColumnIndex('name'))+'"';}}));this.render();};EventGrid.prototype.deleteEvent=function(id_event)
{var self=this;showWait(translate("Deleting")+"...");_ajax('event/delete',{id:id_event}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the event from database","Error");else{self.refresh();self.onChange();}});};EventGrid.prototype.copyEvent=function(id_event)
{var self=this;showWait(translate("Copying")+"...");_ajax('event/copy',{id:id_event}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the event from database","Error");else{self.refresh();self.onChange();}});};;function EventIndex(){}
EventIndex.prototype=new DefaultScreen();EventIndex.prototype.init=function()
{var self=this;this.grid=new EventGrid("EventGrid",{getParameters:function(){var parameter=EventGrid.prototype.getParameters.call(this);return parameter;}});$("a.add:not(.import)").click(function(){dlgButtons=$('div.add_event').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("div.add_event textarea,div.add_event input[type=password],div.add_event input[type=text],div.add_event select").val('');$("div.add_event .datepicker").val('').datepicker({dateFormat:locale['date_format_jquery']});dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("div.add_event [name=label]").focus();var updateButtonState=function(e){dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("div.add_event [mandatory]").each(function(){if(!$(this).val()){dlgButtons.attr('disabled','1').addClass('ui-state-disabled');return false;}});};$("div.add_event [mandatory]").keyup(updateButtonState).change(updateButtonState);});$("div.add_event").dialog({width:680,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New event"),buttons:[{text:translate("Add event"),click:function(){if(self.add($('div.add_event')))$(this).dialog('close');}}]});$("div.add_event select").each(function(){$(this).select2({width:400,placeholder:$(this).attr('placeholder'),dropdownCssClass:'ui-dialog'});});};EventIndex.prototype.add=function(dialog)
{var self=this;showWait(translate("Creating event")+"...");_ajax('event/create',merge(this.parameters,{name:dialog.find('[name=name]').val(),date:dialog.find('[name=date]').val(),description:dialog.find('[name=description]').val()})).done(function(response){hideWait();self.grid.refresh();});return true;};;$(function(){$('#integration_evernote').click(function(){_ajax('evernote/temptoken').done(function(response){window.location=response.autorizeUrl;});});});function getAccessToken(){_ajax('evernote/accesstoken').done(function(response){if(typeof response.token!=='undefined'){$('#response').html('<h1>'+translate('Thank you !')+'</h1>'+'<p>'+translate('%PRODUCT has now access to your Evernote account.').replace('%PRODUCT',camel_case(config.ui.product,true))+'</p>');}});};function ExpenseModule()
{_$("searchfield").onkeyup=function(e){var keynum=window.event?window.event.keyCode:e.which;if(keynum==13)expenseModule.filterExpenses();};this.editableGrid=new TimetrackEditableGrid("ExpenseGrid",{alternate:true,serverSide:true,noResult:translate('No expense found'),noResultMatchingFilter:translate('No expense found matching your search criteria'),tableLoaded:function(){expenseModule.initializeGrid(this);},isEditable:function(rowIndex,columnIndex){if(!isAllowed('expenses','edit')){jerror("You are not authorized to modify expenses.");return false;}
return true;},readonlyWarning:function(column){if(column.name=='amount')jinfo("The expense amount is not editable directly: you have to edit the expense entries.");else if(column.name=='vat')jinfo("The VAT amount not editable directly: you have to edit the expense entries.");},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/expense/updatecellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){return expenseModule.onUpdateCellValueResponse(rowIndex,columnIndex,response);},(expenseModule.editableGrid.getColumnName(columnIndex)=="id_status"&&parseInt(newValue)==4));},tableRendered:function(containerid,className,tableid){EditableGrid.prototype.tableRendered.call(this,containerid,className,tableid);updatePaginator(this,"paginator");$("a.tooltip").scrolltip({content:function(){var rowIndex=grid.getRowIndex(this.parentNode.parentNode);return grid.getRowAttribute(rowIndex,"tooltip");}});}});$("#searchfield_from, #searchfield_to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=this.id=="searchfield_from"?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$("#searchfield_from, #searchfield_to").not(this).datepicker("option",option,date);}});$("#expense_create_date").datepicker({dateFormat:locale['date_format_jquery']});$('#add_scratch').click(function(){expenseModule.showCreateDialog();});var buttons={};buttons[translate("OK")]=function(){if(expenseModule.createExpense($('#expense_create_dialog [name=expense_create_supplier]').val()))$(this).dialog("close");};buttons[translate("Cancel")]=function(){$(this).dialog("close");};$("#expense_create_dialog").dialog({width:420,modal:!jQuery.browser.msie,autoOpen:false,buttons:buttons});var btnCreate={};btnCreate[translate("Add supplier")]=function(){expenseModule.createSupplier(_$('quickadd_supplier_form'));$(this).dialog("close");};$("#quickadd_supplier_dialog").dialog({width:400,modal:!jQuery.browser.msie,autoOpen:false,buttons:btnCreate,title:translate("New supplier")});$("#quickadd_supplier_form").submit(function(){expenseModule.createSupplier(_$('quickadd_supplier_dialog'));$("#quickadd_supplier_dialog").dialog("close");return false;});this.fetchGrid();}
ExpenseModule.prototype.onUpdateCellValueResponse=function(rowIndex,columnIndex,response)
{with(this.editableGrid)
{var colname=getColumnName(columnIndex);if(colname=="id_status"){if(response==='error')return false;response=eval("("+response+")");if(typeof response!='object')return false;$('#total').html(response.total);$('#totalUnpaid').html(response.totalUnpaid);return true;}}
return response=="ok";};ExpenseModule.prototype.fetchGrid=function()
{gridWait("tablecontent");$("#paginator").empty();this.editableGrid.loadJSON(baseUrl+"/expense/generatejson");};ExpenseModule.prototype.initializeGrid=function(grid)
{grid.setCellRenderer("id_supplier",new EnumCellRenderer({render:function(cell,value){value=value?this.getLabel(cell.rowIndex,value):value;if(!isAllowed('expenses','view'))cell.innerHTML=value?truncate(value,40):"";else cell.innerHTML=value?"<a class='customer_link tooltip' href='"+baseUrl+"/expense/view/id/"+grid.getRowId(cell.rowIndex)+"'>"+truncate(value,40)+"</a>":"";}}));var truncateCellRenderer=new CellRenderer({render:function(cell,value){cell.innerHTML=truncate(value,64);}});grid.setCellRenderer("description",truncateCellRenderer);var dialogButtons={};dialogButtons[translate("Save")]=function(){this.cellEditor.applyEditing(this.cell,$("#expense_description").val());$(this).dialog("close");};grid.setCellEditor("description",new CellEditor({getEditor:function(cell,value){_$("expense_description_dialog").cellEditor=this;_$("expense_description_dialog").cell=cell;$("#expense_description_dialog").dialog({width:480,height:320,modal:!jQuery.browser.msie,autoOpen:false,open:function(event,ui){$("#expense_description").val(value);},beforeClose:function(event,ui){if(this.cell.isEditing)this.cellEditor.cancelEditing(this.cell);return true;},buttons:dialogButtons,title:translate("Note for expense")+" : "+this.editablegrid.getValueAt(cell.rowIndex,1)+" &raquo; "+this.editablegrid.getValueAt(cell.rowIndex,0)}).dialog('open');return null;}}));grid.setCellRenderer("id_status",new EnumCellRenderer({originalRenderer:grid.getColumn("id_status").cellRenderer,render:function(cell,value){this.originalRenderer.render.call(this,cell,value);$(cell.parentNode).addClass(value==3?"paid":"unpaid").removeClass(value==3?"unpaid":"paid");this.editablegrid.setValueAt(cell.rowIndex,grid.getColumnIndex("amount"),this.editablegrid.getValueAt(cell.rowIndex,grid.getColumnIndex("amount")));}}));grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_expense){$(cell).empty().css({'white-space':'nowrap','width':0});if(isAllowed('expenses','view'))cell.innerHTML+="<a href=\""+baseUrl+'/expense/view/id/'+id_expense+"\">"+img('invoice_view','view','View')+"</a>\n";if(isAllowed('expenses','delete'))cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\"if (confirm('"+translate('Are you sure you want to delete this expense ?')+"')) expenseModule.deleteExpense("+id_expense+");\">"+img('invoice_delete','delete','Delete')+"</a>\n";}}));grid.renderGrid("tablecontent","datagrid");if(grid.currentFilter){setHelperText_aux(_$('searchfield'),'',true);$('#searchfield').val(grid.currentFilter);}};ExpenseModule.prototype.showAddSupplier=function()
{dlgCompanyButtons=$('#quickadd_supplier_dialog').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("#quickadd_supplier_dialog  input[type=text]").val('');$("#quickadd_supplier_dialog [name=supplier_name]").focus();};ExpenseModule.prototype.createSupplier=function(form)
{ajax('/supplier/add',{name:$("#supplier_name").val()},function(response){if(typeof response!="object")jerror("Unexpected error");if(response.update_status!="ok")jerror(response.message);else{$('#msg_create').html("<div class=\"notification success\">"+translate("Supplier added")+"</div>").fadeIn().delay(5000).fadeOut('slow');ajax('/supplier/getsupplierlist',null,function(customerNames){var id_created=-1;$('#expense_create_dialog [name=expense_create_supplier]').empty();$('#expense_create_dialog [name=expense_create_supplier]').append($("<option>").attr('value',-1).html(translate("(select a supplier)")+"&nbsp;"));for(var c=0;c<customerNames.length;c++){var target=customerNames[c];if(target.id>id_created)id_created=target.id;$('#expense_create_dialog [name=expense_create_supplier]').append($("<option>").attr('value',target.id).html(target.name));}
$('#expense_create_dialog [name=expense_create_supplier]').val(id_created);},"json");}},"json");};ExpenseModule.prototype.deleteExpense=function(id)
{ajax('/expense/delete',{id:id},function(response){if(response=="error")showDialog("Error","An error occured while deleting the expense from database","error");else expenseModule.fetchGrid();if(typeof response=='object'){$('#total').html(response.total);$('#totalUnpaid').html(response.totalUnpaid);}},"json");};ExpenseModule.prototype.setExpenseStatus=function(id,id_status)
{var rowIndex=expenseModule.editableGrid.getRowIndex(id);var columnIndex=expenseModule.editableGrid.getColumnIndex("id_status");var row=expenseModule.editableGrid.getRow(rowIndex);var oldValue=expenseModule.editableGrid.getValueAt(rowIndex,columnIndex);expenseModule.editableGrid.setValueAt(rowIndex,columnIndex,id_status);updateCellValue(expenseModule.editableGrid,'/expense/updateexpensecellvalue',rowIndex,columnIndex,oldValue,id_status,row,function(response){return expenseModule.onUpdateCellValueResponse(rowIndex,columnIndex,response);});};ExpenseModule.prototype.getExpenseRef=function(id)
{var rowIndex=expenseModule.editableGrid.getRowIndex(id);var columnIndex=expenseModule.editableGrid.getColumnIndex("expense_ref");return expenseModule.editableGrid.getValueAt(rowIndex,columnIndex);};ExpenseModule.prototype.showCreateDialog=function()
{ajax('/supplier/getsupplierlist',null,function(customerNames){$("#expense_create_dialog").dialog('open');$("#expense_create_amount").focus();$('#expense_create_dialog [name=expense_create_supplier]').empty();$('#expense_create_dialog [name=expense_create_supplier]').append($("<option>").attr('value',-1).html(translate("(select a supplier)")+"&nbsp;"));for(var c=0;c<customerNames.length;c++){var target=customerNames[c];$('#expense_create_dialog [name=expense_create_supplier]').append($("<option>").attr('value',target.id).html(target.name));}},"json");};ExpenseModule.prototype.createExpense=function(form)
{var date=this.editableGrid.checkDate($("#expense_create_date").val());if($("#expense_create_supplier").val()==-1){jalert(translate("You must select a supplier"));return false;}
if($("#expense_create_date").val()!=''&&!date.dbDate){jalert(translate("Please enter the date as")+" "+translate('dd/mm/yyyy'));return false;}
ajax('/expense/add',{supplier:$("#expense_create_supplier").val(),id_type:$("#expense_create_type").val(),amount:$("#expense_create_amount").val(),date:date.dbDate?date.dbDate:'',description:$("#expense_create_description").val()},function(response){if(typeof response!='object'&&response!="ok")jerror(response=="error"?"An error occured while creating the expense in database":response);if(typeof response=='object'){$('#total').html(response.total);$('#totalUnpaid').html(response.totalUnpaid);}
expenseModule.fetchGrid();},"json");return true;};ExpenseModule.prototype.filterExpenses=function()
{var searchfield=getRealValue('searchfield');gridWait("tablecontent");$("#paginator").empty();ajax('/expense/setfilter',{searchfield:searchfield,from:$('#searchfield_from').val(),to:$('#searchfield_to').val()},function(response){$('#total').html(response.total);$('#totalUnpaid').html(response.totalUnpaid);expenseModule.editableGrid.filter(searchfield);},"json");};;var expenseEntryGrid=null;function initExpenseView()
{expenseEntryGrid=new TimetrackEditableGrid("ExpenseEntryGrid",{alternate:true,tableLoaded:function(){initializeExpenseEntryGrid(this);},isEditable:function(rowIndex,columnIndex){if(!isAllowed('expenses','edit')){jerror("You are not authorized to modify expenses.");return false;}
return true;},readonlyWarning:function(column){if(column.name=='amount')jinfo("The entry amount is not editable directly: you have to edit the quantity and/or unitary price.");},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){updateCellValue(this,'/expense/updateexpenseentrycellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){if(response=="error")return false;update_expense();var res=$.parseJSON(response);expenseEntryGrid.setValueAt(rowIndex,expenseEntryGrid.getColumnIndex("vat"),parseFloat(res.vat));expenseEntryGrid.setValueAt(rowIndex,expenseEntryGrid.getColumnIndex("id_vat_type"),parseFloat(res.id_vat_type));return true;});}});var dialogButtons={};dialogButtons[translate("Add entry")]=function(){create_expense_entry(_$('entries_form'));$(this).dialog("close");};$("#entries_form_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,buttons:dialogButtons,title:translate("New entry")});expenseEntryGrid.loadXML(baseUrl+"/expense/generateentryxml?id="+id);}
function initializeExpenseEntryGrid(grid)
{grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_entry,rowIndex){var confirmMessage=translate('Are you sure you want to delete this entry ?');var delEntryCode="if (confirm('"+confirmMessage+"')) delete_expense_entry("+id_entry+"); return false;";cell.innerHTML="";if(isAllowed('expenses','edit')&&id_status<=1)cell.innerHTML+="<a style=\"cursor:pointer\" onclick=\""+delEntryCode+"\">"+img('invoice_deleteentry','delete',translate('Delete expense entry'))+"</a>";}}));grid.renderGrid("tablecontent_entries","datagrid");}
function showAddExpenseEntryDialog()
{dlgButtons=$('#entries_form_div').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("#entries_form_div textarea,#entries_form_div input[type=text]").val('');$("#entries_form_div [name=expense_create_amount]").focus();$("#entries_form_div [name=expense_create_amount]").keyup(function(e){if($("#entries_form_div [name=expense_create_amount]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});};function update_expense()
{ajax('/expense/getexpense',{id:id},function(response){$('#expense_total').html(response.total_formatted);$('#expense_amount').html(response.amount_formatted);$('#expense_vat').html(response.vat_formatted);},"json");}
function create_expense_entry(form)
{ajax('/expense/createentry',{id_expense:$("#id_expense").val(),description:$("#expense_create_description").val(),amount:$("#expense_create_amount").val(),id_type:$("#expense_create_type").val()},function(response){if(response=="error"){jerror("An error occured while creating the entry in database","Error");return;};update_expense();expenseEntryGrid.loadXML(baseUrl+"/expense/generateentryxml?id="+id);},"json");}
function delete_expense_entry(id_entry)
{ajax('/expense/deleteentry',{id_entry:id_entry},function(response){if(response!="ok"){jerror("An error occured while deleting the entry from database","Error");return;}
update_expense();expenseEntryGrid.removeRow(id_entry);alternate("tablecontent_entries");});};function FileGrid(name,config){if(name)this.init(name,config);}
FileGrid.prototype=new TimetrackEditableGrid();FileGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No file found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No file found matching your search criteria');config.controller='file';TimetrackEditableGrid.prototype.init.call(this,name,config);};FileGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('files','edit')){jinfo("You are not authorized to modify files.");return false;}
return true;};FileGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),[])>=0;};FileGrid.prototype.updatePaginator=function()
{var self=this;TimetrackEditableGrid.prototype.updatePaginator.call(this);$("#tablecontent a.tooltip").tooltip({show:true,tooltipClass:'file-preview',content:function(){var content="Unable to get preview";_ajax('file/preview',{id:$(this).attr("rel")},true).done(function(response){content=response;});return content;}});};FileGrid.prototype.getActions=function(cell,id_file)
{var self=this;var actions=[];if(isAllowed('files','view'))
actions.push({icon:img('download','download',translate('Download')),href:baseUrl+"/file/file/download/1/id/"+this.getRowId(cell.rowIndex)});if(isAllowed('files','delete'))
actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this file ?',true)))self.deleteFile(id_file);}});return actions;};FileGrid.prototype.tableLoaded=function()
{var self=this;this.setCellRenderer("name",new CellRenderer({render:function(cell,value){var filename=value;if(self.currentFilter){indexSearch=value.toLowerCase().indexOf(self.currentFilter);if(indexSearch>=0)value=value.substring(0,indexSearch)
+"<span class='searchhighlight'>"
+value.substring(indexSearch,indexSearch+self.currentFilter.length)
+"</span>"
+value.substring(indexSearch+self.currentFilter.length);}
cell.innerHTML='<img src="'+baseUrl+'/images/filetype/'+(getFileExtension(filename)!=undefined?getFileExtension(filename):'unknown')+'.png" alt="">';if(isAllowed('files','view'))cell.innerHTML+="&nbsp;&nbsp;<a class=\"tooltip\" title=\"\" rel=\""+self.getRowId(cell.rowIndex)+"\" target='file' href=\""+baseUrl+"/file/file/id/"+self.getRowId(cell.rowIndex)+"\">"+value+"</a>\n";else cell.innerHTML+="&nbsp;&nbsp;"+value+"\n";}}));this.setCellRenderer("size",new CellRenderer({render:function(cell,value){cell.innerHTML=bytesToSize(value,2);}}));if(this.hasColumn('linkedto'))this.setCellRenderer("linkedto",new CellRenderer({render:function(cell,value){var linkType=self.getRowAttribute(cell.rowIndex,'linkedtype');if(linkType=="Customer")cell.innerHTML=translate(linkType)+" &rarr; <a href=\""+baseUrl+"/ui/customer/"+self.getRowAttribute(cell.rowIndex,'linkedid')+"\">"+value+"</a>";else if(linkType=="Supplier")cell.innerHTML=translate(linkType)+" &rarr; <a href=\""+baseUrl+"/ui/supplier/"+self.getRowAttribute(cell.rowIndex,'linkedid')+"\">"+value+"</a>";else if(linkType=="Contact")cell.innerHTML=translate(linkType)+" &rarr; <a href=\""+baseUrl+"/ui/contact/"+self.getRowAttribute(cell.rowIndex,'linkedid')+"\">"+value+"</a>";else if(linkType=="Timesheet")cell.innerHTML=translate(linkType)+" &rarr; "+value;}}));this.render();};FileGrid.prototype.deleteFile=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('file/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the file from database","Error");else{self.refresh();self.onChange();}});};;function FileIndex(){}
FileIndex.prototype=new DefaultScreen();FileIndex.prototype.init=function()
{this.grid=new FileGrid("FileGrid");};;function FollowupIndex(){}
FollowupIndex.prototype=new DefaultScreen();FollowupIndex.prototype.init=function()
{var self=this;this.tabLoaded={};this.grids={'timesheet':new TimesheetGrid("FollowupTimesheetGrid",{container_id:"tablecontent-followup-timesheet",actionbar:$('#tabs-followup-timesheet .actionbar'),statusbar:$('#tabs-followup-timesheet .statusbar'),getParameters:function(){var parameter={};parameter.userIds=$('.user_select').size()>0?($('.user_select').val()||[]):null;parameter.id_owners=$('.owner_select').size()>0?($('.owner_select').val()||[]):null;parameter.from=ui.get('parameters.from');parameter.to=ui.get('parameters.to');return parameter;}}),'item_entry':new ItemEntryGrid("FollowupItemEntryGrid",{container_id:"tablecontent-followup-item_entry",actionbar:$('#tabs-followup-item_entry .actionbar'),statusbar:$('#tabs-followup-item_entry .statusbar'),getParameters:function(){var parameter={};parameter.followup=true,parameter.id_users=$('.user_select').size()>0?($('.user_select').val()||[]):null;parameter.id_owners=$('.owner_select').size()>0?($('.owner_select').val()||[]):null;parameter.from=ui.get('parameters.from');parameter.to=ui.get('parameters.to');return parameter;}}),'cost_entry':new CostEntryGrid("FollowupCostEntryGrid",{container_id:"tablecontent-followup-cost_entry",actionbar:$('#tabs-followup-cost_entry .actionbar'),statusbar:$('#tabs-followup-cost_entry .statusbar'),getParameters:function(){var parameter={};parameter.id_owners=$('.owner_select').size()>0?($('.owner_select').val()||[]):null;parameter.from=ui.get('parameters.from');parameter.to=ui.get('parameters.to');return parameter;}}),'task':new TaskGrid("FollowupTaskGrid",{container_id:"tablecontent-followup-task",actionbar:$('#tabs-followup-task .actionbar'),statusbar:$('#tabs-followup-task .statusbar'),getParameters:function(){var parameter={};parameter.id_users=$('.user_select').size()>0?($('.user_select').val()||[]):null;parameter.id_owners=$('.owner_select').size()>0?($('.owner_select').val()||[]):null;parameter.id_statuses=$('.status_select').val()||[];parameter.from=ui.get('parameters.from');parameter.to=ui.get('parameters.to');return parameter;}}),'note':new NoteGrid("FollowupNoteGrid",{container_id:"tablecontent-followup-note",actionbar:$('#tabs-followup-note .actionbar'),statusbar:$('#tabs-followup-note .statusbar'),getParameters:function(){var parameter={};parameter.id_users=$('.user_select').size()>0?($('.user_select').val()||[]):null;parameter.hide_closed=$('[name=hide_closed]').is(':checked');parameter.from=ui.get('parameters.from');parameter.to=ui.get('parameters.to');return parameter;}})};$('input[name=hide_closed]').click(function(){self.grids['note'].refresh();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:200,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"),false,1)}).on('multiselectclose',function(){var id_users=$('.user_select').val()||[];if(!arrayEqual(ui.get('parameters.id_users'),id_users))_ajax('followup/setparams',{id_users:id_users}).done(function(){self.reload();});});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:200,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"),false,1)}).on('multiselectclose',function(){var id_owners=$('.owner_select').val()||[];if(!arrayEqual(ui.get('parameters.id_owners'),id_owners))_ajax('followup/setparams',{id_owners:id_owners}).done(function(){self.reload();});});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:($.isTouch?75:200),noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grids['task'].refresh();});ui.on('shortcut',function(event){var interval=$(event.node).attr('rel');$("#followup_from").val(ui.get('interval')[interval]?ui.get('interval')[interval].from:'');$("#followup_to").val(ui.get('interval')[interval]?ui.get('interval')[interval].to:'');_ajax('followup/setparams',{interval:interval,from:$("#followup_from").val(),to:$("#followup_to").val()}).done(function(){self.reload();});});$("#followup_from, #followup_to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,changeYear:true,numberOfMonths:1,onSelect:function(selectedDate){if(false){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$("#followup_from, #followup_to").not(this).datepicker("option",option,date);}
_ajax('followup/setparams',{interval:'',from:$("#followup_from").val(),to:$("#followup_to").val()}).done(function(){self.reload();});}});$('#tabs-followup').tabs().on("tabsbeforeactivate",function(e,ui){var key=$(ui.newPanel).find('div.followup').attr('rel');if(typeof self.tabLoaded[ui.newPanel.attr('id')]!='undefined'){if(key)self.grids[key].refresh();return true;}
if(key)self.grids[key].fetch();else self.chart();self.tabLoaded[ui.newPanel.attr('id')]=true;});if(localisset('followup_currentTabIndex')&&parseInt(localget('followup_currentTabIndex'))>0&&$("#tabs-followup").tabs('option','active')==0)$("#tabs-followup").tabs('option','active',parseInt(localget('followup_currentTabIndex')));else{this.tabLoaded['tabs-followup-summary']=true;this.chart();}
$("#tabs-followup").on("tabsactivate",function(event,ui){localset('followup_currentTabIndex',$(this).tabs('option','active'));});};FollowupIndex.prototype.chart=function()
{gridWait("chart-container");var self=this;_ajax('followup/chart').done(function(response){if(response&&typeof response.chart.xAxis!='undefined'){ui.set(response);var chart={chart:{type:'column'},credits:{enabled:false},title:{text:translate('Worked hours')},subtitle:{text:translate('Hours per user and tracker type')},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y:.2f} h</b></td></tr>',footerFormat:'</table>',shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.1,borderWidth:0,stacking:'normal',groupPadding:0.1}}};chart.xAxis=response.chart.xAxis;chart.yAxis=response.chart.yAxis;chart.series=response.chart.series;$('#chart-container').highcharts(chart,function(chart){var widthColumn=null;if(chart.series[0])$.each(chart.series[0].points,function(pointIndex,p){if(chart.yAxis[0].max<response.reference_lines[pointIndex].threshold>0)chart.yAxis[0].setExtremes(null,response.reference_lines[pointIndex].threshold);if(chart.yAxis[0].max<response.reference_lines[pointIndex].target>0)chart.yAxis[0].setExtremes(null,response.reference_lines[pointIndex].target);});if(chart.series[0])$.each(chart.series[0].points,function(pointIndex,p){if(widthColumn===null){var lastX=null;widthColumn=0;$.each(chart.series[0].points,function(i,p){if(lastX)widthColumn=p.plotX-lastX;lastX=p.plotX;});if(widthColumn==0)widthColumn=chart.plotWidth;}
var xPosition=chart.plotLeft+p.plotX-widthColumn/2;if(response.reference_lines[pointIndex].threshold>0){var attributes={'stroke-width':2,stroke:'red',zIndex:3};var yPosition=chart.yAxis[0].toPixels(response.reference_lines[pointIndex].threshold);chart.renderer.path(['M',xPosition,yPosition,'L',xPosition+widthColumn,yPosition]).attr(attributes).add();}
if(response.reference_lines[pointIndex].target>0){var attributes={'stroke-width':2,stroke:'green',zIndex:3};var yPosition=chart.yAxis[0].toPixels(response.reference_lines[pointIndex].target);chart.renderer.path(['M',xPosition,yPosition,'L',xPosition+widthColumn,yPosition]).attr(attributes).add();}});});}});};;function ForecastcustomerfeesGrid(name,config){if(name)this.init(name,config);}
ForecastcustomerfeesGrid.prototype=new TimetrackEditableGrid();ForecastcustomerfeesGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No customer found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No customer found matching your search criteria');config.controller='forecastcustomerfees';TimetrackEditableGrid.prototype.init.call(this,name,config);};ForecastcustomerfeesGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['amount_1','amount_2','amount_3','amount_4','amount_5','amount_6','amount_7','amount_8','amount_9','amount_10','amount_11','amount_12'])>=0;};;function ForecastcustomerfeesIndex(){}
ForecastcustomerfeesIndex.prototype=new DefaultScreen();ForecastcustomerfeesIndex.prototype.init=function()
{var self=this;$("select[name=year]").select2({width:100,minimumResultsForSearch:-1}).change(function(){router.navigate('/forecastcustomerfees/index/'+$(this).val()+(ui.get('id_customer')?"/"+ui.get('id_customer'):""),true);});this.grid=new ForecastcustomerfeesGrid("ForecastcustomerfeesGrid",{getParameters:function(){var parameter=ForecastcustomerfeesGrid.prototype.getParameters.call(this);parameter.id_customer=ui.get('id_customer');parameter.year=ui.get('year');parameter.id_teams=$('.team_select').val()||[];parameter.id_owners=$('.owner_select').val()||[];parameter.id_tags=$('.tag_select').val()||[];return parameter;}});$('.team_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose teams")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Teams"))}).on('multiselectclose',function(){self.grid.refresh();});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});};;if(typeof CellRenderer!='undefined'){function PieHeaderRenderer(){this.pieIcon=$('<i>').attr('class','fa '+imgpath("report_pie"));};PieHeaderRenderer.prototype=new CellRenderer();PieHeaderRenderer.prototype.render=function(cell,value){if(value.match(/^\*.*/))$(cell).empty();else{try{var arr=$.parseJSON(value);if(arr&&typeof arr.length!='undefined')value=arr.join(' / ');}
catch(e){}
maxlen=64;if(!$(cell).html())$(cell).html(truncate_nolink(value,maxlen));else $(cell).find('a').each(function(){$(this).html(truncate_nolink($(this).text(),maxlen));});if(value.length>maxlen)$(cell).attr('title',value);if(this.editablegrid.isColumnNumerical(cell.columnIndex))$(cell).append("\u00a0\u00a0").append($("<a>").attr('href',"javascript:graphAccordion.grid.renderChart("+cell.columnIndex+");").append(this.pieIcon));var show_as_tooltip=true;var columName=this.editablegrid.getColumnName(cell.columnIndex);var valuekey=columName.substr(0,columName.indexOf(':'));var helpbox_id='report_'+ui.get('current_report_id')+'_'+valuekey;if(helpboxes[helpbox_id]){var link=document.createElement("a");$(link).append("<span class='fa fa-info-circle'/>").css('cursor','pointer');if(show_as_tooltip)$(link).find('span').attr('title','<strong>'+value+'</strong><br/><br/>'+helpboxes[helpbox_id]);link.onclick=function(){jalert(helpboxes[helpbox_id],false,value);};cell.appendChild(document.createTextNode("\u00a0\u00a0"));cell.appendChild(link);}
else if(valuekey)console.info("Helpbox for "+helpbox_id+" not found");}};}
function GraphAccordion()
{var self=this;ui.set('auto_refresh',!localisset('reports_auto_refresh')||localget('reports_auto_refresh')==1);ui.observe('auto_refresh',function(value){if(typeof value!=='undefined'){localset('reports_auto_refresh',value?1:0);if(value&&$('p.chart_outofdate').size()>0)graphAccordion.updateCurrentChartParameters();}});this.categories=[];this.grids={};this.currentChart=null;this.grid=null;this.currentDescription='';$('#report').html('<div id="reportdata">'+'<div id="reportform"></div>'+'<div id="reportgrid" class="clear"></div>'+'<div id="reportchart"></div>'+'</div>');$('#reportform').before('<div class="report_toolbar">'+'<div style="position:absolute;bottom:10px;left:0px"><i class="fa fa-gear fa-lg primc"></i><a class="report_param_link">'+translate('Parameters')+' &laquo;</a></div>'+'<div class="caption"></div>'+'<div style="position:absolute;bottom:10px;right:0px"><i class="fa fa-table fa-lg primc"></i><a class="report_table_link">'+translate('Hide table')+'</a><i class="fa fa-bar-chart-o fa-lg primc"></i><a class="report_chart_link">'+translate('Hide chart')+'</a></div>'+'</div>');$("a.report_param_link").click(function(event){event.preventDefault();if($("#reportform").is(":hidden")){$("#reportform").slideDown('fast');$(this).html(translate("Parameters")+" &laquo;");}
else{$("#reportform").slideUp('fast');$(this).html(translate("Parameters")+' &raquo;');}});$("a.report_chart_link").click(function(event){event.preventDefault();if($("#reportchart").is(":hidden")){graphAccordion.grid.renderChart();$("#reportchart").show();$(this).text(translate("Hide chart"));}
else{$("#reportchart").hide();$(this).text(translate("Show chart"));}});$("a.report_table_link").click(function(event){event.preventDefault();if($("#reportgrid").is(":hidden")){$("#reportgrid").slideDown('fast');$(this).text(translate("Hide table"));}
else{$("#reportgrid").slideUp('fast');$(this).text(translate("Show table"));}});$(".add_bookmark").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.addBookmark();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});ui.observe('bookmarks',function(){try{$('div.report_menu').accordion('refresh');}catch(e){}},{defer:true});this.createChartGrid();};GraphAccordion.prototype.createChartGrid=function()
{with(this){this.grid=new TimetrackEditableGrid("ReportGrid",{serverSide:false,actionbar:null,statusbar:null,pieColumnIndex:-1,pieColumnName:null,treeTable:null,setPieColumnIndex:function(columnIndex)
{with(this){pieColumnIndex=columnIndex<0?-1:columnIndex;pieColumnName=pieColumnIndex<0?null:getColumnName(pieColumnIndex);}},renderChart:function(columnIndex)
{DefaultScreen.prototype.show();var isChartHidden=$("#reportchart").is(":hidden");$("#reportchart").show();with(this){if(typeof columnIndex!='undefined')setPieColumnIndex(pieColumnIndex==columnIndex?-1:columnIndex);if(pieColumnIndex<0){var type=$("#reportform [name=chart]").val()=='horizontal'?'bar':'column';renderStackedBarChart('reportchart','',0,{type:type,bar3d:false,legend:getColumnLabel(0).replace(/\*/,''),rotateXLabels:(type=='bar'?0:(this.getRowCount()>=10?-60:0)),noDataMessage:translate("No data to display")});}
else if(!renderPieChart('reportchart',getColumnCount()<=2?'':null,pieColumnIndex,'label',{startAngle:35,gradientFill:false}))jinfo((translate("There is nothing to display!")));}
if(isChartHidden)$("#reportchart").hide();},render:function()
{this.renderGrid("reportgrid","datagrid");},getColumnLabel:function(columnIndexOrName)
{var column=this.getColumn(columnIndexOrName);try{var arr=$.parseJSON(column.jsonLabel);if(arr&&typeof arr.length!='undefined')return arr.join(' / ');}
catch(e){}
return column.label;},tableRendered:function()
{var self=this;with(this){var firstRowCells=$("#reportgrid tbody tr:eq(0) td");var firstColumnIsIndex=$("#reportgrid thead tr:eq(0) th:eq(0)").html()=='';if(firstColumnIsIndex)$("#reportgrid tbody tr:eq(0) td:eq(0)").css("width","0px");else $("#reportgrid tbody tr:eq(0) td:eq(0)").css("min-width","250px");var firstColCells=$("#reportgrid tbody tr td:nth-child("+(firstColumnIsIndex?2:1)+")").scrolltip({noanimation:true,content:function(){return self.getRowAttribute(self.getRowIndex(this.parentNode),"tooltip");}});var columnCount=getColumnCount();for(var c=0;c<columnCount;c++){try{var arr=$.parseJSON(columns[c].jsonLabel);if(typeof arr.length=='undefined')throw new Error();setValueAt(-1,c,arr[arr.length-1]||translate("Total"));}
catch(e){}}
var tHead=$(table).find("THEAD").get(0);for(var headerIndex=0;;headerIndex++){var pivotFound=false;var trHeader=tHead.insertRow(headerIndex);var last_value='';var colspan=1;var last_td=null;for(var c=0;c<columnCount;c++){var headerCell=document.createElement("TH");try{var arr=$.parseJSON(columns[c].jsonLabel);if(arr===null||typeof arr.length=='undefined')throw new Error();if(arr.length<=headerIndex+1)throw new Error();value=arr[headerIndex]||translate("Total");if(value!=last_value){var td=trHeader.appendChild(headerCell);$(td).html(value).css('text-align','right');pivotFound=true;colspan=1;last_td=td;last_value=value;}
else if(last_td){$(last_td).attr('colspan',++colspan).css('text-align','center');}}catch(e){if(headerCell){var td=trHeader.appendChild(headerCell);$(td).css({'background-color':'transparent','border':'0px'});}}}
if(!pivotFound){tHead.deleteRow(headerIndex);break;}}
for(var r=0;r<getRowCount();r++){var row=getRow(r);var indent=getRowAttribute(r,"indent")?getRowAttribute(r,"indent"):0;row.setAttribute("indent",indent);var expanded=treeTable&&row.id in treeTable.expandedRowIds?treeTable.expandedRowIds[row.id]:(indent<1);if(getRowAttribute(r,"is_leaf")==0)row.setAttribute("expanded",expanded?'1':'');}
$(table).addClass("treetable");treeTable=new TreeTable(table,firstColumnIsIndex?1:0);treeTable.rowToggled=function(row){self.renderChart();};$(table).find('th').css('padding','1px 1px 0px 0px').css('background-clip','content-box').each(function(){if($(this).html()!='')$(this).html($('<div>').attr('title',$(this).attr('title')).css('padding','6px').append($(this).contents())).attr('title','');});}},tableLoaded:function()
{with(this){ignoreLastRow=getRowCount()>1&&(getRowId(getRowCount()-1)=='total');if(getColumnIndex(sortedColumnName)<0)sortedColumnName=-1;if(pieColumnIndex>=0&&(pieColumnIndex>=getColumnCount()||getColumnName(pieColumnIndex)!=pieColumnName)){pieColumnIndex=-1;pieColumnName=null;}
if(hasColumn("label"))setCellRenderer("label",new CellRenderer({render:function(cell,label){$(cell).html(label);if(this.editablegrid.getRowAttribute(cell.rowIndex,'is_total')==1)$(cell).parent().addClass('row_total').addClass('level_'+this.editablegrid.getRowAttribute(cell.rowIndex,'indent'));var rowId=this.editablegrid.getRowId(cell.rowIndex);if(rowId=='total')$(cell).parent().addClass('row_total').addClass('last');if(rowId=='dummy')$(cell).addClass('row_dummy');$(cell).css('white-space','nowrap');if(cell.toggleLink)cell.insertBefore(cell.toggleLink,cell.firstChild);}}));if(hasColumn("label"))setCellEditor("label",new TextCellEditor(null,null,{displayEditor:function(element,htmlInput){TextCellEditor.prototype.displayEditor.call(this,element,htmlInput);htmlInput.style.left=(parseInt(htmlInput.style.left)+20)+'px';htmlInput.style.width=(parseInt(htmlInput.style.width)-20)+'px';}}));for(var c=0;c<getColumnCount();c++){columns[c].jsonLabel=columns[c].label;setHeaderRenderer(c,new PieHeaderRenderer());var config={originalRenderer:getColumn(c).cellRenderer,render:getColumn(c).cellRenderer.render,getDisplayValue:function(rowIndex,value){var sort_under=this.editablegrid.getRowAttribute(rowIndex,'sort_under');sort_under=sort_under?this.editablegrid.getRowIndex(sort_under):-1;return sort_under<0?value:this.editablegrid.getValueAt(sort_under,this.column.columnIndex);}};if(columns[c].name=='total'||columns[c].name.endsWith(':total'))config.render=function(cell,value){this.originalRenderer.render(cell,value);$(cell).addClass('col_total');};setCellRenderer(c,new CellRenderer(config));}
render();DefaultScreen.prototype.show();}},tableSorted:function(){this.renderChart();},modelChanged:function(){this.sort();}});}};GraphAccordion.prototype.addCategory=function(category,charts)
{if(charts.length==0)return false;category.charts=[];for(var i=0;i<charts.length;i++){if(charts[i]){charts[i].parameters=charts[i].parameters||{};charts[i].parameters_base=clone(charts[i].parameters);category.charts.push(charts[i]);}}
this.categories.push(category);};GraphAccordion.prototype.exportCurrentChart=function(event,format)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$("#"+format+"_form").attr('target',event.ctrlKey||event.metaKey?'_blank':'report_'+format);else $("#"+format+"_form").removeAttr('target');if(format=='pdf')$("#"+format+"_form [name=image_data]").val($('#reportchart').is(':hidden')||typeof $('#reportchart').highcharts()=='undefined'?null:$('#reportchart').highcharts().getSVGForExport());if(format=='pdf'||format=='xls')$("#"+format+"_form [name=grid_data]").val($('#reportgrid').is(':hidden')?null:$.toJSON(this.grid.data));$("#"+format+"_form [name=request]").val($.toJSON(this.currentChart));$("#"+format+"_form").submit();};GraphAccordion.prototype.start=function()
{var href=$('select.go-report optgroup option').attr('value');if(href)router.navigate(href,{trigger:true,replace:true});else DefaultScreen.prototype.show();};GraphAccordion.prototype.updateCurrentChartParameters=function(formOnly,resetParameters)
{showWait(formOnly?translate("Updating..."):translate("Updating chart..."));var dateError=false;if(resetParameters)this.currentChart.parameters=clone(this.currentChart.parameters_base);else{$('#reportform').populateParameters(this.currentChart.parameters);$("#reportform .datepicker").each(function(){if($(this).val()=='')graphAccordion.currentChart.parameters[this.name]=null;else{var date=graphAccordion.grid.checkDate($(this).val());if(!date.dbDate){alert(translate("Please enter the dates as")+" "+translate(locale['date_format_jquery']));dateError=true;return false;}
else graphAccordion.currentChart.parameters[this.name]=date.dbDate;}});}
if(!dateError){this.currentChart.parametersHaveBeenSet=true;$('#reportform').find('input, select').attr('disabled',true);var url_parameters={};for(var p in this.currentChart.parameters)if($.inArray(p,['title','description',''])<0)url_parameters[p]=this.toUrlValue(this.currentChart.parameters[p]);router.navigate('/report/'+this.currentChart.category+'/'+this.currentChart.id+(resetParameters?'':'/'+encodeURIComponent($.toJSON(url_parameters))),{trigger:false,replace:false});this._updateChart(formOnly,resetParameters,true);}
else DefaultScreen.prototype.show();};GraphAccordion.prototype.fromUrlValue=function(urlValue)
{if(urlValue&&typeof urlValue.replace!='undefined')return urlValue.replace('__SLASH__','/');return urlValue;};GraphAccordion.prototype.toUrlValue=function(value)
{if(value&&typeof value.replace!='undefined')return value.replace('/','__SLASH__');return value;};GraphAccordion.prototype.switchTo=function(category,id,parameters)
{for(var index=0;index<this.categories.length;index++){for(var c_index=0;c_index<this.categories[index].charts.length;c_index++){var chart=this.categories[index].charts[c_index];if(chart.category==category&&chart.id==id){showWait(translate("Loading chart..."));if(parameters){for(var key in parameters)chart.parameters[key]=this.fromUrlValue(parameters[key]);chart.parametersHaveBeenSet=true;}
this.currentChart=chart;return this._updateChart(false,false,false);}}}
this.start();};GraphAccordion.prototype._updateChart=function(formOnly,resetParameters,saveParameters)
{var self=this;if(ui.get('auto_refresh')&&formOnly===true)formOnly=false;this.currentChart.reset_parameters=resetParameters||false;this.currentChart.form_only=formOnly||false;this.currentChart.use_saved_parameters=!this.currentChart.parametersHaveBeenSet;this.currentChart.save_parameters=saveParameters;ajax('/report/getreport',this.currentChart,function(response){self.currentDescription=response.description;var bookmark_buttons="<a style='margin-left:10px' class='button add' style='font-size:0.75em' onclick='graphAccordion.showAddBookmark(true)'><i class='fa fa-bookmark'></i> "+translate('Add bookmark')+"</a>";var bookmark_id=self.currentChart.parameters['bookmark'];if(bookmark_id&&ui.get('bookmarks.bookmark_'+bookmark_id)&&(id_logged_user==1||ui.get('bookmarks.bookmark_'+bookmark_id+'.owned'))){bookmark_buttons+="<a style='margin-left:10px' class='button blue' style='font-size:0.75em' title='"+translate('Update bookmark')+"' onclick='graphAccordion.showAddBookmark()'><i class='fa fa-save'></i> "+translate('Update')+"</a>";bookmark_buttons+="<a style='margin-left:10px' class='button delete' style='font-size:0.75em' title='"+translate('Delete bookmark')+"' onclick='graphAccordion.deleteBookmark()'><i class='fa fa-remove'></i> "+translate('Delete')+"</a>";}
$('.boxcontent.reports h1:first').html(ui.get('bookmarks.bookmark_'+bookmark_id+'.label')||response.description);document.title=strip_tags($('.boxcontent.reports h1:first').text());$('.boxcontent.reports h1:first').siblings('i.fa').remove();if(helpbox('report_'+self.currentChart.id)){ui.set('current_report_id',self.currentChart.id);$('.boxcontent.reports h1:first').after("<i style='margin-left: 10px;cursor: pointer;font-size: 1.6em' class='fa fa-life-ring'></i>");$('.boxcontent.reports .fa-life-ring').click(function(){$(".helpbox.report").fadeIn('fast');});}
$('.actionbar.reports .actions').html("<a class='button blue' onclick='graphAccordion.updateCurrentChartParameters()'><i class='fa fa-refresh'></i> "+translate('Refresh')+"</a>"+
bookmark_buttons+
(isAllowed('reports','export')?"<a style='margin-left:20px; margin-right:15px' onclick='graphAccordion.exportCurrentChart(event, \"xls\")'><img src='"+skinUrl+"/images/export_icons/xls.png' /></a>":"")+
(isAllowed('reports','export')?"<a style='margin-right:15px' onclick='graphAccordion.exportCurrentChart(event, \"pdf\")'><img src='"+skinUrl+"/images/export_icons/pdf.png' /></a>":"")+
(isAllowed('reports','export')?"<a onclick='graphAccordion.exportCurrentChart(event, \"csv\")'><img tooltip='"+translate("Raw data")+"' src='"+skinUrl+"/images/export_icons/csv.png' /></a>":""));$('#reportform').html(response.form);graphAccordion.grid.enableSort=true;if(formOnly){if(formOnly===true){$('p.chart_outofdate').remove();$('#reportgrid').before("<p class='chart_outofdate' style='text-align:center;margin-bottom:25px'><a class='button blue' onclick='graphAccordion.updateCurrentChartParameters()'><i class='fa fa-refresh'></i>"+translate('Chart data must be refreshed...')+"</a></p>");}
DefaultScreen.prototype.show();}
else{$('p.chart_outofdate').remove();if(response.html){$('#reportgrid').html(response.html);$('#reportchart').html('').css('min-height','0px').css('margin-top','0px');DefaultScreen.prototype.show();}
else if(response.grid){$('#reportchart').css('min-height','').css('margin-top','');graphAccordion.grid.load(response.grid);graphAccordion.grid.tableLoaded();}}
$('#reportform form').submit(function(){return false;});$('#reportform input[type=text]').change(function(){graphAccordion.updateCurrentChartParameters(true);});$('#reportform input[type=checkbox]').click(function(){graphAccordion.updateCurrentChartParameters(true);});$('#reportform a.reset_form').click(function(){graphAccordion.updateCurrentChartParameters(true,true);});$('#reportform a.bookmark_form').click(function(){graphAccordion.showAddBookmark();});var is_hidden=$('#reportform').is(':hidden');if(is_hidden)$('#reportform').show();if(config.ui.report_select_multiple=='multiselect')$('#reportform select[multiple]').each(function(){$(this).multiselect({height:'auto',multiple:true,header:true,minWidth:250,noneSelectedText:translate('OPTION[all]'),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText("",true)});}).on('multiselectclose',function(){graphAccordion.updateCurrentChartParameters(true);});else $('#reportform select[multiple]').each(function(){$(this).select2({placeholder:translate("OPTION[all]"),allowClear:true,width:300,dropdownAutoWidth:true,closeOnSelect:false}).on('select2:close',function(){graphAccordion.updateCurrentChartParameters(true);});if($(this).closest("td.display").size()>0||$(this).attr('name')=='groupkey[]'||$(this).attr('name')=='pivotkey[]'||$(this).attr('name')=='valuekey[]')$(this).select2Sortable({bindOrder:'sortableStop',sortableOptions:{'stop':function(){graphAccordion.updateCurrentChartParameters(true);}}});});if(config.ui.report_select_single=='multiselect')$('#reportform select:not([multiple])').each(function(){$(this).multiselect({height:'auto',multiple:false,header:false,minWidth:250,noneSelectedText:'',uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText("",true)});}).on('multiselectclose',function(){graphAccordion.updateCurrentChartParameters(true);});else $('#reportform select:not([multiple])').each(function(){$(this).select2({width:300,dropdownAutoWidth:true,minimumResultsForSearch:$(this).attr('name').startsWith('max')?-1:10});}).on('change',function(){graphAccordion.updateCurrentChartParameters(true);});;$("#reportform .datepicker").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,changeYear:true,onSelect:function(dateText,inst){graphAccordion.updateCurrentChartParameters(true);}});if(is_hidden)$('#reportform').hide();},'json');};GraphAccordion.prototype.showAddBookmark=function(forceCreate)
{ui.set('add_bookmark_force_create',forceCreate);var bookmark_id=forceCreate?null:this.currentChart.parameters['bookmark'];$('div.add_bookmark input[name=label]').val(ui.get('bookmarks.bookmark_'+bookmark_id+'.label')||this.currentDescription);$('div.add_bookmark input[name=is_public]').attr('checked',!bookmark_id?true:ui.get('bookmarks.bookmark_'+bookmark_id+'.is_public')==1);$('div.add_bookmark').dialog('option','title',ui.get('bookmarks.bookmark_'+bookmark_id)?translate("Update bookmark"):translate("Add bookmark"));$('div.add_bookmark').dialog('open');};GraphAccordion.prototype.addBookmark=function()
{var self=this;var bookmark_id=this.currentChart.parameters['bookmark'];showWait(ui.get('bookmarks.bookmark_'+bookmark_id)?translate("Updating bookmark..."):translate("Adding bookmark..."));_ajax('report/bookmark',{id:(ui.get('bookmarks.bookmark_'+bookmark_id)&&!ui.get('add_bookmark_force_create')?bookmark_id:null),label:$('div.add_bookmark input[name=label]').val(),is_public:$('div.add_bookmark input[name=is_public]').is(':checked'),chart:this.currentChart}).done(function(response){self.refresh().done(function(){self.currentChart.parameters['bookmark']=response;self.updateCurrentChartParameters(2);});});ui.set('add_bookmark_force_create',null);};GraphAccordion.prototype.deleteBookmark=function()
{var self=this;if(confirm(translate("Are you sure you want to delete this bookmark ?"))){showWait(translate("Deleting bookmark..."));_ajax('report/deletebookmark',{id:self.currentChart.parameters['bookmark']}).done(function(response){self.refresh().done(function(){delete self.currentChart.parameters['bookmark'];self.updateCurrentChartParameters(2);});});}};;function GraphToggle(graphs)
{this.graphs=[];for(var i=0;i<graphs.length;i++)if(graphs[i])this.graphs.push(graphs[i]);this.graph_active=-1;this.grid=new TimetrackEditableGrid("ReportGrid",{serverSide:false,actionbar:null,statusbar:null,getColumnLabel:function(columnIndexOrName)
{var column=this.getColumn(columnIndexOrName);try{var arr=$.parseJSON(column.jsonLabel);if(arr&&typeof arr.length!='undefined')return arr.join(' / ');}
catch(e){}
return column.label;},tableLoaded:function(){with(this){for(var c=0;c<getColumnCount();c++)columns[c].jsonLabel=columns[c].label;ignoreLastRow=getRowCount()>1&&(getRowId(getRowCount()-1)=='total');var dstDiv='grid'+(graphToggle.graph_active+1);var gcategory=graphToggle.graphs[graphToggle.graph_active].category;if(gcategory=='customer'||gcategory=='supplier'){if(!renderPieChart(dstDiv,'',1,0,{startAngle:35,gradientFill:false}))$('#'+dstDiv).html("<center><i>"+translate("There is nothing to display!")+"</i></center>");}
else renderBarChart(dstDiv,'',0,{bar3d:false,legend:getColumnLabel(0).replace(/\*/,''),noDataMessage:translate("No data to display")});}}});this.toggleGraph();$("#graph_toggle").click(function(event){event.preventDefault();graphToggle.toggleGraph();return false;});};GraphToggle.prototype.showActiveGraph=function()
{with(this)if(typeof graphs[graph_active]!='undefined'){showWait(translate("Loading chart..."));ajax('/report/getreport',graphs[graph_active],function(response){graphToggle.update();var graphNo=graphToggle.graph_active+1;$('#graph'+graphNo).html('<div id="grid'+graphNo+'" style="height:300px"></div>');$('#graph_title').html(graphToggle.graphs[graph_active].title=response.title);graphToggle.grid.load(response.grid);graphToggle.grid.tableLoaded();hideWait();},"json");}};GraphToggle.prototype.toggleGraph=function()
{this.graph_active=(this.graph_active+1)%this.graphs.length;if(!$('#graph'+(this.graph_active+1)).data('done'))this.showActiveGraph();else this.update();};GraphToggle.prototype.update=function()
{with(this){for(var i=1;i<=graphs.length;i++)$('#graph'+i).css('display','none');var graph=$('#graph'+(graph_active+1));graph.css('display','');$('#graph_title').html(graphs[graph_active].title);$('#graph_index').html((graph_active+1)+'/'+graphs.length);graph.data('done',true);}};;function InvoiceModule(patterns){this.patterns=patterns||false;}
InvoiceModule.prototype=new DefaultScreen();InvoiceModule.prototype.init=function()
{invoiceModule=this;this._focusTabbable_bkp=$.ui.dialog.prototype._focusTabbable;$.ui.dialog.prototype._focusTabbable=function(){};var self=this;$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.team_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose teams")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Teams"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});$('.type_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose types")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Types"))}).on('multiselectclose',function(){ui.set('parameters.id_types',$(this).val()||[]);self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$("select[name=show_value]").dropkick({width:100,change:function(value,label){self.grid.refresh();}});this.grid=new InvoiceGrid(this.patterns?"RecurrentInvoiceGrid":"InvoiceGrid",{patterns:this.patterns,updatecellaction:(this.patterns?'updatepatterncell':'updatecell'),noResult:(this.patterns?translate('No recurring invoice found'):translate('No invoice found')),noResultMatchingFilter:(this.patterns?translate('No recurring invoice found matching your search criteria'):translate('No invoice found matching your search criteria')),getParameters:function(){var parameter=InvoiceGrid.prototype.getParameters.call(this);parameter.id_users=$('.user_select').size()==0?null:($('.user_select').val()||[]);parameter.id_teams=$('.team_select').size()==0?null:($('.team_select').val()||[]);parameter.id_statuses=ui.get('parameters.id_statuses');parameter.id_tags=$('.tag_select').val()||[];parameter.id_types=$('.type_select').val()||[];parameter.from=$('.searchfield.from').val();parameter.to=$('.searchfield.to').val();parameter.show_value=$('[name=show_value]').val();localset(this.name+'DateFrom',parameter.from);localset(this.name+'DateTo',parameter.to);ui.set('parameters.show_value',parameter.show_value);return parameter;}});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$('.stringfilter > .searchfield').autocomplete({source:baseUrl+'/customer/listcustomername',select:function(event,ui){self.grid.filter(ui.item.value);}});ui.on('create-invoice',function(event,invoice_type){self.createFromScratch(invoice_type);});$('#export_overlay').on('click','a[format=bob], a[format=winbooksonweb], a[format=winbooksclassic], a[format=jvsoft], a[format=clogic]',function(){setTimeout(function(){self.grid.refreshGrid();},2000);});$("select.smartselect").select2({width:450,placeholder:translate("select a customer")});};InvoiceModule.prototype.createFromScratch=function(invoice_type)
{var self=this;showWait(translate("Creating")+"...");ajax('/invoice/createfromscratch',{invoice_type:invoice_type,repeat_mode:this.patterns?4:0},function(response){if(response=="error"){hideWait();jerror("An error occured while creating the invoice");}
else router.navigate('/invoice/'+(self.patterns?'recurrent/':'')+response,true);},"json");return true;};InvoiceModule.prototype.dispose=function()
{$.ui.dialog.prototype._focusTabbable=this._focusTabbable_bkp;};function InvoiceIndex(){};InvoiceIndex.prototype=new InvoiceModule(false);function InvoiceRecurrent(){};InvoiceRecurrent.prototype=new InvoiceModule(true);;function InvoiceAdd(){};InvoiceAdd.prototype=new DefaultScreen();InvoiceAdd.prototype.init=function()
{var self=this;this.additionalTrackerIds=[];this.additionalUserIds=[];ui.on({'create-invoices':function(){self.createInvoices();},'create-advance-invoices':function(){self.createAdvanceInvoices();},'list-invoiceable':function(event){self.listInvoiceable(event);}});trackerSelector=new TrackerSelector({filterDirty:false,showTrackerAction:'/invoice/showtrackers',getSelectedUsers:function(){return $('.actionbar.filters .user_select').size()==0?null:($('.actionbar.filters .user_select').val()||[]);},getTimeInterval:function(){var interval=TrackerSelector.prototype.getTimeInterval.call(this);if(!interval)return interval;interval.options={filter:self.dummyGrid._getFilter(),id_owners:($('.actionbar.filters .owner_select').size()==0?null:($('.actionbar.filters .owner_select').val()||[])),id_statuses:($('.actionbar.filters .status_select').size()==0?null:($('.actionbar.filters .status_select').val()||[])),show_all_trackers:!$('input.active_trackers').is(':checked')};return interval;},reload:function(restoreSelection,additionalTrackerIds,additionalUserIds,after){this.filterDirty=false;return TrackerSelector.prototype.reload.call(this,restoreSelection,additionalTrackerIds,additionalUserIds,after);},renderUsers:function(result){if(result){var activeTabId=$('#tabs .ui-tabs-panel:eq('+$('#tabs').tabs('option','active')+')').attr('id');if(activeTabId=="tabs-review")reviewGrid.refresh();else reviewGrid.dirty=true;if(activeTabId=="tabs-review-items")reviewItemsGrid.refresh();else reviewItemsGrid.dirty=true;if(activeTabId=="tabs-review-costs")reviewCostsGrid.refresh();else reviewCostsGrid.dirty=true;self.trackers_actionbar.set('user_select',{options:result.users,values:result.selectedUsers});$('.actionbar.filters .user_select').multiselect('refresh');self.dummyGrid.updateAutoTags();$('.actionbar.filters').show();}},renderText:function(node,info,trackerText){if(info&&info.has_amount)trackerText+=' : '+'<span class="'+info.color+'">'+info.amount+'</span>';if(info&&info.has_duration)trackerText+=' ('+info.duration+')';if(info&&info.worked)trackerText+=" <a class='selector_attach' onClick='router.screen_controller.cancelBlocks(this, "+node.id+")'>"+img('selector_attach',translate("Cancel these entries for invoicing"))+'</a>';if(node.delayed)trackerText+=" <a class='selector_delayed'>"+img('selector_delayed',null)+'</a>';return trackerText;},renderTooltip:function(node,info,tooltip){if(node.delayed){if(tooltip!='')tooltip+='<hr>';tooltip+=img('selector_delayed',null)+" <i>"+translate("This tracker has delayed entries")+"</i>";}
if(info){if(info.usernames){if(tooltip!='')tooltip+='<hr>';tooltip+="<p>"+translate('Timesheet')+': <b>'+info.duration+'</b></p>';tooltip+="<p>"+translate('Users')+': '+(info.usernames?'<b>'+info.usernames+'</b>':'n/a')+'</p>';}
if(info.has_timesheet||info.has_items||info.has_refund||info.has_costs){if(tooltip!='')tooltip+='<hr>';if(info.has_timesheet)tooltip+="<p>"+translate('Invoiceable time')+': <b>'+info.amount_timesheet+'</b></p>';if(info.has_items)tooltip+="<p>"+translate('Invoiceable items')+': <b>'+info.amount_items+'</b></p>';if(info.has_costs)tooltip+="<p>"+translate('Invoiceable costs')+': <b>'+info.amount_costs+'</b></p>';if(info.has_refund)tooltip+="<p>"+translate('Advance refund')+': <b>'+info.amount_refund+'</b></p>';}
if(info.has_purchases)tooltip+=translate('Purchases')+': '+info.costs+'<br/>';if(tooltip!='')tooltip+='<hr>';tooltip+=translate('Gross margin')+': '+info.gross_margin+'<br/>';if(info.performance!==null){tooltip+=translate('Theoretical amount')+': '+info.amount_theo+'<br/>';tooltip+=translate('Performance')+': '+(info.performance==null?'n/a':'<b><span class="'+info.color+'">'+info.performance+'</span></b>')+'<br/>';}}
return tooltip;}});reviewGrid=new TimesheetGrid("ReviewGrid",{actionbar:null,statusbar:null,container_id:"tablecontent"});reviewItemsGrid=new ItemEntryGrid("ReviewItemsGrid",{actionbar:null,statusbar:null,container_id:"tablecontent-items"});reviewCostsGrid=new CostEntryGrid("ReviewCostsGrid",{actionbar:null,statusbar:null,container_id:"tablecontent-costs"});reviewGrid.getParameters=reviewItemsGrid.getParameters=reviewCostsGrid.getParameters=function(){var trackerIds=trackerSelector.getSelectedTrackers().concat(self.additionalTrackerIds);var userIds=trackerSelector.getSelectedUsers();if(userIds!==null)userIds=userIds.concat(self.additionalUserIds);var interval=trackerSelector.getTimeInterval();return{start:interval.start,end:interval.end,trackerIds:trackerIds,userIds:userIds,uninvoiced_only:true};};reviewGrid.onChange=reviewItemsGrid.onChange=reviewCostsGrid.onChange=function(){trackerSelector.dirty=true;reviewGrid.dirty=true;reviewItemsGrid.dirty=true;reviewCostsGrid.dirty=true;this.dirty=false;};reviewGrid.mustReload=function(rowIndex,columnIndex){if(this.getColumnName(columnIndex)=='id_customer_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));if(this.getColumnName(columnIndex)=='id_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));if(this.getColumnName(columnIndex)=='id_user')self.additionalUserIds.push(this.getValueAt(rowIndex,columnIndex));return TimesheetGrid.prototype.mustReload.call(this,rowIndex,columnIndex);};reviewItemsGrid.mustReload=function(rowIndex,columnIndex){if(this.getColumnName(columnIndex)=='id_customer_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));if(this.getColumnName(columnIndex)=='id_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));if(this.getColumnName(columnIndex)=='id_user')self.additionalUserIds.push(this.getValueAt(rowIndex,columnIndex));return ItemEntryGrid.prototype.mustReload.call(this,rowIndex,columnIndex);};reviewCostsGrid.mustReload=function(rowIndex,columnIndex){if(this.getColumnName(columnIndex)=='id_customer_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));if(this.getColumnName(columnIndex)=='id_tracker')self.additionalTrackerIds.push(this.getValueAt(rowIndex,columnIndex));return CostEntryGrid.prototype.mustReload.call(this,rowIndex,columnIndex);};trackerSelector.dirty=false;reviewGrid.dirty=false;reviewItemsGrid.dirty=false;reviewCostsGrid.dirty=false;trackerSelector.setCheckbox=function(image,checked)
{TrackerSelector.prototype.setCheckbox.call(this,image,checked);reviewGrid.dirty=true;reviewItemsGrid.dirty=true;reviewCostsGrid.dirty=true;};$(".boxcontent").append($('<form>').attr({'id':'export_invoiceable_form','method':'POST','action':baseUrl+'/invoice/invoiceable'}).append($('<input>').attr({'type':'hidden','name':'request'})));this.updateSelector();};InvoiceAdd.prototype.updateSelector=function(interval)
{var self=this;ajax('/invoice/updateselector',interval||{},function(result){$("#selector_calendar_content").html(result.content);$("#tabs").tabs();$("#tabs").on("tabsbeforeactivate",function(event,ui){if(ui.newPanel.attr('id')=="tabs-review"&&reviewGrid.dirty){reviewGrid.fetch();reviewGrid.dirty=false;}
if(ui.newPanel.attr('id')=="tabs-review-items"&&reviewItemsGrid.dirty){reviewItemsGrid.fetch();reviewItemsGrid.dirty=false;}
if(ui.newPanel.attr('id')=="tabs-review-costs"&&reviewCostsGrid.dirty){reviewCostsGrid.fetch();reviewCostsGrid.dirty=false;}
if(ui.newPanel.attr('id')=="tabs-selector"&&trackerSelector.dirty){var _reviewGrid_dirty=reviewGrid.dirty;var _reviewItemsGrid_dirty=reviewItemsGrid.dirty;var _reviewCostsGrid_dirty=reviewCostsGrid.dirty;trackerSelector.reload(true,self.additionalTrackerIds,self.additionalUserIds,function(){reviewGrid.dirty=_reviewGrid_dirty;reviewItemsGrid.dirty=_reviewItemsGrid_dirty;reviewCostsGrid.dirty=_reviewCostsGrid_dirty;});trackerSelector.dirty=false;self.additionalTrackerIds=[];self.additionalUserIds=[];}});if(self.items_actionbar)self.items_actionbar.teardown();self.items_actionbar=$('.actionbar.items').ractive({path:'invoice_add_selector_item_entry_actionbar.ractive'}).instance();ui.observe('rows_checked',function(){self.items_actionbar.set('rows_checked',ui.get('rows_checked'));});self.items_actionbar.on('toggle-filter clear-filter',function(){ui.fire(this.event.name,this.event);});if(self.costs_actionbar)self.costs_actionbar.teardown();self.costs_actionbar=$('.actionbar.costs').ractive({path:'invoice_add_selector_cost_entry_actionbar.ractive'}).instance();ui.observe('rows_checked',function(){self.costs_actionbar.set('rows_checked',ui.get('rows_checked'));});self.costs_actionbar.on('toggle-filter clear-filter',function(){ui.fire(this.event.name,this.event);});reviewGrid.bind($('#tabs-review .actionbar'),$('#tabs-review .statusbar'));reviewItemsGrid.bind($('#tabs-review-items .actionbar'),$('#tabs-review-items .statusbar'));reviewCostsGrid.bind($('#tabs-review-costs .actionbar'),$('#tabs-review-costs .statusbar'));if(self.trackers_actionbar)self.trackers_actionbar.teardown();self.trackers_actionbar=$('.actionbar.filters').hide().ractive({path:'invoice_add_selector_actionbar.ractive',data:{owner_select:ui.get('owner_select'),status_select:ui.get('status_select'),active_trackers:true}}).instance();self.trackers_actionbar.on('toggle-filter clear-filter',function(){ui.fire(this.event.name,this.event);});$('.actionbar.filters .owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.dummyGrid.filter();});$('.actionbar.filters .user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.dummyGrid.filter();});$('.actionbar.filters .status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.dummyGrid.filter();});self.dummyGrid=new TimetrackEditableGrid("DummyInvoiceAddGrid",{actionbar:null,statusbar:null,serverSide:false,filter:function(filter,cols){if(!trackerSelector.block)return false;this.updateAutoTags();trackerSelector.reload(false);},fetch:function(filter,cols){this.updateAutoTags();trackerSelector.reload(false);},refresh:function(){this.updateAutoTags();trackerSelector.reload(false);}});self.dummyGrid.currentFilter=ui.get('default_filter');self.dummyGrid.bind($('#tabs-selector .actionbar'));self.dummyGrid.updateAutoTags();$('input.active_trackers').on('click',function(){trackerSelector.reload(false);});if(!result.nothingmatching)trackerSelector.apply(_$(result.ts_start),_$(result.ts_end));},"json");reviewGrid.dirty=true;reviewItemsGrid.dirty=true;reviewCostsGrid.dirty=true;};InvoiceAdd.prototype.uncancelBlocks=function(link)
{ajax('/invoice/uncancel',{blockIds:link.canceled_blocks},function(response){if(response){delete link.canceled_blocks;$(link).parent().css('text-decoration','').end().siblings('img').css('cursor','pointer').each(function(){$(this).attr('onClick',$(this).attr('onClick_backup'));if(Math.floor($(this).attr("img_checked"))==0)$(this).trigger('click');}).attr('onClick_backup','').end().html(img('selector_attach',translate("Cancel these entries for invoicing"))).each(function(){$(this).attr('onClick',$(this).attr('onClick_backup'));}).attr('onClick_backup','');}},"json");reviewGrid.dirty=true;reviewItemsGrid.dirty=true;reviewCostsGrid.dirty=true;};InvoiceAdd.prototype.cancelBlocks=function(link,id_tracker)
{var trackerIds=[id_tracker];var userIds=trackerSelector.getSelectedUsers();var interval=trackerSelector.getTimeInterval();ajax('/invoice/cancel',{start:interval.start,end:interval.end,trackerIds:trackerIds,userIds:userIds},function(response){if(response===false){}else{link.canceled_blocks=response;$(link).parent().css('text-decoration','line-through').end().siblings('img').css('cursor','default').each(function(){if(Math.floor($(this).attr("img_checked"))==1)$(this).trigger('click');$(this).attr('onClick_backup',$(this).attr('onClick'));}).attr('onClick','').end().html(img('selector_detach',translate("Consider these entries for invoicing"))).each(function(){$(this).attr('onClick_backup',$(this).attr('onClick'));}).attr('onClick','router.screen_controller.uncancelBlocks(this)');}},"json");reviewGrid.dirty=true;reviewItemsGrid.dirty=true;reviewCostsGrid.dirty=true;};InvoiceAdd.prototype.createInvoices=function()
{var self=this;var trackerIds=trackerSelector.getSelectedTrackers().concat(this.additionalTrackerIds);var userIds=trackerSelector.getSelectedUsers();if(userIds!==null)userIds=userIds.concat(this.additionalUserIds);var interval=trackerSelector.getTimeInterval();trackerSelector.wait(translate("Creating invoices"));ajax('/invoice/create',{start:interval.start,end:interval.end,trackerIds:trackerIds,userIds:userIds},function(response){created=parseInt(response);if(created==1&&config.invoice.go_to_invoice_if_one_created==1)router.navigate('/invoice/last',true);else{feedback_message(isNaN(created)?response:(created>0?created+' '+translate("invoice(s) created"):translate("No invoice created")+'!'),isNaN(created)||created<=0?'error':'success');self.updateSelector(interval);}},"json",null,function(){self.updateSelector(interval);});};InvoiceAdd.prototype.createAdvanceInvoices=function()
{var self=this;var trackerIds=trackerSelector.getSelectedTrackers().concat(this.additionalTrackerIds);var userIds=trackerSelector.getSelectedUsers().concat(this.additionalUserIds);var interval=trackerSelector.getTimeInterval();var percent=prompt(translate("Enter the advance percentage"));if(percent<=0)return false;trackerSelector.wait(translate("Creating invoices"));ajax('/invoice/createadvance',{percent:percent,start:interval.start,end:interval.end,trackerIds:trackerIds,userIds:userIds},function(response){created=parseInt(response);if(created==1&&config.invoice.go_to_invoice_if_one_created==1)window.location.href=baseUrl+'/ui/invoice/last';else{feedback_message(isNaN(created)?response:(created>0?created+' '+translate("invoice(s) created"):translate("No invoice created")+'!'),isNaN(created)||created<=0?'error':'success');self.updateSelector(interval);}},"json",null,function(){self.updateSelector(interval);});};InvoiceAdd.prototype.listInvoiceable=function(event)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$('#export_invoiceable_form').attr('target',event.ctrlKey||event.metaKey?'_blank':'listing_invoiceable');else $('#export_invoiceable_form').removeAttr('target');var trackerIds=trackerSelector.getSelectedTrackers().concat(this.additionalTrackerIds);var userIds=trackerSelector.getSelectedUsers();if(userIds!==null)userIds=userIds.concat(this.additionalUserIds);var interval=trackerSelector.getTimeInterval();var paramObject={start:interval.start,end:interval.end,trackerIds:trackerIds,userIds:userIds};$("#export_invoiceable_form [name=request]").val($.toJSON(paramObject));$("#export_invoiceable_form").submit();};InvoiceAdd.prototype.dispose=function()
{reset_window_resize();};;function InvoiceGrid(name,config){if(name)this.init(name,config);}
InvoiceGrid.prototype=new TimetrackEditableGrid();InvoiceGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No invoice found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No invoice found matching your search criteria');config.controller='invoice';TimetrackEditableGrid.prototype.init.call(this,name,config);$('#invoice_send_to').autocomplete({source:baseUrl+'/customer/listcontactemail'});this.paymentGrid=new TimetrackEditableGrid("PaymentGrid",{controller:"invoicepayment",container_id:"invoice_history_payment_tablecontent",actionbar:false,statusbar:false,noResult:translate('No payment yet'),getParameters:function(){return{pageSize:5,id_invoice:ui.get('history.id_invoice')}},isEditable:function(){return false;},getActions:function(cell,id_payment){var actions=[];if(isAllowed('invoices','edit'))actions.push({icon:img('user_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this payment ?',true)))self.deletePayment(id_payment);}});return actions;},tableRendered:function(){TimetrackEditableGrid.prototype.tableRendered.call(this);$("#invoice_history_dialog .paginationControl .empty").addClass('small');}});$("#invoice_pattern_dialog").dialog({width:685,modal:!jQuery.browser.msie,autoOpen:false,});ui.on("add-payment",function(){self.addPayment();});ui.on("add-payment-close",function(){self.addPayment(true);});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected invoices ?',true)))self.deleteInvoice(ui.get('rows_checked'));});ui.observe('rows_checked',function(){var total_saldo_vatincl=0;var rows_checked=ui.get('rows_checked');if(rows_checked)for(var i=0;i<rows_checked.length;i++)total_saldo_vatincl+=parseFloat(self.getRowAttribute(self.getRowIndex(rows_checked[i]),"saldo_vatincl"));ui.set('total_saldo_vatincl_selected',total_saldo_vatincl);});ui.on('actionbar-quickpay',function(){jconfirm(translate("Do you want to mark selected invoices as paid today ?"),translate("Quick pay"),function(){},function(){if(ui.get('rows_checked'))_ajax('invoice/quick_pay',{ids:ui.get('rows_checked')}).done(function(){self.refresh();});});});};InvoiceGrid.prototype.getParameters=function()
{return{patterns:this.patterns};};InvoiceGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);if(response.dates&&response.dates.length>0){var message=translate('You just enabled a recurring invoice which includes some invoices in the past')+':<ul style="padding-top:5px;padding-left:25px">';for(var i=0;i<response.dates.length;i++)message+="<li>"+response.dates[i]+'</li>';message+='</ul><br/>'+translate('Do you want to create those invoices now ?');jconfirm(message,null,function(){ajax('/invoice/createinvoicesfrompattern',{id:self.getRowId(rowIndex),doCreate:false},function(response){},"json");},function(){ajax('/invoice/createinvoicesfrompattern',{id:self.getRowId(rowIndex),doCreate:true},function(response){jinfo(response.nb_created+" "+(response.nb_created>1?translate("invoices have been created"):translate("invoice has been created"))+".");},"json");},translate("No"),translate("Yes"),500);}}});};InvoiceGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('invoices','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify invoices.");return false;}
if(columnIndex==this.getColumnIndex("exported_bob"))return true;if(this.hasColumn('id_status')&&config.invoice.freeze_sent_invoices==1&&parseInt(this.getRowAttribute(rowIndex,"status_type"),10)>AppConfig.INVOICE_STATUS_READY&&columnIndex!=this.getColumnIndex("id_status")&&columnIndex!=this.getColumnIndex("id_owner")&&columnIndex!=this.getColumnIndex("id_customer_contact")&&columnIndex!=this.getColumnIndex("tags")){jinfo("The invoice cannot be modified. If you wish to modify it, set the invoice back to 'Draft' status.",null,400);return false;}
return true;};InvoiceGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_status','id_status_pattern','id_owner'])>=0;};InvoiceGrid.prototype.readonlyWarning=function(column)
{if(column.name=='amount')jinfo("The invoiced amount is not editable directly: you have to edit the invoice entries.");else if(column.name=='vat')jinfo("The VAT amount is not editable: you have to edit the invoice entries and change their VAT rate.");else if(column.name=='vatincl')jinfo("The VAT incl. amount is not editable: you have to edit the invoice entries and change their VAT rate.");};InvoiceGrid.prototype.updatePaginator=function()
{var self=this;TimetrackEditableGrid.prototype.updatePaginator.call(this);$("a.tooltip").scrolltip({content:function(){var rowIndex=self.getRowIndex(this.parentNode.parentNode);return self.getRowAttribute(rowIndex,"tooltip");}});};InvoiceGrid.prototype.getActions=function(cell,id_invoice)
{var self=this;var actions=[];var status_type=parseInt(this.getRowAttribute(cell.rowIndex,"status_type"),10);var invoice_type=this.getRowAttribute(cell.rowIndex,'invoice_type');if(!this.patterns&&isAllowed('invoices','view'))
actions.push({icon:img('invoice_payment','history',translate('Payments and history')),click:function(){self.showHistoryDialog(id_invoice,0);}});if(isAllowed('invoices','create'))
actions.push({icon:img('customer_copytracker','copy',translate('Duplicate invoice')),click:function(){self.copyInvoice(id_invoice);}});if(isAllowed('invoices','export')){var target=config.ui.open_reports_in_new_tab==1?'_blank':'';var invoice_filename=this.getRowAttribute(cell.rowIndex,'invoice_filename');actions.push({icon:img('invoice_export_pdf16','pdf',translate('Export as PDF')),href:baseUrl+'/invoice/getpdf/id/'+id_invoice+"/"+invoice_filename+'.pdf',target:target});if(locale.country=='BE')actions.push({icon:img('invoice_export_xml16','e-fff',translate('Export as E-FFFF')),href:baseUrl+'/invoice/getefff/id/'+id_invoice+"/"+invoice_filename+'.xml',target:target});}
if(!this.patterns&&isAllowed('invoices','export')){if(status_type<AppConfig.INVOICE_STATUS_SENT){if(config.invoice.generate_reference_on!='APPROVED'||status_type==AppConfig.INVOICE_STATUS_APPROVED)
actions.push({icon:img('invoice_send','send',invoice_type=='invoice'?translate('Send invoice'):translate('Send credit note')),click:function(){self.sendInvoice(invoice_type,id_invoice);}});}
else if(status_type==AppConfig.INVOICE_STATUS_SENT)actions.push({icon:img('invoice_reminder','send_reminder',translate('Send a reminder')),click:function(){self.sendInvoice(invoice_type,id_invoice,true);}});}
if(!this.patterns&&isAllowed('invoices','create')&&this.getRowAttribute(cell.rowIndex,'invoice_type')=='invoice'&&status_type>=AppConfig.INVOICE_STATUS_SENT&&status_type<AppConfig.INVOICE_STATUS_ANNULLED)
actions.push({icon:img('invoice_credit','credit',translate('Make a credit note')),click:function(){self.showCreditNoteDialog(id_invoice);}});var privilege=this.patterns||!this.getRowAttribute(cell.rowIndex,"invoice_ref_")?'delete':'delete_if_ref';if(isAllowed('invoices',privilege)&&(this.patterns||status_type<=AppConfig.INVOICE_STATUS_READY))
actions.push({icon:img('invoice_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this invoice ?',true)))self.deleteInvoice(id_invoice);}});return actions;};InvoiceGrid.prototype.tableLoaded=function()
{var self=this;if(this.hasColumn('exported_bob'))this.setHeaderRenderer('exported_bob',getInfoHeaderRenderer(translate('Checked if the invoice has already been exported to your accounting software'),translate('BOB'),480,true));if(this.hasColumn("invoice_date"))this.addCellValidator("invoice_date",new CellValidator({isValid:function(value){return trim(value)!="";}}));if(this.hasColumn("invoice_duedate"))this.addCellValidator("invoice_duedate",new CellValidator({isValid:function(value){return trim(value)!="";}}));if(this.hasColumn('invoice_ref'))this.setCellRenderer("invoice_ref",new CellRenderer({render:function(cell,invoice_ref){if(!isAllowed('invoices','view'))cell.innerHTML=invoice_ref;else cell.innerHTML="<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/invoice"+(self.patterns?'/recurrent':'')+"/"+self.getRowId(cell.rowIndex)+"/entry'>"+invoice_ref+"</a>";$(cell).css('white-space','nowrap');}}));else this.setCellRenderer("id_customer",new EnumCellRenderer({render:function(cell,value){var label=this.getLabel(cell.rowIndex,value);if(!isAllowed('invoices','view'))cell.innerHTML=label?truncate(label,40):"";else cell.innerHTML=label?"<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/invoice"+(self.patterns?'/recurrent':'')+"/"+self.getRowId(cell.rowIndex)+"'>"+truncate(label,40)+"</a>":"";}}));if(this.hasColumn('description'))this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('img, i').css({color:(value?'black':'#ccc'),'font-size':'.95em'});}}));if(this.hasColumn('description'))this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:true,getDialogTitle:function(cell,value){var label=self.getValueAt(cell.rowIndex,self.hasColumn('invoice_ref')?self.getColumnIndex('invoice_ref'):self.getColumnIndex('customer_ref'));return translate("Description")+(label?" : "+label:'');}}));if(this.hasColumn('id_customer_contact'))this.setEnumProvider('id_customer_contact',new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var values=null;syncAjax('/customer/getcontacts',{id_customer:self.getValueAt(rowIndex,self.getColumnIndex('id_customer'))},function(response){values=response;},'json');return values;}}));if(!this.patterns&&this.hasColumn('id_status'))this.setEnumProvider('id_status',new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var values=null;syncAjax('/invoice/getstatuses',{id:self.getRowId(rowIndex)},function(response){values=response;},'json');return values;}}));this.setCellRenderer("amount",new CellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).css('font-weight',ui.get('parameters.show_value')=='amount'?'bold':'');if(!self.hasColumn("gross_margin")){var gross_margin_performance=self.getRowAttribute(cell.rowIndex,"gross_margin_performance");var amount_theo=self.getRowAttribute(cell.rowIndex,"amount_theo");var performance=(gross_margin_performance/amount_theo)*100;var color='';if(!self.patterns){$(cell).removeClass('green').removeClass('blue').removeClass('red').removeClass('orange');$(cell).addClass(color=get_performance_class(performance));}
cell.title='';if(amount_theo&&amount_theo!=0){var amount_theo_formatted=self.getRowAttribute(cell.rowIndex,"amount_theo_formatted");cell.title+=translate('Theoretical amount')+': '+amount_theo_formatted+'<br/>';cell.title+=translate('Performance')+' : <span class="'+color+'">'+performance.toFixed(2)+" %</span>";}}}}));this.setCellRenderer("vatincl",new CellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).css('font-weight',ui.get('parameters.show_value')=='vatincl'||ui.get('parameters.show_value')=='saldo_vatincl'?'bold':'');var paid_amount=self.getRowAttribute(cell.rowIndex,"paid_amount");var vatincl=self.getRowAttribute(cell.rowIndex,"vatincl");var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);if(paid_amount>0&&parseFloat(paid_amount)!=parseFloat(vatincl)){var paid_amount_formatted=self.getRowAttribute(cell.rowIndex,"paid_amount_formatted");var tooltip=translate('Paid amount (VAT included)')+': '+paid_amount_formatted;var vatincl=self.getValueAt(cell.rowIndex,self.getColumnIndex("vatincl"));var color=parseFloat(paid_amount)<parseFloat(vatincl)?"orange":(paid_amount>vatincl?"green":"black");var currency=locale.currency=='EUR'?'euro':'dollar';var icon='<span class="fa fa-stack '+color+'"><i class="fa fa-circle-o fa-stack-2x"></i><i class="fa fa-'+currency+' fa-stack-1x" title="'+tooltip+'"></i></span>';$(cell).append("&nbsp;"+icon);$(cell).find('i.fa').click(function(){self.showHistoryDialog(self.getRowId(cell.rowIndex),0);return false;});}}}));if(this.hasColumn("gross_margin"))this.setCellRenderer("gross_margin",new CellRenderer({render:function(cell,gross_margin){NumberCellRenderer.prototype.render.call(this,cell,gross_margin);$(cell).css('font-weight',ui.get('parameters.show_value')=='gross_margin'?'bold':'');var gross_margin_performance=self.getRowAttribute(cell.rowIndex,"gross_margin_performance");var amount_theo=self.getRowAttribute(cell.rowIndex,"amount_theo");var performance=(gross_margin_performance/amount_theo)*100;var color='';if(!self.patterns){$(cell).removeClass('green').removeClass('blue').removeClass('red').removeClass('orange');$(cell).addClass(color=get_performance_class(performance));}
cell.title='';if(amount_theo&&amount_theo!=0){var amount_theo_formatted=self.getRowAttribute(cell.rowIndex,"amount_theo_formatted");cell.title+=translate('Theoretical amount')+': '+amount_theo_formatted+'<br/>';cell.title+=translate('Performance')+' : <span class="'+color+'">'+performance.toFixed(2)+" %</span>";}}}));if(this.hasColumn('id_status'))this.setCellRenderer("id_status",new EnumCellRenderer({getLabel:function(rowIndex,value){return self.getRowAttribute(rowIndex,'status');},render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);var is_gray=status_type==AppConfig.INVOICE_STATUS_PAID||status_type==AppConfig.INVOICE_STATUS_ANNULLED;$(cell.parentNode).addClass(is_gray?"paid":"unpaid").removeClass(is_gray?"unpaid":"paid");if(color=self.getRowAttribute(cell.rowIndex,'status_color')){color=toRGB(color);$(cell).html("<span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+$(cell).html()+"</span>");}
$(cell).css('white-space','nowrap');self.setValueAt(cell.rowIndex,self.getColumnIndex("action"),self.getValueAt(cell.rowIndex,self.getColumnIndex("action")));}}));if(this.hasColumn("invoice_duedate"))this.setCellRenderer("invoice_duedate",new DateCellRenderer({render:function(cell,value){DateCellRenderer.prototype.render.call(this,cell,value);var due_delta=self.getRowAttribute(cell.rowIndex,"due_delta");$(cell).removeClass('green').removeClass('blue').removeClass('red').removeClass('orange');if(due_delta!==''){$(cell).addClass(due_delta<0?'red':'green');cell.title=due_delta<0?translate('Due date passed since %d days').replace("%d",Math.abs(due_delta)):translate('Due date in %d days').replace("%d",due_delta);}}}));if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No invoice tag was created yet. To create an invoice tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
var patternEditor=new ScheduleCellEditor("/invoice/getpatterneditor",'invoice/updatepattern')
if(this.hasColumn('dateinterval'))this.setCellEditor("dateinterval",patternEditor);if(this.hasColumn('pattern'))this.setCellEditor("pattern",patternEditor);this.render();};InvoiceGrid.prototype.deleteInvoice=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('invoice/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the invoice from database","Error");else{self.refresh();self.onChange();}});};InvoiceGrid.prototype._setInvoiceStatus=function(id,id_status)
{if(!id_status)return this.refresh(true);var rowIndex=this.getRowIndex(id);var columnIndex=this.getColumnIndex("id_status");var row=this.getRow(rowIndex);var oldValue=this.getValueAt(rowIndex,columnIndex);this.setValueAt(rowIndex,columnIndex,id_status);this.modelChanged(rowIndex,columnIndex,oldValue,id_status,row);};InvoiceGrid.prototype._sendMail=function(id)
{var self=this;showWait(translate("Sending mail")+'...');_ajax('invoice/send',{id:id,subject:$("#invoice_send_subject").val(),message:tinymce.get('invoice_send_message').getContent(),to:$("#invoice_send_to").val(),copy:$("#invoice_send_copy").is(':checked'),activity_report:($("#invoice_send_activity_report").is(':checked')?$("#invoice_send_activity_report_format").val():false),timesheet:($("#invoice_send_timesheet").is(':checked')?$("#invoice_send_timesheet_format").val():false)}).done(function(response){if(response.status!="ok")jerror(response.message);else self._setInvoiceStatus(id,response.invoice.id_status);hideWait();});};InvoiceGrid.prototype.sendInvoice=function(invoice_type,id,isReminder)
{var self=this;var subjectPrefix=isReminder?translate('REMINDER')+': ':'';var buttons={};buttons[translate('Send')]=function(){self._sendMail(id);$(this).dialog('close');};buttons[translate('Cancel')]=function(){$(this).dialog('close');};var data=null;_ajax('invoice/sendformdata',{id:id,reminder:isReminder}).done(function(data){$("#invoice_send_subject").val(subjectPrefix+data.ref_display);$("#invoice_send_to").val(data.email?data.email:'');if(data.body)$("#invoice_send_message").val(data.body);self._setInvoiceStatus(id);if(data&&data.activity_report_format){$("#invoice_send_activity_report").attr('checked',true);$("#invoice_send_activity_report_format").val(data.activity_report_format);}
else $("#invoice_send_activity_report").attr('checked',false);if(data&&data.timesheet_format){$("#invoice_send_timesheet").attr('checked',true);$("#invoice_send_timesheet_format").val(data.timesheet_format);}
else $("#invoice_send_timesheet").attr('checked',false);if(invoice_type!='invoice'){$("#invoice_send_timesheet").attr('checked',false);$("#invoice_send_activity_report").attr('checked',false);$("#invoice_send_dialog .row.report").hide();}
else $("#invoice_send_dialog .row.report").show();$("#invoice_send_dialog").dialog({autoOpen:true,width:700,minHeight:700,modal:!jQuery.browser.msie,resizable:false,buttons:buttons,open:function(event){tinymce.execCommand('mceAddEditor',false,'invoice_send_message');},close:function(event){tinymce.execCommand('mceRemoveEditor',false,'invoice_send_message');}});});};InvoiceGrid.prototype.copyInvoice=function(id)
{var self=this;showWait(translate("Duplicating")+"...");ajax('/invoice/copyinvoice',{id_invoice:id},function(response){hideWait();if(response=="error"){hideWait();jerror("An error occured while copying the invoice in database","Error");}
else router.navigate('/invoice/'+(self.patterns?'recurrent/':'')+response,true);},"json");};InvoiceGrid.prototype.showHistoryDialog=function(id,activeTabIndex)
{var self=this;_ajax('invoice/history',{id:id}).done(function(response){ui.observe('history.form.id_credit_note',self.applyCreditNote);ui.set('history',response);ui.set('history.id_invoice',id);ui.set('history.editable',isAllowed('invoices','edit')&&self.getRowAttribute(self.getRowIndex(id),'status_type')>=AppConfig.INVOICE_STATUS_SENT);var showPayment=self.getRowAttribute(self.getRowIndex(id),'invoice_type')=='invoice'&&self.getRowAttribute(self.getRowIndex(id),'status_type')>=AppConfig.INVOICE_STATUS_SENT;$('a[href="#invoice_history_payment"]').parent().css('display',showPayment?'':'none');var tabs=$('#invoice_history_dialog .tabs').tabs();if(typeof activeTabIndex!='undefined')tabs.tabs('option','active',activeTabIndex);if(!showPayment&&tabs.tabs('option','active')==0)tabs.tabs('option','active',1);$("#invoice_history_dialog").dialog({width:500,title:translate('History')+' - '+response.ref_display,buttons:[{text:translate('Close'),click:function(){$(this).dialog('close');}}]});$("#invoice_history_dialog input[name=paid]").focus().select();self.paymentGrid.fetch();});};InvoiceGrid.prototype.applyCreditNote=function()
{var self=this;var id_credit_note=parseInt(ui.get('history.form.id_credit_note'),10);if(id_credit_note>0){var credit_notes=ui.get('history.form.credit_notes');for(var i=0,lgth=credit_notes.length;i<lgth;i++){if(credit_notes[i].value==id_credit_note){ui.set('history.form.paid_placeholder',credit_notes[i].amount_vatincl);ui.set('history.form.paydate',credit_notes[i].date_formatted);ui.set('history.form.paid','');}}}
else ui.set('history.form.paid',ui.get('history.form.saldo'));}
InvoiceGrid.prototype.onPaymentChange=function(id_invoice,response)
{this.paymentGrid.refresh();ui.set('history.form.paid_placeholder',0);ui.set('history.form.id_credit_note','');if(response.saldo)ui.set('history.form.paid',response.saldo);if(response.history)ui.set('history.history',response.history);if(response.row)this.update(response.row);ui.set('history.editable',isAllowed('invoices','edit')&&this.getRowAttribute(this.getRowIndex(id_invoice),'status_type')>=AppConfig.INVOICE_STATUS_SENT);this.refresh(true);};InvoiceGrid.prototype.addPayment=function(close)
{var self=this;var id_invoice=ui.get('history.id_invoice');_ajax('invoice/add_payment',merge(this.getParameters(),{id:id_invoice},ui.get('history.form'))).done(function(response){self.onPaymentChange(id_invoice,response);if(close)$("#invoice_history_dialog").dialog('close');});};InvoiceGrid.prototype.deletePayment=function(id)
{var self=this;var id_invoice=ui.get('history.id_invoice');_ajax('invoice/delete_payment',merge(this.getParameters(),{id:id_invoice,id_payment:id})).done(function(response){self.onPaymentChange(id_invoice,response);});};InvoiceGrid.prototype.showCreditNoteDialog=function(id)
{var self=this;var buttons={};buttons[translate('Create')]=function(){self.makeCreditNote(id);$(this).dialog('close');};buttons[translate('Cancel')]=function(){$(this).dialog('close');};$("#invoice_credit_dialog").dialog({autoOpen:true,width:550,modal:!jQuery.browser.msie,resizable:false,buttons:buttons});};InvoiceGrid.prototype.makeCreditNote=function(id)
{var self=this;showWait(translate("Creating")+"...");ajax('/invoice/credit',{id:id},function(response){if(response=="error"){hideWait();jerror("An error occured while making the credit note");}
else router.navigate('/invoice/'+response,true);},"json");};InvoiceGrid.prototype.createFromInvoice=function(id_invoice)
{var self=this;showWait(translate("Creating")+"...");ajax('/invoice/createfrominvoice',{id_invoice:id_invoice,repeat_mode:4},function(response){if(response=="error"){hideWait();jerror("An error occured while creating the invoice");}
else router.navigate('/invoice/recurrent/'+response,true);},"json");};InvoiceGrid.prototype.repeater_select=function()
{var repeat_mode=$('input[name=repeater]:checked').val();var type='none';if(repeat_mode==3)type='week';else if(repeat_mode==4)type='month';else if(repeat_mode==5)type='year';for(_type in{any:1,week_row:1,week_row2:1,month_row:1,month_row2:1,year_row:1})_$('repeater_'+_type).style.display='none';$('#repeater_any').css('display','');$('#repeater_'+type+'_row').css('display','');$('#repeater_'+type+'_row2').css('display','');$('#label_dateinterval_from').html(translate((type=='none'?'on_date':translate('From'))));$('#dateinterval_to_zone').css('display',(type!='none')?"":"none");this.repeater_update_ui();};InvoiceGrid.prototype.repeater_update_ui=function()
{var repeat_mode=$('input[name=repeater]:checked').val();$('#repeater_week_each').attr('disabled',(repeat_mode!=3||!$('#repeater_week_each_cb').is(':checked')));$('#repeater_month_each').attr('disabled',(repeat_mode!=4||!$('#repeater_month_each_cb').is(':checked')));$('#repeater_year_each').attr('disabled',(repeat_mode!=5||!$('#repeater_year_each_cb').is(':checked')));$('#repeater_month_fixed').attr('disabled',$('#recurrence input[name=repeater_month]:checked').val()==2);$('#repeater_month_rule_1').attr('disabled',$('#recurrence input[name=repeater_month]:checked').val()==1);$('#repeater_month_rule_2').attr('disabled',$('#recurrence input[name=repeater_month]:checked').val()==1);};;function InvoiceView(){}
InvoiceView.prototype=new DefaultScreen();InvoiceView.prototype.init=function(parameter)
{var self=this;this.disposed=false;$('input[name=invoice_send_to]').autocomplete({source:baseUrl+'/customer/listcontactemail'});this.setup_autosave();this.tabControllers={'general':new InvoiceViewGeneral(),'entry':new InvoiceViewEntry(),'history':new InvoiceViewHistory(),'item_entry':new InvoiceViewItemEntry(),'timesheet_entry':new InvoiceViewTimesheetEntry(),'item_entry_timesheet':new InvoiceViewItemEntryTimesheet(),'cost_entry':new InvoiceViewCostEntry()};if(ui.get('id_invoice')==='last'||ui.get('id_block'))router.navigate('/invoice/'+ui.get('invoice.id')+'/'+ui.get('tab'),{trigger:false,replace:true});ui.on("toggle-status",function(event){$(".ui-tooltip").remove();$("#status_overlay").css('min-height',$(window).height()+'px').toggle();});ui.on('autosave-invoice',function(){self.autosave();});ui.on('set-status-invoice',function(event,id_status){self.setStatus(id_status);});ui.on('set-recurrence-status-invoice',function(event,id_status){self.setRecurrenceStatus(id_status);});ui.on('send-invoice',function(){self.sendInvoice(ui.get('invoice.invoice_type'),ui.get('invoice.id'));});ui.on('send-reminder',function(){self.sendInvoice(ui.get('invoice.invoice_type'),ui.get('invoice.id'),true);});ui.on('delete-invoice',function(){jconfirm(ui.get('invoice.invoice_type')=='credit_note'?translate("Are you sure you want to delete this credit note ?"):translate("Are you sure you want to delete this invoice ?"),null,null,function(){self.deleteInvoice();});});ui.on('copy-invoice',function(){self.copyInvoice(ui.get('invoice.id'));});ui.on('credit-invoice',function(){self.makeCreditNote(ui.get('invoice.id'));});ui.on('recurring-invoice',function(){self.createFromInvoice(ui.get('invoice.id'));});ui.on('hover-status',function(event){$(event.node).attr('style',event.hover?$(event.node).attr('style_hilite'):$(event.node).attr('style_normal'));});this.setTab(ui.get('tab'),true);};InvoiceView.prototype.setTab=function(tab,first)
{var self=this;if(!first&&ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onhide){console.info("Hiding "+ui.get('tab'));self.tabControllers[ui.get('tab')].onhide();}
menu.hilite();ui.set('tab',tab);if(ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onshow){console.info("Showing "+ui.get('tab'));self.tabControllers[ui.get('tab')].onshow();}};InvoiceView.prototype._sendMail=InvoiceGrid.prototype._sendMail;InvoiceView.prototype.sendInvoice=InvoiceGrid.prototype.sendInvoice;InvoiceView.prototype._setInvoiceStatus=function(id,id_status)
{var self=this;if(!id_status)return this.refresh();_ajax('invoice/updateview',{id:id,id_status:id_status}).done(function(response){self.autosave_observer.cancel();ui.set(response);if(ui.get('tab')=='entry')self.tabControllers['entry'].grid.fetch();self.setup_autosave();});};InvoiceView.prototype.setStatus=function(id_status)
{$(".ui-tooltip").remove();this._setInvoiceStatus(ui.get('invoice.id'),id_status);$("#status_overlay").hide();};InvoiceView.prototype.setRecurrenceStatus=function(id_status)
{var self=this;_ajax('invoice/updateview',{id:ui.get('invoice.id'),id_status_pattern:id_status}).done(function(response){self.autosave_observer.cancel();ui.set(response);self.setup_autosave();if(response.dates&&response.dates.length>0){var message=translate('You just enabled a recurring invoice which includes some invoices in the past')+':<ul style="padding-top:5px;padding-left:25px">';for(var i=0;i<response.dates.length;i++)message+="<li>"+response.dates[i]+'</li>';message+='</ul><br/>'+translate('Do you want to create those invoices now ?');jconfirm(message,null,function(){ajax('/invoice/createinvoicesfrompattern',{id:ui.get('invoice.id'),doCreate:false},function(response){},"json");},function(){ajax('/invoice/createinvoicesfrompattern',{id:ui.get('invoice.id'),doCreate:true},function(response){jinfo(response.nb_created+" "+(response.nb_created>1?translate("invoices have been created"):translate("invoice has been created"))+".");},"json");},translate("No"),translate("Yes"),500);}});};InvoiceView.prototype.setup_autosave=function()
{var self=this;if(self.disposed)return false;this.autosave_observer=ui.observe('invoice.id_customer invoice.id_customer_contact invoice.invoice_date invoice.invoice_duedate invoice.id_signer invoice.id_owner invoice.id_status invoice.description',function(newValue,oldValue,keypath){if(!oldValue&&!newValue)return false;self.autosave();},{init:false});};InvoiceView.prototype.getInvoiceData=function()
{var data={};var properties=['id','id_customer','id_customer_contact','invoice_date','invoice_duedate','invoice_ref','customer_ref','id_signer','id_owner','id_status','description'];for(var i=0;i<properties.length;i++)data[properties[i]]=ui.get('invoice.'+properties[i]);return data;};InvoiceView.prototype.autosave=function()
{var self=this;_ajax('invoice/updateview',this.getInvoiceData()).done(function(response){if(self.disposed)return false;self.autosave_observer.cancel();ui.set(response);self.setup_autosave();});};InvoiceView.prototype.deleteInvoice=function()
{showWait(translate("Deleting")+"...");_ajax('invoice/delete',{id:ui.get('invoice.id')}).done(function(){router.navigate(ui.get('invoice._invoice_date')?'/invoice/index':'/invoice/recurrent',true);});};InvoiceView.prototype.copyInvoice=function(id)
{this.patterns=ui.get('invoice._invoice_date')?false:true;InvoiceGrid.prototype.copyInvoice.call(this,id);};InvoiceView.prototype.createFromInvoice=InvoiceGrid.prototype.createFromInvoice;InvoiceView.prototype.makeCreditNote=InvoiceGrid.prototype.makeCreditNote;InvoiceView.prototype.dispose=function()
{this.disposed=true;ui.off('autosave-invoice');this.autosave_observer.cancel();for(var tab in this.tabControllers){if(this.tabControllers[tab].dispose){console.info("Disposing "+tab);this.tabControllers[tab].dispose();}}};;function InvoiceViewCostEntry(){this.init();};InvoiceViewCostEntry.prototype.init=function()
{};InvoiceViewCostEntry.prototype.onshow=function()
{var self=this;this.grid=new CostEntryGrid("InvoiceViewCostEntryGrid",{isEditable:function(rowIndex,columnIndex){return false;},getParameters:function(){return{invoiceId:ui.get('invoice.id')};}});this.grid.fetch();ui.on('actionbar-detach',function(){if(confirm(translate('Are you sure you want to detach selected costs from invoice ?',true)))self.detachCost(ui.get('rows_checked'));});};InvoiceViewCostEntry.prototype.onhide=function()
{ui.off('actionbar-detach');};InvoiceViewCostEntry.prototype.detachCost=function(id_cost_entry)
{var self=this;showWait(translate("Detaching")+"...");_ajax('cost/detach',{id:id_cost_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while detaching costs from invoice in database","Error");else{self.grid.refresh();self.grid.onChange();}});};;function InvoiceViewEntry(){this.init();}
InvoiceViewEntry.prototype.init=function()
{var self=this;};InvoiceViewEntry.prototype.createGrid=function()
{var self=this;this.grid=new TimetrackEditableGrid("InvoiceViewEntryGrid",{alternate:true,serverSide:false,noResult:translate("No entry found"),tableLoaded:function(){self.initializeGrid(this);},tableRendered:function(containerid,className,tableid){TimetrackEditableGrid.prototype.tableRendered.call(this,containerid,className,tableid);if(this.sortedColumnName==-1){var selfgrid=this;$("#tablecontent tbody").sortable({delay:150,helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index){$(this).width($originals.eq(index).width());});return $helper;},stop:function(event,ui){var id_entries_sorted=[];$(this).find('tr').each(function(){id_entries_sorted.push(selfgrid.getRowId(selfgrid.getRowIndex(this)));});ajax('/invoice/sortentries',{id_entries_sorted:id_entries_sorted},function(){selfgrid.fetch();selfgrid.onChange();});}});}},fetch:function(){this.wait();this.loadJSON(baseUrl+"/invoice/generateentryjson?id="+ui.get('invoice.id'));},isEditable:function(rowIndex,columnIndex){var interactive=this.getColumnType(columnIndex)!='boolean';var type=this.getValueAt(rowIndex,this.getColumnIndex('type'));if(!isAllowed('invoices','edit')){if(interactive)jerror("You are not authorized to modify invoices.");return false;}
if(config.invoice.freeze_sent_invoices==1&&ui.get('invoice.status_type')>AppConfig.INVOICE_STATUS_READY&&columnIndex!=this.getColumnIndex('id_tracker')&&columnIndex!=this.getColumnIndex('unitary_cost')){if(interactive)jinfo("The invoice cannot be modified. If you wish to modify it, set the invoice back to 'Draft' status.",null,400);return false;}
if(type=='comment'&&$.inArray(this.getColumnName(columnIndex),['type','label','description'])<0){if(interactive)jinfo(translate("You cannot only modify the label and description of comment entries."));return false;}
return true;},readonlyWarning:function(column){if(column.name=='amount')jinfo("The entry amount is not editable directly: you have to edit the quantity and/or unitary price.");},getActions:function(cell,id_entry)
{var actions=[];var active=isAllowed('invoices','edit')&&(config.invoice.freeze_sent_invoices==0||ui.get('invoice.status_type')<=AppConfig.INVOICE_STATUS_READY);actions.push({icon:img('customer_copytracker','copy','Duplicate'),active:active,click:function(){self.copyEntry(id_entry);}});actions.push({icon:img('customer_deletetracker','delete','Delete'),active:active,click:function(){if(confirm(translate('Are you sure you want to delete this entry ?',true)))self.deleteEntry(id_entry);}});return actions;},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){var selfgrid=this;updateCellValue(this,'/invoice/updateinvoiceentrycellvalue',rowIndex,columnIndex,oldValue,newValue,row,function(response){if(response=="error")return false;self.update(false);selfgrid.onChange();response=eval("("+response+")");selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("amount"),parseFloat(response.amount));selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("quantity"),parseFloat(response.quantity));selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_unit"),response.id_unit);selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("unitary_price"),parseFloat(response.unitary_price));selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_vat_type"),response.id_vat_type);if(selfgrid.hasColumn("id_tracker"))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_tracker"),response.id_tracker);if(selfgrid.hasColumn("unitary_cost"))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("unitary_cost"),parseFloat(response.unitary_cost));if(selfgrid.hasColumn("id_supplier"))selfgrid.setValueAt(rowIndex,selfgrid.getColumnIndex("id_supplier"),parseFloat(response.id_supplier));return true;});}});};InvoiceViewEntry.prototype.onshow=function()
{var self=this;$('#invoice_comment_dialog').dialog({autoOpen:false,width:640,buttons:[{text:translate("OK"),click:function(){self.addComment();$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});$(".create_discount").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.createDiscount();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});ui.on('add-entries',function(){if(!self.dialog||self.dialog.parameters.id_tracker_root!=ui.get('customer.id_tracker')){if(self.dialog)console.log('Client changed: recreating invoice selector');self.dialog=new ItemSelectorDialog({url:'/invoice/entrydialog?_html',parameters:{id_tracker_root:ui.get('customer.id_tracker')},title:translate("Add items to invoice"),add:function(type,id_items){return self.add(this.dialog,type,id_items);},onOpen:function(){this.dialog.find('[name=id_tracker]').val(ui.get('id_tracker_entry_common')).trigger('change');}});}
self.dialog.open();});ui.on('add-comment',function(){$('#invoice_comment_dialog').dialog('open');});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected entries ?',true)))self.deleteEntry(ui.get('rows_checked'));});ui.on('actionbar-ignore',function(){self.toggleignoreEntry(ui.get('rows_checked'));});ui.on('actionbar-discount',function(){self.showCreateDiscount();});this.createGrid();this.update(true);};InvoiceViewEntry.prototype.onhide=function()
{ui.off('add-entries');ui.off('add-comment');ui.off('actionbar-delete');ui.off('actionbar-ignore');ui.off('actionbar-discount');};InvoiceViewEntry.prototype.showCreateDiscount=function()
{$(".create_discount").dialog('open');$('.create_discount select').select2({width:450});$('.create_discount select[name=id_unit]').select2({width:150});};InvoiceViewEntry.prototype.createDiscount=function(id_entry,percent)
{var self=this;showWait(translate("Creating")+"...");_ajax('invoice/creatediscount',{id_invoice:ui.get('invoice.id'),id:ui.get('rows_checked'),percent:$(".create_discount [name=percent]").val(),id_unit:$(".create_discount [name=id_unit]").val()}).done(function(response){hideWait();if(!response)jerror("An error occured while creating the discount","Error");else{self.grid.fetch();self.grid.onChange();}});};InvoiceViewEntry.prototype.initializeGrid=function(grid)
{var self=this;for(var columnIndex=0;columnIndex<grid.getColumnCount();columnIndex++){var columName=grid.getColumnName(columnIndex);if(columName=='unitary_cost'&&ui.get('purchases_count')==0)continue;if(helpboxes["invoice_entry_"+columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes["invoice_entry_"+columName],grid.getColumnLabel(columnIndex),480,true));}
grid.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));grid.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+grid.getValueAt(cell.rowIndex,grid.getColumnIndex('label'))+'"';}}));grid.setCellRenderer("label",new CellRenderer({render:function(cell,value){$(cell).css('max-width','400px');CellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('quantity'))grid.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('unitary_price'))grid.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('unitary_cost'))grid.setCellRenderer('unitary_cost',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('id_unit'))grid.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('id_vat_type'))grid.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('id_tracker'))grid.setCellRenderer('id_tracker',new EnumCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('amount'))grid.setCellRenderer('amount',new NumberCellRenderer({render:function(cell,value){if(grid.getValueAt(cell.rowIndex,grid.getColumnIndex('type'))=='comment')$(cell).html('');else NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(grid.hasColumn('ignored'))grid.setCellRenderer("ignored",new EnumCellRenderer({originalRenderer:grid.getColumn("ignored").cellRenderer,render:function(cell,value){this.originalRenderer.render.call(this,cell,value);if(value)$(cell.parentNode).addClass("paid");else $(cell.parentNode).removeClass("paid");}}));grid.render();};InvoiceViewEntry.prototype.update=function(fetch)
{if(fetch){this.grid.fetch();this.grid.onChange();}
ajax('/invoice/getinvoice',{id:ui.get('invoice.id')},function(response){ui.set(response.ui);$('.statusbar .total.amount').html(response.amount_formatted);var performance=(response.gross_margin_performance/response.amount_theo)*100;var color='';$('.statusbar .total.amount').removeClass('green').removeClass('blue').removeClass('red').removeClass('orange');$('.statusbar .total.amount').addClass(color=get_performance_class(performance,true));$('.statusbar .total.amount').attr('title',translate("Gross margin")+': '+response.gross_margin_formatted+"<br/>"+
(response.amount_theo==0||response.amount_theo==null?'':(translate("Theoretical amount")+': '+response.amount_theo_formatted+"<br/>"+translate('Performance')+' : <span class="'+color+'">'+performance.toFixed(2)+" %</span>")));},"json");};InvoiceViewEntry.prototype.add=function(dialog,type,id_items)
{var self=this;var id_tracker=dialog.find('[name=id_tracker]').val();if(!id_tracker){jalert(translate("No tracker selected!"));return false;}
showWait(translate("Creating entry")+"...");if(type=='manual'){var add_catalog=dialog.find('[name=add_catalog]').is(':checked')?1:0;if(add_catalog){ajax('/item/add',{label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()}).done(function(response){ajax('/invoice/createentries',{id_invoice:ui.get('invoice.id'),id_tracker:id_tracker,id_items:JSON.parse(response).id}).done(function(response){hideWait();self.update(true);});});}
else ajax('/invoice/createentry',{id_invoice:ui.get('invoice.id'),id_tracker:id_tracker,label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val(),advance:dialog.find('[name=advance]').is(':checked')?1:0}).done(function(response){hideWait();self.update(true);});}
else if(type=='items'){ajax('/invoice/createentries',{id_invoice:ui.get('invoice.id'),id_tracker:id_tracker,id_items:id_items}).done(function(response){hideWait();self.update(true);});}
return true;};InvoiceViewEntry.prototype.addComment=function()
{var self=this;showWait(translate("Creating entry")+"...");ajax('/invoice/createentry',{id_invoice:ui.get('invoice.id'),id_tracker:ui.get('customer.id_tracker'),label:$('#invoice_comment_dialog [name=label]').val(),description:$('#invoice_comment_dialog [name=description]').val(),type:'comment'}).done(function(response){hideWait();self.update(true);});return true;};InvoiceViewEntry.prototype.copyEntry=function(id_entry)
{var self=this;gridWait('tablecontent');ajax('/invoice/copyentry',{id_entry:id_entry},function(response){if(response!="ok")jerror("An error occured while copying the entry in database","Error");else self.update(true);},'json');};InvoiceViewEntry.prototype.deleteEntry=function(id_entry)
{var self=this;showWait(translate("Deleting")+"...");_ajax('invoiceentry/delete',{id:id_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the entry from database","Error");else self.update(true);});};InvoiceViewEntry.prototype.toggleignoreEntry=function(id_entry)
{var self=this;showWait(translate("Ignoring")+"...");_ajax('invoiceentry/toggleignore',{id:id_entry,value:1}).done(function(response){hideWait();if(!response)jerror("An error occured while updating the entry in database","Error");else self.update(true);});};;function InvoiceViewGeneral(){this.init();}
InvoiceViewGeneral.prototype.init=function()
{var self=this;ui.observe('invoice.id_customer',function(newValue){if(newValue){_ajax('customer/customercontactselectoptions',{id_customer:newValue}).done(function(response){ui.set('customer_contact_select_options',response);});}},{init:false});};InvoiceViewGeneral.prototype.onshow=function()
{this.setupParameterForm();this.setupSchedule();$('div.row select:first').focus();};InvoiceViewGeneral.prototype.setupSchedule=function()
{var self=this;this.schedule=new ScheduleModule(ui.get('invoice.id'));$('.schedule').find('input, select').change(function(){self.saveSchedule();});};InvoiceViewGeneral.prototype.saveSchedule=function()
{var self=this;_ajax('invoice/updatepatternview',{id:ui.get('invoice.id'),pattern:self.schedule.getPattern()}).done(function(response){ui.set(response);self.setupSchedule();});};InvoiceViewGeneral.prototype.setupParameterForm=function()
{var self=this;$('#parameter_form select[multiple]').each(function(){$(this).select2({placeholder:translate("OPTION[none]"),allowClear:true,width:175,dropdownAutoWidth:true,closeOnSelect:false,minimumResultsForSearch:-1}).on('select2:close',function(){self.saveParameterForm();});$(this).select2Sortable({bindOrder:'sortableStop',sortableOptions:{'stop':function(){self.saveParameterForm();}}});});$('#parameter_form select:not([multiple])').each(function(){$(this).select2({width:175,dropdownAutoWidth:true,minimumResultsForSearch:-1});}).on('change',function(){self.saveParameterForm();});$('#parameter_form input[type=text]').change(function(){self.saveParameterForm();});$('#parameter_form textarea').change(function(){self.saveParameterForm();});$('#parameter_form input[type=checkbox]').click(function(){self.saveParameterForm();});};InvoiceViewGeneral.prototype.saveParameterForm=function()
{var self=this;var parameters={id_invoice:ui.get('invoice.id'),parameters:{}};$('#parameter_form').populateParameters(parameters.parameters);_ajax('invoice/saveparameters',parameters).done(function(response){ui.set(response);self.setupParameterForm();});};;function InvoiceViewHistory(){this.init();}
InvoiceViewHistory.prototype.init=function()
{var self=this;};InvoiceViewHistory.prototype.createGrid=function()
{var self=this;this.grid=new TimetrackEditableGrid("PaymentGrid",{controller:"invoicepayment",actionbar:false,statusbar:false,noResult:ui.get('invoice.invoice_type')=='invoice'?translate('No payment yet'):translate('No related invoice yet'),getParameters:function(){return{pageSize:5,id_invoice:ui.get('invoice.id')}},isEditable:function(){return false;},getActions:function(cell,id_payment){var actions=[];if(isAllowed('invoices','edit'))actions.push({icon:img('user_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this payment ?',true)))self.deletePayment(id_payment);}});return actions;},tableRendered:function(){TimetrackEditableGrid.prototype.tableRendered.call(this);$(".paginationControl .empty").addClass('small');}});};InvoiceViewHistory.prototype.onshow=function()
{var self=this;ui.on("add-payment",function(){self.addPayment();});ui.observe('payment_form.id_credit_note',self.applyCreditNote);this.createGrid();this.grid.fetch();};InvoiceViewHistory.prototype.onhide=function()
{ui.off('add-payment');};InvoiceViewHistory.prototype.addPayment=function()
{var self=this;_ajax('invoice/add_payment',merge({id:ui.get('invoice.id'),is_view:true},ui.get('payment_form'))).done(function(response){ui.set(response);ui.set('payment_form.paid_placeholder',0);ui.set('payment_form.id_credit_note','');self.grid.refresh();});};InvoiceViewHistory.prototype.applyCreditNote=function()
{var self=this;var id_credit_note=parseInt(ui.get('payment_form.id_credit_note'),10);if(id_credit_note>0){var credit_notes=ui.get('payment_form.credit_notes');for(var i=0,lgth=credit_notes.length;i<lgth;i++){if(credit_notes[i].value==id_credit_note){ui.set('payment_form.paid_placeholder',credit_notes[i].amount_vatincl);ui.set('payment_form.paydate',credit_notes[i].date_formatted);ui.set('payment_form.paid','');}}}
else ui.set('payment_form.paid',ui.get('payment_form.saldo'));}
InvoiceViewHistory.prototype.deletePayment=function(id)
{var self=this;_ajax('invoice/delete_payment',{id:ui.get('invoice.id'),id_payment:id,is_view:true}).done(function(response){ui.set(response);self.grid.refresh();});};;function InvoiceViewItemEntry(){this.init();};InvoiceViewItemEntry.prototype.init=function()
{};InvoiceViewItemEntry.prototype.onshow=function()
{this.grid=new ItemEntryGrid("InvoiceViewItemEntryGrid",{getParameters:function(){return{invoiceId:ui.get('invoice.id')};}});this.grid.fetch();};InvoiceViewItemEntry.prototype.onhide=function()
{};;function InvoiceViewItemEntryTimesheet(){this.init();};InvoiceViewItemEntryTimesheet.prototype.init=function()
{};InvoiceViewItemEntryTimesheet.prototype.onshow=function()
{var self=this;this.grid=new ItemEntryGrid("InvoiceViewItemEntryTimesheetGrid",{getParameters:function(){return{containingInvoiceId:ui.get('invoice.id'),timesheet:true};}});this.grid.fetch();ui.on('actionbar-detach',function(){if(confirm(translate('Are you sure you want to detach selected items from invoice ?',true)))self.detachItemEntry(ui.get('rows_checked'));});};InvoiceViewItemEntryTimesheet.prototype.onhide=function()
{ui.off('actionbar-detach');};InvoiceViewItemEntryTimesheet.prototype.detachItemEntry=function(id_item_entry)
{var self=this;showWait(translate("Detaching")+"...");_ajax('itementry/detach',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while detaching items from invoice in database","Error");else{self.grid.refresh();self.grid.onChange();}});};;function InvoiceViewTimesheetEntry(){this.init();};InvoiceViewTimesheetEntry.prototype.init=function()
{};InvoiceViewTimesheetEntry.prototype.onshow=function()
{var self=this;this.grid=new TimesheetGrid("JobViewTimesheetGrid",{isEditable:function(rowIndex,columnIndex){return false;},getParameters:function(){return{invoiceId:ui.get('invoice.id')};}});this.grid.fetch();ui.on('actionbar-detach',function(){if(confirm(translate('Are you sure you want to detach selected entries from invoice ?',true)))self.detachEntry(ui.get('rows_checked'));});};InvoiceViewTimesheetEntry.prototype.onhide=function()
{ui.off('actionbar-detach');};InvoiceViewTimesheetEntry.prototype.detachEntry=function(id_timesheet_entry)
{var self=this;showWait(translate("Detaching")+"...");_ajax('timesheet/detach',{id:id_timesheet_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while detaching entries from invoice in database","Error");else{self.grid.refresh();self.grid.onChange();}});};;function ItemEntryDialog(config)
{var self=this;this.controller='itementry';this.url='/index/itementrydialog';for(var p in config)this[p]=config[p];this.dialog=new ItemSelectorDialog({url:this.url,parameters:this.parameters||null,add:function(type,id_items){return self.add(this.dialog,type,id_items);},onOpen:function(){self.onOpen();}});}
ItemEntryDialog.prototype.onOpen=function()
{};ItemEntryDialog.prototype.open=function()
{this.dialog.open();};ItemEntryDialog.prototype.onAdd=function()
{};ItemEntryDialog.prototype.add=function(dialog,type,id_items)
{var self=this;var id_tracker=dialog.find('[name=id_tracker]').val();if(!id_tracker){jalert(translate("No tracker selected!"));return false;}
showWait(translate("Creating item")+"...");var controller=this.controller;if(type=='manual'){var add_catalog=dialog.find('[name=add_catalog]').is(':checked')?1:0;if(add_catalog){ajax('/item/add',{id_tracker:id_tracker,label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()}).done(function(response){_ajax(controller+'/additems',{id_tracker:id_tracker,id_items:JSON.parse(response).id}).done(function(response){hideWait();self.onAdd();});});}
else _ajax(this.controller+'/create',merge(this.parameters,{id_tracker:id_tracker,label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()})).done(function(response){hideWait();self.onAdd();});}
else if(type=='items'){_ajax(this.controller+'/additems',merge(this.parameters,{id_tracker:id_tracker,id_items:id_items})).done(function(response){hideWait();self.onAdd();});}
return true;};;function ItemEntryGrid(name,config){if(name)this.init(name,config);}
ItemEntryGrid.prototype=new TimetrackEditableGrid();ItemEntryGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No item found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No item found matching your search criteria');if(typeof config.tracker_enum_provider=='undefined')config.tracker_enum_provider='itementry/customertrackers';config.controller='itementry';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected items ?',true)))self.deleteItem(ui.get('rows_checked'));});this.setupSplit();};ItemEntryGrid.prototype.setupSplit=function()
{var self=this;$(".split_item").dialog({resizable:false,resize:true,width:600,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.splitItem();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});this.splitGrid=new TimetrackEditableGrid("ItemEntrySplitGrid",{enableSort:false,serverSide:false,actionbar:null,statusbar:null,container_id:'tablecontent_split',modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row)
{var totalPct=0;if(rowIndex==this.getRowCount()-1){for(var rowIndex=1;rowIndex<this.getRowCount();rowIndex++)totalPct+=this.getValueAt(rowIndex,this.getColumnIndex('percentage'));this.setValueAt(0,this.getColumnIndex('percentage'),100-totalPct);}
else{for(var rowIndex=0;rowIndex<this.getRowCount()-1;rowIndex++)totalPct+=this.getValueAt(rowIndex,this.getColumnIndex('percentage'));this.setValueAt(this.getRowCount()-1,this.getColumnIndex('percentage'),100-totalPct);}}});var metadata=[];metadata.push({name:"label",label:translate("Label"),datatype:"string",editable:true});metadata.push({name:"percentage",label:translate("Percentage"),datatype:"double(%,1)",editable:true});metadata.push({name:"invoice_duedate",label:translate("Due date"),datatype:"date",editable:true});this.splitGrid.load({"metadata":metadata});};ItemEntryGrid.prototype.isEditable=function(rowIndex,columnIndex)
{return true;};ItemEntryGrid.prototype.isDeletable=function(rowIndex)
{if(this.hasColumn('invoice_status')){var invoice_status=this.getValueAt(rowIndex,this.getColumnIndex('invoice_status'));if(invoice_status=='invoiced'||invoice_status=='canceled')return false;}
if(this.hasColumn('purchase_status')){var purchase_status=this.getValueAt(rowIndex,this.getColumnIndex('purchase_status'));if(purchase_status=='booked')return false;}
return true;};ItemEntryGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_customer_tracker','id_tracker','unitary_cost','unitary_price','quantity','id_unit','invoice_duedate','invoice_status','id_invoice'])>=0;};ItemEntryGrid.prototype.getActions=function(cell,id_item_entry)
{var self=this;var actions=[];var parameters=this.getParameters();var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('customers','edit')||(parameters&&parameters.blockId))actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyItem(id_item_entry);}});if(isAllowed('customers','edit'))actions.push({icon:img('customer_splititem','split',translate('Split this item')),active:deletable,click:function(){self.showSplit(cell.rowIndex);}});if(isAllowed('customers','edit')||(parameters&&parameters.blockId))actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_item_entry);}});return actions;};ItemEntryGrid.prototype.tableLoaded=function()
{var self=this;for(var columnIndex=0;columnIndex<self.getColumnCount();columnIndex++){var columName=self.getColumnName(columnIndex);if(helpboxes["item_entry_"+columName])self.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes["item_entry_"+columName],self.getColumnLabel(columnIndex),480,true));}
this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('label'))+'"';}}));if(this.tracker_enum_provider&&this.hasColumn('id_tracker'))this.setEnumProvider("id_tracker",new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var optionValues=null;_ajax(self.tracker_enum_provider,{id_tracker:self.getValueAt(rowIndex,column.columnIndex)},true).done(function(response){optionValues=response;});return optionValues;}}));this.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){cell.style.color=self.getRowAttribute(cell.rowIndex,'quantity_is_duration')==1?"#AAAAAA":"";NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('id_vat_type'))this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("id_user"))this.setCellRenderer('id_user',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("id_owner"))this.setCellRenderer('id_owner',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("date_start_formatted"))this.setCellRenderer("date_start_formatted",new CellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";CellRenderer.prototype.render.call(this,cell,value?value:"n/a");}}));if(this.hasColumn("id_supplier"))this.setCellRenderer('id_supplier',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('unitary_price'))this.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"";NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('invoice_status'))this.setCellRenderer("invoice_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');var invoice_status=self.getRowAttribute(cell.rowIndex,'invoice_status');var pseudo_delayed=self.getRowAttribute(cell.rowIndex,'pseudo_delayed');if(invoice_status!='none'||pseudo_delayed==1)$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));if(this.hasColumn('id_invoice'))this.setCellRenderer("id_invoice",new EnumCellRenderer({render:function(cell,id_invoice){var label=this.getLabel(cell.rowIndex,id_invoice);if(!isAllowed('invoices','view'))cell.innerHTML=label;cell.innerHTML=id_invoice?"<a class='customer_link tooltip' target='_blank' href='"+baseUrl+"/ui/invoice/"+id_invoice+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');}}));if(this.hasColumn('purchase_status'))this.setCellRenderer("purchase_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');if(self.hasColumn('action'))self.setValueAt(cell.rowIndex,self.getColumnIndex("action"),self.getValueAt(cell.rowIndex,self.getColumnIndex("action")));}}));this.render();};ItemEntryGrid.prototype.deleteItem=function(id_item_entry)
{var self=this;showWait(translate("Deleting")+"...");_ajax('itementry/delete',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the item from database","Error");else{self.refresh();self.onChange();}});};ItemEntryGrid.prototype.showSplit=function(rowIndex)
{var self=this;ui.set('split_rowindex',rowIndex);ui.set('split_id',this.getRowId(rowIndex));$(".split_item [name=mode]").val(this.getValueAt(rowIndex,this.getColumnIndex('quantity'))==1?'unitary_price':'quantity');$(".split_item [name=number]").val(2).change(function(){self.updateSplitGrid();});this.splitGrid.load({data:[]});this.splitGrid.render();this.updateSplitGrid();$(".split_item").dialog('open');};ItemEntryGrid.prototype.updateSplitGrid=function()
{var rowCount=this.splitGrid.getRowCount();var targetRowCount=$(".split_item [name=number]").val();if(targetRowCount<rowCount)for(var rowIndex=rowCount-1;rowIndex>=targetRowCount;rowIndex--)this.splitGrid.remove(rowIndex);else if(targetRowCount>rowCount)for(var rowIndex=rowCount;rowIndex<targetRowCount;rowIndex++){var values=rowCount>0?this.splitGrid.getRowValues(rowCount-1):{label:this.getValueAt(ui.get('split_rowindex'),this.getColumnIndex('label')),invoice_duedate:this.getValueAt(ui.get('split_rowindex'),this.getColumnIndex(this.hasColumn('due_date')?'due_date':'invoice_duedate'))};values['percentage']=0;var newRowId=0;for(var r=0;r<this.splitGrid.getRowCount();r++)newRowId=Math.max(newRowId,parseInt(this.splitGrid.getRowId(r))+1);this.splitGrid.insertAfter(rowCount-1,newRowId,values);}
if(targetRowCount!=rowCount){for(var rowIndex=0;rowIndex<targetRowCount-1;rowIndex++)this.splitGrid.setValueAt(rowIndex,this.splitGrid.getColumnIndex('percentage'),100.0/targetRowCount);this.splitGrid.setValueAt(targetRowCount-1,this.splitGrid.getColumnIndex('percentage'),100-(targetRowCount-1)*(100.0/targetRowCount));}};ItemEntryGrid.prototype.splitItem=function()
{var self=this;showWait(translate("Splitting")+"...");var slices=[];for(var rowIndex=0;rowIndex<this.splitGrid.getRowCount();rowIndex++)slices.push({label:this.splitGrid.getValueAt(rowIndex,this.splitGrid.getColumnIndex('label')),percentage:this.splitGrid.getValueAt(rowIndex,this.splitGrid.getColumnIndex('percentage')),invoice_duedate:this.splitGrid.checkDate(this.splitGrid.getValueAt(rowIndex,this.splitGrid.getColumnIndex('invoice_duedate'))).dbDate});_ajax('itementry/split',{id:ui.get('split_id'),slices:slices,mode:$(".split_item [name=mode]").val()}).done(function(response){hideWait();if(!response)jerror("An error occured while splitting the item in database","Error");else{self.refresh();self.onChange();}});};ItemEntryGrid.prototype.copyItem=function(id_item_entry)
{var self=this;showWait(translate("Copying")+"...");_ajax('itementry/copy',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the item from database","Error");else{self.refresh();self.onChange();}});};;function ItemEntryIndex(){}
ItemEntryIndex.prototype=new DefaultScreen();ItemEntryIndex.prototype.init=function()
{var self=this;this.grid=new ItemEntryGrid("ItemEntryGrid",{getParameters:function(){var parameter=ItemEntryGrid.prototype.getParameters.call(this);parameter.id_owners=$('.owner_select').val()||[];parameter.id_statuses=$('.status_select').val()||[];parameter.show_value=$('[name=show_value]').val();return parameter;}});this.dialog=new ItemEntryDialog({onAdd:function(){self.grid.onChange();self.grid.refresh();}});$('a.add').click(function(){self.dialog.open();});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});};;function ItemIndex(){}
ItemIndex.prototype=new DefaultScreen();ItemIndex.prototype.init=function()
{var self=this;this.grid=new TimetrackEditableGrid("ItemGrid",{controller:'item',noResult:translate('No item found in this folder'),noResultMatchingFilter:translate('No item found in this folder matching your search criteria'),tableLoaded:function(){self.initializeGrid(this);},isEditable:function(rowIndex,columnIndex){if(this.getRowId(rowIndex,columnIndex).startsWith('folder')&&columnIndex>0){jalert(translate('You cannot change this cell on a folder'));return false;}
return isAllowed('items','edit');},getParameters:function(){return{id_folder:ui.get('id_folder')||null};},filter:function(filter,cols){ui.set('id_folder',null);TimetrackEditableGrid.prototype.filter.call(this,filter,cols);self.folderBrowser.refresh();},refresh:function(silent,refreshTree){TimetrackEditableGrid.prototype.refresh.call(this,silent);if(refreshTree)self.folderBrowser.refresh();},getActions:function(cell,id_item_or_folder)
{var actions=[];if(isAllowed('items','create')){if(id_item_or_folder.startsWith('folder'))actions.push({icon:img('item_copy','copy',translate('Duplicate')),click:function(){self.copyFolder(id_item_or_folder.substr(7));}});else actions.push({icon:img('item_copy','copy',translate('Duplicate')),click:function(){self.copyItem(id_item_or_folder);}});}
if(isAllowed('items','delete')){if(id_item_or_folder.startsWith('folder'))actions.push({icon:img('item_delete','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this folder ? This will delete all items and sub folders in it.',true)))self.deleteFolder(id_item_or_folder.substr(7));}});else actions.push({icon:img('item_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_item_or_folder);}});}
return actions;},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});}});this.folderBrowser=new FolderBrowser();this.folderBrowser.getParameters=function(){return self.grid.getUrlParameters();};this.folderBrowser.init('item',this.grid,'span.dragme');ui.observe('id_folder',function(){_ajax('item/path',{id_folder:ui.get('id_folder')||null}).done(function(path){ui.set('path',path);});});ui.on('go-folder',function(event,id_folder){ui.set('id_folder',id_folder);self.grid.refresh();});ui.on('actionbar-add',function(){self.showAddForm();});ui.on('actionbar-add-folder',function(){self.showAddFolderForm();});$("#folder_form_div").dialog({width:575,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:[{text:translate("Create"),click:function(){self.createFolder(_$('folder_form'));$(this).dialog("close");}}],title:translate("New item")});$("#folder_form").submit(function(){if($("#folder_form_div [name=folder]").val()=='')return false;self.createFolder(_$('folder_form'));$("#folder_form_div").dialog("close");return false;});$("#item_form_div").dialog({width:675,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:[{text:translate("Create"),click:function(){self.createItem(_$('item_form'));$(this).dialog("close");}}],title:translate("New item")});$("#item_form").submit(function(){if($("#item_form_div [name=label]").val()=='')return false;self.createItem(_$('item_form'));$("#item_form_div").dialog("close");return false;});ui.on('quick-add-unit',function(){jprompt(translate("Enter name"),translate("Quick add"),"",null,function(name){_ajax('customer/quickaddunit',{name:name}).done(function(response){ui.set('unit_select.options',response.options);ui.set('unit_select.values',response.id);});});});}
ItemIndex.prototype.initializeGrid=function(grid)
{var self=this;for(var columnIndex=0;columnIndex<grid.getColumnCount();columnIndex++){var columName=grid.getColumnName(columnIndex);if(helpboxes['item_'+columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes['item_'+columName],trim(grid.getColumnLabel(columnIndex))?grid.getColumnLabel(columnIndex):translate("Information"),480,true));}
grid.addCellValidator("label",new CellValidator({isValid:function(value){return value!="";}}));if(grid.hasColumn('description'))grid.setCellRenderer('description',new CellRenderer({render:function(cell,value){if(this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex).startsWith('folder'))$(cell).empty();else $(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));if(grid.hasColumn('description'))grid.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,width:900,height:500,getDialogTitle:function(cell,value){return translate("Description")+" : "+self.grid.getValueAt(cell.rowIndex,self.grid.getColumnIndex('label'));}}));if(grid.hasColumn('quantity'))grid.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){if(this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex).startsWith('folder'))$(cell).empty();else{cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}}));grid.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);var rowId=this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex);if(rowId.startsWith('folder'))$(cell).html('');}}));grid.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){if(this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex).startsWith('folder'))$(cell).empty();else{cell.style.color=!value?"#AAAAAA":"black";EnumCellRenderer.prototype.render.call(this,cell,value);}}}));grid.setCellRenderer('id_supplier',new EnumCellRenderer({render:function(cell,value){if(this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex).startsWith('folder'))$(cell).empty();else{cell.style.color=!value?"#AAAAAA":"black";EnumCellRenderer.prototype.render.call(this,cell,value);}}}));grid.setCellRenderer("label",new CellRenderer({render:function(cell,value){$(cell).css('max-width','400px');var rowId=this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex);if(rowId.startsWith('folder')){var id_folder=rowId.substr(7);var link=$("<a title=\"\" rel=\""+id_folder+"\">"+value+"</a>");$(cell).html(img('item_folder','','')).append(' ').append(link);$(link).click(function(){ui.set('id_folder',id_folder);grid.refresh();});}
else $(cell).html($('<span>').addClass('dragme').append(img('item','','')).append(' ').append(value));$(cell).find('span').draggable({delay:150,helper:'clone'});}}));if(grid.hasColumn('tags')){grid.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No item tag was created yet. To create an item tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));grid.setCellRenderer("tags",new TagCellRenderer({render:function(cell,value){if(this.editablegrid.getRowId(cell.rowIndex,cell.columnIndex).startsWith('folder'))$(cell).empty();else TagCellRenderer.prototype.render.call(this,cell,value);}}));}
grid.render();};ItemIndex.prototype.deleteFolder=function(id)
{var self=this;ajax('/item/deletefolder',{id:id},function(response){if(response!="ok")showDialog("Error","An error occured while deleting the folder from database","error");else self.grid.refresh(false,true);},"json");};ItemIndex.prototype.copyFolder=function(id)
{var self=this;ajax('/item/copyfolder',{id:id},function(response){if(response!="ok")showDialog("Error","An error occured while copying the folder in database","error");else self.grid.refresh(false,true);},"json");};ItemIndex.prototype.deleteItem=function(id)
{var self=this;ajax('/item/delete',{id:id},function(response){if(response!="ok")showDialog("Error","An error occured while deleting the item from database","error");else self.grid.refresh();},"json");};ItemIndex.prototype.copyItem=function(id)
{var self=this;ajax('/item/copy',{id:id},function(response){if(response!="ok")showDialog("Error","An error occured while copying the item in database","error");else self.grid.refresh();},"json");};ItemIndex.prototype.showAddFolderForm=function()
{clear_form_elements(_$('folder_form'));$('#folder_form_div').dialog('option','title',translate("New folder")).dialog('open');};ItemIndex.prototype.showAddForm=function()
{clear_form_elements(_$('item_form'));$('#id').val('0');$('#item_form_div').dialog('option','title',translate("New item")).dialog('open');this.updateSaveState();};ItemIndex.prototype.updateSaveState=function()
{dlgButtons=$('#item_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");if($("#item_form_div [name=label]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("#item_form_div [name=label]").focus().keyup(function(e){if($("#item_form_div [name=label]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');}).bind('paste',function(e){dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});};ItemIndex.prototype.createFolder=function(form)
{var self=this;ajax("/item/addfolder",{name:$(form.name).val(),id_parent:ui.get('id_folder')},function(response){if(response.update_status!="ok")feedback_message(response.update_status=="error"?"An error occured while creating the folder in database":response.update_status,"error");else feedback_message(translate(translate("The folder has been created")),"success");self.grid.refresh(false,true);},"json","POST",function(){self.grid.refresh(false,true);});};ItemIndex.prototype.createItem=function(form)
{var self=this;ajax("/item/add",{label:$(form.label).val(),id_folder:ui.get('id_folder'),description:$(form.description).val(),id_unit:$(form.id_unit).val(),id_supplier:$(form.id_supplier).val(),unitary_price:$(form.unitary_price).val(),unitary_cost:$(form.unitary_cost).val(),quantity:$(form.quantity).val()},function(response){if(response.update_status!="ok")feedback_message(response.update_status=="error"?"An error occured while creating the item in database":response.update_status,"error");else feedback_message(translate("The item has been created"),"success");self.grid.fetch();},"json","POST",function(){self.grid.refresh();});};;function _ItemPatternDialog(){this.init(config);}
_ItemPatternDialog.prototype.init=function(config)
{var self=this;for(var p in config)this[p]=config[p];this.dialog=new ItemSelectorDialog({url:'/index/'+this.controller+'dialog',parameters:this.parameters||null,add:function(type,id_items){return self.add(this.dialog,type,id_items);},onOpen:function(){self.onOpen();}});};_ItemPatternDialog.prototype.onOpen=function()
{};_ItemPatternDialog.prototype.open=function()
{this.dialog.open();};_ItemPatternDialog.prototype.onAdd=function()
{};_ItemPatternDialog.prototype.add=function(dialog,type,id_items)
{var self=this;var id_tracker=dialog.find('[name=id_tracker]').val();if(!id_tracker&&typeof this.parameters[this.pkey]=='undefined'){jalert(translate("No tracker selected!"));return false;}
showWait(translate("Creating item")+"...");var action='additems';var parameter={id_items:id_items};if(type=='manual'){action='create';parameter={label:dialog.find('[name=label]').val(),description:dialog.find('[name=description]').val(),id_unit:dialog.find('[name=id_unit]').val(),quantity:dialog.find('[name=quantity]').val(),unitary_price:dialog.find('[name=unitary_price]').val(),unitary_cost:dialog.find('[name=unitary_cost]').val(),id_supplier:dialog.find('[name=id_supplier]').val()};}
if(id_tracker)parameter[this.pkey]=id_tracker;_ajax(this.controller+'/'+action,merge(this.parameters,parameter)).done(function(response){hideWait();self.onAdd();});return true;};function ItemPatternDialog(config)
{config=config||{};config.controller='itempattern';config.pkey='id_tracker';this.init(config);}
ItemPatternDialog.prototype=new _ItemPatternDialog();function DefaultItemPatternDialog(config)
{config=config||{};config.controller='defaultitempattern';config.pkey='id_default_tracker';this.init(config);}
DefaultItemPatternDialog.prototype=new _ItemPatternDialog();;function ItemPatternGrid(name,config){if(name)this.init(name,config);}
ItemPatternGrid.prototype=new TimetrackEditableGrid();ItemPatternGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No item found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No item found matching your search criteria');config.controller='itempattern';TimetrackEditableGrid.prototype.init.call(this,name,config);};ItemPatternGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit')){jinfo("You are not authorized to modify items.");return false;}
return true;};ItemPatternGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('customers','edit'))return false;return true;};ItemPatternGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_tracker','quantity','id_unit'])>=0;};ItemPatternGrid.prototype.getActions=function(cell,id_item_pattern)
{var self=this;var actions=[];if(isAllowed('customers','edit'))
actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyItem(id_item_pattern);}});if(isAllowed('customers','edit'))
actions.push({icon:img('customer_deletetracker','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_item_pattern);}});return actions;};ItemPatternGrid.prototype.tableLoaded=function()
{var self=this;if(this.hasColumn('recurrence'))this.setCellEditor('recurrence',new ScheduleCellEditor("/customer/getdefaultitempatterneditor",'defaultitempattern/updatepattern'));else{this.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).prepend('/ ').css('white-space','nowrap');}}));}
this.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('label'))+'"';}}));this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=value==''?"#AAAAAA":"black";EnumCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"black";NumberCellRenderer.prototype.render.call(this,cell,value);}}));this.render();};ItemPatternGrid.prototype.deleteItem=function(id_item_pattern)
{var self=this;showWait(translate("Deleting")+"...");_ajax('itempattern/delete',{id:id_item_pattern}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the item from database","Error");else{self.refresh();self.onChange();}});};ItemPatternGrid.prototype.copyItem=function(id_item_pattern)
{var self=this;showWait(translate("Copying")+"...");_ajax('itempattern/copy',{id:id_item_pattern}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the item from database","Error");else{self.refresh();self.onChange();}});};;function JobGantt(){}
JobGantt.prototype=new DefaultScreen();JobGantt.prototype.init=function()
{var jobs=[];for(var index=0;index<ui.get('jobs').length;index++){var job=ui.get('jobs')[index];var startDateSplit=job['_start_date'].split('-');var endDateSplit=job['_end_date'].split('-');var description="<p>"+translate("Start")+': <b>'+job['start_date']+"</b></p>";if(job['end_date_actual'])description+="<p>"+translate("End")+": <b>"+job['end_date_actual']+"</b></p>";if(job['title'])description+="<p><strong><u>"+job['title']+"</u></strong></p>";if(job['description'])description+="<div style='max-width:450px'><p>"+job['description']+"</p></div>";jobs.push({name:job['name'],values:[{from:"/Date("+startDateSplit[0]+","+startDateSplit[1]+","+startDateSplit[2]+")/",to:"/Date("+endDateSplit[0]+","+endDateSplit[1]+","+endDateSplit[2]+")/",desc:job['start_date']+(job['end_date_actual']?" &raquo; "+job['end_date_actual']:""),customClass:description}]});}
$("#gantt_scheme").gantt({source:jobs,scale:"months",minScale:"days",maxScale:"months",itemsPerPage:25,navigate:"scroll"});};function JobGrid(name,config){if(name)this.init(name,config);}
JobGrid.prototype=new TimetrackEditableGrid();JobGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No %template found').replace(/%template/,window.config.tracker.job_label.toLocaleLowerCase());if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No %template found matching your search criteria').replace(/%template/,window.config.tracker.job_label.toLocaleLowerCase())
config.controller='job';TimetrackEditableGrid.prototype.init.call(this,name,config);};JobGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('jobs','edit')){return false;}
return true;};JobGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_owner','id_status'])>=0;};JobGrid.prototype.getActions=function(cell,id_job)
{var self=this;var actions=[];if(isAllowed('estimates','export')){var id_estimate=this.hasColumn('id_estimate')?this.getValueAt(cell.rowIndex,this.getColumnIndex('id_estimate')):null;if(id_estimate>0)actions.push({icon:img('estimate_export_pdf16','pdf','Export as PDF'),href:baseUrl+'/estimate/getpdf/id/'+id_estimate+"/"+this.getRowAttribute(cell.rowIndex,'estimate_filename')+'.pdf',target:config.ui.open_reports_in_new_tab==1?'_blank':''});}
if(isAllowed('jobs','create'))
actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyJob(id_job);}});if(isAllowed('jobs','delete'))
actions.push({icon:img('customer_deletetracker','delete','Delete'),click:function(){var message=translate('Be careful! Deleting this %template will delete all its trackers. Associated entries will be transferred to the parent tracker (client). Are you sure you want to continue ?',true);if(confirm(message.replace(/%template/,config.tracker.job_label.toLocaleLowerCase())))self.deleteJob(id_job);}});return actions;};JobGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};JobGrid.prototype._tableLoaded=function()
{var self=this;this.setCellRenderer("name",new CellRenderer({render:function(cell,value){if(!isAllowed('jobs','view'))$(cell).html(value);else $(cell).html(value?"<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/job/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>":"");}}));if(this.hasColumn('id_estimate'))this.setCellRenderer("id_estimate",new CellRenderer({render:function(cell,id_estimate){var estimate_ref=self.getRowAttribute(cell.rowIndex,"estimate_ref");var url=baseUrl+"/ui/job/"+self.getRowId(cell.rowIndex)+'/estimate/'+id_estimate;if(!isAllowed('estimates','view'))cell.innerHTML=estimate_ref;else cell.innerHTML=id_estimate?"<a class='customer_link tooltip' title='' href='"+url+"'>"+estimate_ref+"</a>":"";}}));if(this.hasColumn('title'))this.setCellRenderer('title',new CellRenderer({render:function(cell,value){CellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('description'))this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));if(this.hasColumn('description'))this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:true,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('name'))+'"';}}));if(this.hasColumn('costs_theo_formatted'))this.setHeaderRenderer('costs_theo_formatted',new CellRenderer({render:function(cell,value){EditableGrid.prototype.addClassName(cell,"number");}}));if(this.hasColumn('costs_theo_formatted'))this.setCellRenderer('costs_theo_formatted',new CellRenderer({render:function(cell,value){CellRenderer.prototype.render.call(this,cell,value);EditableGrid.prototype.addClassName(cell,"number");}}));if(this.hasColumn('invoiceable_amount'))this.setCellRenderer("invoiceable_amount",new NumberCellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);if(isAllowed('invoices','create'))$(cell).html($('<a>').html($(cell).html()).attr('href',baseUrl+'/ui/invoice/add/tracker/'+self.getRowAttribute(cell.rowIndex,'id_tracker')));}}));var BudgetRenderer=function(){};BudgetRenderer.prototype=new NumberCellRenderer();BudgetRenderer.prototype.render=function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).html($('<a>').html($(cell).html()).attr('href',baseUrl+"/ui/job/"+self.getRowId(cell.rowIndex)+'/planning'));$(cell).find('a').css('color',value===null?"#AAAAAA":"");};if(this.hasColumn('budget'))this.setCellRenderer("budget",new BudgetRenderer());if(this.hasColumn('budget_amount'))this.setCellRenderer("budget_amount",new BudgetRenderer());if(this.hasColumn('budget_cost'))this.setCellRenderer("budget_cost",new BudgetRenderer());if(this.hasColumn('gross_margin'))this.setCellRenderer("gross_margin",new CellRenderer({render:function(cell,gross_margin){NumberCellRenderer.prototype.render.call(this,cell,gross_margin);var amount_theo=self.getRowAttribute(cell.rowIndex,"amount_theo");var amount_theo_formatted=self.getRowAttribute(cell.rowIndex,"amount_theo_formatted");var performance=(gross_margin/amount_theo)*100;var color='';$(cell).removeClass('green').removeClass('blue').removeClass('red').removeClass('orange');$(cell).addClass(color=get_performance_class(performance));cell.title='';if(amount_theo&&amount_theo!=0){cell.title+=translate('Theoretical amount')+': '+amount_theo_formatted+'<br/>';cell.title+=translate('Performance')+' : <span class="'+color+'">'+performance.toFixed(2)+" %</span>";}}}));if(this.hasColumn('id_status'))this.setCellRenderer("id_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);var status_type=parseInt(self.getRowAttribute(cell.rowIndex,'status_type'),10);$(cell.parentNode).addClass(status_type==AppConfig.TRACKER_STATUS_DONE?"paid":"unpaid").removeClass(status_type==AppConfig.TRACKER_STATUS_DONE?"unpaid":"paid");if(color=self.getRowAttribute(cell.rowIndex,'status_color')){color=toRGB(color);$(cell).html("<span class='task_color_marker' style='background-color:"+cssColor(color)+";color:"+cssColor(getFrontColor(color))+"'>"+$(cell).html()+"</span>");}
$(cell).css('white-space','nowrap');self.setValueAt(cell.rowIndex,self.getColumnIndex("action"),self.getValueAt(cell.rowIndex,self.getColumnIndex("action")));}}));if(this.hasColumn('id_customer_contact'))this.setEnumProvider('id_customer_contact',new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var values=null;syncAjax('/customer/getcontacts',{id_customer:self.getRowAttribute(rowIndex,'id_customer')},function(response){values=response;},'json');return values;}}));if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No tag was created yet. To create a tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}};JobGrid.prototype.tableLoaded=function()
{this._tableLoaded();this.render();};JobGrid.prototype.deleteJob=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('job/delete',{id:id}).done(function(response){self.refresh();self.onChange();hideWait();});};JobGrid.prototype.copyJob=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('job/copy',{id:id}).done(function(response){hideWait();var default_panel='general';router.navigate('/job/'+response+'/'+default_panel,true);});};;function JobItemGrid(name,config){if(name)this.init(name,config);}
JobItemGrid.prototype=new TimetrackEditableGrid();JobItemGrid.prototype.init=function(name,config)
{var self=this;config=merge({controller:'jobitem',noResult:translate('No item found'),noResultMatchingFilter:translate('No item found matching your search criteria')},config);TimetrackEditableGrid.prototype.init.call(this,name,config);$(".quick_move_tracker").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.quickMove();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});$(".quick_add_tracker").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.quickAdd();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});$(".quick_add_tracker [name=mode]").on('change',function(){$(".quick_add_tracker .quickadd_price").css('display',$(".quick_add_tracker [name=mode]:checked").val()=='time'?'':'none');});$(".create_discount").dialog({resizable:false,resize:true,width:640,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){self.createDiscount();$(this).dialog('close');}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected items ?',true)))self.deleteItem(ui.get('rows_checked'));});ui.on('actionbar-discount',function(){self.showCreateDiscount();});ItemEntryGrid.prototype.setupSplit.call(this);};JobItemGrid.prototype.tableRendered=function(containerid,className,tableid)
{var self=this;TimetrackEditableGrid.prototype.tableRendered.call(this,containerid,className,tableid);if(!this.currentFilter&&this.sortedColumnName==-1){$("#tablecontent tbody").sortable({delay:150,helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index){$(this).width($originals.eq(index).width());});return $helper;},stop:function(){var id_sorted=[];$(this).find('tr').each(function(){id_sorted.push(self.getRowId(self.getRowIndex(this)));});_ajax('jobitem/sort',{id_sorted:id_sorted});}});}};JobItemGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit'))return false;var invoice_status=this.getRowAttribute(rowIndex,'invoice_status');if(invoice_status=='invoiced'||invoice_status=='canceled'){if(columnIndex==this.getColumnIndex('quantity')||columnIndex==this.getColumnIndex('unitary_price')||columnIndex==this.getColumnIndex('id_unit')){}
if(columnIndex==this.getColumnIndex('due_date')){jalert(translate('You cannot modifiy the due date for this item since it has already been invoiced or canceled'));return false;}}
if(columnIndex==this.getColumnIndex('id_tracker')&&this.getRowAttribute(rowIndex,'id_user_budget')){jalert(translate('You cannot modify the tracker for this item because it has been imported from the planning'));return false;}
if(columnIndex==this.getColumnIndex('due_date')&&this.getValueAt(rowIndex,columnIndex)===null){return false;}
return true;};JobItemGrid.prototype.isSubtrackerable=function(rowIndex)
{if(!isAllowed('customers','edit'))return false;if(!isAllowed('timesheet','list'))return false;return this.getRowAttribute(rowIndex,'subtrackerable')==1;};JobItemGrid.prototype.isMovable=function(rowIndex)
{if(!isAllowed('customers','edit'))return false;if(!isAllowed('timesheet','list'))return false;return this.getRowAttribute(rowIndex,'movable')==1;};JobItemGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('customers','edit'))return false;return this.getRowAttribute(rowIndex,'deletable')==1;};JobItemGrid.prototype.isDuplicable=function(rowIndex)
{if(!isAllowed('customers','edit'))return false;return this.getRowAttribute(rowIndex,'duplicable')==1;};JobItemGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_tracker','quantity','unitary_price','unitary_cost','id_unit','invoice_status'])>=0;};JobItemGrid.prototype.readonlyWarning=function(column){if(column.name=='amount')jinfo("The entry amount is not editable directly: you have to edit the quantity and/or unitary price.");};JobItemGrid.prototype.getActions=function(cell,id_job_item)
{var self=this;var actions=[];var subtrackerable=this.isSubtrackerable(cell.rowIndex);var movable=this.isMovable(cell.rowIndex);var deletable=this.isDeletable(cell.rowIndex);var duplicable=this.isDuplicable(cell.rowIndex);var is_item_entry=id_job_item.startsWith('item_entry');if(isAllowed('customers','edit')){if(isAllowed('timesheet','list')&&ui.get('job.mode')!="estimate"){if(subtrackerable)actions.push({icon:img('item_quickadd_tracker','create sub tracker',this.getRowAttribute(cell.rowIndex,'subtrackerable_why').replace('%template',config.tracker.job_label.toLocaleLowerCase())),active:subtrackerable,click:function(){self.showQuickAdd(cell.rowIndex);}});else if(this.getRowAttribute(cell.rowIndex,'movable_why'))actions.push({icon:img('item_move','move',this.getRowAttribute(cell.rowIndex,'movable_why').replace('%template',config.tracker.job_label.toLocaleLowerCase())),active:movable,click:function(){self.showQuickMove(cell.rowIndex);}});}
actions.push({icon:img('customer_copytracker','copy',this.getRowAttribute(cell.rowIndex,'duplicable_why').replace('%template',config.tracker.job_label.toLocaleLowerCase())),active:duplicable,click:function(){self.copyItem(id_job_item);}});actions.push({icon:img('customer_splititem','split',translate('Split this item')),active:is_item_entry&&deletable,click:function(){self.showSplit(cell.rowIndex);}});actions.push({icon:img('customer_deletetracker','delete',this.getRowAttribute(cell.rowIndex,'deletable_why').replace('%template',config.tracker.job_label.toLocaleLowerCase())),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_job_item);}});}
return actions;};JobItemGrid.prototype.showQuickMove=function(rowIndex)
{ui.set('quick_move_id',this.getRowId(rowIndex));$(".quick_move_tracker [name=id_unit]").val(this.getValueAt(rowIndex,this.getColumnIndex('id_unit')));$(".quick_move_tracker [name=unitary_price]").val(this.getDisplayValueAt(rowIndex,this.getColumnIndex('unitary_price')));$(".quick_move_tracker").dialog('open');$('.quick_move_tracker select').select2({width:450});$('.quick_move_tracker select[name=id_unit]').select2({width:150});};JobItemGrid.prototype.showQuickAdd=function(rowIndex)
{ui.set('quick_add_id',this.getRowId(rowIndex));$(".quick_add_tracker [name=id_parent]").val(this.getValueAt(rowIndex,this.getColumnIndex('id_tracker')));$(".quick_add_tracker [name=name]").val(this.getValueAt(rowIndex,this.getColumnIndex('label')));$(".quick_add_tracker [name=id_unit]").val(this.getValueAt(rowIndex,this.getColumnIndex('id_unit')));$(".quick_add_tracker [name=unitary_price]").val(this.getDisplayValueAt(rowIndex,this.getColumnIndex('unitary_price')));$(".quick_add_tracker").dialog('open');$('.quick_add_tracker select').select2({width:450});$('.quick_add_tracker select[name=id_unit]').select2({width:150});};JobItemGrid.prototype.quickAdd=function()
{var self=this;showWait(translate("Creating")+"...");_ajax('jobitem/quickadd',{id:ui.get('quick_add_id'),id_parent:$(".quick_add_tracker [name=id_parent]").val(),name:$(".quick_add_tracker [name=name]").val(),id_type:$(".quick_add_tracker [name=id_type]").val(),mode:$(".quick_add_tracker [name=mode]:checked").val(),unitary_price:$(".quick_add_tracker [name=unitary_price]").val(),id_unit:$(".quick_add_tracker [name=id_unit]").val()}).done(function(){self.fetch();});};JobItemGrid.prototype.quickMove=function()
{var self=this;showWait(translate("Moving")+"...");_ajax('jobitem/move',{id:ui.get('quick_move_id'),unitary_price:$(".quick_move_tracker [name=unitary_price]").val(),id_unit:$(".quick_move_tracker [name=id_unit]").val()}).done(function(response){hideWait();if(!response)jerror("An error occured while moving the item from database","Error");else{self.refresh();self.onChange();}});};JobItemGrid.prototype.showCreateDiscount=function()
{$(".create_discount").dialog('open');$('.create_discount select').select2({width:450});$('.create_discount select[name=id_unit]').select2({width:150});};JobItemGrid.prototype.createDiscount=function(id_job_item,percent)
{var self=this;showWait(translate("Creating")+"...");_ajax('jobitem/creatediscount',merge(this.getParameters(),{id:ui.get('rows_checked'),percent:$(".create_discount [name=percent]").val(),id_unit:$(".create_discount [name=id_unit]").val()})).done(function(response){hideWait();if(!response)jerror("An error occured while creating the discount","Error");else{self.refresh();self.onChange();}});};JobItemGrid.prototype.tableLoaded=function()
{var self=this;for(var columnIndex=0;columnIndex<this.getColumnCount();columnIndex++){var columnName=this.getColumnName(columnIndex);var helpboxName='job_item_'+columnName;if(columnName=="due_date"&&this.getColumnType(columnIndex)=='date')helpboxName+="_estimate";if(helpboxes[helpboxName])this.setHeaderRenderer(columnName,getInfoHeaderRenderer(helpboxes[helpboxName],trim(this.getColumnLabel(columnIndex))?this.getColumnLabel(columnIndex):translate("Information"),480,true));}
this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('label'))+'"';}}));this.setCellRenderer('quantity',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"";NumberCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("id_type"))this.setCellRenderer('id_type',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"";NumberCellRenderer.prototype.render.call(this,cell,value);var invoice_status=self.getRowAttribute(cell.rowIndex,'invoice_status');if(invoice_status=='invoiced'||invoice_status=='canceled')$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));if(this.hasColumn("due_date")&&this.getColumnType('due_date')!='date')this.setCellEditor('due_date',new ScheduleCellEditor("/customer/getjobitempatterneditor",'jobitem/updatepattern'));if(this.hasColumn('due_date'))this.setCellRenderer('due_date',new CellRenderer({render:function(cell,value){if(value===null){cell.style.color="#AAAAAA";CellRenderer.prototype.render.call(this,cell,'n/a');}
else{cell.style.color="";if(self.getColumnType('due_date')=='date')DateCellRenderer.prototype.render.call(this,cell,value);else CellRenderer.prototype.render.call(this,cell,value);}}}));if(this.hasColumn('invoice_status'))this.setCellRenderer("invoice_status",new EnumCellRenderer({render:function(cell,value){var label=value?this.getLabel(cell.rowIndex,value):'n/a';if(!isAllowed('invoices','view'))cell.innerHTML=label;var id_invoice=self.getRowAttribute(cell.rowIndex,'id_invoice');cell.innerHTML=value=='invoiced'&&id_invoice?"<a class='customer_link tooltip' target='_blank' title='"+translate('Invoice')+' '+self.getRowAttribute(cell.rowIndex,'invoice_ref')+"' href='"+baseUrl+"/ui/invoice/"+self.getRowAttribute(cell.rowIndex,'id_invoice')+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');cell.style.color=!value?"#AAAAAA":"";if(value&&value!='none')$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));this.render();};JobItemGrid.prototype.deleteItem=function(id_job_item)
{var self=this;showWait(translate("Deleting")+"...");_ajax('jobitem/delete',merge(this.getParameters(),{id:id_job_item})).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the item from database","Error");else{self.refresh();self.onChange();}});};JobItemGrid.prototype.showSplit=function(rowIndex)
{ItemEntryGrid.prototype.showSplit.call(this,rowIndex);ui.set('split_id',this.getRowId(rowIndex).replace('item_entry.',''));};JobItemGrid.prototype.updateSplitGrid=ItemEntryGrid.prototype.updateSplitGrid;JobItemGrid.prototype.splitItem=ItemEntryGrid.prototype.splitItem;JobItemGrid.prototype.copyItem=function(id_job_item)
{var self=this;showWait(translate("Copying")+"...");_ajax('jobitem/copy',merge(this.getParameters(),{id:id_job_item})).done(function(response){hideWait();if(!response)jerror("An error occured while copying the item from database","Error");else{self.fetch();self.onChange();}});};;function JobEstimate(){}
JobEstimate.prototype=new DefaultScreen();JobEstimate.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/estimate',true);});ui.on('create-estimate',function(){showWait(translate("Creating estimate")+"...");_ajax('estimate/create',{id_estimate:null,id_customer:ui.get('tracker.id_customer'),description:null,customer_ref:null,id_trackers:[ui.get('tracker.id')]}).done(function(response){hideWait();router.navigate('/job/'+ui.get('job.id')+'/estimate/'+parseInt(response,10),true);});});if(ui.get('estimate.id')){this.estimateViewEntry=new EstimateViewEntry(true);this.estimateViewEntry.onshow();ui.on('edit-estimate',function(){ui.set('edit_mode',true);});ui.on('save-estimate',function(){self.save();});ui.on('send-estimate',function(){self.sendEstimate(ui.get('estimate.id'));});ui.on('delete-estimate',function(){jconfirm(translate("Are you sure you want to delete this estimate ?"),null,null,function(){self.deleteEstimate();});});ui.on('update-estimate',function(){self.updateFromJob();});ui.on('set-status-estimate',function(event,id_status){self._setEstimateStatus(ui.get('estimate.id'),id_status);});$('input[name=estimate_send_to]').autocomplete({source:baseUrl+'/customer/listcontactemail'});return true;}
this.grid=new EstimateGrid("JobEstimateGrid",{inJob:true,getViewLink:function(id_estimate){return{'class':'customer_link tooltip','url':baseUrl+"/ui/job/"+ui.get('job.id')+'/estimate/'+id_estimate};},noResult:translate('There is not estimate yet for this %template').replace(/%template/,config.tracker.job_label.toLocaleLowerCase()),getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){self.refresh();}});};JobEstimate.prototype.deleteEstimate=function()
{showWait(translate("Deleting estimate")+"...");_ajax('estimate/delete',{id:ui.get('estimate.id')}).done(function(response){router.navigate('/job/'+ui.get('job.id')+'/estimate/index',true);});};JobEstimate.prototype.getEstimateData=function()
{var data={};var properties=['id','estimate_date','estimate_ref','id_signer','id_status'];for(var i=0;i<properties.length;i++)data[properties[i]]=ui.get('estimate.'+properties[i]);return data;};JobEstimate.prototype.save=function()
{var self=this;showWait(translate("Saving")+"...");_ajax('estimate/update',this.getEstimateData()).done(function(){self.refresh().done(function(){ui.set('edit_mode',false);self.estimateViewEntry.onshow();hideWait();});});};JobEstimate.prototype.updateFromJob=function()
{var self=this;showWait(translate("Updating estimate")+"...");_ajax('estimate/updatefromjob',{id_estimate:ui.get('estimate.id')}).done(function(){self.refresh().done(function(){self.estimateViewEntry.onshow();hideWait();});});};JobEstimate.prototype._sendMail=EstimateGrid.prototype._sendMail;JobEstimate.prototype.sendEstimate=EstimateGrid.prototype.sendEstimate;JobEstimate.prototype._setEstimateStatus=function(id,id_status)
{if(!id_status)return this.refresh();var self=this;_ajax('estimate/update',{id:id,id_status:id_status}).done(function(){self.refresh().done(function(){self.estimateViewEntry.onshow();});});};;function JobGeneral(){};JobGeneral.prototype=new DefaultScreen();JobGeneral.prototype.init=function()
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/general',true);});$('textarea[name=description]').attr('id','JobEditGeneral_description');tinymce.execCommand('mceAddEditor',false,'JobEditGeneral_description');$('select:not(.quick-access)').select2({width:400,minimumResultsForSearch:10});$('select[name=id_parent]').change(function(){var parameters={id_tracker:$(this).val()};_ajax('job/contactselect',parameters).done(function(response){ui.set(response);});});ui.on('save-job',function(){self.save();});};JobGeneral.prototype.save=function()
{var self=this;var parameters={id:ui.get('job.id'),id_tracker:ui.get('tracker.id')};$('.job_edit_dialog').populateParameters(parameters);parameters['description']=tinymce.get('JobEditGeneral_description').getContent();showWait(translate("Saving")+"...");_ajax('job/update',parameters).done(function(){self.refresh().done(function(){message("success",translate(translate("The %template has been updated").replace('%template',config.tracker.job_label.toLocaleLowerCase())));hideWait();});});};JobGeneral.prototype.dispose=function()
{try{tinymce.execCommand('mceRemoveEditor',false,'JobEditGeneral_description');}catch(ex){}
$('#JobEditGeneral_description').hide();};;function JobJobItem(){};JobJobItem.prototype=new DefaultScreen();JobJobItem.prototype.init=function(parameter)
{var self=this;$('select.id_job_change').change(function(){router.navigate('/job/'+$(this).val()+'/job_item',true);});this.grid=new JobItemGrid("JobJobItemGrid",{getParameters:function(){return{id_tracker:ui.get('tracker.id')};},onChange:function(){if(ui.get('job.mode')=='job'||ui.get('job.status_type')==AppConfig.TRACKER_STATUS_IN_PROGRESS)self.refresh();}});this.dialog=new ItemEntryDialog({controller:'jobitem',parameters:{id_tracker:ui.get('tracker.id')},onAdd:function(){self.grid.onChange();self.grid.refresh();},onOpen:function(){if(!isEnabled('timesheet','list'))$('select#id_tracker').val(0).parent().hide();else $('select#id_tracker').parent().show();}});ui.on('actionbar-add',function(){self.dialog.open();});ui.on("create-budget-items",function(){self.createBudgets();});ui.on("update-budget-items",function(){self.updateBudgets();});};JobJobItem.prototype.updateBudgets=function()
{var self=this;jconfirm(translate("This will delete and recreate all items corresponding to time budgets. Please confirm."),null,null,function(){showWait(translate("Updating items")+"...");self._updateBudgets();});};JobJobItem.prototype.createBudgets=function()
{if(!ui.get('has_budgets'))jinfo(translate("There are no budgets defined yet. In order to define the estimated time budgets, use the tab <a href='%URL'>Planning</a>.").replace('%URL',baseUrl+'/ui/job/'+ui.get('job.id')+'/planning'));else{showWait(translate("Creating items")+"...");this._updateBudgets();}};JobJobItem.prototype._updateBudgets=function()
{var self=this;_ajax('itementry/updatebudgetitems',{id_tracker:ui.get('tracker.id')}).done(function(response){hideWait();if(self.grid.serverSide)self.grid.refresh();else self.grid.fetch();self.grid.onChange();});};;function LeadGrid(name,config){if(name)this.init(name,config);}
LeadGrid.prototype=new TimetrackEditableGrid();LeadGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No new business found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No new business found matching your search criteria');config.controller='lead';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected leads ?',true)))self.deleteLead(ui.get('rows_checked'));});};LeadGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('leads','delete'))return false;return true;};LeadGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['projected_fees','projected_costs','id_status','archived'])>=0;};LeadGrid.prototype.getActions=function(cell,id_lead)
{var self=this;var actions=[];var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('leads','create'))actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyLead(id_lead);}});if(isAllowed('leads','delete'))actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this lead ?',true)))self.deleteLead(id_lead);}});return actions;};LeadGrid.prototype.tableLoaded=function()
{var self=this;if(isAllowed('customers','list')&&this.hasColumn('projected_fees'))this.setCellRenderer("projected_fees",new NumberCellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);$(cell).html($('<a>').html($(cell).html()).attr('href',baseUrl+'/ui/forecastcustomerfees/index/0/'+self.getRowAttribute(cell.rowIndex,'id_customer')));}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getDisplayValueAt(cell.rowIndex,self.getColumnIndex('name'))+'"';}}));if(this.hasColumn("id_owner"))this.setCellRenderer('id_owner',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('id_status'))this.setCellRenderer("id_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');}}));this.setCellRenderer("archived",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);if(value){$(cell.parentNode).addClass("archived");$(cell).addClass("archived");}
else{$(cell.parentNode).removeClass("archived");$(cell).removeClass("archived");}}}));if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No customer tag was created yet. To create a customer tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
this.render();};LeadGrid.prototype.deleteLead=function(id_lead)
{var self=this;showWait(translate("Deleting")+"...");_ajax('lead/delete',{id:id_lead}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the lead from database","Error");else{self.refresh();self.onChange();}});};LeadGrid.prototype.copyLead=function(id_lead)
{var self=this;showWait(translate("Copying")+"...");_ajax('lead/copy',{id:id_lead}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the lead from database","Error");else{self.refresh();self.onChange();}});};;function LeadIndex(){}
LeadIndex.prototype=new DefaultScreen();LeadIndex.prototype.init=function()
{var self=this;this.grid=new LeadGrid("LeadGrid",{getParameters:function(){var parameter=LeadGrid.prototype.getParameters.call(this);parameter.id_teams=$('.team_select').val()||[];parameter.id_statuses=$('.status_select').val()||[];parameter.id_owners=$('.owner_select').val()||[];parameter.id_tags=$('.tag_select').val()||[];parameter.hide_archived=$('input[name=hide_archived]').is(':checked');return parameter;}});$("a.add:not(.import)").click(function(){dlgButtons=$('div.add_lead').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("div.add_lead textarea,div.add_lead input[type=password],div.add_lead input[type=text],div.add_lead select").val('');$("div.add_lead .datepicker").val('').datepicker({dateFormat:locale['date_format_jquery']});dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("div.add_lead [name=label]").focus();var updateButtonState=function(e){dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("div.add_lead [mandatory]").each(function(){if(!$(this).val()){dlgButtons.attr('disabled','1').addClass('ui-state-disabled');return false;}});};$("div.add_lead [mandatory]").keyup(updateButtonState).change(updateButtonState);});$("div.add_lead").dialog({width:680,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New lead"),buttons:[{text:translate("Add lead"),click:function(){if(self.add($('div.add_lead')))$(this).dialog('close');}}]});$("div.add_lead select").each(function(){$(this).select2({width:450,placeholder:$(this).attr('placeholder'),dropdownCssClass:'ui-dialog',dropdownAutoWidth:true});});$('.team_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose teams")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Teams"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});$('input[name=hide_archived]').click(function(){self.grid.refresh();});};LeadIndex.prototype.add=function(dialog)
{var self=this;showWait(translate("Creating lead")+"...");_ajax('lead/create',merge(this.parameters,{name:dialog.find('[name=name]').val(),id_team:dialog.find('[name=id_team]').val(),start_date:dialog.find('[name=start_date]').val(),id_status:dialog.find('[name=id_status]').val(),description:dialog.find('[name=description]').val()})).done(function(response){hideWait();self.grid.refresh();});return true;};;function NoteGrid(name,config){if(name)this.init(name,config);}
NoteGrid.prototype=new TimetrackEditableGrid();NoteGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No note found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No note found matching your search criteria');config.controller='note';TimetrackEditableGrid.prototype.init.call(this,name,config);};NoteGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){if(response.row)self.update(response.row);}});};NoteGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify notes.");return false;}
return true;};NoteGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_user','id_type','closed'])>=0;};NoteGrid.prototype.getActions=function(cell,id_note)
{var self=this;var actions=[];if(isAllowed('customers','edit')){actions.push({icon:img('customer_copytracker','copy',translate('Duplicate')),click:function(){self.copyNote(id_note);}});actions.push({icon:img('customer_deletetracker','delete',translate('Delete')),click:function(){if(confirm(translate('Are you sure you want to delete this note ?',true)))self.deleteNote(id_note);}});}
return actions;};NoteGrid.prototype.tableLoaded=function()
{var self=this;this.setCellEditor("note",new NoteCellEditor({getParameters:self.getParameters,forceEdit:isAllowed('customers','edit')}));this.setCellEditor("created",new NoteCellEditor({getParameters:self.getParameters}));this.setCellEditor("modified",new NoteCellEditor({getParameters:self.getParameters}));this.setCellRenderer("note",new CellRenderer({render:function(cell,value){$(cell).css('max-width','350px');CellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer("closed",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);$(cell.parentNode).addClass(value?"paid":"unpaid").removeClass(value?"unpaid":"paid");}}));this.render();};NoteGrid.prototype.copyNote=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('note/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the note from database","Error");else{self.refresh();self.onChange();}});};NoteGrid.prototype.deleteNote=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('note/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the note from database","Error");else{self.refresh();self.onChange();}});};;function NoteIndex(){};NoteIndex.prototype=new DefaultScreen();NoteIndex.prototype.init=function()
{var self=this;this.grid=new NoteGrid("NoteGrid",{getParameters:function(){var parameter={};parameter.from=$('.searchfield.from').val();parameter.to=$('.searchfield.to').val();parameter.id_users=$('.user_select').val()||[];parameter.id_types=$('.type_select').val()||[];parameter.hide_closed=$('[name=hide_closed]').is(':checked');localset(this.name+'DateFrom',parameter.from);localset(this.name+'DateTo',parameter.to);return parameter;}});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$('a.button.add').click(function(){new NoteEditor({afterSave:function(){self.grid.refresh();}}).open();});$('input[name=hide_closed]').click(function(){self.grid.refresh();});$('.user_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose users")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Users"))}).on('multiselectclose',function(){self.grid.refresh();});$('.type_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose types")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Types"))}).on('multiselectclose',function(){self.grid.refresh();});};;function PlanningGrid(name,config){if(name)this.init(name,config);}
PlanningGrid.prototype=new TrackerBasedGrid();PlanningGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No tracker found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No tracker found matching your search criteria');config.controller='planning';config.serverSide=false;config.enableSort=false;TrackerBasedGrid.prototype.init.call(this,name,config);this.budgetEntryGrid=new TimetrackEditableGrid("BudgetEntry",{serverSide:false,controller:"budgetentry",container_id:"tablecontent_budget_entry",actionbar:false,statusbar:false});this.budgetCurrencyEntryGrid=new TimetrackEditableGrid("BudgetCurrencyEntry",{serverSide:false,controller:"budgetcurrencyentry",container_id:"tablecontent_budget_entry",actionbar:false,statusbar:false});};PlanningGrid.prototype.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{var self=this;return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=='object'){$('span.total.budget').html(response.budget);$('span.total.budget_amount').html(response.budget_amount);$('span.total.budget_cost').html(response.budget_cost);$('span.total.budget_costs').html(response.budget_costs);$('span.total.budget_fees').html(response.budget_fees);}});};PlanningGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed(ui.get('job.id')?'jobs':'customers','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
var auto_budget=this.getValueAt(rowIndex,this.getColumnIndex('auto_budget'))==1;if(auto_budget&&this.getColumnName(columnIndex).startsWith('budget')){jinfo("You cannot set a budget since this is an automatic budget tracker");return false;}
if(this.getColumnName(columnIndex).startsWith('budget-')){var id_user=this.getColumn(columnIndex).cellRenderer.id_user;var access=this.getRowAttribute(rowIndex,"access_by_user")[id_user];if(access.user_access_value_inherited!=1&&!this.getValueAt(rowIndex,columnIndex))return false;}
return true;};PlanningGrid.prototype.isColumnHideable=function(colIndex)
{return colIndex>0&&!this.getColumnName(colIndex).startsWith("budget-");};PlanningGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['auto_budget','start_date','end_date'])>=0;};PlanningGrid.prototype.tableLoaded=function()
{this.setDefaultRenderers();this._tableLoaded();this.render();this.setupTreeTable();};PlanningGrid.prototype._tableLoaded=function()
{var self=this;for(var columnIndex=0;columnIndex<this.getColumnCount();columnIndex++){var columName=this.getColumnName(columnIndex);if(helpboxes[columName])this.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes[columName],this.getColumnLabel(columnIndex),480,true));}
if(this.hasColumn('start_date'))this.setCellRenderer('start_date',new DateCellRenderer({render:function(cell,value){if(self.getRowAttribute(cell.rowIndex,'start_date_inherited')==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');DateCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('end_date'))this.setCellRenderer('end_date',new DateCellRenderer({render:function(cell,value){if(self.getRowAttribute(cell.rowIndex,'end_date_inherited')==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');DateCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('auto_budget')&&this.hasColumn('budget_periodicity'))this.setCellRenderer('budget_periodicity',new EnumCellRenderer({render:function(cell,value){if(self.getValueAt(cell.rowIndex,self.getColumnIndex('auto_budget'))==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('budget_fees'))this.setCellEditor('budget_fees',new NumberCellEditor("double",{getEditor:function(cell,value){var budget_periodicity=self.getValueAt(cell.rowIndex,self.getColumnIndex("budget_periodicity"));if(budget_periodicity=='none')return NumberCellEditor.prototype.getEditor.call(this,cell,value);self.viewBudgetCurrencyEntries('FEES',this,cell);}}));if(this.hasColumn('budget_costs'))this.setCellEditor('budget_costs',new NumberCellEditor("double",{getEditor:function(cell,value){var budget_periodicity=self.getValueAt(cell.rowIndex,self.getColumnIndex("budget_periodicity"));if(budget_periodicity=='none')return NumberCellEditor.prototype.getEditor.call(this,cell,value);self.viewBudgetCurrencyEntries('COSTS',this,cell);}}));for(var c=0;c<this.getColumnCount();c++)if(this.getColumnName(c).startsWith("budget-")){var id_user=self.getColumnName(c).substr(7);this.setHeaderRenderer(c,new CellRenderer({id_user:id_user,render:function(cell,value){var renderer=this;var response=$.evalJSON(value);if(self.getColumnCount()>=11)$(cell).html(response.initials).attr('title',response.fullname+'<br/>'+response.category+'<br/>'+response.tags).css('font-family','Courier').css('font-size','1.15em');else $(cell).html(response.fullname).attr('title',response.category+'<br/>'+response.tags).css('font-family','').css('font-size','');var report_link=$("<i class='fa fa-bar-chart-o'></i>").css('cursor','pointer').attr('title',translate("Budgets for next 6 months")).click(function(){var today=new Date();var param={id_user:renderer.id_user,show_all_trackers:'tree_matching',accumulate:1,level:1,maxcols:0,valuekey:'budget',id_unit:config.calendar.default_unit,groupkey:(config.company.mono_customer==1?'path_sort_relative_to_customer':['id_customer','path_sort_relative_to_customer']),pivotkey:'month',past_only:0,from:today.format('Y-m-01'),to:(new Date(today.getFullYear(),today.getMonth()+6,0)).format('Y-m-d')};router.navigate('/report/time/time/'+encodeURIComponent($.toJSON(param)),true);});$(cell).prepend(" ").prepend(report_link);}}));this.setCellRenderer(c,new NumberCellRenderer({id_user:id_user,render:function(cell,value){var access=self.getRowAttribute(cell.rowIndex,"access_by_user")[this.id_user];var access=access.user_access_value_inherited==1;var inherited=self.getValueAt(cell.rowIndex,self.getColumnIndex('auto_budget'))==1||!access||!value;$(cell).css('min-width','20px');NumberCellRenderer.prototype.render.call(this,cell,value?value:(access?0:'n/a'));$(cell).css('font-weight',!value?"normal":"bold");$(cell).css('text-decoration',!access&&value?'line-through':'none');if(inherited)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}));this.setCellEditor(c,new NumberCellEditor("double",{id_user:id_user,getEditor:function(cell,value){var budget_periodicity=self.getValueAt(cell.rowIndex,self.getColumnIndex("budget_periodicity"));if(budget_periodicity=='none')return NumberCellEditor.prototype.getEditor.call(this,cell,value);self.viewBudgetEntries(this.id_user,this,cell);}}));}};PlanningGrid.prototype.viewBudgetEntries=function(id_user,cellEditor,cell)
{var id_tracker=this.getRowId(cell.rowIndex);this.budgetEntryGrid.getParameters=function(){return{id_tracker:id_tracker,id_user:id_user};};this.budgetEntryGrid.fetch();this.viewBudgetDialog(cellEditor,cell);};PlanningGrid.prototype.viewBudgetCurrencyEntries=function(type,cellEditor,cell)
{var id_tracker=this.getRowId(cell.rowIndex);this.budgetCurrencyEntryGrid.getParameters=function(){return{id_tracker:id_tracker,type:type};};this.budgetCurrencyEntryGrid.fetch();this.viewBudgetDialog(cellEditor,cell);};PlanningGrid.prototype.viewBudgetDialog=function(cellEditor,cell)
{var self=this;$("#budget_entry_dialog").dialog({resizable:false,modal:!jQuery.browser.msie,width:400,title:translate("Budget entries"),beforeClose:function(event,ui){if(cell.isEditing)cellEditor.cancelEditing(cell);self.fetch();self.onChange();return true;},buttons:[{text:translate("OK"),click:function(){$(this).dialog('close');}}]});};;function PresenceGrid(name,config){if(name)this.init(name,config);}
PresenceGrid.prototype=new TimetrackEditableGrid();PresenceGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No entry found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No entry found matching your search criteria');config.controller='presence';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected entries ?',true)))self.deletePresence(ui.get('rows_checked'));});};PresenceGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('presences','delete'))return false;return true;};PresenceGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['projected_fees','projected_costs','id_status'])>=0;};PresenceGrid.prototype.getActions=function(cell,id_presence)
{var self=this;var actions=[];var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('presences','delete'))actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this entry ?',true)))self.deletePresence(id_presence);}});return actions;};PresenceGrid.prototype.tableLoaded=function()
{var self=this;this.setCellRenderer("filename",new CellRenderer({render:function(cell,filename){cell.innerHTML='<img src="'+baseUrl+'/images/filetype/'+(getFileExtension(filename)!=undefined?getFileExtension(filename):'unknown')+'.png" alt="">';if(isAllowed('files','view'))cell.innerHTML+="&nbsp;&nbsp;<a class=\"tooltip\" title=\"\" rel=\""+self.getRowId(cell.rowIndex)+"\" target='file' href=\""+baseUrl+"/file/file/id/"+self.getRowAttribute(cell.rowIndex,'id_file')+"/"+filename+"\">"+filename+"</a>\n";else cell.innerHTML+="&nbsp;&nbsp;"+value+"\n";}}));this.render();};PresenceGrid.prototype.deletePresence=function(id_presence)
{var self=this;showWait(translate("Deleting")+"...");_ajax('presence/delete',{id:id_presence}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the entry from database","Error");else{self.refresh();self.onChange();}});};PresenceGrid.prototype.copyPresence=function(id_presence)
{var self=this;showWait(translate("Copying")+"...");_ajax('presence/copy',{id:id_presence}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the entry from database","Error");else{self.refresh();self.onChange();}});};;function PresenceIndex(){}
PresenceIndex.prototype=new DefaultScreen();PresenceIndex.prototype.init=function()
{Number.prototype.pad=function(size){var s=String(this);while(s.length<(size||2)){s="0"+s;}
return s;};var self=this;this.grid=new PresenceGrid("PresenceGrid",{getParameters:function(){var parameter=PresenceGrid.prototype.getParameters.call(this);parameter.from=$('.searchfield.from').val();parameter.to=$('.searchfield.to').val();localset(this.name+'DateFrom',parameter.from);localset(this.name+'DateTo',parameter.to);return parameter;}});this.grid.onChange=function(){$("#calendar").datepicker("destroy");self.reloadCalendar();};if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));self.reloadCalendar();var uploader=new qq.FileUploader({element:$('#file-upload')[0],allowedExtensions:['jpg','jpeg','gif','png','pdf'],dropText:translate("Drop an image or PDF file here to upload it"),buttonText:"<span class='icon plus'></span>"+translate("Select image or PDF file"),action:baseUrl+'/ajax/presence/uploadfile?request={}',showMessage:jerror,onSubmitFiles:function(){showWait(translate("Uploading")+"...");},onComplete:function(_id,fileName,response){hideWait();ui.set('upload',{filename:fileName,id_file:response.id_file});$('#id_file').val(response.id_file);dlgButtons=$('div.add_presence').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("div.add_presence [mandatory]").each(function(){if(!$(this).val()){dlgButtons.attr('disabled','1').addClass('ui-state-disabled');}});}});ui.on('actionbar-add',function(){self.openDialog();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$("div.add_presence").dialog({width:680,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New entry"),buttons:[{text:translate("Add entry"),click:function(){if(self.add($('div.add_presence')))$(this).dialog('close');}}]});};PresenceIndex.prototype.countFilledInMonth=function(month,year)
{_ajax('presence/daysfilledinmonth',{month:month,year:year}).done(function(response){ui.set('daysinmonth',response.totalDays);ui.set('daysfilled',response.filled);});};PresenceIndex.prototype.reloadCalendar=function()
{var self=this;_ajax('presence/datesfilled').done(function(response){$('#calendar').datepicker({onChangeMonthYear:function(year,month){self.countFilledInMonth(month,year);},beforeShowDay:function(date){var selectable=true;var css;var dateStr=$.datepicker.formatDate('yy-mm-dd',date);var dateObj=new Date(dateStr);if($.inArray(dateStr,response)>-1)selectable=false;else if(dateObj.getDay()===6||dateObj.getDay()===0)selectable=false;else{selectable=true;css='not-completed';}
selectable=true;return[selectable,css,''];},onSelect:function(date){self.openDialog(date);}});var curMonth=$('#calendar').datepicker("getDate").getMonth()+1;var curYear=$('#calendar').datepicker("getDate").getFullYear();self.countFilledInMonth(curMonth,curYear);});};PresenceIndex.prototype.add=function(dialog)
{var self=this;showWait(translate("Creating entry")+"...");_ajax('presence/create',merge(this.parameters,{date:dialog.find('[name=date]').val(),id_file:dialog.find('[name=id_file]').val(),comment:dialog.find('[name=description]').val()})).done(function(response){hideWait();self.grid.refresh();$("#calendar").datepicker("destroy");self.reloadCalendar();});return true;};PresenceIndex.prototype.openDialog=function(date)
{var self=this;var today=new Date();date=date||ui.get('default_date');dlgButtons=$('div.add_presence').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$("div.add_presence textarea,div.add_presence input[type=password],div.add_presence input[type=text],div.add_presence select").val('');$("div.add_presence .datepicker").val('').datepicker({defaultDate:0,dateFormat:locale['date_format_jquery']}).val(date);ui.set('upload',null);dlgButtons.attr('disabled','1').addClass('ui-state-disabled');var updateButtonState=function(e){dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');$("div.add_presence [mandatory]").each(function(){if(!$(this).val()){dlgButtons.attr('disabled','1').addClass('ui-state-disabled');}});};$("div.add_presence [mandatory]").keyup(updateButtonState).change(updateButtonState);};;function PriceCategoryGrid(name,config){if(name)this.init(name,config);}
PriceCategoryGrid.prototype=new TimetrackEditableGrid();PriceCategoryGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No price category found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No price category found matching your search criteria');config.controller='pricecategoryhistory';TimetrackEditableGrid.prototype.init.call(this,name,config);};PriceCategoryGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){jinfo("You are not authorized to modify price categories.");return false;}
if(this.getColumnName(columnIndex)=="date_effect"&&!this.getRowAttribute(rowIndex,"_date_effect"))return false;return true;};PriceCategoryGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['date_effect','name'])>=0;};PriceCategoryGrid.prototype.getActions=function(cell,id_price_category_history)
{var self=this;var actions=[];if(isAllowed('configuration','edit')){actions.push({icon:img('customer_copytracker','copy',translate('Add a new line for this category')),click:function(){self.addHistory(id_price_category_history);}});if(this.getValueAt(cell.rowIndex,this.getColumnIndex("date_effect")))actions.push({icon:img('user_delete','delete','Delete history line'),click:function(){if(confirm(translate('Are you sure you want to delete this history line ?',true)))self.deletePriceCategoryHistory(id_price_category_history);}});else actions.push({active:this.getRowAttribute(cell.rowIndex,'is_only')==1,icon:img('user_delete','delete','Delete category'),click:function(){if(confirm(translate('Are you sure you want to delete this price category ?',true)))self.deletePriceCategory(self.getRowAttribute(cell.rowIndex,'id_price_category'));}});}
return actions;};PriceCategoryGrid.prototype.tableLoaded=function()
{var self=this;this.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));this.addCellValidator("date_effect",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("date_effect",new DateCellRenderer({render:function(cell,value){if(!value)$(cell).css('color','#AAA').html(translate("(since the beginning)"));else{$(cell).css('color','');DateCellRenderer.prototype.render.call(this,cell,value);}}}));if(this.hasColumn("unitary_price"))this.addCellValidator("unitary_price",new CellValidator({isValid:function(value){return parseFloat(value)>=0;}}));if(this.hasColumn("unitary_cost"))this.addCellValidator("unitary_cost",new CellValidator({isValid:function(value){return parseFloat(value)>=0;}}));this.render();};PriceCategoryGrid.prototype.deletePriceCategory=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('pricecategory/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the price category from database. Most common cause is that users are still associated with this category.","Error");else{self.refresh();self.onChange();}});};PriceCategoryGrid.prototype.deletePriceCategoryHistory=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('pricecategoryhistory/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the history line from database","Error");else{self.refresh();self.onChange();}});};PriceCategoryGrid.prototype.addHistory=function(id)
{var self=this;showWait(translate("Creating")+"...");_ajax('pricecategoryhistory/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while duplicating the history line from database","Error");else{self.refresh();self.onChange();}});};;function profile(){_$("savesettingsbutton").onclick=function(){_$('profile_form').submit();};$("#tabs").tabs().find(".ui-tabs-nav").sortable({axis:'x'});$('#profile_enable_icalvcs, #profile_enable_caldav').click(function()
{ajax('/profile/enablecaldav',{enable_icalvcs:$('#profile_enable_icalvcs').is(':checked'),enable_caldav:$('#profile_enable_caldav').is(':checked')},function(response){message(response.status,response.message);},"json");});this.changepassword=function(form)
{ajax('/profile/changepassword',{oldpwd:form.oldpassword?form.oldpassword.value:'',newpwd:form.newpassword.value,cnewpwd:form.cnewpassword.value},function(response){message(response.status,response.message);},"json");};};function PurchaseGrid(name,config){if(name)this.init(name,config);}
PurchaseGrid.prototype=new TimetrackEditableGrid();PurchaseGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No purchase found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No purchase found matching your search criteria');if(typeof config.tracker_enum_provider=='undefined')config.tracker_enum_provider='purchase/customertrackers';config.controller='purchase';TimetrackEditableGrid.prototype.init.call(this,name,config);ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected items ?',true)))self.deleteItem(ui.get('rows_checked'));});};PurchaseGrid.prototype.mustReload=function(rowIndex,columnIndex)
{};PurchaseGrid.prototype.isDeletable=function(rowIndex)
{if(this.hasColumn('purchase_status')){var purchase_status=this.getValueAt(rowIndex,this.getColumnIndex('purchase_status'));if(purchase_status=='booked')return false;}
return true;};PurchaseGrid.prototype.getActions=function(cell,id_item_entry)
{var self=this;var actions=[];var parameters=this.getParameters();var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('jobs','edit')){actions.push({icon:img('customer_copytracker','copy','Duplicate'),click:function(){self.copyItem(id_item_entry);}});actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this item ?',true)))self.deleteItem(id_item_entry);}});}
return actions;};PurchaseGrid.prototype.tableLoaded=function()
{var self=this;this.setCellRenderer('description',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Description")+' "'+self.getValueAt(cell.rowIndex,self.getColumnIndex('label'))+'"';}}));if(this.hasColumn("id_owner"))this.setCellRenderer('id_owner',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("id_supplier"))this.setCellRenderer('id_supplier',new EnumCellRenderer({render:function(cell,value){cell.style.color=!value?"#AAAAAA":"";EnumCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn('amount'))this.setCellRenderer('amount',new NumberCellRenderer({render:function(cell,value){cell.style.color=value===null||isNaN(value)?"#AAAAAA":"";NumberCellRenderer.prototype.render.call(this,cell,value);}}));if(this.hasColumn("id_job"))this.setCellRenderer('id_job',new EnumCellRenderer({render:function(cell,id_job){var label=this.getLabel(cell.rowIndex,id_job);cell.style.color=!id_job?"#AAAAAA":"";if(!isAllowed('jobs','view'))cell.innerHTML=label;cell.innerHTML=id_job?"<a class='customer_link tooltip' href='"+baseUrl+"/ui/job/"+id_job+"/job_item'>"+label+"</a>":label;$(cell).css('white-space','nowrap');}}));if(this.hasColumn('id_invoice'))this.setCellRenderer("id_invoice",new EnumCellRenderer({render:function(cell,id_invoice){var label=this.getLabel(cell.rowIndex,id_invoice);cell.style.color=!id_invoice?"#AAAAAA":"";if(!isAllowed('invoices','view'))cell.innerHTML=label;cell.innerHTML=id_invoice?"<a class='customer_link tooltip' target='_blank' href='"+baseUrl+"/ui/invoice/"+id_invoice+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');}}));if(this.hasColumn('purchase_status'))this.setCellRenderer("purchase_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');}}));if(this.hasColumn('purchase_status_action'))this.setCellRenderer("purchase_status_action",new EnumCellRenderer({render:function(cell,value){$(cell).html('');if(value!='booked'&&isAllowed('jobs','edit')){$(cell).append(img('fa-check-circle fa-2x green','validate','Validate'));$(cell).find('i').css("margin-left","5px").click(function(){self.validateItem(self.getRowId(cell.rowIndex));});}}}));this.render();};PurchaseGrid.prototype.validateItem=function(id_item_entry)
{var self=this;_ajax('itementry/validatepurchase',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while updating the item from database","Error");else{self.refresh();self.onChange();}});};PurchaseGrid.prototype.deleteItem=function(id_item_entry)
{var self=this;showWait(translate("Deleting")+"...");_ajax('itementry/delete',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the item from database","Error");else{self.refresh();self.onChange();}});};PurchaseGrid.prototype.copyItem=function(id_item_entry)
{var self=this;showWait(translate("Copying")+"...");_ajax('itementry/copy',{id:id_item_entry}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the item from database","Error");else{self.refresh();self.onChange();}});};;function PurchaseIndex(){}
PurchaseIndex.prototype=new DefaultScreen();PurchaseIndex.prototype.init=function()
{var self=this;this.grid=new PurchaseGrid("PurchaseGrid",{getParameters:function(){var parameter=PurchaseGrid.prototype.getParameters.call(this);parameter.id_owners=$('.owner_select').val()||[];parameter.id_statuses=$('.status_select').val()||[];parameter.id_job_statuses=$('.job_status_select').val()||[];return parameter;}});this.dialog=new ItemEntryDialog({url:'/index/purchasedialog',onAdd:function(){self.grid.onChange();self.grid.refresh();}});$('a.add').click(function(){self.dialog.open();});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){ui.set('parameters.id_statuses',$(this).val()||[]);self.grid.refresh();});$('.job_status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});};;function ReportIndex(){}
ReportIndex.prototype=new DefaultScreen();ReportIndex.prototype.showAsap=function(){return false;};ReportIndex.prototype.init=function(parameter)
{var self=this;graphAccordion=new GraphAccordion();graphAccordion.refresh=function(){return self.refresh().done(function(){self.select2();});};$('#reportdata').append($('<form>').attr({'id':'pdf_form','method':'POST','action':baseUrl+'/report/getpdf'}).append($('<input>').attr({'type':'hidden','name':'request'})).append($('<input>').attr({'type':'hidden','name':'image_data'})).append($('<input>').attr({'type':'hidden','name':'grid_data'})));$('#reportdata').append($('<form>').attr({'id':'xls_form','method':'POST','action':baseUrl+'/report/getxls'}).append($('<input>').attr({'type':'hidden','name':'request'})).append($('<input>').attr({'type':'hidden','name':'grid_data'})));$('#reportdata').append($('<form>').attr({'id':'csv_form','method':'POST','action':baseUrl+'/report/getcsv'}).append($('<input>').attr({'type':'hidden','name':'request'})));this.go(parameter);};ReportIndex.prototype.go=function(parameter)
{graphAccordion.categories=[];this.add_cambre_category();this.add_rtesian_category();this.add_ovinfo_category();if(locale.country=="BE")
this.add_belgium_category();if(ui.get('invoice_count')>0){if(isAllowed('reports','cat_amount'))this.add_amount_category();if(isAllowed('reports','cat_time_cost'))this.add_time_cost_category();}
else{if(isAllowed('reports','cat_time_cost'))this.add_time_cost_category();if(isAllowed('reports','cat_amount'))this.add_amount_category();}
if(isAllowed('reports','cat_customer')){graphAccordion.addCategory({label:translate('Customers'),category:"customer"},[{label:translate('Customers by tags'),id:"bytags",parameters:{groupkey:"bytags"}},{label:translate('Customers by country'),id:"bycountry",parameters:{groupkey:"bycountry"}},(isAllowed('timesheet','list')?{label:translate('Trackers by type'),id:"trackerbytype",parameters:{groupkey:"trackerbytype"}}:null)]);}
if(isAllowed('reports','cat_supplier')){graphAccordion.addCategory({label:translate('Suppliers'),category:"supplier"},[{label:translate('Suppliers by tags'),id:"bytags",parameters:{groupkey:"bytags"}},{label:translate('Suppliers by country'),id:"bycountry",parameters:{groupkey:"bycountry"}},]);}
for(var i=0;i<graphAccordion.categories.length;i++){var cat=graphAccordion.categories[i];for(var j=0;j<cat.charts.length;j++){var chart=cat.charts[j];chart.category=cat.category;if(typeof chart.classname=='undefined')chart.classname=cat.classname;chart.template=cat.template;}}
ui.set('categories',graphAccordion.categories);$('div.report_menu').accordion({heightStyle:'content',collapsible:true});this.select2();if(!parameter.id_report)graphAccordion.start();else graphAccordion.switchTo(parameter.category,parameter.id_report,parameter.params);};ReportIndex.prototype.select2=function()
{$('select.go-report').select2({width:400,formatNoMatches:translate("no match found"),placeholder:translate("Go to report")+'...'}).unbind('select2:select').bind('select2:select',function(){router.navigate($(this).val(),true);$(this).select2('val','');}).unbind('select2:open').bind('select2:open',function(){$('.select2-results').css('max-height','600px');$('.select2-results__options').css('max-height','500px');});$('select.go-xls').select2({width:400,formatNoMatches:translate("no match found"),placeholder:translate("Bookmarks - Direct Excel download")+'...'}).unbind('select2:select').bind('select2:select',function(){window.open($(this).val());$(this).select2('val','');}).unbind('select2:open').bind('select2:open',function(){$('.select2-results').css('max-height','600px');$('.select2-results__options').css('max-height','500px');});};ReportIndex.prototype.add_amount_category=function()
{graphAccordion.addCategory({label:translate('Profitability'),category:"amount",classname:"AmountPerfReport"},[{label:translate('Profitability'),id:"amount"}]);};ReportIndex.prototype.add_time_cost_category=function()
{graphAccordion.addCategory({label:translate('Time_Reports'),category:"time"},[{label:translate('Time_Reports'),id:"time",classname:"TimeReport"},{label:translate('Timesheet'),id:"timesheet",classname:"TimesheetReport"},{label:translate('Activity report'),id:"activityreport",classname:"ActivityReport"}]);};ReportIndex.prototype.add_cambre_category=function()
{var cat_cambre=[];if(isAllowed('reports','cat_cambre_staffhours'))cat_cambre.push({label:translate('Staff hours'),id:"staffhours",classname:"CambreStaffHours",parameters:{}});if(isAllowed('reports','cat_cambre_clienthours'))cat_cambre.push({label:translate('Client hours'),id:"clienthours",classname:"CambreClientHours",parameters:{}});if(isAllowed('reports','cat_cambre_clientcosts'))cat_cambre.push({label:translate('Client costs'),id:"clientcosts",classname:"CambreClientCosts",parameters:{}});if(isAllowed('reports','cat_cambre_budgetreconciliation'))cat_cambre.push({label:translate('Budget reconciliation'),id:"budgetreconciliation",classname:"CambreBudgetReconciliation",parameters:{}});if(isAllowed('reports','cat_cambre_budgetreconciliation'))cat_cambre.push({label:translate('Budget tracker (cumulative)'),id:"budgettracker",classname:"CambreBudgetTracker",parameters:{}});if(isAllowed('reports','cat_cambre_clientutility'))cat_cambre.push({label:translate('Client servicing level'),id:"clientutility",classname:"CambreClientUtility",parameters:{}});if(isAllowed('reports','cat_cambre_profitability'))cat_cambre.push({label:translate('Profitability (EBITDA)'),id:"profitability",classname:"CambreProfitability",parameters:{}});graphAccordion.addCategory({label:translate('Cambre'),category:"cambre"},cat_cambre);};ReportIndex.prototype.add_rtesian_category=function()
{var cat_rtesian=[];if(isAllowed('reports','cat_rtesian_jobstatus'))cat_rtesian.push({label:translate('Client report'),id:"jobstatus",classname:"RtesianJobStatus",parameters:{}});graphAccordion.addCategory({label:translate('Rtesian'),category:"rtesian"},cat_rtesian);};ReportIndex.prototype.add_ovinfo_category=function()
{var cat_ovinfo=[];if(isAllowed('reports','cat_ovinfo_last_activity'))cat_ovinfo.push({label:translate('Last activity'),id:"last_activity",classname:"BaseReport",parameters:{}});graphAccordion.addCategory({label:translate('OV Informatique'),category:"ovinfo"},cat_ovinfo);};ReportIndex.prototype.add_belgium_category=function()
{var cat_belgium=[];if(isAllowed('invoices','list'))cat_belgium.push({label:translate('Yearly VAT listing'),id:"yearly_vat_listing",classname:"BaseReport",parameters:{}});graphAccordion.addCategory({label:translate('BE'),category:"belgium"},cat_belgium);};;function ScheduleModule(id,allowEmptyDateFrom)
{this.id=id;this.allowEmptyDateFrom=allowEmptyDateFrom;this.repeater_select();this.grid=new TimetrackEditableGrid('checkDate');var self=this;this.find('.buttonset').buttonset();this.find(".datepicker").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,changeYear:true});this.find('input[name="repeater_'+this.id+'"]').change(function(){self.repeater_select();});this.find('input[name="repeater_month_'+this.id+'"]').change(function(){self.repeater_update_ui();});this.find('input[name=repeater_holiday_flag]').change(function(){self.repeater_update_ui();});this.find('input[name=repeater_month_each_cb]').change(function(){self.repeater_update_ui();});this.find('input[name=repeater_week_each_cb]').change(function(){self.repeater_update_ui();});}
ScheduleModule.prototype.find=function(selector)
{return $('table.schedule[rel="'+this.id+'"]').find(selector);};ScheduleModule.prototype.getPattern=function()
{var repeat_mode=this.find('input[name="repeater_'+this.id+'"]:checked').attr('checked',true).val();var repeat_each=1;if(repeat_mode==3&&this.find('input[name=repeater_week_each_cb]').is(':checked'))repeat_each=this.find('select[name=repeater_week_each]').val();if(repeat_mode==4&&this.find('input[name=repeater_month_each_cb]').is(':checked'))repeat_each=this.find('select[name=repeater_month_each]').val();if(repeat_mode==5&&this.find('input[name=repeater_year_each_cb]').is(':checked'))repeat_each=this.find('select[name=repeater_year_each]').val();var week_days='0000000';this.find("input[name='repeater_week[]']:checked").each(function(){week_days=week_days.replaceAt(parseInt($(this).val()),'1');});var d_from=this.grid.checkDate(this.find("input[name='dateinterval_from']").val());if(!this.allowEmptyDateFrom&&this.find("input[name='dateinterval_from']").is(':visible')&&this.find("input[name='dateinterval_from']").val()=='')return translate($('#repeater').val()>0?"Please enter the start date":"Please enter the date");if(this.find("input[name='dateinterval_from']").val()!=''&&!d_from.dbDate)return translate("Please enter the dates as")+" "+translate(locale['date_format_jquery']);var d_to=this.grid.checkDate(this.find("input[name='dateinterval_to']").val());if(repeat_mode>0&&this.find("input[name='dateinterval_to']").val()!=''&&!d_to.dbDate)return translate("Please enter the dates as")+" "+translate(locale['date_format_jquery']);return{repeat_mode:repeat_mode,from:(d_from.dbDate?d_from.dbDate:null),to:(d_to.dbDate?d_to.dbDate:null),hour:this.find("select[name='dateinterval_hour']").val(),minutes:this.find("select[name='dateinterval_minutes']").val(),repeat_each:repeat_each,week_days:week_days,month_day:(this.find('input[name="repeater_month_'+this.id+'"]:checked').val()==1?this.find('select[name=repeater_month_fixed]').val():''),month_rule:(this.find('input[name="repeater_month_'+this.id+'"]:checked').val()==2?this.find('select[name=repeater_month_rule_1]').val()+this.find('select[name=repeater_month_rule_2]').val():''),year_month:this.find('select[name=repeater_year_month]').val(),year_month_day:this.find('select[name=repeater_year_month_day]').val(),holiday_flag:(this.find('[name=repeater_holiday_flag]').is(':checked')?1:0),holiday_carryforward:this.find('[name=repeater_holiday_carryforward]').val()};};ScheduleModule.prototype.repeater_select=function()
{var repeat_mode=this.find('input[name="repeater_'+this.id+'"]:checked').val();var type='none';if(repeat_mode==3)type='week';else if(repeat_mode==4)type='month';else if(repeat_mode==5)type='year';for(_type in{any:1,any_2:1,week_row:1,week_row2:1,month_row:1,month_row2:1,year_row:1})this.find('.repeater_'+_type).css('display','none');this.find('.repeater_any').css('display','');if(type!='none')this.find('.repeater_any_2').css('display','');this.find('.repeater_'+type+'_row').css('display','');this.find('.repeater_'+type+'_row2').css('display','');this.find('span.label_dateinterval_from').html(translate((type=='none'?'on_date':translate('From'))));this.find('span.dateinterval_from_zone').css('display',(repeat_mode!='block')?"":"none");this.find('span.dateinterval_to_zone').css('display',(type!='none')?"":"none");this.repeater_update_ui();};ScheduleModule.prototype.repeater_update_ui=function()
{var repeat_mode=this.find('input[name="repeater_'+this.id+'"]:checked').val();this.find('[name=repeater_holiday_carryforward]').attr('disabled',this.find('[name=repeater_holiday_flag]').is(':checked'));this.find('select[name=repeater_week_each]').attr('disabled',(repeat_mode!=3||!this.find('input[name=repeater_week_each_cb]').is(':checked')));this.find('select[name=repeater_month_each]').attr('disabled',(repeat_mode!=4||!this.find('input[name=repeater_month_each_cb]').is(':checked')));this.find('select[name=repeater_year_each]').attr('disabled',(repeat_mode!=5||!this.find('input[name=repeater_year_each_cb]').is(':checked')));this.find('select[name=repeater_month_fixed]').attr('disabled',this.find('input[name="repeater_month_'+this.id+'"]:checked').val()==2);this.find('select[name=repeater_month_rule_1]').attr('disabled',this.find('input[name="repeater_month_'+this.id+'"]:checked').val()==1);this.find('select[name=repeater_month_rule_2]').attr('disabled',this.find('input[name="repeater_month_'+this.id+'"]:checked').val()==1);};function ScheduleCellEditor(url,update_url,config)
{this.url=url;this.update_url=update_url;this.init(config);}
ScheduleCellEditor.prototype=new DialogCellEditor();ScheduleCellEditor.prototype.init=function(config)
{DialogCellEditor.prototype.init.call(this,config);this.width=680;this.autoOpen=false;this.dialog=$('<div>');};ScheduleCellEditor.prototype.save=function(send)
{var self=this;var parameters={};this.dialog.find('form').populateParameters(parameters);};ScheduleCellEditor.prototype.create=function(cell,value)
{var self=this;var id=this.editablegrid.getRowId(cell.rowIndex);ajax(this.url,{id:id},function(response){self.dialog.html(response);self.module=new ScheduleModule(id,false);self.dialog.dialog('open');});};ScheduleCellEditor.prototype.open=function(cell,value)
{this.module.find('input:first').blur();};ScheduleCellEditor.prototype.getValue=function()
{return this.module.getPattern();};ScheduleCellEditor.prototype.applyEditing=function(cell,value)
{var self=this;if(typeof value=='string'){jalert(value);return false;}
_ajax(this.update_url,{id:this.module.id,pattern:value}).done(function(response){self.editablegrid.onChange();self.editablegrid.refresh();});return true;};;function SchedulerModule(){this.tinyMCE_initalized=false;this.tinyMCE_ids={};this.schedules={};this.setSaveNeeded=function(_saveNeeded){saveNeeded=_saveNeeded;if(saveNeeded)$("#scheduler_save_button").show();else $("#scheduler_save_button").hide();};this.enableSave=function(input){if(!input||($.inArray(input.name,[])==-1&&($(input.form).attr('name')!="addrule_form")&&($(input.form).attr('name')!="copyrule_form")&&($(input.form).attr('name')!="addcondition_form")&&($(input.form).attr('name')!="addaction_form")))this.setSaveNeeded(true);};this.enableSaveOnChange=function(parent)
{var self=this;parent.find('input[type=radio],select').change(function(){self.enableSave(this);});parent.find('input[type=checkbox]').click(function(){self.enableSave(this);});parent.find('input[type=text], input[type=password]').keypress(function(event){if($.inArray(event.keyCode,[37,38,39,40])==-1)self.enableSave(this);}).keydown(function(event){if(event.which==8)self.enableSave(this);}).bind('paste',function(event){self.enableSave(this);}).bind('change',function(event){self.enableSave(this);});};this.quickSave=function()
{if(saveNeeded)this.save(true);};this.addRule=function()
{this.quickSave();$('#scheduling_rules').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/addrule',{category:$("#addrule_form select[name='category']").val(),name:$("#addrule_form input[name='name']").val()},function(response)
{if(response=="ok"){message("success",translate("The rule has been successfully created."));$("#addrule_dialog").dialog("close");}
else message("error",response=="error"?translate("An error occured while creating the rule"):response);scheduler.loadRules();},"json");};this.copyRule=function()
{this.quickSave();$('#scheduling_rules').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/copyrule',{id_rule:$("#copyrule_dialog").attr('id_rule'),name:$("#copyrule_form input[name='name']").val()},function(response)
{if(response=="ok"){message("success",translate("The rule has been successfully duplicated."));$("#copyrule_dialog").dialog("close");}
else message("error",response=="error"?translate("An error occured while duplicating the rule"):response);scheduler.loadRules();},"json");};this.deleteRule=function(id_scheduling_rule)
{var self=this;jconfirm("Are you sure to delete this rule ?",null,null,function(){self.quickSave();if(self.tinyMCE_ids[id_scheduling_rule])for(id_action in self.tinyMCE_ids[id_scheduling_rule])for(paramName in self.tinyMCE_ids[id_scheduling_rule][id_action])tinymce.execCommand('mceRemoveEditor',false,self.tinyMCE_ids[id_scheduling_rule][id_action][paramName]);delete(self.tinyMCE_ids[id_scheduling_rule]);$('#scheduling_rules').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/deleterule',{id_scheduling_rule:id_scheduling_rule},function(response)
{if(response=="ok")message("success",translate("The rule has been successfully deleted."));else message("error",response=="error"?translate("An error occured while deleting the rule"):response);scheduler.loadRules();},"json");});};this.loadRules=function()
{var self=this;$('#scheduling_rules').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/rules?_html',{},function(response){self.enableSaveOnChange($('#scheduling_rules').html(response));$(".scheduling-rule>div").tabs();var renameRule=function(){if($(this).val()!=''&&$(this).parents('span').attr('backup')!=$(this).val()){var self=this;ajax('/config/renamerule',{id:$(this).parents('div').attr('rel'),name:$(this).val()},function(){$(self).parents('span').html($(self).val());$(".scheduling-rule>h3").unbind('click').click(editInPlace);});}
else{$(this).parents('span').html($(this).parents('span').attr('backup'));$(".scheduling-rule>h3").unbind('click').click(editInPlace);}};var editInPlace=function(){var span=$(this).unbind('click').find('span');var editInput=$('<input>').attr('size',64).val(span.html());span.attr('backup',span.html()).html(editInput).show();span.find('input').focus().select().blur(renameRule).keypress(function(event){var keycode=(event.keyCode?event.keyCode:event.which);if(keycode=='13')renameRule.call(this);});};$(".scheduling-rule>h3").unbind('click').click(editInPlace);$('a.copy_rule').click(function(){var id_rule=$(this).attr('rel');$('#copyrule_dialog').attr('id_rule',id_rule).dialog('open');;$("#copyrule_form input[name='name']").val($("#rule-"+id_rule+" h3 span").html()+' '+translate("(copy)")).focus();});$('table.schedule').each(function(){var id_rule=$(this).attr('rel');self.schedules[id_rule]=new ScheduleModule(id_rule,true);});var addconditionDialogButtons={};addconditionDialogButtons[translate("Apply")]=function(){scheduler.addCondition();};addconditionDialogButtons[translate("Cancel")]=function(){$(this).dialog('close');};$("#addcondition_dialog").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:addconditionDialogButtons,title:translate("Add condition")});$('.add_condition').click(function(){var id_scheduling_rule=$(this).attr('rel');ajax("/config/conditionids",{id_scheduling_rule:id_scheduling_rule},function(response){$("#addcondition_dialog").dialog('open');$("#addcondition_form input[name='name']").focus();$("#addcondition_form input[name='id_scheduling_rule']").val(id_scheduling_rule);$("#addcondition_form select[name='condition_id']").empty();for(var condition_id in response)$("#addcondition_form select[name='condition_id']").append($("<option>").attr('value',condition_id).html(response[condition_id]));},'json');});$("div.scheduling-rule").each(function(){self.loadConditions($(this).attr('rel'));});var addactionDialogButtons={};addactionDialogButtons[translate("Apply")]=function(){scheduler.addAction();};addactionDialogButtons[translate("Cancel")]=function(){$(this).dialog('close');};$("#addaction_dialog").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:addactionDialogButtons,title:translate("Add action")});$('.add_action').click(function(){var id_scheduling_rule=$(this).attr('rel');ajax("/config/actionids",{id_scheduling_rule:id_scheduling_rule},function(response){$("#addaction_dialog").dialog('open');$("#addaction_form input[name='name']").focus();$("#addaction_form input[name='id_scheduling_rule']").val(id_scheduling_rule);$("#addaction_form select[name='action_id']").empty();for(var action_id in response)$("#addaction_form select[name='action_id']").append($("<option>").attr('value',action_id).html(response[action_id]));},'json');});$("div.scheduling-rule").each(function(){self.loadActions($(this).attr('rel'));});});};this.loadConditions=function(id_scheduling_rule)
{var self=this;$('#tabs-rule-'+id_scheduling_rule+'-conditions .scheduling_conditions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/conditions?_html',{id_scheduling_rule:id_scheduling_rule},function(response){var conditionTab=$('#tabs-rule-'+id_scheduling_rule+'-conditions .scheduling_conditions');self.enableSaveOnChange(conditionTab.html(response));$("#tabs-rule-"+id_scheduling_rule+"-conditions select").select2({placeholder:translate("OPTION[dontcare]"),width:250,dropdownAutoWidth:true,minimumResultsForSearch:-1});var nbConditions=conditionTab.find('.scheduling-condition').size();$("#tabs-rule-"+id_scheduling_rule+"-conditions select[name='condition_operator']").css('display',nbConditions>=2?'':'none');});};this.addCondition=function()
{this.quickSave();var id_scheduling_rule=$("#addcondition_form input[name='id_scheduling_rule']").val();$('#tabs-rule-'+id_scheduling_rule+'-conditions .scheduling_conditions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/addcondition',{id_scheduling_rule:id_scheduling_rule,condition_id:$("#addcondition_form select[name='condition_id']").val()},function(response)
{if(response=="ok"){message("success",translate("The condition has been successfully created."));$("#addcondition_dialog").dialog("close");}
else message("error",response=="error"?translate("An error occured while creating the condition"):response);scheduler.loadConditions(id_scheduling_rule);},"json");};this.deleteCondition=function(id_scheduling_rule,id_scheduling_condition)
{var self=this;jconfirm("Are you sure to delete this condition ?",null,null,function(){self.quickSave();$('#tabs-rule-'+id_scheduling_rule+'-conditions .scheduling_conditions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/deletecondition',{id_scheduling_condition:id_scheduling_condition},function(response)
{if(response=="ok")message("success",translate("The condition has been successfully deleted."));else message("error",response=="error"?translate("An error occured while deleting the condition"):response);scheduler.loadConditions(id_scheduling_rule);},"json");});};this.loadActions=function(id_scheduling_rule)
{var self=this;if(self.tinyMCE_ids[id_scheduling_rule])for(id_action in self.tinyMCE_ids[id_scheduling_rule])for(paramName in self.tinyMCE_ids[id_scheduling_rule][id_action])tinymce.execCommand('mceRemoveEditor',false,self.tinyMCE_ids[id_scheduling_rule][id_action][paramName]);self.tinyMCE_ids[id_scheduling_rule]={};$('#tabs-rule-'+id_scheduling_rule+'-actions .scheduling_actions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/actions?_html',{id_scheduling_rule:id_scheduling_rule},function(response){self.enableSaveOnChange($('#tabs-rule-'+id_scheduling_rule+'-actions .scheduling_actions').html(response));$("#tabs-rule-"+id_scheduling_rule+"-actions select").select2({width:250,dropdownAutoWidth:true,minimumResultsForSearch:-1});if(typeof tinyMCE!='undefined'){var counter=0;$('#tabs-rule-'+id_scheduling_rule+'-actions .scheduling-action').each(function(){var id_action=$(this).attr('rel');self.tinyMCE_ids[id_scheduling_rule][id_action]={};$(this).find('input[type=text]').not('[name=max_executions]').css('width','450px');$(this).find('textarea').each(function(){if(!self.tinyMCE_initalized){self.tinyMCE_initalized=true;tinyMceInit(function(editor){editor.on('keypress',function(){self.enableSave();});editor.on('change',function(){self.enableSave();});});}
var paramName=$(this).attr('name');var textarea_id="textarea_"+id_action+"_"+paramName;$(this).attr('id',textarea_id).css('height','250px');tinymce.execCommand('mceAddEditor',false,textarea_id);self.tinyMCE_ids[id_scheduling_rule][id_action][paramName]=textarea_id;});});}});};this.addAction=function()
{this.quickSave();var id_scheduling_rule=$("#addaction_form input[name='id_scheduling_rule']").val();$('#tabs-rule-'+id_scheduling_rule+'-actions .scheduling_actions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/addaction',{id_scheduling_rule:id_scheduling_rule,action_id:$("#addaction_form select[name='action_id']").val()},function(response)
{if(response=="ok"){message("success",translate("The action has been successfully created."));$("#addaction_dialog").dialog("close");}
else message("error",response=="error"?translate("An error occured while creating the action"):response);scheduler.loadActions(id_scheduling_rule);},"json");};this.deleteAction=function(id_scheduling_rule,id_scheduling_action)
{var self=this;jconfirm("Are you sure to delete this action ?",null,null,function(){self.quickSave();$('#tabs-rule-'+id_scheduling_rule+'-actions .scheduling_actions').html("<center><br/>"+img('wait')+"<br/><br/></center>");ajax('/config/deleteaction',{id_scheduling_action:id_scheduling_action},function(response)
{if(response=="ok")message("success",translate("The action has been successfully deleted."));else message("error",response=="error"?translate("An error occured while deleting the action"):response);scheduler.loadActions(id_scheduling_rule);},"json");});};this.init=function()
{this.loadRules();$('#scheduler_save_button').click(function(){scheduler.save();});var addruleDialogButtons={};addruleDialogButtons[translate("Apply")]=function(){scheduler.addRule();};addruleDialogButtons[translate("Cancel")]=function(){$(this).dialog('close');};$("#addrule_dialog").dialog({width:550,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:addruleDialogButtons,title:translate("Add rule")});$('#add_rule').click(function(){$('#addrule_dialog').dialog('open');$("#addrule_form input[name='name']").focus();});var copyruleDialogButtons={};copyruleDialogButtons[translate("Apply")]=function(){scheduler.copyRule();};copyruleDialogButtons[translate("Cancel")]=function(){$(this).dialog('close');};$("#copyrule_dialog").dialog({width:550,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:copyruleDialogButtons,title:translate("Duplicate rule")});this.enableSaveOnChange($(document));if($.browser.msie)$('input.button:disabled').each(function(){$(this).addClass('disabled');this.disabled=false;});};this.save=function(noShowWait)
{var self=this;var error_found=false;var parameters_rule={};$('.scheduling-rule').each(function(){var id_rule=$(this).attr('rel');var pattern=self.schedules[id_rule].getPattern();if(typeof pattern=='string'){alert(pattern);error_found=true;return false;}
parameters_rule[id_rule]={'condition_operator':$(this).find("select[name='condition_operator']").val(),'active':$(this).find("input[name='active']").is(':checked'),'schedule':pattern};});if(error_found)return false;var parameters_condition={};$('.scheduling-rule .scheduling-condition').each(function(){var id_condition=$(this).attr('rel');parameters_condition[id_condition]={'invert':$(this).find("input[name='invert']").is(':checked')};$(this).find('form').populateParameters(parameters_condition[id_condition]);});var parameters_action={};$('.scheduling-rule .scheduling-action').each(function(){var id_action=$(this).attr('rel');parameters_action[id_action]={'max_executions':$(this).find("input[name='max_executions']").val()};$(this).find('form').populateParameters(parameters_action[id_action]);});for(id_scheduling_rule in self.tinyMCE_ids){for(id_action in self.tinyMCE_ids[id_scheduling_rule]){for(paramName in self.tinyMCE_ids[id_scheduling_rule][id_action]){parameters_action[id_action][paramName]=tinyMCE.get(self.tinyMCE_ids[id_scheduling_rule][id_action][paramName]).getContent();}}}
if(!noShowWait)showWait(translate("Saving scheduling rules"));ajax('/config/saverules',{parameters_rule:parameters_rule,parameters_condition:parameters_condition,parameters_action:parameters_action},function(response){message(response.status,response.message);self.setSaveNeeded(false);if(response.ruleActiveChanged)self.loadRules();hideWait();},"json");};this.toggleRule=function(button)
{var div=$(button).parents('div.scheduling-rule').find('div.rule-tab');if(div.is(':hidden')){div.slideDown('fast');$(button).html(translate('Hide'));}
else{div.slideUp('fast');$(button).html(translate('Show'));};};this.init();};function StaffcostGrid(name,config){if(name)this.init(name,config);}
StaffcostGrid.prototype=new TimetrackEditableGrid();StaffcostGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No cost found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No cost found matching your search criteria');config.controller='staffcost';TimetrackEditableGrid.prototype.init.call(this,name,config);};StaffcostGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['amount'])>=0;};;function StaffcostIndex(){}
StaffcostIndex.prototype=new DefaultScreen();StaffcostIndex.prototype.init=function()
{var self=this;$("select[name=year]").select2({width:100,minimumResultsForSearch:-1}).change(function(){router.navigate('/staffcost/index/'+$(this).val(),true);});this.grid=new StaffcostGrid("StaffcostGrid",{getParameters:function(){var parameter=StaffcostGrid.prototype.getParameters.call(this);parameter.year=ui.get('year');parameter.months=$('.month_select').val()||[];return parameter;}});$('.month_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose months")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Months"))}).on('multiselectclose',function(){self.grid.refresh();});ui.on('actionbar-copy-from-year',function(){$('div.copy_from_year_dialog').dialog({width:400,buttons:[{text:translate("OK"),click:function(){self.copyFromYear($('div.copy_from_year_dialog select[name=from_year]').val());$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});});};StaffcostIndex.prototype.copyFromYear=function(from_year)
{var self=this;showWait(translate("Copying from")+' '+from_year+"...");_ajax('staffcost/copyfromyear',merge(this.parameters,{year:ui.get('year'),from_year:from_year})).done(function(response){hideWait();self.grid.fetch();});return true;};;function SupplierForm(config)
{var self=this;for(var p in config)this[p]=config[p];$("#supplier_form_div").dialog({width:800,modal:!jQuery.browser.msie,autoOpen:false,resizable:false,buttons:[{text:translate("Save"),click:function(){self.saveSupplier(_$('supplier_form'));$(this).dialog("close");}}],open:function(event){tinymce.execCommand('mceAddEditor',false,'note');},close:function(event){tinymce.execCommand('mceRemoveEditor',false,'note');}});$("#supplier_form").submit(function(){if($("#supplier_form_div [name=name]").val()=='')return false;self.saveSupplier(_$('supplier_form'));$("#supplier_form_div").dialog("close");return false;});}
SupplierForm.prototype.onChange=function()
{};SupplierForm.prototype.open=function(id)
{var self=this;_ajax('supplier/get',id?{id:id}:null).done(function(response){if(!response)jerror("An error occured while retrieving supplier rom the database");else{var cform=_$('supplier_form');clear_form_elements(cform);$(cform.id).val(id?response.id:0);$(cform.name).val(response.name);$(cform.firstname).val(response.firstname);$(cform.title).val(response.title);$(cform.code).val(response.code);$(cform.id_bob).val(response.id_bob);$(cform.vat).val(response.vat);$(cform.adress).val(response.adress);$(cform.cp).val(response.cp);$(cform.city).val(response.city);$(cform.country).val(response.id_country);$(cform.legal_form).val(response.id_legalform);$(cform.email).val(response.email);$(cform.phone).val(response.phone);$(cform.id_vat_type).val(response.id_vat_type);$(cform.fax).val(response.fax);$(cform.note).val(response.note);$(cform.website).val(response.website);$(cform.iscompany).attr('checked',response.iscompany==1);$('#supplier_form_div').dialog('option','title',id?translate("Update supplier"):translate("Create supplier")).dialog('open');self.setupForm();}});};SupplierForm.prototype.setupForm=function()
{var self=this;this._updateFormState();$('#iscompany').click(function(){self._updateFormState();});$("#supplier_form_div [name=name]").keyup(function(e){self._updateFormState();});$("#supplier_form_div [name=name]").bind('paste',function(e){self._updateFormState();});$("#supplier_form_div [name=name]").focus();};SupplierForm.prototype._updateFormState=function()
{var dlgButtons=$('#supplier_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");if($("#supplier_form_div [name=name]").val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');if($('#iscompany').is(':checked')){$('#firstname,#title').attr('disabled','1').addClass('ui-state-disabled');$('#div_person').hide();}
else{$('#firstname,#title').removeAttr('disabled').removeClass('ui-state-disabled');$('#div_person').show();}};SupplierForm.prototype.saveSupplier=function(form)
{var self=this;var update=$(form.id).val()!="0";var action=update?"supplier/update":"supplier/create";showWait(translate(update?"Updating":"Creating")+"...");_ajax(action,{id:$(form.id).val(),name:$(form.name).val(),firstname:$(form.firstname).val(),title:$(form.title).val(),code:$(form.code).val(),vat:$(form.vat).val(),adress:$(form.adress).val(),cp:$(form.cp).val(),city:$(form.city).val(),id_country:$(form.country).val(),email:$(form.email).val(),phone:$(form.phone).val(),fax:$(form.fax).val(),note:tinyMCE.get(form.note.id).getContent(),website:$(form.website).val(),iscompany:$('#iscompany').is(':checked')?1:0}).done(function(response){hideWait();if(!response)jerror("An error occured while creating or updating the supplier in database","Error");else if(response.status)message("error",response.status);else{message("success",translate(update?translate("The supplier has been updated"):translate("The supplier has been created")));self.onChange();}});};;function SupplierGrid(name,config){if(name)this.init(name,config);}
SupplierGrid.prototype=new TimetrackEditableGrid();SupplierGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No supplier found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No supplier found matching your search criteria');config.controller='supplier';TimetrackEditableGrid.prototype.init.call(this,name,config);};SupplierGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('suppliers','edit')){jinfo("You are not authorized to modify suppliers.");return false;}
return true;};SupplierGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['archive'])>=0;};SupplierGrid.prototype.updatePaginator=function()
{var self=this;TimetrackEditableGrid.prototype.updatePaginator.call(this);$("a.tooltip").scrolltip({content:function(){var rowIndex=self.getRowIndex(this.parentNode.parentNode);return self.getRowAttribute(rowIndex,"note");}});};SupplierGrid.prototype.getActions=function(cell,id_supplier)
{var self=this;var actions=[];return actions;};SupplierGrid.prototype.tableLoaded=function()
{var self=this;this.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("id_country",new CellRenderer({render:function(cell,value){$(cell).html(value?"<img src='"+baseUrl+"/images/flags/"+value.toLowerCase()+".png' alt='"+value+"'/>":"");}}));this.setCellRenderer("name",new CellRenderer({render:function(cell,value){if(self.currentFilter){indexSearch=value.toLowerCase().indexOf(self.currentFilter);if(indexSearch>=0)value=value.substring(0,indexSearch)
+"<span class='searchhighlight'>"
+value.substring(indexSearch,indexSearch+self.currentFilter.length)
+"</span>"
+value.substring(indexSearch+self.currentFilter.length);}
if(isAllowed('suppliers','view'))value="<a title=\"\" class='supplier_link tooltip' href='"+baseUrl+"/ui/supplier/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>";CellRenderer.prototype.render.call(this,cell,value);}}));this.setCellRenderer("adress",new CellRenderer({render:function(cell,value){CellRenderer.prototype.render.call(this,cell,value);truncateCell(cell,48);}}));this.setCellRenderer("title",new CellRenderer({render:function(cell,value){if(typeof short_titles[value]!='undefined')value=short_titles[value];cell.innerHTML=value;}}));this.setCellRenderer("archive",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);if(value){$(cell.parentNode).addClass("archived");$(cell).addClass("archived");}
else{$(cell.parentNode).removeClass("archived");$(cell).removeClass("archived");}}}));this.getColumn("id_country").cellEditor.minWidth=200;this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No supplier tag was created yet. To create a supplier tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());this.render();};;function SupplierIndex(){}
SupplierIndex.prototype=new DefaultScreen();SupplierIndex.prototype.init=function()
{var self=this;$('select.id_supplier_change').change(function(){router.navigate('/supplier/'+$(this).val(),true);});this.form=new SupplierForm({onChange:function(){self.grid.refresh();}});$('.owner_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose owners")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Owners"))}).on('multiselectclose',function(){self.grid.refresh();});$('.tag_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose tags")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Tags"))}).on('multiselectclose',function(){self.grid.refresh();});this.grid=new SupplierGrid("SupplierGrid",{getParameters:function(){return{id_users:($('.owner_select').size()==0?null:($('.owner_select').val()||[])),id_tags:$('.tag_select').val()||[],hide_archived:$('input[name=hide_archived]').is(':checked')};},getActions:function(cell,id_supplier){var actions=SupplierGrid.prototype.getActions.call(this,cell,id_supplier);if(isAllowed('suppliers','edit'))actions.splice(0,0,{icon:img('supplier_edit','edit','Edit'),click:function(){self.form.open(id_supplier);}});if(isAllowed('suppliers','delete'))actions.push({icon:img('supplier_delete','delete','Delete'),click:function(){if(confirm(translate("Are you sure you want to delete this supplier ?")))self.deleteSupplier(id_supplier);}});return actions;}});$('input[name=hide_archived]').click(function(){self.grid.refresh();});ui.on('actionbar-add',function(){self.form.open();});$(document).jkey('alt+n',function(){self.showForm();});$("#transfer_supplier_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,title:translate("Delete supplier"),buttons:[{text:translate("OK"),click:function(){self.deleteSupplier($('#transfer_supplier_form [name=id_supplier]').val(),$('#transfer_supplier_form [name=id_target]').val());$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});};SupplierIndex.prototype.deleteSupplier=function(id,id_target)
{var self=this;showWait(translate("Deleting")+"...");_ajax('supplier/delete',{id:id,id_target:id_target}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the supplier from database","Error");else{self.grid.refresh();self.grid.onChange();}});};;function SupplierContact(){}
SupplierContact.prototype=new DefaultScreen();SupplierContact.prototype.init=function()
{var self=this;ui.set('panel',{title:translate('Contacts')});ui.set('filter',{hint:translate('name, email')});$('select.id_supplier_change').change(function(){router.navigate('/supplier/'+$(this).val()+'/contact',true);});this.form=new ContactForm(true,{id_supplier:ui.get('supplier.id'),onChange:function(){self.grid.refresh();}});this.grid=new ContactGrid("SupplierViewContactGrid",{getParameters:function(){return{id_supplier:ui.get('supplier.id')};},getActions:function(cell,id_contact){var actions=ContactGrid.prototype.getActions.call(this,cell,id_contact);if(isAllowed('suppliers','edit'))actions.splice(0,0,{icon:img('customer_edit','edit',translate('Edit')),click:function(){self.form.open(id_contact);}});return actions;}});$("a.add").click(function(){self.form.open();});};;function SupplierFile(){}
SupplierFile.prototype=new DefaultScreen();SupplierFile.prototype.init=function()
{var self=this;ui.set('panel',{title:translate('Files')});ui.set('filter',{hint:translate('filename')});$('select.id_supplier_change').change(function(){router.navigate('/supplier/'+$(this).val()+'/file',true);});this.fileBrowser=new FileBrowser("supplier");this.grid=this.fileBrowser.grid;};;function SupplierGeneral(){}
SupplierGeneral.prototype=new DefaultScreen();SupplierGeneral.prototype.init=function()
{var self=this;ui.set('panel',{title:translate('General informations')});$('select.id_supplier_change').change(function(){router.navigate('/supplier/'+$(this).val()+'/general',true);});this.form=new SupplierForm({onChange:function(){self.reload();}});ui.on('edit-supplier',function(){self.form.open(ui.get('supplier.id'));});};;function SupplierMap(){}
SupplierMap.prototype=new DefaultScreen();SupplierMap.prototype.needGoogleMaps=function(){return true;};SupplierMap.prototype.init=function()
{var self=this;$('select.id_supplier_change').change(function(){router.navigate('/supplier/'+$(this).val()+'/map',true);});$('#supplier_map').height(window_height()-192);var latlng=new google.maps.LatLng(-34.397,150.644);geocoder=new google.maps.Geocoder();geocoder.geocode({'address':ui.get('address')},function(results,status){if(status!=google.maps.GeocoderStatus.OK)feedback_message("Geocode failed with following status : "+status,'error');var waterColor="#d3d3d3";var stylez=[{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":waterColor}]},{"featureType":"transit","stylers":[{"color":"#808080"},{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"visibility":"on"},{"color":"#b3b3b3"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.local","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"weight":1.8}]},{"featureType":"road.local","elementType":"geometry.stroke","stylers":[{"color":"#d7d7d7"}]},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ebebeb"}]},{"featureType":"administrative","elementType":"geometry","stylers":[{"color":"#a7a7a7"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#efefef"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#696969"}]},{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"color":"#737373"}]},{"featureType":"poi","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.arterial","elementType":"geometry.stroke","stylers":[{"color":"#d6d6d6"}]},{"featureType":"road","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{},{"featureType":"poi","elementType":"geometry.fill","stylers":[{"color":"#dadada"}]}];var mapType=new google.maps.StyledMapType(stylez,{name:"Grayscale"});var mapOptions={zoom:13,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};var map=new google.maps.Map(_$("supplier_map"),mapOptions);map.mapTypes.set('tehgrayz',mapType);if(results){map.setCenter(results[0].geometry.location);var marker=new google.maps.Marker({map:map,position:results[0].geometry.location});var infowindow=new google.maps.InfoWindow({content:"<p>"+ui.get('address')+"</p>"});google.maps.event.addListener(marker,'click',function(){infowindow.open(map,marker);});}});};;function TaskIndex(){}
TaskIndex.prototype=new TaskPanel();TaskIndex.prototype.init=function()
{var self=this;this.timer=null;if(config.imap.method){console.info("Starting task auto refresh");self.timer=setInterval(function(){self.grid.refreshGrid();},30000);}
return TaskPanel.prototype.init.call(this,"TaskIndex");};TaskIndex.prototype.dispose=function()
{if(this.timer){console.info("Stopping task auto refresh");clearInterval(this.timer);}};;function TemplateGrid(name,config){if(name)this.init(name,config);}
TemplateGrid.prototype=new TimetrackEditableGrid();TemplateGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No template found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No template found matching your search criteria');config.controller='template';TimetrackEditableGrid.prototype.init.call(this,name,config);};TemplateGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('configuration','edit')){jinfo("You are not authorized to modify templates.");return false;}
if(!this.getRowAttribute(rowIndex,'id_parent')&&columnIndex==this.getColumnIndex('default_name'))return false;if(!this.getRowAttribute(rowIndex,'id_parent')&&columnIndex==this.getColumnIndex('tags'))return false;return true;};TemplateGrid.prototype.isDeletable=function(rowIndex)
{if(!isAllowed('configuration','edit'))return false;if(!this.getRowAttribute(rowIndex,'id_parent'))return false;return true;};TemplateGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),[])>=0;};TemplateGrid.prototype.getActions=function(cell,id_template)
{var self=this;var actions=[];if(isAllowed('configuration','edit'))
actions.push({icon:img('customer_copytracker','copy','Duplicate'),active:this.isDeletable(cell.rowIndex),click:function(){self.copyTemplate(id_template);}});if(isAllowed('configuration','edit'))
actions.push({icon:img('customer_deletetracker','delete','Delete'),active:this.isDeletable(cell.rowIndex),click:function(){if(confirm(translate('Are you sure you want to delete this template ? This will delete all associated trackers!',true)))self.deleteTemplate(id_template);}});return actions;};TemplateGrid.prototype.tableLoaded=function()
{var self=this;this.setCellRenderer("name",new CellRenderer({render:function(cell,value){if(!isAllowed('configuration','view'))$(cell).html(value);else $(cell).html(value?"<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/template/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>":"");}}));if(this.hasColumn('id_parent')){this.setEnumProvider("id_parent",new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var optionValues=null;_ajax('template/parenttemplatetrackers',{id_parent:self.getValueAt(rowIndex,self.getColumnIndex('id_parent'))},true).done(function(response){optionValues=response;});return optionValues;}}));}
if(this.hasColumn('tags')){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No tag was created yet. To create a tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
this.render();};TemplateGrid.prototype.copyTemplate=function(id)
{var self=this;showWait(translate("Copying")+"...");_ajax('template/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while copying the template from database","Error");else{self.refresh();self.onChange();}});};TemplateGrid.prototype.deleteTemplate=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('template/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the template from database","Error");else{self.refresh();self.onChange();}});};;function TemplateIndex(){}
TemplateIndex.prototype=new DefaultScreen();TemplateIndex.prototype.init=function()
{var self=this;this.grid=new TemplateGrid("TemplateGrid");$("#template_create_dialog").dialog({width:680,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("OK"),click:function(){if(self.add($('#template_create_dialog')))$(this).dialog("close");}},{text:translate("Cancel"),click:function(){$(this).dialog("close");}}]});$('a.button.add').unbind('click').click(function(event){event.preventDefault();event.stopPropagation();_ajax('defaulttracker/getlist').done(function(trackerPaths){$('#template_create_dialog [name=id_parent]').empty();for(var c=0;c<trackerPaths.length;c++){var target=trackerPaths[c];$('#template_create_dialog [name=id_parent]').append($("<option>").attr('value',target.id).html(htmlspecialchars(target.path)));}
_ajax('trackertype/getlist').done(function(trackerPaths){$('#template_create_dialog [name=id_type]').empty();for(var c=0;c<trackerPaths.length;c++){var target=trackerPaths[c];if(target.id>1)$('#template_create_dialog [name=id_type]').append($("<option>").attr('value',target.id).html(htmlspecialchars(target.name)));}
$('#template_create_dialog [name=name]').val('');$('#template_create_dialog').dialog('open');});});});};TemplateIndex.prototype.add=function(form)
{var id_parent=form.find('[name=id_parent]').val();var name=form.find('[name=name]').val();var tracker_id_type=form.find('[name=id_type]').val();var tracker_name=form.find('[name=name]').val();if(!id_parent){jalert(translate("No parent tracker selected!"));return false;}
var self=this;showWait(translate("Creating")+"...");_ajax('template/create',{name:name,id_parent:id_parent,tracker_name:tracker_name,tracker_id_type:tracker_id_type}).done(function(response){self.grid.refresh();self.grid.onChange();hideWait();});return true;};;function TemplateBilling(){};TemplateBilling.prototype=new DefaultScreen();TemplateBilling.prototype.init=function()
{var self=this;this.grid=new DefaultBillingGrid("TemplateBillingGrid",{getParameters:function(){return{id_template:ui.get('template.id')};}});};;function TemplateItemPattern(){};TemplateItemPattern.prototype=new DefaultScreen();TemplateItemPattern.prototype.init=function()
{var self=this;this.grid=new DefaultItemPatternGrid("TemplateItemPatternGrid",{getParameters:function(){return{id_template:ui.get('template.id')};}});this.dialog=new DefaultItemPatternDialog({parameters:{id_template:ui.get('template.id')},onAdd:function(){self.grid.onChange();self.grid.refresh();},onOpen:function(){if(!isAllowed('timesheet','list'))$('select#id_tracker').val(0).parent().hide();else $('select#id_tracker').parent().show();}});ui.on('actionbar-add',function(){self.dialog.open();});};;function TemplateTeam(){};TemplateTeam.prototype=new DefaultScreen();TemplateTeam.prototype.init=function()
{var self=this;this.grid=new DefaultTeamGrid("TemplateTeamGrid",{getParameters:function(){return{id_template:ui.get('template.id')};}});};;function TemplateTracker(){};TemplateTracker.prototype=new DefaultScreen();TemplateTracker.prototype.init=function()
{var self=this;ui.set('panel',{title:translate('Trackers')});this.trackerModule=new TrackerModule(0,"tablecontent","configuration");this.trackerModule.templateId=ui.get('template.id');trackerModule=this.trackerModule;ui.on('save-job-label',function(){_ajax('template/saveconfig',{job_label:config.tracker.job_label});});ui.on('save-job-title',function(){_ajax('template/saveconfig',{job_title:config.tracker.job_title});});ui.on('save-template-name',function(){_ajax('template/update',{id:ui.get('template.id'),name:ui.get('template.name')});});this.trackerModule.grid.fetch();};;var trackerSelector=null;function TimesheetExportModule()
{trackerSelector=new TrackerSelector({showTrackerAction:'/timesheet/showtrackers',getTimeInterval:function(){var interval=TrackerSelector.prototype.getTimeInterval.call(this);interval.options={filter:$('#tree_filter').val()};return interval;},renderUsers:function(result){var self=this;TrackerSelector.prototype.renderUsers.call(this,result);if($('#tree_filter').size()==0){var filter=$("<input>").attr('type','text').attr('id','tree_filter').css('width','200px').keyup(function(event){if(event.which==13)self.reload(false);});var div=$('<div style="clear:both">').css('text-align','right').css('margin-top','15px');$('#'+this.prefix+"users").after(div.append($("<p>").append(translate('Filter')+': ').append(filter)));if(logged_user_is_guest)div.hide();}},renderTrackers:function(result,selection,additionalTrackerIds){TrackerSelector.prototype.renderTrackers.call(this,result,selection,additionalTrackerIds);if($('#tree_filter').size()==0){var checkbox=$("<input>").attr('type','checkbox').attr('id','for_invoice').attr('checked',config.calendar.export_for_customer_by_default=='1'||logged_user_is_guest);var div=$('<div style="clear:both">').css('text-align','right').css('margin-top','15px');$('#'+this.prefix+"buttons").append(div.append($("<p>").append(checkbox).append(translate('For customer')+' ')));if(logged_user_is_guest)div.hide();}},renderText:function(node,info,trackerText){var text='';if(info)text+=(text==''?'':', ')+(info.users>1?info.users+' '+translate('users'):info.usernames);if(info)text+=(text==''?'':', ')+info.duration;if(text!='')trackerText+=' ('+text+')';return trackerText;},renderTooltip:function(node,info,tooltip){if(info){if(tooltip!='')tooltip+='<hr>';tooltip+=translate('Timesheet')+': <b>'+info.duration+'</b><br/>';tooltip+=translate('Users')+': '+(info.usernames?'<b>'+info.usernames+'</b>':'n/a')+'<br/>';}
return tooltip;}});ajax('/timesheet/getselector',null,function(result){$("#selector_calendar_content").html(result.content);if(!result.nothingmatching)trackerSelector.apply(_$(result.ts_start),_$(result.ts_end));},"json");$(".boxcontent").append($('<form>').attr({'id':'export_monthlytimesheet_form','method':'POST','action':baseUrl+'/timesheet/monthlytimesheet'}).append($('<input>').attr({'type':'hidden','name':'request'})));$(".boxcontent").append($('<form>').attr({'id':'export_activityreport_form','method':'POST','action':baseUrl+'/timesheet/activityreport'}).append($('<input>').attr({'type':'hidden','name':'request'})));$(".boxcontent").append($('<form>').attr({'id':'export_customactivityreport_form','method':'POST','action':baseUrl+'/timesheet/customreport'}).append($('<input>').attr({'type':'hidden','name':'request'})));}
TimesheetExportModule.prototype.exportTimesheet=function(event,format)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$('#export_monthlytimesheet_form').attr('target',event.ctrlKey||event.metaKey?'_blank':'monthlytimesheet');else $('#export_monthlytimesheet_form').removeAttr('target');var interval=trackerSelector.getTimeInterval();var paramObject={format:format,start:interval.start,end:interval.end,trackerIds:trackerSelector.getSelectedTrackers(),userIds:trackerSelector.getSelectedUsers(),forInvoice:$('#for_invoice').is(':checked')};$("#export_monthlytimesheet_form [name=request]").val($.toJSON(paramObject));$("#export_monthlytimesheet_form").submit();};TimesheetExportModule.prototype.exportActivityReport=function(event,format)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$('#export_activityreport_form').attr('target',event.ctrlKey||event.metaKey?'_blank':'activityreport');else $('#export_activityreport_form').removeAttr('target');var interval=trackerSelector.getTimeInterval();var paramObject={format:format,start:interval.start,end:interval.end,trackerIds:trackerSelector.getSelectedTrackers(),userIds:trackerSelector.getSelectedUsers(),forInvoice:$('#for_invoice').is(':checked')};$("#export_activityreport_form [name=request]").val($.toJSON(paramObject));$("#export_activityreport_form").submit();};TimesheetExportModule.prototype.customReport=function(event,format)
{if(config.ui.open_reports_in_new_tab==1||event.ctrlKey||event.metaKey)$('#export_activityreport_form').attr('target',event.ctrlKey||event.metaKey?'_blank':'activityreport');else $('#export_activityreport_form').removeAttr('target');var interval=trackerSelector.getTimeInterval();var paramObject={format:format,start:interval.start,end:interval.end,trackerIds:trackerSelector.getSelectedTrackers(),userIds:trackerSelector.getSelectedUsers()};$("#export_customactivityreport_form [name=request]").val($.toJSON(paramObject));$("#export_customactivityreport_form").submit();};;function TimesheetGrid(name,config){if(name)this.init(name,config);}
TimesheetGrid.prototype=new TimetrackEditableGrid();TimesheetGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No entry found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No entry found matching your search criteria');if(typeof config.tracker_enum_provider=='undefined')config.tracker_enum_provider='timesheet/customertrackers';config.controller='timesheet';TimetrackEditableGrid.prototype.init.call(this,name,config);};TimesheetGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('timesheet','edit')){jinfo("You are not authorized to modify entries.");return false;}
if(this.getRowAttribute(rowIndex,'locked')&&columnIndex!=this.getColumnIndex('invoice_status')&&columnIndex!=this.getColumnIndex('id_invoice')){jinfo("This block is locked.");return false;}
if(!isAllowed('users','edit_timesheet')){if(this.getValueAt(rowIndex,this.getColumnIndex('id_user'))!=id_logged_user){jinfo("You cannot modify somebody else's timesheet.");return false;}}
return true;};TimesheetGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['comment','comment_full'])<0;};TimesheetGrid.prototype.isColumnHideable=function(colIndex)
{return colIndex>=0&&trim(this.getColumnSelectorLabel(colIndex))!='';};TimesheetGrid.prototype.getColumnSelectorLabel=function(colIndex)
{if(this.getColumnName(colIndex)=='comment')return translate("Comment");if(this.getColumnName(colIndex)=='comment_full')return translate("Comment (full)");return trim(this.getColumnLabel(colIndex));};TimesheetGrid.prototype.getActions=function(cell,id_timesheet_entry)
{var self=this;var actions=[];if(isAllowed('timesheet','delete')&&!this.getRowAttribute(cell.rowIndex,'locked'))
actions.push({icon:img('customer_deletetracker','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this entry ?',true)))self.deleteEntry(id_timesheet_entry);}});return actions;};TimesheetGrid.prototype.tableLoaded=function()
{var self=this;var truncateCellRenderer=new CellRenderer({render:function(cell,value){$(cell).html(truncate(value,64));}});this.setCellRenderer("comment_full",truncateCellRenderer);this.setCellRenderer('comment',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',comment2html(value))).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));this.setCellEditor("comment_full",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Comment");}}));this.setCellEditor("comment",new TextAreaCellEditor({useTinyMce:false,getDialogTitle:function(cell,value){return translate("Comment");}}));if(this.hasColumn('id_tracker'))this.setCellRenderer("id_tracker",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).parent().css('color','#'+self.getRowAttribute(cell.rowIndex,"color"));}}));if(this.tracker_enum_provider)this.setEnumProvider("id_tracker",new EnumProvider({getOptionValuesForEdit:function(grid,column,rowIndex){var optionValues=null;_ajax(self.tracker_enum_provider,{id_tracker:self.getValueAt(rowIndex,column.columnIndex)},true).done(function(response){optionValues=response;});return optionValues;}}));this.setCellRenderer("hstart",new CellRenderer({render:function(cell,value){$(cell).html(self.getRowAttribute(cell.rowIndex,'hstart')+" &rarr; "+self.getRowAttribute(cell.rowIndex,'hend'));}}));this.setCellRenderer("date_start_formatted",new CellRenderer({render:function(cell,value){if(value==self.getRowAttribute(cell.rowIndex,'date_end_formatted')||self.getRowAttribute(cell.rowIndex,'hend')=='00:00')$(cell).html(value);else $(cell).html(value+" &rarr; "+self.getRowAttribute(cell.rowIndex,'date_end_formatted'));}}));if(this.hasColumn('invoice_status'))this.setCellRenderer("invoice_status",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');var invoice_status=self.getRowAttribute(cell.rowIndex,'invoice_status');if(invoice_status!='none')$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));if(this.hasColumn('id_invoice'))this.setCellRenderer("id_invoice",new EnumCellRenderer({render:function(cell,id_invoice){var label=this.getLabel(cell.rowIndex,id_invoice);if(!isAllowed('invoices','view'))cell.innerHTML=label;cell.innerHTML=id_invoice?"<a class='customer_link tooltip' target='_blank' href='"+baseUrl+"/ui/invoice/"+id_invoice+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');}}));if(this.hasColumn('base_unitary_price'))this.setCellRenderer('base_unitary_price',new NumberCellRenderer({render:function(cell,value){NumberCellRenderer.prototype.render.call(this,cell,value);if((self.getRowAttribute(cell.rowIndex,'time_billing')=='none'||self.getRowAttribute(cell.rowIndex,'invoiceable')!=1))$(cell).css('text-decoration','line-through');if(self.getRowAttribute(cell.rowIndex,'invoiceable')!=1)$(cell).attr("title",translate("This tracker is of a non invoiceable type"));else if(self.getRowAttribute(cell.rowIndex,'time_billing')=='none')$(cell).attr("title",translate("Time billing is not enabled on this tracker"));else $(cell).removeAttr("title");}}));if(this.hasColumn("quantity"))this.setCellRenderer("quantity",new NumberCellRenderer({render:function(cell,value){this.column.datatype="double("+self.getRowAttribute(cell.rowIndex,'unit')+")";self.parseColumnType(this.column);NumberCellRenderer.prototype.render.call(this,cell,value);EditableGrid.prototype.addClassName(cell,"number");if(self.getRowAttribute(cell.rowIndex,"quantity_set")==1)$(cell).removeClass('inherited');else $(cell).addClass('inherited');}}));this.render();};TimesheetGrid.prototype.deleteEntry=function(id)
{var self=this;showWait(translate("Deleting")+"...");var rowIndex=this.getRowIndex(id);var partial=this.getRowAttribute(rowIndex,'partial');var ts_start=this.getRowAttribute(rowIndex,'ts_start');var ts_end=this.getRowAttribute(rowIndex,'ts_end');_ajax('timesheet/delete',{id:id,partial_start:(parseInt(partial)==1||parseInt(partial)==3?parseInt(ts_start):0),partial_end:(parseInt(partial)==2||parseInt(partial)==3?parseInt(ts_end):0)}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the entry from database","Error");else{self.refresh();self.onChange();}});};;var trackerInfoByTreeNodeId={};var itemInfoByTreeNodeId={};var taskInfo={};var curdate='LASTDATE';var curmode='LASTMODE';var curnumber_day='LASTNUMBER';var curnumber_week='LASTNUMBER';var curnumber_month='LASTNUMBER';var curusers=null;var current_unit=null;var loggeduser=-1;var readonly=true;var serial=0;var blocks=null;var debug=false;var lastDropZone=null;var ts_errors='';var ts_warnings='';var ts_infos='';var scrollbarWidth=0;var table_column_header=null;var isDraggingOverBlock=0;var r_timeout=null;function feedback(message,append,stick){$('#user_message').css('background-color','').html((append?$('#user_message').html():"")+message).css('z-index',Math.max(100000,(blocks?blocks.zIndex+1:0))).show();if(!stick)$('#user_message').delay(1000).fadeOut('slow');}
function error(message,append,stick){$('#user_message').css('background-color','#DD0000').html((append?$('#user_message').html():"")+message).css('z-index',Math.max(100000,(blocks?blocks.zIndex+1:0))).show();if(!stick)$('#user_message').delay(1000).fadeOut('slow');}
function TimesheetIndex(){}
TimesheetIndex.prototype=new DefaultScreen();TimesheetIndex.prototype.showAsap=function(){return false;};TimesheetIndex.prototype.dispose=function()
{$('html').css('overflow-y','visible');$('body').css('overflow-y','auto');$("#content").css("padding-bottom",'');reset_window_resize();};TimesheetIndex.prototype.init=function(parameter)
{$('html').css('overflow-y','hidden');$('body').css('overflow-y','hidden');$("#content").css("padding-bottom",'1px');trackerInfoByTreeNodeId={};itemInfoByTreeNodeId={};taskInfo={};curdate='LASTDATE';curmode='LASTMODE';curnumber_day='LASTNUMBER';curnumber_week='LASTNUMBER';curnumber_month='LASTNUMBER';curusers=null;current_unit=null;loggeduser=-1;readonly=true;serial=0;blocks=null;lastDropZone=null;ts_errors='';ts_warnings='';ts_infos='';time_start=null;timer_infos='';scrollbarWidth=0;table_column_header=null;isDraggingOverBlock=0;r_timeout=null;scrollbarWidth=getScrollBarWidth();$('img.toggle').click(function(){calendarOnResize();});ui.on('quick-add-customer',function(){showQuickAdd(0);});ui.on('switch-left',function(event){var rel=$(event.node).attr('rel');$(".timesheet_selector").removeClass('current');$(event.node).addClass('current');$(".timesheet_component").addClass('hidden');$("#"+rel).removeClass('hidden');timesheet_adapt_result_height();localset('TimesheetSearchTab',rel);});timesheetList=new TimesheetList();$("#datepicker").datepicker({showOn:'button',buttonImage:imgpath('timesheet_gotodate'),buttonImageOnly:true,buttonText:translate('Go to a specific date'),dateFormat:"yy-mm-dd",changeMonth:true,changeYear:true,numberOfMonths:1,onSelect:function(date,inst){setDate(date);},beforeShow:function(){setTimeout(function(){$(".ui-datepicker").css("z-index",Math.max(100000,blocks.zIndex+1));},10);}});$("#edit_block_form_div").dialog({width:960,modal:false,autoOpen:false,title:translate("Timesheet entry details"),buttons:[{text:translate("Close"),click:function(){$(this).dialog('close');}},{text:translate("Save and close"),click:function(){saveBlockDetails(_$('edit_block_form'),true);}},{text:translate("Save"),click:function(){saveBlockDetails(_$('edit_block_form'));}}],open:function(){$('div.Block').each(function(){if(!this.locked)$(this).droppable("option","disabled",true);});},close:function(){$('div.Block').each(function(){if(!this.locked)$(this).droppable("option","disabled",false);});},resize:function(event,ui){$('#comment').height(ui.size.height-differenceBetweenDialogAndTextArea);},resizeStart:function(event,ui){if(typeof differenceBetweenDialogAndTextArea=='undefined')differenceBetweenDialogAndTextArea=ui.size.height-$('#comment').height();}});$("#dialog_quick_add").dialog({resizable:false,resize:true,width:400,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Confirm"),click:function(){quickaddCustomerOrTracker();}},{text:translate("Cancel"),click:function(){$(this).dialog('close');}}],title:""});$("#edit_block_form_div").find("input[type=text], textarea").keydown(function(event){var _key=String.fromCharCode(event.which).toLowerCase();if(((event.ctrlKey||event.metaKey)&&_key=='s')||event.which==19){event.preventDefault();saveBlockDetails(_$('edit_block_form'));}
else if($.inArray(event.keyCode,[37,38,39,40])==-1)setEditBlockDialogSaveEnabled(true);}).keydown(function(event){if(event.which==8)setEditBlockDialogSaveEnabled(true);}).bind('paste',function(event){setEditBlockDialogSaveEnabled(true);});$("#edit_block_form_div select").change(function(event){setEditBlockDialogSaveEnabled(true);});if(skin=="modern")$("#ui-datepicker-div").css('display','none');spinnerChange=function(event){var nbUnits=parseInt($("#number_spinner").val());if(!isNaN(nbUnits)&&nbUnits>0&&nbUnits!=curnumber()){$("#number_spinner").spinner('disable');setNumber(nbUnits);}};$("#number_spinner").spinner({max:15,min:1,change:spinnerChange,stop:spinnerChange});blocks=new Blocks('blocks',{moveEnabled:function(block){return!block.locked&&!readonly&&block.block_id>0;},resizeEnabled:function(block){return!block.locked&&!readonly;},formatBlock:formatBlock,populatePopupMenu:populatePopupMenu,handleDragEvent:handleDragEvent,blockCreated:blockCreated,blockCloned:blockCloned,allowOverlap:config.calendar.allowoverlap==1});blocks.addButton(new Button('split-columns',{tooltip:translate("Split block in columns"),isVisible:function(block,isShowing){return isShowing&&!block.locked&&!readonly&&block.block_id>0&&blocks.getWidthInGrid(block)>1;},actionPerformed:function(block){deleteBlock(block,function(block){blocks.splitBlockInColumns(block);});}}));blocks.addButton(new Button('delete',{tooltip:translate("Delete block"),isVisible:function(block,isShowing){return isShowing&&!block.locked&&!readonly&&block.block_id>0;},actionPerformed:function(block){if(confirm(translate("Are you sure you want to delete this block ?")))deleteBlock(block,function(block){blocks.deleteBlock(block);});}}));blocks.addButton(new Button('lock',{tooltip:translate("This block is locked"),isVisible:function(block,isShowing){return isShowing&&(block.locked||readonly);}}));blocks.addButton(new Button('note',{tooltip:translate("Edit entry's note"),isVisible:function(block,isShowing){return block.comment!=null;},actionPerformed:function(block){showEditBlockDialog(block);}}));itemGrid=new ItemEntryGrid("TimesheetItemGrid",{container_id:'tablecontent-item',actionbar:$('#tabs-edit-block-items .actionbar'),statusbar:null,getParameters:function(){return{blockId:this.id_block,pageSize:8};},onChange:function(){$(this.block.content).removeData("ajax_tooltip");},tableLoaded:function(){var self=this;ItemEntryGrid.prototype.tableLoaded.call(this);$('#tablecontent-item').parent().droppable({accept:'#tree_items .dTreeNode',tolerance:'pointer',greedy:true,hoverClass:'HoveredBlock',drop:function(event,ui){onDropItemGrid(ui.draggable.get(0),self);}});}});updateCalendar(null,'LASTDATE','LASTMODE','LASTNUMBER','setdate');$("#timesheet_tracker_div .searchfield").attr('id','searchfield');$("#timesheet_tracker_div .searchfield").on('keyup',function(event){validateSearch(event);});$("#timesheet_tracker_div .searchfield_go").on('click',function(){search();});$("#timesheet_tracker_div .searchfield_clear").on('click',function(){$(this).siblings('.searchfield').val('');search();});$("#timesheet_item_div .searchfield").attr('id','searchfield_items');$("#timesheet_item_div .searchfield").on('keyup',function(event){validateSearch(event,'_items');});$("#timesheet_item_div .searchfield_go").on('click',function(){search('_items');});$("#timesheet_item_div .searchfield_clear").on('click',function(){$(this).siblings('.searchfield').val('');search('_items');});$("#timesheet_task_div .searchfield").on('keyup',function(event){var event=event||window.event;if(event.keyCode==13)return loadTasks();});$("#timesheet_task_div .searchfield_go").on('click',function(){loadTasks();});$("#timesheet_task_div .searchfield_clear").on('click',function(){$(this).siblings('.searchfield').val('');loadTasks();});$('a.task-reload').click(loadTasks);$('a.task-add').click(createTask);$('#searchfield').focus();search('_items');if(localisset('TimesheetSearchTab')){var rel=localget('TimesheetSearchTab');$(".timesheet_selector").removeClass('current');$("a[rel="+rel+"]").addClass('current');$(".timesheet_component").addClass('hidden');$("#"+rel).removeClass('hidden');}};function loadTasks()
{return _loadTasks($("#timesheet_task_div .searchfield").val());};function _loadTasks(filter)
{if(!isAllowed('tasks','list'))return false;unmakeTasksDraggable();$('#timesheet_task_div div.phtml').html("<center><br/>"+img('wait')+"<br/>"+translate('Searching...')+"</center>");ajax('/timesheet/tasks',{filter:filter},function(response){taskInfo=response.taskInfo;$('#timesheet_task_div div.phtml').html(response.html);if(isAllowed('tasks','edit'))$('div.task_actions a.done').click(function(){editTask($(this).parents('li').attr('rel'),true);});if(isAllowed('tasks','view'))$('#timesheet_task_div li').unbind('dblclick').dblclick(function(){editTask($(this).attr('rel'));});makeTasksDraggable();},'json');}
function createTask()
{new TaskEditor({afterSave:loadTasks}).open();}
function editTask(id_task,forceEdit)
{new TaskEditor({id_task:id_task,forceEdit:forceEdit,afterSave:loadTasks}).open();}
function formatBlock(block,elmX,elmY,elmW,elmH)
{if(elmW>1){block.style.left=elmX+'px';block.style.width=elmW+'px';}
if(elmH>0){block.style.top=elmY+'px';block.style.height=elmH+'px';formatBlockContent(block);}}
function formatBlockContent(block)
{if(block.content){var contentPadding=Math.floor(parseInt(block.style.height)*0.30);$(block.content).css({'padding-left':'5px','padding-right':'5px','padding-top':contentPadding+'px','max-height':(parseInt(block.style.height)-contentPadding)+'px'});}}
function populatePopupMenu(popupMenu,block,mouseX,mouseY,mouseRowIndex,mouseColIndex)
{if(block&&block.block_id>0&&isAllowed('timesheet','edit'))popupMenu.addMenuItem(translate("Edit block")+"...",function(block){showEditBlockDialog(block);});if(block&&block.block_id>0&&!block.locked&&!readonly)popupMenu.addMenuItem(translate("Delete"),function(block){deleteBlock(block,function(block){blocks.deleteBlock(block);});});var canCut=block&&block.block_id>0&&!readonly&&!block.locked;var canCopy=block&&block.block_id>0&&!readonly;var canPaste=!readonly;blocks.addCopyPasteEntriesInPopupMenu(popupMenu,block,mouseX,mouseY,mouseRowIndex,mouseColIndex,canCut,canCopy,canPaste,translate("Cut"),translate("Copy"),translate("Paste"),translate("(cannot paste here)"));if(block)popupMenu.addMenuItem(translate("Send to back"),function(block){blocks.sendToBack(block);});if(block&&(isAllowed('customers','view')&&(block.locked&&isAllowed('invoices','view'))))popupMenu.addMenuItem('<hr>');if(block&&isAllowed('customers','view'))popupMenu.addMenuItem(translate("View customer"),null,null,baseUrl+"/ui/customer/tracker/"+block.tracker_id);if(block&&block.locked&&isAllowed('invoices','view'))popupMenu.addMenuItem(translate("View invoice"),null,null,baseUrl+"/ui/invoice/block/"+block.block_id);if(block&&isAllowed('reports','view')&&isAllowed('reports','cat_time_cost')){var boundsInGrid=blocks.getBlockBoundsInGrid(block);if(boundsInGrid!=null&&boundsInGrid.cell_tl!=null||boundsInGrid.cell_br!=null){var id_user=getCellUserId(boundsInGrid.cell_tl);var today=new Date();var param=merge({},{id_user:id_user,matrixmode:'pivot_first',maxcols:0,valuekey:'hours,budget',id_unit:config.calendar.default_unit,groupkey:(config.company.mono_customer==1?'path_sort_relative_to_customer':['id_customer','path_sort_relative_to_customer']),pivotkey:'month'});var paramPlanned=merge(param,{past_only:0,from:today.format('Y-m-01'),to:(new Date(today.getFullYear(),today.getMonth()+6,0)).format('Y-m-d')});var paramWorked=merge(param,{past_only:1,from:(new Date(today.getFullYear(),today.getMonth()-5,0)).format('Y-m-01'),to:''});popupMenu.addMenuItem(' <hr>');popupMenu.addMenuItem(translate("Worked vs. budget for last 6 months"),null,null,baseUrl+"/ui/report/time/time/"+encodeURIComponent($.toJSON(paramWorked)),"timesheet_time_report");popupMenu.addMenuItem(translate("Planned vs. budgets for next 6 months"),null,null,baseUrl+"/ui/report/time/time/"+encodeURIComponent($.toJSON(paramPlanned)),"timesheet_time_report");}}}
function handleDragEvent(block,eventType,isSnapping)
{$(block.content).tooltipster('hide');if(eventType==DragEvent_DRAGMOVE||eventType==DragEvent_DRAGRESIZE){if(isSnapping)setBlockContent(block,false);}
else if(eventType==DragEvent_DRAGEND&&blocks.hasMoved){setBlockContent(block,true);updateBlock(block);}}
function setBlockContent(block,tooltip,ts)
{var tz_offset_start=block.tz_offset_start;var tz_offset_end=block.tz_offset_end;if(!ts){var boundsInGrid=blocks.getBlockBoundsInGrid(block,"y");if(boundsInGrid==null||boundsInGrid.cell_tl==null||boundsInGrid.cell_br==null){ts={};ts_warnings+='<p style="color:orange">[WARNING] Could not find dates for block '+block.block_id+'</p>';}
else{ts={start:parseInt(boundsInGrid.cell_tl.id),end:parseInt(boundsInGrid.cell_br.id)+current_unit};tz_offset_start=parseInt($(boundsInGrid.cell_tl).attr('tzo'));tz_offset_end=parseInt($(boundsInGrid.cell_br).attr('tzo'));}}
var date_start=getDate(ts.start,tz_offset_start);var date_end=getDate(ts.end,tz_offset_end);if(tooltip){var min_start=date_start.getUTCHours()*60+date_start.getUTCMinutes();var min_end=date_end.getUTCHours()*60+date_end.getUTCMinutes();if(min_end<min_start)min_end+=24*60;if(min_start==min_end){var sec_start=date_start.getHours()*3600+date_start.getUTCMinutes()*60+date_start.getUTCSeconds();var sec_end=date_end.getHours()*3600+date_end.getUTCMinutes()*60+date_end.getUTCSeconds();var blockSurface=(sec_end-sec_start)*blocks.getWidthInGrid(block);var blockDuration=blockSurface?Math.floor(blockSurface/60)+"m"+pad(''+(blockSurface%60),2,'0'):'?';}
else{var blockSurface=(min_end-min_start)*blocks.getWidthInGrid(block);var blockDuration=blockSurface?Math.floor(blockSurface/60)+"h"+pad(''+(blockSurface%60),2,'0'):'?';}}
var blockTimeInterval=(ts.start?getUTCTimeInDay(date_start):'?')+' - '+(ts.end?getUTCTimeInDay(date_end):'?');$(block.content).html(block.tracker_path+(block.task_id?(isAllowed('tasks','view')?' <a class="task" href="javascript:editTask('+block.task_id+')">[#'+block.task_id+']</a>':' [#'+block.task_id+']'):'')+"<br/><b>"+blockTimeInterval+'</b>');if(tooltip){$(block.content).data("tooltip_title",(debug?"["+block.block_id+"] ":"")+blockTimeInterval+" = <b>"+blockDuration+"</b><p>"+block.tracker_path+"</p>");$(block.content).tooltipster('destroy').tooltipster({theme:'tooltipster-noir',delay:500,functionBefore:function(origin,continueTooltip){if(!origin.data('ajax_tooltip')){ajax('/timesheet/tooltip?_html',{id_block:block.block_id},function(response){origin.tooltipster('update',origin.data("tooltip_title")+response).data('ajax_tooltip',response);continueTooltip();});}
else{origin.tooltipster('update',origin.data("tooltip_title")+origin.data('ajax_tooltip'));continueTooltip();}}});}
var bgColor=dimColor(block.locked?combineColors(block.customer_color,{red:255,green:255,blue:255},.3):readonly?combineColors(block.customer_color,{red:200,green:200,blue:200},.3):block.customer_color,0.95);block.style.backgroundColor=cssColor(bgColor);block.style.color=cssColor(dimColor(getFrontColor(bgColor,0.2),0.60));}
function reconnectDuplicateBlocks(block,id_block_before,id_block_after)
{if(id_block_before>0||id_block_after>0){var blockList=blocks.getBlocks();for(var i=0;i<blockList.length;i++){if(!blockList[i].ts_start||blockList[i]==block||blockList[i].block_id!=block.block_id)continue;if(blockList[i].ts_start<block.partial_start&&id_block_before>0)blockList[i].block_id=id_block_before;if(blockList[i].ts_start>block.partial_start&&id_block_after>0)blockList[i].block_id=id_block_after;if(debug)feedback("<br/>Splitting occured: other block "+block.block_id+" changed to "+blockList[i].block_id,true);}}}
function updateTotals()
{ajax('/timesheet/totals',{},function(response){$('#timesheet_calendar_column_header th span').each(function(){if($(this).attr('rel')in response)$(this).html(" ("+response[$(this).attr('rel')]+")");else $(this).html("");});var empiricAdapt=$.browser.mozilla||($.browser.msie&&$.browser.version.substr(0,1)=="8")?-1:0;$('#timesheet_calendar_row_header').css("margin-top",(table_column_header.offsetHeight+empiricAdapt)+'px');},'json');}
function getCellUserId(cell)
{var id_parts=cell.id.split('_');return id_parts[1];}
function updateBlock(block,new_id_tracker,new_id_task)
{var boundsInGrid=blocks.getBlockBoundsInGrid(block);if(boundsInGrid==null||boundsInGrid.cell_tl==null||boundsInGrid.cell_br==null){feedback('<p style="color:orange">[WARNING] Could not find dates for block '+block.block_id+'</p>');return false;}
var breaks=[];for(var c=boundsInGrid.c1;c<boundsInGrid.c2;c++){var cell=blocks.getCellAtRC(boundsInGrid.r1,c);if(cell.hasAttribute?cell.hasAttribute('break'):cell.getAttribute('break'))breaks.push(cell);}
if(breaks.length>0){var bounds=blocks.getBlockBounds(block);for(var i=0;i<breaks.length;i++)blocks.copyBlockInGrid(block,boundsInGrid.r1,breaks[i].c+1,boundsInGrid.r2,i<breaks.length-1?breaks[i+1].c:boundsInGrid.c2,false);this.formatBlock(block,bounds.x,bounds.y,breaks[0].x2-bounds.x,bounds.h);boundsInGrid=blocks.getBlockBoundsInGrid(block);blocks.deselect(true);}
if(new_id_tracker){$(block.content).removeData("ajax_tooltip");}
ajax(block.block_id>0?'/timesheet/update':'/timesheet/insert',{id:block.block_id,id_user:getCellUserId(boundsInGrid.cell_tl),id_user_other:getCellUserId(boundsInGrid.cell_br),id_tracker:new_id_tracker||block.tracker_id,id_task:new_id_task||block.task_id,start:parseInt(boundsInGrid.cell_tl.id),end:parseInt(boundsInGrid.cell_br.id)+current_unit,partial_start:block.partial_start,partial_end:block.partial_end,comment:block.comment,copy_quantity_from:block.block_id==0&&block.source_block_id?block.source_block_id:0},function(response){feedback(response.message);var is_new_block=(block.block_id==0);block.block_id=response.id;updateTotals();if(response.veto){if(is_new_block)blocks.deleteBlock(block);else{var bounds=getBlockBounds(response.ts_start,response.ts_end,response.id_user);if(bounds)blocks.formatBlock(block,bounds.x1,bounds.y1,bounds.x2-bounds.x1,bounds.y2-bounds.y1);block.ts_start=parseInt(response.ts_start);block.ts_end=parseInt(response.ts_end);block.tz_offset_start=parseInt(response.tz_offset_start);block.tz_offset_end=parseInt(response.tz_offset_end);setBlockContent(block,true,{start:block.ts_start,end:block.ts_end});blocks.deselect(true);}
jinfo(response.message);}
else if(response.block){block.customer_id=response.block.id_customer;block.tracker_id=response.block.id_tracker;block.task_id=response.block.id_task;block.tracker_path=response.block.path;block.tracker_type=response.block.type;block.customer_color=toRGB(response.block.color);block.locked=response.block.locked;_updateComment(block,response.block.comment);block.tz_offset_start=parseInt(response.tz_offset_start);block.tz_offset_end=parseInt(response.tz_offset_end);setBlockContent(block,true,{start:response.block.ts_start,end:response.block.ts_end});if(is_new_block){if(response.block.available_tags.length>0&&config.calendar.tag_mandatory==1){showEditBlockDialog(block,0,true);}}}
reconnectDuplicateBlocks(block,response.id_block_before,response.id_block_after);block.partial_start=0;block.partial_end=0;if(debug)setBlockContent(block,true);},"json");}
function deleteBlock(block,after)
{syncAjax('/timesheet/delete',{id:block.block_id,partial_start:block.partial_start,partial_end:block.partial_end},function(response){if(!response.ok)error(response.message);else{updateTotals();feedback(response.message);reconnectDuplicateBlocks(block,response.id_block_before,response.id_block_after);if(after)after(block);}},"json");}
function setEditBlockDialogSaveEnabled(enabled)
{$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button").removeClass('ui-state-focus');if(enabled){$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:last").removeClass('ui-state-disabled').show();$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:nth-child(2)").removeClass('ui-state-disabled').show();$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:first").addClass('ui-state-disabled').hide();}
else{$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:last").addClass('ui-state-disabled').hide();$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:nth-child(2)").addClass('ui-state-disabled').hide();$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button:first").removeClass('ui-state-disabled').show();}}
function showEditBlockDialog(block,activeTabIndex,forceSaveEnabled)
{if(block.block_id<=0)return false;$(block.content).tooltipster('hide');ajax('/timesheet/getblockdetails',{id:block.block_id},function(details){$(block.content).removeData("ajax_tooltip");setEditBlockDialogSaveEnabled(forceSaveEnabled||false);$("#edit_block_form_div").dialog('open').dialog('moveToTop');$('.ui-front').css("z-index",Math.max(1000,blocks.zIndex+1));if(details.invoiceable==0)$('a[href="#tabs-edit-block-quantity"]').parent().hide();else $('a[href="#tabs-edit-block-quantity"]').parent().show();$('#edit_block_form_tabs').tabs();if(activeTabIndex)$('#edit_block_form_tabs').tabs('option','active',activeTabIndex);if(details.invoiceable==0&&$('#edit_block_form_tabs').tabs('option','active')==1)$('#edit_block_form_tabs').tabs('option','active',0);var select=$('#id_tag').get(0);while(select.length>0)select.remove(0);if(details.available_tags.length>0&&config.calendar.tag_mandatory!=1){var option=document.createElement('option');option.text=translate('(no tag)');option.value='';try{select.add(option,null);}catch(e){select.add(option);}}
for(var c=0;c<details.available_tags.length;c++){var tag=details.available_tags[c];var option=document.createElement('option');option.text=tag.name;option.value=tag.id;try{select.add(option,null);}catch(e){select.add(option);}}
if(select.length>0){$("#edit_block_form_div .row.id_tag").show();$(select).val(details.id_tag);}
else $("#edit_block_form_div .row.id_tag").hide();$("#edit_block_form_tabs").on("tabsactivate",function(event,ui){if($.inArray(ui.newPanel.attr('id'),["tabs-edit-block-comment"])!=-1)$("#comment").focus();});itemGrid.id_block=block.block_id;itemGrid.block=block;itemGrid.fetch();$('#id_block').val(block.block_id);$('#id_block_div').val(block.id);$('#quantity').val(details.quantity).keyup(function(e){var quantity=$('#quantity').val().replace(',','.');if(!quantity)quantity=details.default_quantity;$('#edit_block_form_cost').html(parseFloat(details.base_unitary_price*(quantity/(details.unit_hours>1?details.unit_hours:1))).toFixed(locale.amount_decimals));});if(!details.quantity_set||block.locked)$('#quantity').attr('disabled','1').addClass('ui-state-disabled');else $('#quantity').removeAttr('disabled').removeClass('ui-state-disabled');$('#timesheet_unlock_quantity').css('display',details.quantity_set||block.locked?'none':'').click(function(){$('#quantity').removeAttr('disabled').removeClass('ui-state-disabled');});$('#edit_block_form_unitary_cost').html(parseFloat(details.base_unitary_price).toFixed(locale.amount_decimals)+' '+locale.currency_symbol+'/'+details.unit);$('#edit_block_form_cost').html(parseFloat(details.price).toFixed(locale.amount_decimals));$('#edit_block_form_unit').html(details.unit_hours>1?"h":details.unit);$('#edit_block_form_unitary_cost, #edit_block_form_cost').css('text-decoration',details.time_billing=='none'?'line-through':'');$('#invoice_status').val(details.invoice_status);if(block.locked)$('div.invoice_status').hide();else $('div.invoice_status').show();var comment=details.comment==null?'':details.comment;comment=comment.replace(/u000a/g,"\n");comment=comment.replace(/u0009/g,"\t");$('#comment').val(comment).focus();},"json");}
function _updateComment(block,comment)
{block.comment=comment?comment:null;blocks.updateButton(block,blocks.getButton('note'));setCommentTooltip(block);}
function saveBlockDetails(form,closeafter)
{var block=_$(form.id_block_div.value);var afterSave=function(result){$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane img").remove();setEditBlockDialogSaveEnabled(false);feedback(result);_updateComment(block,$('#comment').val());if(closeafter)$('#edit_block_form_div').dialog("close");};$('#edit_block_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane").prepend(img('wait',null,null,"float:left"));ajax('/timesheet/updateblockdetails',{id:block.block_id,comment:$('#comment').val(),id_tag:($(".id_tag").is(':hidden')?null:parseInt($("#id_tag").val(),10)),quantity:($('#quantity').is(':hidden')||$('#quantity').attr('disabled')?null:$("#quantity").val()),invoice_status:($(".invoice_status").is(':hidden')?null:$("#invoice_status").val())},afterSave,"json");}
function curnumber(mode)
{mode=mode||curmode;return mode=='DAY'?curnumber_day:(mode=='WEEK'?curnumber_week:curnumber_month);}
function setcurnumber(number,mode)
{mode=mode||curmode;if(mode=='DAY')curnumber_day=number;else if(mode=='WEEK')curnumber_week=number;else curnumber_month=number;}
function nextPeriod(){updateCalendar(curusers,curdate,curmode,curnumber(),'next');}
function prevPeriod(){updateCalendar(curusers,curdate,curmode,curnumber(),'prev');}
function setMode(mode)
{var isListMode=$('#list_mode_div').is(':visible');$('#list_mode_div').hide();$('#calendar-toolbar .actionbar').hide();$('#calendar_mode_div').show();$('#calendar_navigator').show();$('#timesheet_task_div').show();if(isListMode||curmode!=mode)updateCalendar(curusers,curdate,mode,curnumber(mode),'setdate');}
function setListMode()
{timesheetList.grid.fetch();$('#calendar_mode_div').hide();$('#calendar_navigator').hide();$('#timesheet_task_div').hide();$('#list_mode_div').show();$('#calendar-toolbar .actionbar').show();$("#calendar-toolbar").css({"padding-left":'10px',"width":$("#tablecontent").width()+"px"});}
function setNumber(number){updateCalendar(curusers,curdate,curmode,number,'setdate');}
function setDate(date){updateCalendar(curusers,date,curmode,curnumber(),'setdate');}
function setCalendar(date,mode){updateCalendar(curusers,date,mode,curnumber(mode),'setdate');}
function setUsers(id_users){updateCalendar(id_users===null?[loggeduser]:id_users,curdate,curmode,curnumber(),'setdate');}
function updateCalendar(id_users,date,mode,number,action)
{showWait(translate("Loading timesheet")+'...');ajax('/timesheet/'+action,{id_users:id_users,date:date,mode:mode,number:number},function(response){updateCalendarCallback(response);},"json");}
function createBlock(block_id,tracker_id,task_id,customer_id,tracker_path,tracker_type,customer_color,locked,comment,x1,y1,x2,y2)
{var attributes={block_id:block_id,locked:locked,partial_start:0,partial_end:0,comment:comment,tracker_path:tracker_path,tracker_type:tracker_type,tracker_id:tracker_id,task_id:task_id,customer_id:customer_id,customer_color:customer_color};var block=blocks.createBlock(x1,y1,x2,y2,'Block'+((locked||readonly)?'':' MoveableBlock'),'MovingBlock',attributes,block_id==0);if(!block)jerror(translate("You cannot create a block here because it would overlap an existing block."),translate("Cannot create a block here"));return block;}
function visibleCalendarHeight()
{var docViewTop=$(window).scrollTop();var docViewBottom=docViewTop+$(window).height();var calendarTop=$(blocks.container).offset().top;var calendarBottom=calendarTop+$(blocks.container).height();return Math.min(docViewBottom,calendarBottom)-Math.max(docViewTop,calendarTop);}
function blockCreated(block)
{$(block).css('border',null);block.id='block_'+block.tracker_id+'_'+(++serial);if(!block.locked)$('#'+block.id).droppable({accept:'.dTreeNode, li.task',tolerance:'pointer',greedy:true,hoverClass:'HoveredBlock',over:function(){isDraggingOverBlock++;$("#calendar_table td").removeClass('hoverdrop').removeClass('hoverdrop_rejected');},out:function(){isDraggingOverBlock--;},drop:function(event,ui){onDropBlock(ui.draggable.get(0),this,getDroppedCell(event));}});block.content=document.createElement('DIV');if(navigator.appVersion.indexOf("MSIE")==-1)block.content.style.overflow='hidden';formatBlockContent(block);block.appendChild(block.content);block.notediv=document.createElement('DIV');block.notediv.className='note-div tooltip';block.notediv.style.display='none';block.buttons['note'].appendChild(block.notediv);setCommentTooltip(block);$(block.buttons['note']).hoverIntent({sensitivity:3,interval:100,timeout:200,over:function(){$(this.block.content).tooltipster('hide');var bounds=blocks.getBlockBounds(this.block);var block_note_width=Math.max(300,Math.min(800,Math.ceil($(block.notediv).html().length/500)*250));var visible_calendar_height=visibleCalendarHeight();var icon_top=blocks.getY(block.buttons['note'])-$(blocks.container).scrollTop()-Math.max($(window).scrollTop()-$(blocks.container).offset().top,0);var space_above_icon=icon_top+$(block.buttons['note']).height();var space_below_icon=visible_calendar_height-icon_top;var tooltip_bottom_up=space_above_icon>space_below_icon;var block_note_max_height=Math.max(space_above_icon,space_below_icon)-10;$(block).attr('title_org',$(block).attr('title')).attr('title','');$(block.buttons['note']).attr('title_org',$(block.buttons['note']).attr('title')).attr('title','');$(block.notediv).css({'width':(block_note_width+'px'),'max-height':(block_note_max_height+'px'),'overflow':'auto'});this.block.style.zIndex=++blocks.zIndex;blocks.updateResizeHandles(this.block,false);if(UserAgentBrowser.IE)this.block.style.filter='';this.block.style.overflow='visible';$(this.block.notediv).css('right','-'+Math.max(block_note_width+16-bounds.x2,0)+'px');if(tooltip_bottom_up)$(this.block.notediv).addClass('note-div-bottomup').removeClass('note-div-topdown');else $(this.block.notediv).removeClass('note-div-bottomup').addClass('note-div-topdown');$(this.block.notediv).slideDown('fast');},out:function(){$(this.block.notediv).slideUp('fast',function(){var block=this.parentNode.parentNode;$(block).attr('title',$(block).attr('title_org'));$(block.buttons['note']).attr('title',$(block.buttons['note']).attr('title_org'));if(UserAgentBrowser.IE)block.style.filter='alpha(opacity=100)';block.style.overflow='hidden';});}});setBlockContent(block,true);if(isAllowed('timesheet','edit'))block.ondblclick=function(){showEditBlockDialog(block);};if(block.block_id==0)updateBlock(block);}
function setCommentTooltip(block)
{block.notediv.innerHTML=comment2html(block.comment);}
function blockCloned(block,clone)
{clone.source_block_id=block.source_block_id||block.block_id;clone.block_id=0;clone.locked=false;clone.partial_start=0;clone.partial_end=0;clone.comment=block.comment;}
function getDropZone(droppedcell)
{var cell_start=droppedcell;var duration_sec=curusers.length>1?240*60:config.calendar.default_duration*60;var id_user=getCellUserId(droppedcell);while($(cell_start).is('.virtual'))cell_start=$(cell_start).parent().next().find("td").eq(cell_start.c).get(0);var cell_end=current_unit>=duration_sec?cell_start:null;while(!cell_end||cell_end.c!=cell_start.c){cell_end=_$(''+(parseInt(cell_start.id)+(duration_sec-current_unit))+'_'+id_user);if(!cell_end||cell_end.c!=cell_start.c)cell_start=_$(''+(parseInt(cell_start.id)-current_unit)+'_'+id_user);}
return{cell_start:cell_start,cell_end:cell_end,x1:cell_start.x1,y1:cell_start.y1,x2:cell_end.x2,y2:cell_end.y2};}
function onDrop(trackerDiv,droppedcell)
{if(droppedcell){var dropZone=getDropZone(droppedcell);highlightDropZone(dropZone,false);if(readonly){var message=translate("You cannot add time blocks on somebody else's timesheet.")+(parseInt(loggeduser)==1?('<br/><br/>'+translate("Please log in using your regular user account to update your timesheet.")):'');return jerror(message,translate("This timesheet is not editable"),480,175);}
else if(!curusers[0]){var message=translate("No regular user found, please create a user first.");return jerror(message,translate("This timesheet is not editable"),480,175);}
else{if($(trackerDiv).hasClass('task')){var id_task=$(trackerDiv).attr('rel');var trackerInfo=taskInfo[id_task];if(!trackerInfo.id_tracker)jconfirm(translate("This task is not linked to a tracker yet, please edit the task to assign a tracker."),translate("Info"),null,function(){editTask(id_task,true);},translate("Cancel"),translate("Edit"));else{var block=createBlock(0,trackerInfo.id_tracker,id_task,trackerInfo.customer_id,trackerInfo.path,trackerInfo.type,toRGB(trackerInfo.color),false,trackerInfo.title,dropZone.x1,dropZone.y1,dropZone.x2,dropZone.y2);blocks.updateResizeHandles(block,true);}}
else{trackerInfo=trackerInfoByTreeNodeId[trackerDiv.id];var block=createBlock(0,trackerInfo.id_tracker,0,trackerInfo.customer_id,trackerInfo.path,trackerInfo.type,trackerInfo.rgbcolor,false,null,dropZone.x1,dropZone.y1,dropZone.x2,dropZone.y2);blocks.updateResizeHandles(block,true);}}}}
function onDropBlock(droppedDiv,droppedblock,droppedcell)
{if(droppedblock&&droppedcell){var dropZone=getDropZone(droppedcell);highlightDropZone(dropZone,false);if(readonly){var message=translate("You cannot add time blocks on somebody else's timesheet.")+(parseInt(loggeduser)==1?('<br/><br/>'+translate("Please log in using your regular user account to update your timesheet.")):'');return jerror(message,translate("This timesheet is not editable"),480,175);}
else if(!curusers[0]){var message=translate("No regular user found, please create a user first.");return jerror(message,translate("This timesheet is not editable"),480,175);}
else{if($(droppedDiv).hasClass('task')){var id_task=$(droppedDiv).attr('rel');var trackerInfo=taskInfo[id_task];if(!trackerInfo.id_tracker)jconfirm(translate("This task is not linked to a tracker yet, please edit the task to assign a tracker."),translate("Info"),null,function(){editTask(id_task,true);},translate("Cancel"),translate("Edit"));else if(confirm(translate("Do you really want to overwrite the task and tracker currently associated with this time entry ?")))updateBlock(droppedblock,trackerInfo.id_tracker,id_task);}
else{trackerInfo=trackerInfoByTreeNodeId[droppedDiv.id];if(trackerInfo){if(confirm(translate("Do you really want to overwrite the tracker currently associated with this time entry ?")))updateBlock(droppedblock,trackerInfo.id_tracker);}
else{itemInfo=itemInfoByTreeNodeId[droppedDiv.id];addItem(itemInfo.id,droppedblock.block_id,function(){showEditBlockDialog(droppedblock,2);});}}}}}
function onDropItemGrid(droppedDiv,droppedgrid)
{if(droppedgrid){itemInfo=itemInfoByTreeNodeId[droppedDiv.id];addItem(itemInfo.id,itemGrid.id_block,function(){droppedgrid.refreshGrid();});}}
function addItem(item_id,block_id,after)
{ajax('/timesheet/additem',{id:block_id,id_item:item_id},function(response){feedback(response.message);after();},"json");}
function getClosestCell(id_user,timestamp,before)
{var rows=_$('calendar_table').getElementsByTagName("TR");for(var r=1;r<rows.length;r++){cells=rows[r].getElementsByTagName("TD");for(var c=0;c<cells.length;c++){var cell=cells[c];if(getCellUserId(cell)!=id_user)continue;var diff=parseInt(cell.id)-timestamp;if((diff>0&&before)||(diff<0&&!before))continue;if(Math.abs(diff)<current_unit)return cell;}}
return null;}
function calendarOnResizeCallback(event)
{if(event.target!==window)timesheet_adapt_result_height();else calendarOnResize();}
function calendarOnResize()
{timesheet_adapt_calendar_height();timesheet_adapt_list_height();if(debug)_step("calendarOnResize: adapt calendar and list height");if(!$(blocks.container).is(':visible'))return true;if(table_column_header!=null){$(table_column_header).css("width",_$('calendar_table').offsetWidth+'px');$('#calendar_table>tbody tr:eq(0) td').each(function(){$(table_column_header.tHead.rows[1].getElementsByTagName("TH")[this.cellIndex]).css({width:this.offsetWidth+'px'});});}
if(debug)_step("calendarOnResize: column header width");var currentScrollTop=$(blocks.container).scrollTop();var currentScrollLeft=$(blocks.container).scrollLeft();$("#timesheet_calendar_row_header").css("height",blocks.container.offsetHeight+'px');if(debug)_step("calendarOnResize: row header height");if(table_column_header!=null){var empiricAdapt=$.browser.mozilla||($.browser.msie&&$.browser.version.substr(0,1)=="8")?-1:0;$('#timesheet_calendar_row_header').find("thead").remove();$('#timesheet_calendar_row_header').css("margin-top",(table_column_header.offsetHeight+empiricAdapt)+'px');}
if(debug)_step("calendarOnResize: row header down");timesheet_adapt_result_height();if(debug)_step("calendarOnResize: adapt result height");var blockList=blocks.getBlocks();for(var i=0;i<blockList.length;i++)blocks.getBlockBoundsInGrid(blockList[i]);if(debug)_step("calendarOnResize: get bounds");blocks.apply(_$('calendar_table'),true,true,60);if(debug)_step("calendarOnResize: apply");blocks.reformatAllBlocks();if(debug)_step("calendarOnResize: reformat");$(blocks.container).scrollTop(currentScrollTop);$(blocks.container).scrollLeft(currentScrollLeft);setTimeout('tweakScrollbars()',0);if(debug)_step("calendarOnResize: tweak scrollbars");}
function tweakScrollbars()
{var calendarClientWidth=parseInt(blocks.container.clientWidth);var calendarClientHeight=parseInt(blocks.container.clientHeight);if(calendarClientWidth==parseInt(blocks.container.scrollWidth)-1){$(blocks.container).css('overflow-x','hidden');calendarClientWidth++;}
var isHorScrollbar=calendarClientWidth<parseInt(blocks.container.scrollWidth);var isVerScrollbar=calendarClientHeight<parseInt(blocks.container.scrollHeight);$("#timesheet_calendar_column_header").css("max-width","");$("#timesheet_calendar_row_header").css("max-height","");if(isHorScrollbar&&isVerScrollbar){$("#timesheet_calendar_column_header").css("max-width",(calendarClientWidth)+"px");$("#timesheet_calendar_row_header").css("max-height",(calendarClientHeight)+"px");}
if($.browser.msie&&$.browser.version.substr(0,1)=="8"){}
else if($.browser.msie&&$.browser.version.substr(0,1)=="7"){}
else $("#calendar-toolbar").css({"padding-left":($("#timesheet_calendar_row_header").width())+'px',"width":(blocks.container.offsetWidth-(isVerScrollbar?scrollbarWidth:5))+"px"});}
function updateCalendarCallback(result)
{if(!result||typeof result!='object'){alert('Unexpected result: '+result);hideWait();return false;}
if(debug)_start();$(window).unbind('resize',calendarOnResizeCallback);var usersChanged=$.toJSON(curusers)!=$.toJSON(result.curusers);curusers=result.curusers;curmode=result.curmode;curdate=result.curdate;setcurnumber(result.curnumber);current_unit=parseInt(result.unit);loggeduser=result.loggeduser;readonly=!isAllowed('timesheet','edit')||((loggeduser!=curusers[0]||curusers.length>1)&&!isAllowed('users','edit_timesheet'));$('#id_user').val(curusers).multiselect('refresh');$('#calendar_table-blocks-container').droppable('destroy');$('#timesheet_calendar_content').html(result.calendar);$('#timesheet_calendar_content_indicator').html(result.interval);blocks.clearBlocks();$("#number_spinner").spinner('value',curnumber()).spinner('enable');if(debug)_step("calendar html");if(UserAgentBrowser.IE7)$("#timesheet_calendar_row_header").hide();else{var table_row_header=_$('calendar_table').cloneNode(false);$(table_row_header).append($('<thead>')).append($('<tbody>'));$('#calendar_table thead tr').each(function(){$(table_row_header.tHead).append($(this.cloneNode(false)).append($(this).find("TH:eq(0)")));});$('#calendar_table tbody tr').each(function(){$(table_row_header.tBodies[0]).append($(this.cloneNode(false)).append($(this).find("TH")));});table_row_header.id='';$('#timesheet_calendar_row_header').children().remove();$('#timesheet_calendar_row_header').append($(table_row_header));$("#timesheet_calendar_row_header").css("width",$(table_row_header).find('tbody tr:first th').size()>1?'70px':'35px');}
if(debug)_step("separate row header");if(UserAgentBrowser.IE7)$("#timesheet_calendar_column_header").hide();else{table_column_header=_$('calendar_table').cloneNode(false);$(table_column_header).append($('<thead>'));$('#calendar_table thead tr').each(function(){$(table_column_header.tHead).append($(this.cloneNode(false)).append($(this).find("td,th")));});table_column_header.id='';$('#timesheet_calendar_column_header').children().remove();$('#timesheet_calendar_column_header').append($(table_column_header));}
if(debug)_step("separate column header");TimesheetIndex.prototype.show();blocks.apply(_$('calendar_table'),true,true,60,true);if(debug)_step("Blocks.apply");blocks.createPopupMenu();if(debug)_step("Popup menu");$(blocks.container).unbind('scroll').scroll(function(event){$("#timesheet_calendar_row_header").scrollTop($(this).scrollTop());$("#timesheet_calendar_column_header").scrollLeft($(this).scrollLeft());}).trigger('scroll');calendarOnResize();var firstWorkCell=$("#calendar_table>tbody td:not(.night)").eq(0).get(0);if(firstWorkCell&&firstWorkCell.y){$(blocks.container).scrollTop(firstWorkCell.y);$("#timesheet_calendar_row_header").scrollTop($(blocks.container).scrollTop());}
if(debug)_step("Scroll setup and calendarOnResize");makeCalendarDroppable();if(debug)_step("Make calendar droppable");ts_errors='',ts_warnings='',ts_infos='';for(index=0;index<result.blocks.length;index++){blockInfo=result.blocks[index];var bounds=getBlockBounds(blockInfo.ts_start,blockInfo.ts_end,blockInfo.id_user);if(bounds){if(debug)ts_infos+='<p style="color:green">[INFO] Creating block at '+bounds.x1+','+bounds.y1+' - '+bounds.x2+','+bounds.y2+'</p>';blockInfo.color=toRGB(blockInfo.color);var block=createBlock(blockInfo.id,blockInfo.id_tracker,blockInfo.id_task,blockInfo.id_customer,blockInfo.path,blockInfo.type,blockInfo.color,blockInfo.locked,blockInfo.comment,bounds.x1,bounds.y1,bounds.x2,bounds.y2);if(debug){var realBounds=blocks.getBlockBounds(block);ts_infos+='<p style="color:green">[INFO] Created block at '+realBounds.x1+','+realBounds.y1+' - '+realBounds.x2+','+realBounds.y2+'</p>';}
block.ts_start=parseInt(blockInfo.ts_start);block.ts_end=parseInt(blockInfo.ts_end);block.tz_offset_start=parseInt(blockInfo.tz_offset_start);block.tz_offset_end=parseInt(blockInfo.tz_offset_end);block.partial_start=parseInt(blockInfo.partial)==1||parseInt(blockInfo.partial)==3?parseInt(blockInfo.ts_start):0;block.partial_end=parseInt(blockInfo.partial)==2||parseInt(blockInfo.partial)==3?parseInt(blockInfo.ts_end):0;if(block)setBlockContent(block,true,{start:block.ts_start,end:block.ts_end});}}
if(debug)_step("Load blocks");if(ts_errors.length>0)feedback((debug?ts_infos+ts_warnings:'')+ts_errors,false,debug);else feedback((readonly?translate("Timesheet loaded in read-only mode"):translate("Timesheet ready!"))+(debug?'<br/>'+ts_infos+ts_warnings:''),false,debug);timesheet_adapt_calendar_height();$(window).resize(calendarOnResizeCallback);updateTotals();if(usersChanged){loadTasks();search();}
var editing_other=curusers.length==1&&loggeduser!=curusers[0]&&isAllowed('users','edit_timesheet');if(editing_other)$('.calendar_warning').html(trim(translate("Attention! You are editing the timesheet of %user").replace(/%user/,$('#id_user').find('option:selected').text()).replace(/\[.+\]/,""))).show();else $('.calendar_warning').hide();hideWait();if(debug)_stop();}
function timesheet_adapt_result_height()
{var reference=typeof blocks!='undefined'&&blocks&&blocks.container&&$(blocks.container).is(':visible')?$(blocks.container):$('#list_mode_div');$('#timesheet_search_div').each(function(){$(this).css('height',Math.max(640,(reference.height()-$(this).offset().top+reference.offset().top))+'px');});if($('#results').size()>0)$('#results').css('height',($('#timesheet_search_div').height()-$('#results').offset().top+$('#timesheet_search_div').offset().top)+'px');if($('#results_items').size()>0)$('#results_items').css('height',($('#timesheet_search_div').height()-$('#results_items').offset().top+$('#timesheet_search_div').offset().top)+'px');if($('#timesheet_task_div div.phtml').size()>0)$('#timesheet_task_div div.phtml').css('height',($('#timesheet_search_div').height()-$('#timesheet_task_div div.phtml').offset().top+$('#timesheet_search_div').offset().top)+'px');}
function timesheet_adapt_calendar_height()
{if(blocks.container){var fillInHeight=window_height()-$(blocks.container).offset().top-parseInt($("#wrap").css("padding-bottom"))-parseInt($("#content").css("padding-bottom"));$(blocks.container).css('max-height',fillInHeight+'px');}}
function timesheet_adapt_list_height()
{var fillInHeight=window_height()-$('#list_mode_div').offset().top-parseInt($("#list_mode_div").css("padding-top"))-parseInt($("#list_mode_div").css("padding-bottom"))-parseInt($("#wrap").css("padding-bottom"));$('#list_mode_div').css('max-height',fillInHeight+'px');}
function getBlockBounds(ts_start,ts_end,id_user)
{var diff_start=0;var diff_end=current_unit;var cell_start=_$(ts_start+'_'+id_user+' (bis)');if(!cell_start)cell_start=_$(ts_start+'_'+id_user);if(!cell_start){cell_start=getClosestCell(id_user,ts_start,true);if(cell_start){diff_start=ts_start-parseInt(cell_start.id);ts_warnings+='<p style="color:orange">[WARNING] Used closest start cell for '+getUTCTime(getDate(ts_start))+': '+getUTCTime(getDate(parseInt(cell_start.id)))+'</p>';}
else ts_errors+='<p style="color:red">[ERROR] Could not find start cell for date '+getUTCTime(getDate(ts_start))+'</p>';}
else if(debug)ts_infos+='<p style="color:green">[INFO] Found exact start cell for '+getUTCTime(getDate(ts_start))+'</p>';var cell_end=null;if(_$(ts_end+'_'+id_user+' (bis)')&&_$(ts_end+'_'+id_user))cell_end=$('#'+ts_end+'_'+id_user).parent().prev().find("td").eq(_$(ts_end+'_'+id_user).c).get(0);if(!cell_end)cell_end=_$(''+(parseInt(ts_end)-current_unit)+'_'+id_user);if(!cell_end){cell_end=getClosestCell(id_user,parseInt(ts_end)-current_unit,false);if(cell_end){ts_warnings+='<p style="color:orange">[WARNING] Used closest end cell for '+getUTCTime(getDate(ts_end))+': '+getUTCTime(getDate(parseInt(cell_end.id)+current_unit))+'</p>';diff_end=ts_end-parseInt(cell_end.id);}
else ts_errors+='<p style="color:red">[ERROR] Could not find end cell for date '+getUTCTime(getDate(ts_end))+'</p>';}
else if(debug)ts_infos+='<p style="color:green">[INFO] Found exact end cell for '+getUTCTime(getDate(ts_end))+'</p>';if(cell_start&&cell_end){var x1=cell_start.x1;var y1=cell_start.y1+Math.floor((diff_start/current_unit)*cell_start.h);var x2=cell_end.x2;var y2=cell_end.y1+Math.ceil((diff_end/current_unit)*cell_end.h);if(typeof x1!='number'||typeof y1!='number'||typeof x2!='number'||typeof y2!='number'||x2<=x1||y2<=y1){ts_errors+='<p style="color:red">[ERROR] Invalid block detected for dates '+getUTCTime(getDate(parseInt(cell_start.id)))+' - '+getUTCTime(getDate(parseInt(cell_end.id)+current_unit))+'</p>';}
else return{x1:x1,y1:y1,x2:x2,y2:y2};}
return false;}
function dragHoverCallback(droppedCell)
{if(!droppedCell)return false;var dropZone=getDropZone(droppedCell);var isDropAllowed=!readonly&&blocks.isPositionAllowed(dropZone.x1,dropZone.y1,dropZone.x2,dropZone.y2);var classname=isDropAllowed?'hoverdrop':'hoverdrop_rejected';if(isDraggingOverBlock<=0){if(lastDropZone)highlightDropZone(lastDropZone,false);highlightDropZone(dropZone,true,classname);}
lastDropZone=dropZone;}
function highlightDropZone(dropZone,activate,classname)
{var cell=dropZone.cell_start;var id_user=getCellUserId(cell);while(cell){if(activate)$(cell).addClass(classname);else $(cell).removeClass('hoverdrop').removeClass('hoverdrop_rejected');if(cell==dropZone.cell_end)break;cell=_$(''+(parseInt(cell.id)+current_unit)+'_'+id_user);}}
function getDroppedCell(event)
{return blocks.getCellAtMouse(event);}
function makeCalendarDroppable()
{$('#calendar_table-blocks-container').droppable({accept:'#tree .dTreeNode, li.task',tolerance:'pointer',out:function(event,ui){if(lastDropZone)highlightDropZone(lastDropZone,false);},drop:function(event,ui){onDrop(ui.draggable.get(0),getDroppedCell(event));}});}
function showQuickAdd(id_parent)
{$('#quickadd_type').css('display',id_parent==0?'none':'');$("#quickadd_id_parent").val(id_parent);$("#quickadd_customer").val('');$("#dialog_quick_add").dialog('option','title',id_parent==0?translate("Quick add customer"):translate("Quick add tracker")).dialog("open");$("#quickadd_customer").focus();}
function quickaddCustomerOrTracker()
{var id_parent=$("#quickadd_id_parent").val();var name=$("#quickadd_customer").val();if(name=="")return false;var handler=function(response){$("#timesheet_tracker_div .searchfield").val(name);search();$("#dialog_quick_add").dialog("close");};if(id_parent==0)_ajax('customer/create',{name:name}).done(handler);else _ajax('tracker/create',{id_parent:id_parent,id_type:$("#quickadd_type select").val(),name:name,note:''}).done(handler);};function TimesheetList()
{var self=this;this.grid=new TimesheetGrid("PlanningGrid",{actionbar:$('#calendar-toolbar .actionbar'),statusbar:$('#calendar-toolbar .statusbar'),getParameters:function(){var from=$('.searchfield.from').val();var to=$('.searchfield.to').val();localset(this.name+'DateFrom',from);localset(this.name+'DateTo',to);curusers=$("#id_user").val();return{from:from,to:to,userIds:curusers};},tableRendered:function(containerid,className,tableid)
{TimesheetGrid.prototype.tableRendered.call(this,containerid,className,tableid);timesheet_adapt_list_height();}});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,changeYear:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$("#timesheet_create_dialog").dialog({width:440,modal:!jQuery.browser.msie,autoOpen:false,buttons:[{text:translate("Add entry"),click:function(){self.createEntry(this);}}],title:translate("New entry")});$('#id_user').multiselect({height:'auto',multiple:true,header:true,minWidth:275,noneSelectedText:translate("Choose users"),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Users"),true,1)}).on('multiselectclose',function(){if($('#list_mode_div').is(':visible'))self.grid.refresh();else setUsers($("#id_user").val());});this.makeDroppable();};TimesheetList.prototype.showAddDialog=function()
{var self=this;dlgButtons=$('#timesheet_create_dialog').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");var startTime=new Date();startTime.setMinutes(0);var endTime=new Date();endTime.setMinutes(0);if(startTime.getHours()<23)endTime.setHours(startTime.getHours()+1);$('#timesheet_create_dialog [name=date_start]').val(startTime.format(locale.date_format_php));$('#timesheet_create_dialog [name=date_end]').val(endTime.format(locale.date_format_php));$("#timesheet_create_dialog [name=h_start]").val(startTime.format(locale.time_format_php));$("#timesheet_create_dialog [name=h_end]").val(endTime.format(locale.time_format_php));$("#timesheet_create_dialog [name=date_start]").keyup(function(e){if($(this).val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});$("#timesheet_create_dialog [name=date_end].datepicker").datepicker({dateFormat:locale['date_format_jquery']});$("#timesheet_create_dialog [name=date_end].datepicker").datepicker("option","minDate",$("#timesheet_create_dialog [name=date_end]").val());$("#timesheet_create_dialog [name=date_start].datepicker").datepicker({dateFormat:locale['date_format_jquery'],onSelect:function(selectedDate){var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$("#timesheet_create_dialog .datepicker").not(this).datepicker("option","minDate",date).datepicker("setDate",date);}});};TimesheetList.prototype.createEntry=function(dialog)
{var self=this;var sdate=this.grid.checkDate($(dialog).find("[name=date_start]").val());var edate=this.grid.checkDate($(dialog).find("[name=date_end]").val());if(!sdate.dbDate)jalert(translate("Please enter the dates as")+" "+translate(locale['date_format_jquery']));else if(!edate.dbDate)jalert(translate("Please enter the dates as")+" "+translate(locale['date_format_jquery']));else if(sdate.sortDate>edate.sortDate)jalert(translate("End date should be posterior to start date"));else{var id_users=[];$(dialog).find("input[name='chkusers']:checked").each(function(){id_users.push($(this).val());});ajax('/timesheet/create',{id_tracker:$(dialog).find("[name=id_tracker]").val(),date_start:sdate.dbDate,h_start:$(dialog).find("[name=h_start]").val(),date_end:edate.dbDate,h_end:$(dialog).find("[name=h_end]").val(),comment:$(dialog).find("[name=comment]").val(),id_users:id_users},function(response){$(dialog).dialog("close");if(response=="error")jerror("An error occured while creating the entry in database","Error");else{self.grid.refresh();message("success",translate("The entry has been created"));}},"json");}};TimesheetList.prototype.onDrop=function(trackerDiv)
{trackerInfo=trackerInfoByTreeNodeId[trackerDiv.id];$("#id_tracker").val(trackerInfo.id_tracker);this.showAddDialog();};TimesheetList.prototype.makeDroppable=function()
{var self=this;$('#list_mode_div').droppable({accept:'.dTreeNode',tolerance:'pointer',drop:function(event,ui){self.onDrop(ui.draggable.get(0));}});};;function search(suffix)
{suffix=suffix||'';if(isSearchValid(suffix)){if(suffix=='_items')unmakeItemSearchResultsDraggable();else unmakeSearchResultsDraggable();$('#results'+suffix).html("<center><br/>"+img('wait')+"<br/>"+translate('Searching...')+"</center>");ajax('/timesheet/search'+suffix,{type:'all',query:trim($('#searchfield'+suffix).val()),id_users:curusers},suffix=='_items'?renderItemResults:renderResults,"json");}}
function validateSearch(event,suffix)
{suffix=suffix||'';var event=event||window.event;if(event.keyCode==13)return search(suffix);if(event.keyCode==9||event.keyCode==27)return true;if(document.getElementById('searchfield'+suffix).value.length==0){document.getElementById('searchmsg'+suffix).innerHTML="";if(typeof timesheet_adapt_result_height!='undefined')timesheet_adapt_result_height();return true;}
if(document.getElementById('searchfield'+suffix).value.length<2){document.getElementById('searchmsg'+suffix).innerHTML="<p class='warnings'>"+translate('Search string too short!')+"</p>";if(typeof timesheet_adapt_result_height!='undefined')timesheet_adapt_result_height();return false;}
document.getElementById('searchmsg'+suffix).innerHTML="<p class='ok'>"+translate('Press ENTER to search!')+"</p>";if(typeof timesheet_adapt_result_height!='undefined')timesheet_adapt_result_height();return true;}
function isSearchValid(suffix)
{suffix=suffix||'';var searchval=$('#searchfield'+suffix).val()||'';return(searchval.length==0||searchval.length>=2);}
function renderResults(searchResult)
{if(searchResult){var message=null;if(searchResult.nbMatching==0)message={status:'warnings',text:searchResult.emptysearch?"<i class='fa fa-angle-up'></i><br />"+translate("Type something in the textbox above to search for trackers"):translate("No result found")};else if(searchResult.mostused)message={status:'ok',text:translate("Most used trackers")};else if(searchResult.all)message={status:'ok',text:translate("All trackers")};else if(searchResult.complete==false)message={status:'ok',text:translate("More than")+" "+searchResult.nbMatching+" "+translate("results found")};else if(searchResult.nbMatching==1)message={status:'ok',text:searchResult.nbMatching+" "+translate("result found")};else message={status:'ok',text:searchResult.nbMatching+" "+translate("results found")};$('#searchmsg').html(message?"<p class='"+message.status+"'>"+message.text+"</p>":"");tree=new dTree('tree');tree.config.inOrder=true;tree.config.useSelection=false;tree.config.useCookies=false;tree.config.useLines=false;tree.config.folderLinks=true;tree.add("root_search_result_tracker",-1,'','','','','','',false);var ractive=$('.dummy').ractive({path:'tracker_tooltip.ractive'}).instance();buildTree(ractive,searchResult.rootNodes,"root_search_result_tracker",searchResult);ractive.teardown();$('#results').html(''+tree);if(!searchResult.complete)document.getElementById('results').innerHTML+='<p align="center" style="font-size:8px;padding-top:10px">...</p>';new PopupMenu({populate:function(element,mouseX,mouseY){if(element.tagName=="STRONG")element=element.parentNode;if(element&&isAllowed('customers','view')&&element.id in trackerInfoByTreeNodeId)this.addMenuItem(translate("View customer"),null,null,baseUrl+"/ui/customer/tracker/"+trackerInfoByTreeNodeId[element.id].id_tracker);if(element&&isAllowed('customers','edit')&&element.id in trackerInfoByTreeNodeId)this.addMenuItem(translate("Add child tracker")+"...",function(){showQuickAdd(trackerInfoByTreeNodeId[element.id].id_tracker);});}}).apply(_$('results'));$('#results div.dTreeNode[title]').each(function(){$(this).attr('tooltip',$(this).attr('title')).attr('title','');}).scrolltip({noanimation:true,content:function(){return $(this).attr("tooltip");},onshow:function(tip){var indent=$(this).find('>img').size()+$(this).find('a.collapse').size();tip.css('max-width','400px').position({my:'left top',at:'left+'+(indent*18)+' bottom',of:this});},onhide:function(tip){tip.appendTo(this);}});makeSearchResultsDraggable();if(typeof timesheet_adapt_result_height!='undefined')timesheet_adapt_result_height();}}
function buildTree(ractive_tooltip,nodes,id_parent)
{for(var index=0;index<nodes.length;index++)
{var node=nodes[index];var icon='';var pattern=config.calendar.timesheet_search_display_field;var tokens=['name','title','invoice_label'];for(var c=0;c<tokens.length;c++){pattern=pattern.replace(new RegExp("\\["+tokens[c]+"\\|(.*)\\|(.*)\\]","g"),function(m,lft,rgt){return node[tokens[c]]?lft:rgt});pattern=pattern.replace("%"+tokens[c],node[tokens[c]]?node[tokens[c]]:'');}
var nodeName=(pattern?pattern:'[no name]')+(node.end_date_formatted?' ('+node.end_date_formatted+')':'')+(node.matching&&debug?' *':'');var nodeId="search_result_tracker_"+node.id_tracker;ractive_tooltip.set(node.tooltip);tree.add(nodeId,id_parent,nodeName,'','',trim(ractive_tooltip.toHTML()),'',icon,icon,node.expanded,!node.id_parent);if(typeof node.children!='undefined')buildTree(ractive_tooltip,node.children,nodeId);trackerInfoByTreeNodeId[nodeId]={id_tracker:(node.id_tracker?node.id_tracker:node.id),access:node.access_granted,path:node.path,customer_id:node.id_customer,type:node.type,rgbcolor:toRGB(node.color)};}}
function unmakeSearchResultsDraggable()
{if(_$('tree')){var elements=_$('tree').getElementsByTagName('div');for(var i=0;i<elements.length;i++)
if(elements[i].id.startsWith("search_result_tracker"))
try{$(elements[i]).draggable('destroy');}catch(ex){}}}
function makeSearchResultsDraggable()
{if(!isAllowed('timesheet','edit'))return;var elements=_$('tree').getElementsByTagName('div');for(var i=0;i<elements.length;i++){if(elements[i].id.startsWith("search_result_tracker")){if(trackerInfoByTreeNodeId[elements[i].id].access){$(elements[i]).css('cursor','move');$(elements[i]).draggable({helper:function(){return $(this).clone().css({'background-color':'transparent'}).appendTo(document.body);},opacity:0.5,revert:true,revertDuration:500,zIndex:100000,start:function(){isDraggingOverBlock=0;},drag:function(event,ui){$('.scrolltip').remove();if(typeof blocks!='undefined')dragHoverCallback(getDroppedCell(event));}});}}}}
function unmakeTasksDraggable()
{$('#timesheet_task_div li').each(function(){try{$(this).draggable('destroy');}catch(ex){}});}
function makeTasksDraggable()
{if(!isAllowed('timesheet','edit'))return;$('#timesheet_task_div li').each(function(){$(this).css('cursor','move').draggable({helper:function(){return $(this).clone().css({'background-color':'transparent'}).appendTo(document.body);},opacity:0.5,revert:true,revertDuration:500,zIndex:100000,start:function(){isDraggingOverBlock=0;},drag:function(event,ui){$('.scrolltip').remove();if(typeof blocks!='undefined')dragHoverCallback(getDroppedCell(event));}});});}
function renderItemResults(searchResult)
{if(searchResult){var message=null;if(searchResult.nbMatching==0)message={status:'warnings',text:searchResult.emptysearch?"<i class='fa fa-angle-up'></i><br />"+translate("Type something in the textbox above to search for items"):translate("No result found")};else if(searchResult.mostused)message={status:'ok',text:translate("Most used items")};else if(searchResult.all)message={status:'ok',text:translate("All items")};else if(searchResult.complete==false)message={status:'ok',text:translate("More than")+" "+searchResult.nbMatching+" "+translate("results found")};else if(searchResult.nbMatching==1)message={status:'ok',text:searchResult.nbMatching+" "+translate("result found")};else message={status:'ok',text:searchResult.nbMatching+" "+translate("results found")};$('#searchmsg_items').html(message?"<p class='"+message.status+"'>"+message.text+"</p>":"");tree_items=new dTree('tree_items');tree_items.config.inOrder=true;tree_items.config.useSelection=false;tree_items.config.useCookies=false;tree_items.config.useLines=false;tree_items.config.folderLinks=true;tree_items.add("root_search_result_item",-1,'','','','','','',false);buildItemTree(searchResult.rootNodes,"root_search_result_item",searchResult.emptysearch?false:true);$('#results_items').html(''+tree_items);if(!searchResult.complete)document.getElementById('results_items').innerHTML+='<p align="center" style="font-size:8px;padding-top:10px">...</p>';$('#results_items div.dTreeNode[title]').each(function(){$(this).attr('tooltip',$(this).attr('title')).attr('title','');}).scrolltip({noanimation:true,content:function(){return $(this).attr("tooltip");},onshow:function(tip){var indent=$(this).find('>img').size()+$(this).find('a.collapse').size();tip.css('max-width','400px').position({my:'left top',at:'left+'+(indent*18)+' bottom',of:this});},onhide:function(tip){tip.appendTo(this);}});makeItemSearchResultsDraggable();if(typeof timesheet_adapt_result_height!='undefined')timesheet_adapt_result_height();}}
function buildItemTree(nodes,id_parent,expanded)
{for(var index=0;index<nodes.length;index++)
{var node=nodes[index];var icon="";var nodeName=(node.label==null?"[noname]":htmlspecialchars(node.label));var nodeId=node.type=='folder'?"search_result_folder_item_"+node.id:"search_result_item_"+node.id;var tooltip='';var label=node.label;var description=(node.description===node.label)?'':node.description;if(label!='')tooltip+=label+"<br/>";if(description!='')tooltip+=description;tree_items.add(nodeId,id_parent,nodeName,'','',tooltip,'',icon,icon,expanded,false);if(typeof node.children!='undefined')buildItemTree(node.children,nodeId,expanded);itemInfoByTreeNodeId[nodeId]={id:node.id};}}
function unmakeItemSearchResultsDraggable()
{if(_$('tree')){var elements=_$('tree').getElementsByTagName('div');for(var i=0;i<elements.length;i++)
if(elements[i].id.startsWith("search_result_item"))
try{$(elements[i]).draggable('destroy');}catch(ex){}}}
function makeItemSearchResultsDraggable()
{if(!isAllowed('timesheet','edit')||!_$('tree_items'))return;var elements=_$('tree_items').getElementsByTagName('div');for(var i=0;i<elements.length;i++){if(elements[i].id.startsWith("search_result_item")){$(elements[i]).css('cursor','move');$(elements[i]).draggable({helper:function(){return $(this).clone().css({'background-color':'transparent'}).appendTo(document.body);},opacity:0.5,revert:true,revertDuration:500,zIndex:100000,start:function(){isDraggingOverBlock=0;},drag:function(event,ui){$('.scrolltip').remove();}});}}};function TrackerModule(customerId,container_id,resource)
{var self=this;if(resource=='customers'&&ui.get('job.id'))resource='jobs';this.treeTable=null;this.customerId=customerId;this.templateId=null;this.trackerId=null;this.resource=resource;this.firstTracker=true;this.grid=!container_id?null:new TimetrackEditableGrid("TrackerGrid",{serverSide:false,enableSort:false,alternate:false,controller:(customerId?"tracker":"defaulttracker"),container_id:container_id,getParameters:function(){if(self.customerId)return{id_tracker_root:self.trackerId,id_tracker:self.trackerId};else return{id_template:self.templateId};},tableLoaded:function(){this.module.initializeGrid(this);},isEditable:function(rowIndex,columnIndex){if(!isAllowed(resource,'edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify this.");return false;}
if(rowIndex==0&&($.inArray(columnIndex,this.module.readonlyColumns)!=-1)&&!this.getRowAttribute(rowIndex,"data_tracker").id_parent){jinfo("The root tracker represents the customer itself: you can't modify its name nor type");return false;}
if(this.hasColumn('disabled')&&this.getRowAttribute(rowIndex,'disabled_readonly')&&columnIndex==this.getColumnIndex("disabled"))return false;if(this.hasColumn('time_billing')&&columnIndex==this.getColumnIndex("time_billing")&&this.getRowAttribute(rowIndex,"data_tracker").invoiceable==0)return false;if(this.hasColumn('time_billing')&&columnIndex==this.getColumnIndex("time_billing")&&this.getRowAttribute(rowIndex,"data_tracker").covered==1)return false;return true;},modelChanged:function(rowIndex,columnIndex,oldValue,newValue,row){if($.inArray(this.getColumnName(columnIndex),["start_date","end_date","auto_budget","budget_periodicity","budget_fees","budget_costs"])>=0)return PlanningGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row);return TimetrackEditableGrid.prototype.modelChanged.call(this,rowIndex,columnIndex,oldValue,newValue,row).done(function(response){if(typeof response=="object"&&!self.grid.mustReload(rowIndex,columnIndex)){self.grid.setValueAt(rowIndex,self.grid.getColumnIndex('name'),response.name);self.grid.setValueAt(rowIndex,self.grid.getColumnIndex('disabled'),response.disabled);}
self.onChange();return true;});},mustReload:function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),["name","disabled","id_type","time_billing","label","description","unitary_price","id_unit","id_vat_type","start_date","end_date","auto_budget"])>=0;},getColumnSelectorLabel:function(colIndex)
{if(this.getColumnName(colIndex)=='description')return translate("Invoice description");return this.getColumnLabel(colIndex);}});$("#tracker_form_div").dialog({width:600,modal:!jQuery.browser.msie,autoOpen:false});var transferButtons={};transferButtons[translate("OK")]=function(){self.transferTracker($('#transfer_tracker_form [name=id_tracker]').val(),$('#transfer_tracker_form [name=id_target]').val());$(this).dialog("close");};transferButtons[translate("Cancel")]=function(){$(this).dialog("close");};$("#transfer_tracker_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,buttons:transferButtons,title:translate("Move this tracker to another customer")});this.dirty=false;if(customerId)this.itemsGrid=new ItemPatternGrid("TrackerItemPatternGrid",{container_id:"tablecontent-items",actionbar:$('#block-items-dialog .actionbar'),statusbar:null,getParameters:function(){return{id_tracker:self.itemsGrid.id_tracker};},onChange:function(){self.dirty=true;},prepareForRow:function(rowId){this.id_tracker=rowId;this.fetch();self.itemsDialog.parameters={id_tracker:this.id_tracker,on_block:1};}});else this.itemsGrid=new DefaultItemPatternGrid("TrackerDefaultItemPatternGrid",{container_id:"tablecontent-items",actionbar:$('#block-items-dialog .actionbar'),statusbar:null,getParameters:function(){return{id_default_tracker:self.itemsGrid.id_default_tracker};},onChange:function(){self.dirty=true;},prepareForRow:function(rowId){this.id_default_tracker=rowId;this.fetch();self.itemsDialog.parameters={id_default_tracker:this.id_default_tracker,on_block:1};}});if(customerId)this.itemsDialog=new ItemPatternDialog({parameters:{on_block:1},onAdd:function(){self.itemsGrid.onChange();self.itemsGrid.refresh();}});else this.itemsDialog=new DefaultItemPatternDialog({parameters:{on_block:1},onAdd:function(){self.itemsGrid.onChange();self.itemsGrid.refresh();}});ui.on('add-items',function(){self.itemsDialog.open();});if(this.grid)this.grid.module=this;}
TrackerModule.prototype.onChange=function()
{};TrackerModule.prototype.initializeGrid=function(grid)
{var self=this;var planningGrid=new PlanningGrid("DummyPlanningGrid");grid.viewBudgetCurrencyEntries=planningGrid.viewBudgetCurrencyEntries;grid.viewBudgetEntries=planningGrid.viewBudgetEntries;grid.viewBudgetDialog=planningGrid.viewBudgetDialog;grid.budgetEntryGrid=planningGrid.budgetEntryGrid;grid.budgetCurrencyEntryGrid=planningGrid.budgetCurrencyEntryGrid;planningGrid._tableLoaded.call(grid);for(var columnIndex=0;columnIndex<grid.getColumnCount();columnIndex++){var columName=grid.getColumnName(columnIndex);if(helpboxes[columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes[columName],grid.getColumnLabel(columnIndex),480,true));if(!this.customerId&&helpboxes['default_tracker_'+columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes['default_tracker_'+columName],trim(grid.getColumnLabel(columnIndex))?grid.getColumnLabel(columnIndex):translate("Information"),640,true));if(helpboxes['item_time_'+columName])grid.setHeaderRenderer(columName,getInfoHeaderRenderer(helpboxes['item_time_'+columName],trim(grid.getColumnLabel(columnIndex))?grid.getColumnLabel(columnIndex):translate("Information"),480,true));}
this.readonlyColumns=[grid.getColumnIndex('name'),grid.getColumnIndex('id_type')];grid.addCellValidator("name",new CellValidator({isValid:function(value){return value!="";}}));grid.setCellRenderer("name",new CellRenderer({render:function(cell,name){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");var indent=self.grid.getRowAttribute(cell.rowIndex,"indent");$(cell).empty();if(isAllowed(self.resource,'edit')&&indent>0)$(cell).append(img('customer_movetracker','move',translate('Drag to move tracker'),'cursor:move')).append(" ");var content=name;if(isAllowed('jobs','view')&&name&&data_tracker&&data_tracker.id_job>0&&data_tracker.id_job!=ui.get('job.id'))content="<a class='customer_link tooltip' title='' href='"+baseUrl+"/ui/job/"+data_tracker.id_job+"/tracker'>"+name+"</a>";$(cell).append(content);if(name&&data_tracker&&data_tracker.id_template>0&&data_tracker.id_template!=ui.get('template.id')){var color=toRGB('92cdef');var content="<a class='customer_link tooltip' style='color:"+'#fff'+"' title='"+translate('This tracker is the root of a template. Click to go into this template.','html')+"'  href='"+baseUrl+"/ui/template/"+data_tracker.id_template+"/tracker'>"+data_tracker.template_name+"</a>";$(cell).append(" &nbsp; <span class='task_color_marker' style='background-color:"+cssColor(color)+"'>"+content+"</span> ");}
if(name.length<=40)$(cell).css('white-space','nowrap');else $(cell).css('white-space','');$(cell).find("img").addClass('move-bullet').show().draggable({opacity:0.5,distance:3,revert:true,revertDuration:200,zIndex:100000,helper:function(){var childRows=self.treeTable.getRowsBelow(this.parentNode.parentNode);$(grid.table).find("tr").attr('valid-target','1');$(childRows).attr('valid-target','');return $("<table>").append($(childRows).clone().find("td:gt(0)").remove().end());}});if(cell.toggleLink)cell.insertBefore(cell.toggleLink,cell.firstChild);}}));grid.setCellEditor("name",new TextCellEditor(null,null,{displayEditor:function(element,htmlInput){TextCellEditor.prototype.displayEditor.call(this,element,htmlInput);var offset=element.rowIndex>0?40:20;htmlInput.style.left=(parseInt(htmlInput.style.left)+offset)+'px';htmlInput.style.width=(parseInt(htmlInput.style.width)-offset)+'px';}}));if(grid.hasColumn('label'))grid.setCellRenderer('label',new CellRenderer({render:function(cell,dummy){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){CellRenderer.prototype.render.call(this,cell,data_tracker.label_value_inherited,true);if(data_tracker.label_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}}));if(grid.hasColumn('label'))grid.setCellEditor('label',new TextCellEditor(null,null,{getEditor:function(cell,value){var editor=TextCellEditor.prototype.getEditor.call(this,cell,value);var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker)$(editor).attr('placeholder',data_tracker.label_placeholder);return editor;}}));if(grid.hasColumn('description'))grid.setCellRenderer('description',new CellRenderer({render:function(cell,value){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){$(cell).html(img('customer_note','note',data_tracker.description_value_inherited)).css('text-align','left').css('width','16px');;$(cell).find('i').css('opacity',data_tracker.description_inherited==0&&value?'1':'.3');}}}));if(grid.hasColumn('description'))grid.setCellEditor("description",new TextAreaCellEditor({useTinyMce:false,create:function(cell,value){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");$(this.textArea).attr('placeholder',data_tracker.description_placeholder);},getDialogTitle:function(cell,value){return translate("Description")+' "'+grid.getValueAt(cell.rowIndex,grid.getColumnIndex('name'))+'"';}}));if(grid.hasColumn('time_billing'))grid.setCellRenderer('time_billing',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){EnumCellRenderer.prototype.render.call(this,cell,data_tracker.time_billing_value_inherited);if(data_tracker.time_billing_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');if(data_tracker.invoiceable==0)$(cell).append("&nbsp;&nbsp;"+img('headerinfo','',translate("This tracker is of a non invoiceable type")+'.'+translate("In order to enable time billing on this tracker, you have to change the tracker type first.")));else if(data_tracker.covered==1)$(cell).append("&nbsp;&nbsp;"+img('headerinfo','',translate("You cannot bill time on this tracker since you are billing the time budgets instead. In order to enable time billing on this tracker, you have to delete the budget lump sums first.")));}}}));if(grid.hasColumn('unitary_price'))grid.setCellRenderer('unitary_price',new NumberCellRenderer({render:function(cell,dummy){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){var time_billing=data_tracker.time_billing_value_inherited;var invoiceable=data_tracker.invoiceable;NumberCellRenderer.prototype.render.call(this,cell,parseFloat(data_tracker.unitary_price_value_inherited));if(data_tracker.unitary_price_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');if(time_billing=='none')$(cell).css('text-decoration','line-through');if(invoiceable!=1)$(cell).attr("title",translate("This tracker is of a non invoiceable type"));else if(time_billing=='none')$(cell).attr("title",translate("Time billing is not enabled on this tracker"));else $(cell).removeAttr("title");}}}));if(grid.hasColumn('id_unit'))grid.setCellRenderer('id_unit',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){EnumCellRenderer.prototype.render.call(this,cell,data_tracker.id_unit_value_inherited);$(cell).prepend('/ ').css('white-space','nowrap');if(data_tracker.id_unit_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}}));if(grid.hasColumn('id_vat_type'))grid.setCellRenderer('id_vat_type',new EnumCellRenderer({render:function(cell,dummy){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");if(data_tracker){EnumCellRenderer.prototype.render.call(this,cell,data_tracker.id_vat_type_value_inherited);if(data_tracker.id_vat_type_inherited==1)$(cell).addClass('inherited');else $(cell).removeClass('inherited');}}}));if(grid.hasColumn("items")){var originalHeaderRenderer=grid.getColumn('items').headerRenderer;grid.setHeaderRenderer('items',new CellRenderer({render:function(cell,value){originalHeaderRenderer.render(cell,value);EditableGrid.prototype.addClassName(cell,"number");}}));grid.setCellRenderer('items',new NumberCellRenderer({render:function(cell,value){CellRenderer.prototype.render.call(this,cell,value);$(cell).addClass("number");$(cell).css("font-weight",/^\d.*/.test(value)?"bold":'normal');}}));grid.setCellEditor("items",new CellEditor({getEditor:function(cell,value){$('#block-items-dialog').dialog({title:translate('Items'),width:900,open:function(){self.itemsGrid.prepareForRow(grid.getRowId(cell.rowIndex));},close:function(){if(self.dirty){grid.fetch();self.dirty=false;}},buttons:[{text:"OK",click:function(){$(this).dialog('close');}}]});this.cancelEditing(cell);}}));}
if(grid.hasColumn('note')){grid.setCellRenderer('note',new CellRenderer({render:function(cell,value){$(cell).css('width','16px').html(img('customer_note','note',value)).css('text-align','right').find('i').css('opacity',value?'1':'.3');}}));grid.setCellEditor("note",new TextAreaCellEditor({getDialogTitle:function(cell,value){return translate("Note")+' "'+grid.getValueAt(cell.rowIndex,0)+'"';}}));}
var confirm_message=(this.customerId>0?translate('Be careful! Deleting this tracker will delete all its children. Associated time blocks will be transferred to the parent tracker. Are you sure you want to continue ?',true):translate('Be careful! Deleting this default tracker will delete this tracker and all its children IN ALL CUSTOMERS. Associated time blocks will be transferred to the parent trackers. Are you SURE you want to continue ?',true));if(grid.hasColumn('disabled'))grid.setCellRenderer("disabled",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);$(cell.parentNode).addClass(value?"paid":"unpaid").removeClass(value?"unpaid":"paid");}}));if(grid.hasColumn('tags')){grid.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No tracker tag was created yet. To create a tracker tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));grid.setCellRenderer("tags",new TagCellRenderer());}
grid.setCellRenderer("action",new CellRenderer({render:function(cell,id_tracker){$(cell).empty().css('white-space','nowrap');var indent=self.grid.getRowAttribute(cell.rowIndex,"indent");var nb_missing_default_trackers=self.grid.getRowAttribute(cell.rowIndex,"nb_missing_default_trackers");if(isAllowed(self.resource,'edit')){var data_tracker=grid.getRowAttribute(cell.rowIndex,"data_tracker");var is_job_root=data_tracker&&data_tracker.id_job>0&&data_tracker.id_job!=ui.get('job.id');if(!is_job_root)$(cell).append($('<a>').css('cursor','pointer').html(img('customer_addtracker','add',translate("Add child tracker"))).click(function(){self.showAddTrackerDialog(id_tracker,cell.rowIndex);}));if(indent>0){$(cell).append($('<a>').css('cursor','pointer').html(img('customer_copytracker','copy',translate("Duplicate tracker"))).click(function(){self.copyTracker(id_tracker);}));if(!is_job_root)self.addCustomTrackerActions(cell,id_tracker);$(cell).append($('<a>').css('cursor','pointer').html(img('customer_deletetracker','delete',translate("Delete tracker"))).click(function(){if(confirm(confirm_message))self.deleteTracker(id_tracker);}));}
if(!is_job_root&&nb_missing_default_trackers>0){var tooltip=nb_missing_default_trackers>1?translate('Restore the %NB missing trackers').replace('%NB',nb_missing_default_trackers):translate('Restore the missing tracker');$(cell).append($('<a>').css('cursor','pointer').html(img('customer_synctracker','sync',tooltip)).click(function(){self.syncTracker(id_tracker);}));}}}}));grid.render();if(grid.currentFilter)$('#tracker_filter').val(grid.currentFilter);this.setupDropAndTreeTable(grid);};TrackerModule.prototype.addCustomTrackerActions=function(cell,id_tracker){};TrackerModule.prototype.setupDropAndTreeTable=function(grid)
{var self=this;$(grid.table).addClass("treetable");for(var r=0;r<grid.getRowCount();r++){var row=grid.getRow(r);row.setAttribute("indent",grid.getRowAttribute(r,"indent"));var expanded=grid.getRowAttribute(r,"expanded")||grid.getRowAttribute(r,"indent")<1;if(this.treeTable&&row.id in this.treeTable.expandedRowIds)expanded=this.treeTable.expandedRowIds[row.id];if(grid.getRowAttribute(r,"nb_children")>0)row.setAttribute("expanded",expanded?'1':'');}
this.treeTable=new TreeTable(grid.table);$(grid.table).find("tr").droppable({accept:'img',tolerance:'pointer',over:function(event,ui){var sameRow=ui.draggable.get(0).parentNode.parentNode==this;$(this).css('background-color',sameRow?'':($(this).attr('valid-target')?'#98e87f':'#ef7c7e'));},out:function(event,ui){$(this).css('background-color','');},drop:function(event,ui){$(this).css('background-color','');if($(this).attr('valid-target')){var id_tracker=grid.getRowId(ui.draggable.get(0).parentNode.rowIndex);var id_parent=grid.getRowId(grid.getRowIndex(this));setTimeout(function(){self.moveTracker(id_tracker,id_parent,ui.draggable.get(0));},250);}}});};TrackerModule.prototype.showAddTrackerDialog=function(id_parent,rowIndex)
{var self=this;$("#tracker_form_div").dialog({title:translate("New tracker"),buttons:[{text:translate("Add tracker"),click:function(){if(self.createTracker(_$('tracker_form')))$(this).dialog("close");}}]});if(!this.customerId)$('.tracker_is_template').show();else $('.tracker_is_template').hide();_ajax(this.grid.controller+'/get',{id:id_parent}).done(function(response){$('#tracker_form_div [name=id_default_tracker] option').remove();if(self.customerId)for(var c=0;c<config.tracker.templates.length;c++){var template=config.tracker.templates[c];if(template.id_parent&&template.id_parent==response.id_default_tracker&&(template.level>1||!isEnabled('jobs','list'))){var option=document.createElement('option');option.text=template.name;option.value=template.id_default_tracker;$(option).attr('template_type',template.template_type);$(option).attr('default_name',template.default_name);$(option).attr('template_id_type',template.id_type);$(option).attr('template_note',template.note);$('#tracker_form_div [name=id_default_tracker]').append($(option));}}
$("#tracker_form_div [name=id_tracker]").val(id_parent);if(self.firstTracker)$("#tracker_form_div [name=id_type]").val(response.id_type==1?2:response.id_type);$("#tracker_form_div [name=name]").val('');$("#tracker_form_div [name=note]").val('');$('#tracker_form_div [name=is_template]').attr('checked',false);$('#tracker_form_div [name=is_template]').unbind('change').change(function(){if($(this).is(':checked'))$('.tracker_template_name').show();else $('.tracker_template_name').hide();}).trigger('change');var dlgButtons=$('#tracker_form_div').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("#tracker_form_div [name=name]").keyup(function(e){if($(this).val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});if($('#tracker_form_div [name=id_default_tracker] option').size()==0)$('.select_tracker_template').hide();else{$('#tracker_form_div [name=id_default_tracker]').prepend($("<option>").attr('value',0).attr('template_type','manual').html(translate("(no template)"))).val(0);$('.select_tracker_template').show();$('#tracker_form_div [name=id_default_tracker]').unbind('change').change(function(){var id_default_tracker=parseInt($(this).val(),10);if(id_default_tracker>0){var default_name=$(this).find('option:selected').attr('default_name').replace(/\>/,'').replace(/\</,'');var template_type=$(this).find('option:selected').attr('template_type');var template_id_type=$(this).find('option:selected').attr('template_id_type');var template_note=$(this).find('option:selected').attr('template_note');$('#tracker_form_div [name=name]').val(default_name);if(template_type=='automatic')$('#tracker_form_div [name=name]').attr('disabled',1);else $('#tracker_form_div [name=name]').removeAttr('disabled');$('#tracker_form_div [name=id_type]').val(template_id_type).attr('disabled',1).trigger('change');$("#tracker_form_div [name=note]").val(template_note);$("#tracker_form_div [name=name]").focus();dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');}
else{$('#tracker_form_div [name=id_type]').val(2).removeAttr('disabled').trigger('change');$('#tracker_form_div [name=name]').val('').trigger('keyup').removeAttr('disabled');$("#tracker_form_div [name=note]").val('');$("#tracker_form_div [name=name]").focus();}}).trigger('change');}
$('#tracker_form_div').dialog('open').find("[name=name]").focus();});};TrackerModule.prototype.createTracker=function(form)
{var self=this;this.showWheel();var template_selected=$(form.id_default_tracker).val()>0;if(!template_selected)this.firstTracker=false;if(!this.customerId&&$(form.is_template).is(':checked')&&!trim($(form.template_name).val())){jalert(translate("You must give a name to your template"));return false;}
_ajax(this.grid.controller+'/create',$.extend(this.grid.getParameters(),{id_default_tracker:(template_selected?$(form.id_default_tracker).val():null),id_parent:$(form.id_tracker).val(),name:$(form.name).val(),id_type:$(form.id_type).val(),note:$(form.note).val(),is_template:(this.customerId?null:$(form.is_template).is(':checked')?1:0),template_name:(this.customerId?null:$(form.template_name).val())})).done(function(response){if(!response)showDialog("Error","An error occured while creating the tracker in database","error");self.grid.fetch();self.onChange();});return true;};TrackerModule.prototype.filter=function(str)
{var curFilter=this.grid.currentFilter===null?'':this.grid.currentFilter;if(curFilter!==str){this.grid.filter(str);if(str=='')this.setupDropAndTreeTable(this.grid);else $(this.grid.table).find("td img.move-bullet").hide();}};TrackerModule.prototype.deleteTracker=function(id)
{var self=this;this.showWheel();_ajax(this.grid.controller+'/delete',$.extend(this.grid.getParameters(),{id:id})).done(function(response){if(!response)jerror("An error occured while deleting the tracker from database","Error");self.grid.fetch();self.onChange();});};TrackerModule.prototype.copyTracker=function(id)
{var self=this;this.showWheel();_ajax(this.grid.controller+'/copy',$.extend(this.grid.getParameters(),{id:id})).done(function(response){if(!response)jerror("An error occured while copying the tracker in database","Error");self.grid.fetch();self.onChange();});};TrackerModule.prototype.syncTracker=function(id)
{var self=this;this.showWheel();ajax('/customer/synctracker',$.extend(this.grid.getParameters(),{id_customer:this.customerId,id_tracker:id}),function(response){if(response!="ok")showDialog("Error","An error occured while restoring the tracker in database","error");self.grid.fetch();self.onChange();},"json");};TrackerModule.prototype.moveTracker=function(id,id_parent,dragged_bullet)
{var self=this;this.showWheel(dragged_bullet);ajax('/customer/movetracker',$.extend(this.grid.getParameters(),{id_customer:this.customerId,id_tracker:id,id_parent:id_parent}),function(response){if(response!="ok")showDialog("Error","An error occured while moving the tracker in database","error");self.grid.fetch();self.onChange();},"json");};TrackerModule.prototype.showWheel=function(dragged_bullet)
{$('tr img').each(function(){if(!dragged_bullet||this!=dragged_bullet)try{$(this).draggable('destroy');}catch(ex){}});try{$('tr').droppable('destroy');}catch(ex){}
gridWait(this.grid.container_id);};;function TreeTable(table,columnIndex)
{this.table=table;this.columnIndex=columnIndex||0;this.rows=table.tBodies[0].getElementsByTagName("TR");this.initialize();this.expandCollapse();}
TreeTable.prototype.toggleRow=function(row)
{row.expanded=!row.expanded;this.expandedRowIds[row.id]=row.expanded;var image=row.cells[this.columnIndex].getElementsByTagName('IMG')[0];image.src=baseUrl+'/js/dtree/img/nolines_'+(row.expanded?'minus.gif':'plus.gif');this.expandCollapse(row);if(this.rowToggled)this.rowToggled(row);};TreeTable.prototype.expandCollapse=function(startRow)
{var isHiding=-1;var indent=startRow?startRow.indent:-1;var collapsing=startRow?!startRow.expanded:false;var r=startRow?(startRow.rowIndex-this.table.tHead.getElementsByTagName("TR").length+1):0;for(;r<this.rows.length;r++){var row=this.rows[r];if(row.indent<=indent)break;var rowDisplayStyle=collapsing?"none":"";if(isHiding>=0){if(row.indent<=isHiding)isHiding=-1;else rowDisplayStyle="none";}
row.style.display=rowDisplayStyle;if(isHiding<0&&!row.expanded)isHiding=row.indent;}};TreeTable.prototype.getRowsBelow=function(startRow)
{var rows=[startRow];var indent=startRow?startRow.indent:-1;var r=startRow.rowIndex-this.table.tHead.getElementsByTagName("TR").length+1;for(;r<this.rows.length;r++){var row=this.rows[r];if(row.indent<=indent)break;rows.push(row);}
return rows;};TreeTable.prototype.initialize=function()
{this.expandedRowIds={};for(var r=0;r<this.rows.length;r++){var row=this.rows[r];row.indent=parseInt(row.getAttribute("indent"),10);if(isNaN(row.indent))row.indent=0;row.expanded=row.getAttribute("expanded");for(var c=0;c<row.cells.length;c++)
if(c==this.columnIndex)row.cells[c].style.paddingLeft=(row.indent*20)+'px';var toggleIcon=document.createElement("img");toggleIcon.style.marginRight="5px";var toggleLink=document.createElement("a");toggleLink.appendChild(toggleIcon);row.cells[this.columnIndex].insertBefore(toggleLink,row.cells[this.columnIndex].firstChild);row.cells[this.columnIndex].toggleLink=toggleLink;this.expandedRowIds[row.id]=row.expanded===null||row.expanded;if(row.expanded===null)toggleIcon.src=baseUrl+'/js/dtree/img/empty.gif';else{toggleIcon.src=baseUrl+'/js/dtree/img/nolines_'+(row.expanded?'minus':'plus')+'.gif';toggleIcon.style.cursor="pointer";toggleIcon.treeTable=this;toggleIcon.row=row;toggleIcon.onclick=function(){this.treeTable.toggleRow(this.row);};}}};;function user_acl(){img_access=img('user_granted');img_noaccess=img('user_refused');this.editableGrid=null;this.stopEditing=false;this.modelChanged=function(rowIndex,columnIndex,oldValue,newValue,row)
{updateCellValue(this,'/user/updateacl',rowIndex,columnIndex,oldValue,newValue,row,rowIndex<0?function(response)
{if(response=='error')return false;var result=$.evalJSON(response);if(result.status=='error'){alert(result.message);return false;}
for(var id_role in roles)user_acl.editableGrid.getColumn(roles[id_role]).name=result.roles[id_role];allroles=result.allroles;roles=result.roles;return true;}:function(response)
{var result=$.evalJSON(response);if(typeof result.cells=="undefined"){showDialog(result['title'],result['message'],"warning",0);return false;}
for(var role in result.cells){var updatedCells=result.cells[role];var columnIndex=user_acl.editableGrid.getColumnIndex(role);for(var i=0;i<updatedCells.length;i++){var value=updatedCells[i];var rowIndex=user_acl.editableGrid.getRowIndex(value.id_row);user_acl.editableGrid.getCell(rowIndex,columnIndex).setAttribute("inherited",value.inherited?"1":"");user_acl.editableGrid.getCell(rowIndex,columnIndex).setAttribute("value_inherited",value.value_inherited);user_acl.editableGrid.setValueAt(rowIndex,columnIndex,value.value);}}
return true;},(rowIndex<0));};this.initAclMatrix=function()
{this.treeTable=new TreeTable(_$('acl_grid'));var dialogButtons={};dialogButtons[translate("Create")]=function(){var self=this;var roleName=trim($('#role_name').val());if(roleName==''){alert(translate("Please enter a name for the new user role"));$('#role_name').focus();return;}
else ajax('/user/addrole',{name:roleName},function(response){if(response.status=='error'){alert(response.message);$('#role_name').focus();return false;}
$(self).dialog("close");window.location=baseUrl+'/user/acl';},"json");};$("#add_role_form").dialog({width:400,modal:true,autoOpen:false,buttons:dialogButtons,title:translate("Create role")});this.editableGrid=new TimetrackEditableGrid("AclMatrix",{serverSide:false,enableSort:false,modelChanged:this.modelChanged,isHeaderEditable:function(rowIndex,columnIndex){return isAllowed('roles','edit')&&!user_acl.stopEditing&&!this.getRow(rowIndex).getAttribute('readonly');},isEditable:function(rowIndex,columnIndex){return isAllowed('roles','edit')&&!user_acl.stopEditing&&!this.getRow(rowIndex).getAttribute('readonly');}});var columns=[new Column({name:"name",datatype:"string",editable:false,renderable:false})];for(var id_role in roles)columns.push(new Column({name:roles[id_role],optionValues:[{value:"",label:translate("(inherited)")},{value:"1",label:translate("Authorized")},{value:"0",label:translate("Refused")}]}));this.editableGrid.attachToHTMLTable(_$('acl_grid'),columns);for(var id_role in roles){this.editableGrid.setEnumProvider(roles[id_role],new EnumProvider({id_role:id_role,getOptionValuesForEdit:function(grid,column,rowIndex){if(rowIndex>0)return column.optionValues;var optionValues={"1":translate("Authorized"),"0":translate("Refused")};for(var o_id_role in roles)if(o_id_role!=this.id_role)optionValues[roles[o_id_role]]=":"+roles[o_id_role];return optionValues;}}));this.editableGrid.getColumn(roles[id_role]).cellEditor.adaptHeight=false;this.editableGrid.setHeaderRenderer(roles[id_role],new CellRenderer({id_role:id_role,render:function(cell,value){cell.innerHTML=value;var message=translate('Are you sure you want to delete this role ?','html');if(isAllowed('roles','delete')&&!$(cell).attr('own_role'))cell.innerHTML+="<span style='white-space:nowrap;'>&nbsp;&nbsp;<a style=\"cursor:pointer\" onclick=\"if (confirm('"+message+"')) user_acl.deleteRole('"+this.id_role+"');\">"+img('user_deleterole','delete')+"</a></span>\n";}}));this.editableGrid.setCellRenderer(roles[id_role],new CellRenderer({render:function(cell,value){if(cell.rowIndex==0){cell.innerHTML=value;var img=value==1?img_access:img_noaccess;CellRenderer.prototype.render.call(this,cell,(value=="0"||value=="1")?img:"<b>:"+value+"</b>");$(cell).find('i').css('opacity',cell.getAttribute("value_inherited")=="1"?'.2':'1');}
else{var value_inherited=cell.getAttribute("value_inherited")=="1";var img=value_inherited?img_access:img_noaccess;CellRenderer.prototype.render.call(this,cell,img);$(cell).find('i').css('opacity',cell.getAttribute("inherited")?'.2':'1');}}}));}
this.editableGrid.renderGrid();};this.showCreateRoleDialog=function()
{$("#add_role_form").dialog('open');$("#add_role_form input[type=text]").focus();};this.deleteRole=function(id_role)
{this.stopEditing=true;window.location=baseUrl+'/user/deleterole?role='+roles[id_role];};this.initAclMatrix();};function UserGrid(name,config){if(name)this.init(name,config);}
UserGrid.prototype=new TimetrackEditableGrid();UserGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No user found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No user found matching your search criteria');config.controller='user';TimetrackEditableGrid.prototype.init.call(this,name,config);};UserGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(!isAllowed('users','edit')){if(this.getColumnType(columnIndex)!='boolean')jinfo("You are not authorized to modify users.");return false;}
return true;};UserGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['id_price_category'])>=0;};UserGrid.prototype.getActions=function(cell,id_user)
{var self=this;var actions=[];if(isAllowed('users','edit'))
actions.push({icon:img('user_change_pwd','change password',translate('Change password for this user')),click:function(){self.changePassword(id_user);}});if(id_logged_user!=id_user&&isAllowed('users','delete'))
actions.push({icon:img('user_delete','delete','Delete'),click:function(){if(confirm(translate('Are you sure you want to delete this user ?',true)))self.deleteUser(id_user);}});return actions;};UserGrid.prototype.tableLoaded=function()
{var self=this;this.addCellValidator("login",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("login",new CellRenderer({render:function(cell,value){if(!isAllowed('users','edit')||!isEnabled("timesheet","view"))$(cell).html(value);else $(cell).html(value?"<a title='' href='"+baseUrl+"/ui/user/"+self.getRowId(cell.rowIndex)+"'>"+value+"</a>":"");$(cell).css('white-space','nowrap');}}));this.setCellEditor("description",new TextAreaCellEditor({getDialogTitle:function(cell,value){return translate("Note for user")+" : "+self.getValueAt(cell.rowIndex,self.getColumnIndex('login'));}}));this.setCellEditor("roles",new CellEditor({getEditor:function(cell,value){var user_roles=value?value.split(','):[];var roles=ui.get('roles');var update_tooltip=function(){var sel_roles=[];for(var index=0;index<roles.length;index++){var role=roles[index];if(_$("cb_role_"+role.name).checked)sel_roles.push(role.name);}
ajax('/user/acltooltip',{id_user:self.getRowId(cell.rowIndex),roles:sel_roles},function(response){$('#acl_tooltip').html(response.message);if(!response.ok)self.dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else self.dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');},"json");};for(var index=0;index<roles.length;index++){var role=roles[index];_$("cb_role_"+role.name).checked=false;_$("cb_role_"+role.name).onclick=update_tooltip;}
for(var i=0;i<user_roles.length;i++)_$("cb_role_"+trim(user_roles[i])).checked=true;update_tooltip();_$("roles_form").cellEditor=this;_$("roles_form").cell=cell;self.dlgButtons=$("#roles_form").dialog({width:900,height:540,modal:!jQuery.browser.msie,autoOpen:true,title:translate("Roles for")+" "+self.getValueAt(cell.rowIndex,self.getColumnIndex('login')),beforeClose:function(event,ui){if(this.cell.isEditing)this.cellEditor.cancelEditing(this.cell);return true;},buttons:[{text:translate("Apply"),click:function(){var sel_roles="";for(var index=0;index<roles.length;index++){var role=roles[index];if(_$("cb_role_"+role.name).checked)sel_roles+=(sel_roles==""?"":", ")+role.name;}
this.cellEditor.applyEditing(this.cell,sel_roles);$(this).dialog("close");}}]}).parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");return null;}}));if(this.hasColumn("tags")){this.setCellEditor("tags",new MultiselectCellEditor({closeText:translate('Apply'),messageIfEmpty:translate("No user tag was created yet. To create a user tag, please go to the <a href='%URL'>configuration</a>").replace(/%URL/,baseUrl+"/config/categories")}));this.setCellRenderer("tags",new TagCellRenderer());}
var truncateCellRenderer=new CellRenderer({render:function(cell,value){cell.innerHTML=value?truncate(value,32):"<i>"+translate("(none_)")+"</i>";}});this.setCellRenderer("roles",truncateCellRenderer);this.setCellRenderer("account_disable",new CheckboxCellRenderer({render:function(cell,value){CheckboxCellRenderer.prototype.render.call(this,cell,value);$(cell.parentNode).addClass(value?"paid":"unpaid").removeClass(value?"unpaid":"paid");}}));if(this.hasColumn('avatar'))this.setCellRenderer("avatar",new CellRenderer({render:function(cell,url){$(cell).html('<img width="60" src="'+url+'"/>');}}));if(this.hasColumn("billable_target_pct")){this.addCellValidator("billable_target_pct",new CellValidator({isValid:function(value){return value===""||parseFloat(value)>=0;}}));this.setCellRenderer("billable_target_pct",new CellRenderer({render:function(cell,value){if(value===null||isNaN(value))$(cell).addClass('inherited');else $(cell).removeClass('inherited');NumberCellRenderer.prototype.render.call(this,cell,value===null||isNaN(value)?parseFloat(self.getRowAttribute(cell.rowIndex,'billable_target_pct_inherited')):value);}}));}
this.render();};UserGrid.prototype.deleteUser=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax('user/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the user from database","Error");else{self.refresh();self.onChange();}});};UserGrid.prototype.changePassword=function(id_user)
{var login=this.getValueAt(this.getRowIndex(id_user),this.getColumnIndex('login'));$("#password_form_div").dialog({resizable:false,modal:!jQuery.browser.msie,width:415,title:translate("Change password for user")+" "+login,buttons:[{text:translate("Confirm"),click:function(){var self_dialog=this;_ajax('user/changepassword',{id_user:id_user,password1:$("#new_password").val(),password2:$("#cnew_password").val()}).done(function(response){feedback_message(response.message,response.status);if(response.status=="success"){$("#new_password").val("");$("#cnew_password").val("");$(self_dialog).dialog('close');}});}},{text:translate("Cancel"),click:function(){$(this).dialog('close');$("#new_password").val("");$("#cnew_password").val("");}}]});};;function UserHistoryGrid(name,config){if(name)this.init(name,config);}
UserHistoryGrid.prototype=new TimetrackEditableGrid();UserHistoryGrid.prototype.init=function(name,config)
{config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No history found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No history found matching your search criteria');config.controller='userhistory';TimetrackEditableGrid.prototype.init.call(this,name,config);};UserHistoryGrid.prototype.isEditable=function(rowIndex,columnIndex)
{if(this.getColumnName(columnIndex)=="date_effect"&&!this.getRowAttribute(rowIndex,"_date_effect"))return false;if(!isAllowed('users','edit')){jinfo("You are not authorized to modify this.");return false;}
return true;};UserHistoryGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['date_effect','id_price_category'])>=0;};UserHistoryGrid.prototype.getActions=function(cell,id_history)
{var self=this;var actions=[];if(isAllowed('configuration','edit')){actions.push({icon:img('customer_copytracker','copy',translate('Add a new line')),click:function(){self.addHistory(id_history);}});if(this.getValueAt(cell.rowIndex,this.getColumnIndex("date_effect")))actions.push({icon:img('user_delete','delete',translate('Delete history line')),click:function(){if(confirm(translate('Are you sure you want to delete this history line ?',false)))self.deleteHistory(id_history);}});}
return actions;};UserHistoryGrid.prototype.getParameters=function()
{return{id_user:ui.get('user.id')};};UserHistoryGrid.prototype.tableLoaded=function()
{var self=this;this.addCellValidator("date_effect",new CellValidator({isValid:function(value){return value!="";}}));this.setCellRenderer("date_effect",new DateCellRenderer({render:function(cell,value){if(!value)$(cell).addClass('inherited').html(translate("(since the beginning)"));else{$(cell).removeClass('inherited');DateCellRenderer.prototype.render.call(this,cell,value);}}}));if(this.hasColumn("billable_target_pct")){this.addCellValidator("billable_target_pct",new CellValidator({isValid:function(value){return value===""||parseFloat(value)>=0;}}));this.setCellRenderer("billable_target_pct",new CellRenderer({render:function(cell,value){if(value===null||isNaN(value))$(cell).addClass('inherited');else $(cell).removeClass('inherited');NumberCellRenderer.prototype.render.call(this,cell,value===null||isNaN(value)?parseFloat(self.getRowAttribute(cell.rowIndex,'billable_target_pct_inherited')):value);}}));}
this.render();};UserHistoryGrid.prototype.deleteHistory=function(id)
{var self=this;showWait(translate("Deleting")+"...");_ajax(this.controller+'/delete',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the history line from database","Error");else{self.refresh();self.onChange();}});};UserHistoryGrid.prototype.addHistory=function(id)
{var self=this;showWait(translate("Creating")+"...");_ajax(this.controller+'/copy',{id:id}).done(function(response){hideWait();if(!response)jerror("An error occured while duplicating the history line from database","Error");else{self.refresh();self.onChange();}});};;function UserIndex(){}
UserIndex.prototype=new DefaultScreen();UserIndex.prototype.init=function()
{var self=this;$('select.id_user_change').change(function(){router.navigate('/user/'+$(this).val()+'/'+ui.get('tab'),true);});this._focusTabbable_bkp=$.ui.dialog.prototype._focusTabbable;$.ui.dialog.prototype._focusTabbable=function(){};this.grid=new UserGrid("UserGrid");$("a.add:not(.import)").click(function(){self.showAddUserForm();});$("#user_form_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New user"),buttons:[{text:translate("Add user"),click:function(){self.createUser(_$('user_form'));}}]});};UserIndex.prototype.showAddUserForm=function()
{dlgButtons=$('#user_form_div').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");$('.row.set_prices_by_user, .row.set_prices_by_category').hide();$('.row.set_prices_by_'+config.user.set_prices_by).show();dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("#user_form_div textarea,#user_form_div input[type=password],#user_form_div input[type=text]").val('');$("#user_form_div [name=login]").focus().keyup(function(e){if($(this).val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});};UserIndex.prototype.createUser=function(form)
{var self=this;_ajax('user/create',{login:$(form.login).val(),password:$(form.password).val(),cpassword:$(form.cpassword).val(),name:$(form.name).val(),firstname:$(form.firstname).val(),email:$(form.email).val(),id_price_category:$(form.id_price_category).val(),unitary_price:$(form.unitary_price).val(),unitary_cost:$(form.unitary_cost).val(),id_unit:$(form.id_unit).val(),id_role:$(form.id_role).val()}).done(function(response){if(!response)jerror("An error occured while creating the user in database","Error");else if(response.status)feedback_message(response.status,"error",10000);else{feedback_message(translate("The user has been created"),"success");self.grid.refresh();self.grid.onChange();$("#user_form_div").dialog("close");}});};UserIndex.prototype.dispose=function()
{$.ui.dialog.prototype._focusTabbable=this._focusTabbable_bkp;};;function UserPricecategory(){}
UserPricecategory.prototype=new DefaultScreen();UserPricecategory.prototype.init=function()
{var self=this;this.grid=new PriceCategoryGrid("PriceCategoryGrid");$("a.add:not(.import)").click(function(){self.showAddCategoryForm();});$("#price_category_form_div").dialog({width:450,modal:!jQuery.browser.msie,autoOpen:false,title:translate("New category"),buttons:[{text:translate("Add category"),click:function(){self.createCategory(_$('price_category_form'));}}]});};UserPricecategory.prototype.showAddCategoryForm=function()
{dlgButtons=$('#price_category_form_div').dialog('open').parents(".ui-dialog:first").find(".ui-dialog-buttonpane button");dlgButtons.attr('disabled','1').addClass('ui-state-disabled');$("#price_category_form_div textarea,#user_form_div input[type=password],#user_form_div input[type=text]").val('');$("#price_category_form_div [name=name]").focus().keyup(function(e){if($(this).val()=='')dlgButtons.attr('disabled','1').addClass('ui-state-disabled');else dlgButtons.removeAttr('disabled').removeClass('ui-state-disabled');});};UserPricecategory.prototype.createCategory=function(form)
{var self=this;_ajax('pricecategory/create',{name:$(form.name).val(),unitary_price:$(form.unitary_price).val(),unitary_cost:$(form.unitary_cost).val(),id_unit:$(form.id_unit).val()}).done(function(response){if(!response)jerror("An error occured while creating the category in database","Error");else if(response.status)message("error",response.status);else{message("success",translate(translate("The category has been created")));self.grid.refresh();self.grid.onChange();$("#price_category_form_div").dialog("close");}});};UserPricecategory.prototype.dispose=function()
{};;function UserView(){}
UserView.prototype=new DefaultScreen();UserView.prototype.init=function(parameter)
{var self=this;this.tabControllers={'history':new UserViewHistory(),'team':new UserViewTeam()};$('select.id_user_change').change(function(){router.navigate('/user/'+$(this).val()+'/'+ui.get('tab'),true);});this.setTab(ui.get('tab'),true);};UserView.prototype.setTab=function(tab,first)
{var self=this;if(!first&&ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onhide){console.info("Hiding "+ui.get('tab'));self.tabControllers[ui.get('tab')].onhide();}
menu.hilite();ui.set('tab',tab);if(ui.get('tab')&&self.tabControllers[ui.get('tab')]&&self.tabControllers[ui.get('tab')].onshow){console.info("Showing "+ui.get('tab'));self.tabControllers[ui.get('tab')].onshow();}};UserView.prototype.dispose=function()
{for(var tab in this.tabControllers){if(this.tabControllers[tab].dispose){console.info("Disposing "+tab);this.tabControllers[tab].dispose();}}};;function UserViewHistory(){this.init();};UserViewHistory.prototype.init=function()
{var self=this;};UserViewHistory.prototype.onshow=function()
{var self=this;this.grid=new UserHistoryGrid("UserHistoryPriceGrid");this.grid.fetch();};;function UserViewTeam(){this.init();};UserViewTeam.prototype.init=function()
{var self=this;ui.on('team-add',function(e){self.setteam(e.node,1);});ui.on('team-remove',function(e){self.setteam(e.node,0);});};UserViewTeam.prototype.onshow=function()
{var self=this;$('ul.team li').draggable({revert:true});$('ul.team.available').droppable({accept:'li.selected',drop:function(event,ui){return self.setteam(ui.draggable,0);}});$('ul.team.selected').droppable({accept:'li.available',drop:function(event,ui){return self.setteam(ui.draggable,1);}});};UserViewTeam.prototype.setteam=function(node,value)
{showWait();_ajax('user/setteam',{id_tracker:$(node).attr('rel'),id_user:ui.get('user.id'),value:value}).done(function(response){ui.set(response);hideWait();});};;var widgetContainer=null;function WidgetContainer(widgets)
{var self=this;this.widgets={};this.fullscreen=ui.get('fullscreen');showWait(translate("Loading widgets..."));ajax('/widget/list',{widgets:ui.get('widgets')},function(widgets){for(widget in widgets){if(widgets.hasOwnProperty(widget)){var colNumber=widgets[widget][0];var visible=widgets[widget][1];var body=widgets[widget][2];var column=colNumber==1?'#dashboard_left':(colNumber==2?'#dashboard_right':null);if(!column)column=$('#dashboard_left').find('.widget').size()<=$('#dashboard_right').find('.widget').size()?'#dashboard_left':'#dashboard_right';$(column).append('<div class="widget" id="'+widget+'"></div>');widgetContainer.widgets[widget]={};widgetContainer._updateWidgetCallback(widget,body,false,visible);}}
DefaultScreen.prototype.show();if(!self.fullscreen||$('#dashboard_left').find('.widget').size()>0)$('#dashboard_left').show();if(!self.fullscreen||$('#dashboard_right').find('.widget').size()>0)$('#dashboard_right').show();if($('#dashboard_right').is(':hidden'))$('#dashboard_left').css('width','99%');if($('#dashboard_left').is(':hidden'))$('#dashboard_right').css('width','99%');},'json');};WidgetContainer.prototype.updateWidgetParameters=function(widget,additional_parameters)
{var selector=this.fullscreen?$('.widgetform'):$('#'+widget+' form');showWait(translate(this.fullscreen?"Updating...":"Updating widget..."));selector.find('input[name=search]').val($('#quick_search_field').val());selector.populateParameters(this.widgets[widget]);if(additional_parameters)for(p in additional_parameters)this.widgets[widget][p]=additional_parameters[p];this.updateWidget(widget,true,true);};WidgetContainer.prototype.toggleParams=function(toggler,widget)
{if($('#'+widget+' form').is(":hidden"))this.showParams(toggler,widget);else this.hideParams(toggler,widget);};WidgetContainer.prototype.hideParams=function(toggler,widget)
{$('#'+widget+' form').slideUp('fast');};WidgetContainer.prototype.showParams=function(toggler,widget)
{$('#'+widget+' form').slideDown('fast');$('#'+widget+' .widgetbar').removeClass('invisible').addClass('visible').next().slideDown('fast');};WidgetContainer.prototype.updateWidget=function(widget,showParams,visible)
{var self=this;ajax('/widget/get',{id:widget,fullscreen:this.fullscreen,parameters:this.widgets[widget]},function(response){self._updateWidgetCallback(widget,response,showParams,visible);hideWait();},'json');};WidgetContainer.prototype._updateWidgetCallback=function(widget,response,showParams,visible)
{$('#'+widget).html(response.content);if(!this.fullscreen&&$.inArray(widget,['quicksearch','recentactivity','memo','charts'])>=0){var link=$('<a>').html(img('fullscreen',this.fullscreen?translate("Quit fullscreen"):translate("Fullscreen"))).css('float','left').css('margin-right','7px').css('margin-top',widget=='quicksearch'?'3px':'1px').attr('href',baseUrl+'/ui/dashboard/widgets/'+(this.fullscreen?'all':widget));$('#'+widget+' .widgetbar').prepend(link);}
if(response.form){$('#'+widget+' .widgetbar').append("<div class='widgetform'>"+response.form+"</div><div style='clear:both'></div>");$('#'+widget+' .widgetbar .widgetform select[multiple]').select2({width:400,minimumResultsForSearch:10});$('#'+widget+' .widgetbar .widgetform .select2-search-field').hide();if(!this.fullscreen){$('#'+widget+' h3').append('<span><a href="#" class="widget_param_link"><i class="fa fa-cog"></i></a></span>');if(!showParams)$('#'+widget+' form').hide();}}
if(this.fullscreen){$('#'+widget).prepareWidgetFullscreen(widget);}
else{$('#'+widget).prepareWidget(widget);$('#'+widget+' .widgetbar').addClass(visible?'visible':'invisible').next().css('display',visible?'':'none');}};WidgetContainer.prototype.saveLayout=function()
{var orderedWidgets={};$('.widgetbar').parent().each(function(){orderedWidgets[this.id]=[($(this).parent().attr('id')=='dashboard_left'?1:2),$(this).find('.widgetbar').is('.visible')];});ajax('/widget/savelayout',{list:orderedWidgets},function(response){},'json');};jQuery.fn.prepareWidgetFullscreen=function(widget)
{$('.widgetform').find('form').submit(function(){widgetContainer.updateWidgetParameters(widget);return false;});$('.widgetform').find('select').change(function(){widgetContainer.updateWidgetParameters(widget);});$('.widgetform').find('input[type=checkbox]').click(function(){widgetContainer.updateWidgetParameters(widget);});$('.widgetform').find('input, select').click(function(){return false;});};jQuery.fn.prepareWidget=function(widget)
{$(this).find('.widgetbar').find('form').submit(function(){widgetContainer.updateWidgetParameters(widget);return false;});$(this).find('.widgetbar').find('select').change(function(){widgetContainer.updateWidgetParameters(widget);});$(this).find('.widgetbar').find('input[type=checkbox]').click(function(){widgetContainer.updateWidgetParameters(widget);});$(this).find('.widgetbar').find('input, select').click(function(){return false;});$(this).find('a.widget_param_link').click(function(event){event.preventDefault();widgetContainer.toggleParams(this,widget);return false;});$(this).find('.widgetbar').css('cursor','pointer').click(function(event){if($(event.target).is('i'))return;var block=$(this).next();if(block.is(':hidden')){block.slideDown('fast');$(this).removeClass('invisible').addClass('visible');}
else{block.slideUp('fast');$(this).addClass('invisible').removeClass('visible');widgetContainer.hideParams($('#'+widget+' a.widget_param_link').get(0),widget);}
widgetContainer.saveLayout();}).draggable({opacity:0.5,distance:3,revert:false,zIndex:100000,start:function(event,ui){widgetContainer.locator=$('<div class="widget_drag_helper"></div>').css('height',$(this).parent().height());},stop:function(event,ui){var draggedWidget=$(this).parent();var widgetClone=draggedWidget.clone().css({position:'static',width:''}).prepareWidget(widget);draggedWidget.remove();widgetContainer.locator.before(widgetClone).remove();widgetContainer.saveLayout();var callback="after_widget_move_"+widgetClone.attr('id');if(typeof(window[callback])=="function")window[callback]();},helper:function(){return $(this).parent().css('width',$(this).parent().width());},drag:function(event,ui){var draggable=this;var mouseX=event.pageX||event.clientX+document.documentElement.scrollLeft;var mouseY=event.pageY||event.clientY+document.documentElement.scrollTop;if(widgetContainer.locator.containsPoint(mouseX,mouseY,25))return true;var found_target=false;$('.widgetbar').each(function(){if(this!=draggable){if($(this).parent().firstHalfContainsPoint(mouseX,mouseY)){$(this).parent().before(widgetContainer.locator);found_target=true;return false;}
else if($(this).parent().secondHalfContainsPoint(mouseX,mouseY,25)){$(this).parent().after(widgetContainer.locator);found_target=true;return false;}}});if(!found_target){if($("#dashboard_left").containsX(mouseX)){if(mouseY>($("#dashboard_left").offset().top+$("#dashboard_left").height()/2))$("#dashboard_left").append(widgetContainer.locator);else $("#dashboard_left").prepend(widgetContainer.locator);}
else if($("#dashboard_right").containsX(mouseX)){if(mouseY>($("#dashboard_right").offset().top+$("#dashboard_right").height()/2))$("#dashboard_right").append(widgetContainer.locator);else $("#dashboard_right").prepend(widgetContainer.locator);}}}});return $(this);};;function WorksheetGrid(name,config){if(name)this.init(name,config);}
WorksheetGrid.prototype=new TimetrackEditableGrid();WorksheetGrid.prototype.init=function(name,config)
{var self=this;config=config||{};if(typeof config.noResult=='undefined')config.noResult=translate('No worksheet found');if(typeof config.noResultMatchingFilter=='undefined')config.noResultMatchingFilter=translate('No worksheet matching your search criteria');config.controller='worksheet';TimetrackEditableGrid.prototype.init.call(this,name,config);};WorksheetGrid.prototype.isEditable=function(rowIndex,columnIndex)
{var status=this.getRowAttribute(rowIndex,'status');if(status!='open'&&this.getColumnName(columnIndex)!='status'){jalert(translate('You cannot modifiy a closed or invoiced worksheet'));return false;}
return true;};WorksheetGrid.prototype.isDeletable=function(rowIndex)
{var status=this.getRowAttribute(rowIndex,'status');return isAllowed('worksheets','delete')&&status!='invoiced';};WorksheetGrid.prototype.isCheckable=function(rowIndex)
{var status=this.getRowAttribute(rowIndex,'status');if(!isAllowed('worksheets','delete')&&!isAllowed('invoices','create'))return false;return status!='invoiced';};WorksheetGrid.prototype.mustReload=function(rowIndex,columnIndex)
{return $.inArray(this.getColumnName(columnIndex),['status'])>=0;};WorksheetGrid.prototype.getActions=function(cell,id_worksheet)
{var self=this;var actions=[];var deletable=this.isDeletable(cell.rowIndex);if(isAllowed('worksheets','edit')){var target='_mobile';actions.push({icon:img('customer_edit','edit',translate('Edit')),active:self.getRowAttribute(cell.rowIndex,'status')!='invoiced',href:baseUrl+'/m/worksheet/#view?request={"id":"'+id_worksheet+'"}',target:target});}
if(isAllowed('worksheets','export')){var target=config.ui.open_reports_in_new_tab==1?'_blank':'';var worksheet_filename=translate("Worksheet")+'_'+this.getRowAttribute(cell.rowIndex,'reference_formatted');actions.push({icon:img('invoice_export_pdf16','pdf',translate('Export as PDF')),href:baseUrl+'/worksheet/pdf/id/'+id_worksheet+"/"+worksheet_filename+'.pdf',target:target});}
if(isAllowed('worksheets','delete')){actions.push({icon:img('customer_deletetracker','delete','Delete'),active:deletable,click:function(){if(confirm(translate('Are you sure you want to delete this worksheet ?',true)))self.deleteWorksheet(id_worksheet);}});}
return actions;};WorksheetGrid.prototype.tableLoaded=function()
{var self=this;if(this.hasColumn('status'))this.setCellRenderer("status",new EnumCellRenderer({render:function(cell,value){var label=this.getLabel(cell.rowIndex,value);if(!isAllowed('invoices','view'))cell.innerHTML=label;var id_invoice=self.getRowAttribute(cell.rowIndex,'id_invoice');cell.innerHTML=value=='invoiced'&&id_invoice?"<a class='customer_link tooltip' title='"+translate('Invoice')+' '+self.getRowAttribute(cell.rowIndex,'invoice_ref')+"' href='"+baseUrl+"/ui/invoice/"+self.getRowAttribute(cell.rowIndex,'id_invoice')+"'>"+label+"</a>":label;$(cell).css('white-space','nowrap');var status=self.getRowAttribute(cell.rowIndex,'status');if(status=='invoiced')$(cell).parent().addClass('paid');else $(cell).parent().removeClass('paid');}}));if(this.hasColumn('id_customer'))this.setCellRenderer("id_customer",new EnumCellRenderer({render:function(cell,value){EnumCellRenderer.prototype.render.call(this,cell,value);$(cell).css('white-space','nowrap');}}));this.render();};WorksheetGrid.prototype.deleteWorksheet=function(id_worksheet)
{var self=this;showWait(translate("Deleting")+"...");_ajax('worksheet/delete',{id:id_worksheet}).done(function(response){hideWait();if(!response)jerror("An error occured while deleting the worksheet from database","Error");else{self.refresh();self.onChange();}});};;function WorksheetIndex(){}
WorksheetIndex.prototype=new DefaultScreen();WorksheetIndex.prototype.init=function()
{var self=this;this.grid=new WorksheetGrid("WorksheetGrid",{getParameters:function(){var parameter=WorksheetGrid.prototype.getParameters.call(this);parameter.id_workers=$('.worker_select').size()>0?($('.worker_select').val()||[]):null;parameter.statuses=$('.status_select').val()||[];parameter.from=$('.searchfield.from').val();parameter.to=$('.searchfield.to').val();localset(this.name+'DateFrom',parameter.from);localset(this.name+'DateTo',parameter.to);return parameter;}});ui.on('actionbar-delete',function(){if(confirm(translate('Are you sure you want to delete selected worksheets ?',true)))self.grid.deleteWorksheet(ui.get('rows_checked'));});ui.on('actionbar-invoice',function(){if(true)self.invoiceWorksheet(ui.get('rows_checked'));});if(localisset(this.grid.name+'DateFrom'))$(".searchfield.from").val(localget(this.grid.name+'DateFrom'));if(localisset(this.grid.name+'DateTo'))$(".searchfield.to").val(localget(this.grid.name+'DateTo'));$(".datefilter .searchfield_clear").click(function(){$('.searchfield.from, .searchfield.to').val('').datepicker("option",'minDate','').datepicker("option",'maxDate','');self.grid.refresh();});$(".searchfield.from, .searchfield.to").datepicker({dateFormat:locale['date_format_jquery'],changeMonth:true,numberOfMonths:1,onSelect:function(selectedDate){var option=$(this).hasClass('from')?"minDate":"maxDate";var instance=$(this).data("datepicker");var date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);$(".searchfield.from, .searchfield.to").not(this).datepicker("option",option,date);self.grid.refresh();}});$('.worker_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose workers")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Workers"))}).on('multiselectclose',function(){self.grid.refresh();});$('.status_select').multiselect({height:'auto',multiple:true,header:true,minWidth:400,noneSelectedText:noneSelectedText(translate("Choose statuses")),uncheckAllText:translate("None"),checkAllText:translate("All"),selectedText:selectedText(translate("Statuses"))}).on('multiselectclose',function(){self.grid.refresh();});};WorksheetIndex.prototype.invoiceWorksheet=function(id_worksheet)
{var self=this;showWait(translate("Creating")+"...");_ajax('worksheet/invoice',{id:id_worksheet}).done(function(response){hideWait();created=parseInt(response);if(created==1)router.navigate('/invoice/last',true);else{feedback_message(isNaN(created)?response:(created>0?created+' '+translate("invoice(s) created"):translate("No invoice created")+'!'),isNaN(created)||created<=0?'error':'success');self.grid.refresh();self.grid.onChange();}});};;function after_widget_move_charts()
{$("#graph_toggle").click(function(event){event.preventDefault();graphToggle.toggleGraph();return false;});graphToggle.showActiveGraph();};var memoText=null;function displayMemo(text){memoText=text;$("#dashboard_memo").html(htmlentities(memoText).replace(/\n/g,"<br/>"));}
function loadMemo(){ajax('/widget/action',{id:'memo',action:'load'},function(response){displayMemo(response);});}
function saveMemo(){displayMemo($("#dashboard_memo_editor").val());ajax('/widget/action',{id:'memo',action:'save',actionParameters:{content:memoText}},function(response){if(response!="ok")showDialog("Error","An error occured while saving your memo","error");},"json");}
function editMemo(){if($(this).find("textarea").size()>0)saveMemo();else{$(this).empty().append($('<textarea id="dashboard_memo_editor"></textarea>'));$("#dashboard_memo_editor").blur(saveMemo).val(memoText).focus();var textArea=$("#dashboard_memo_editor").get(0);if(typeof textArea.setSelectionRange=='function')textArea.setSelectionRange(0,0);_$("dashboard_memo_editor").onkeydown=function(event){event=event||window.event;if(event.keyCode==27){saveMemo();return false;}};}}
function after_widget_move_memo()
{$("#dashboard_memo").dblclick(editMemo);};function after_widget_move_quicksearch(init_mode)
{if(!init_mode)$('#quick_search_field').focus();$('#quick_search_field').keypress(function(event){if(event.which=='13'){event.preventDefault();$('#quicksearch form').submit();}});$("div.has_tooltip").scrolltip({content:function(){return comment2html($(this).siblings('.comment').html());}});};